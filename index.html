<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="theme-color" content="#2c3e50">
	<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItee16LXqNeb16og16DXmdeU15XXnCDXnteZ15DXmSAtINeh15nXoNeV15Qg16HXmdeY15kiLAogICJzaG9ydF9uYW1lIjogItee15zXkNeZINeh15nXoNeV15QiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y1ZjVmNSIsCiAgInRoZW1lX2NvbG9yIjogIiMyYzNlNTAiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBSUFBQUFDQUNBWUFBQUREdDFkRkFBQUFCSE5DU1ZRSUNBZ0lmQWhraUFBQUFBbHdTRmx6QUFBQUJFZ0FBQUI0QVlnQlpBQUFBQUFCbDVqbGtBQUFBQUFBQUFBQUFBQUFBQkpSVTVFcmtKZ2dnPT0iLAogICAgICAic2l6ZXMiOiAiMTI4eDEyOCIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    <title>מערכת ניהול מלאי - סינמה סיטי חדרה</title>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <style>
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; }
        
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background-color:#f5f5f5;color:#333;line-height:1.6;min-height:100vh;}
        .login-container {display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
        .login-box {background:white;padding:40px;border-radius:12px;box-shadow:0 15px 35px rgba(0,0,0,0.2);width:90%;max-width:400px;}
        .login-box h1 {text-align:center;margin-bottom:30px;color:#333;}
        .main-container {display:none;min-height:100vh;}
        .top-nav {background:#2c3e50;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
        .nav-brand {font-size:20px;font-weight:bold;display:flex;align-items:center;gap:10px;}
        .nav-user {display:flex;align-items:center;gap:15px;}
        .user-info {display:flex;flex-direction:column;align-items:flex-end;font-size:14px;}
        .user-role {font-size:12px;opacity:.8;}
        .logout-btn {background:#e74c3c;color:white;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;font-size:14px;}
        .logout-btn:hover {background:#c0392b;}
        .container {max-width:1400px;margin:0 auto;padding:20px;}
        .tabs {display:flex;gap:5px;margin-bottom:20px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:5px;}
        .tab {padding:12px 20px;background:white;border:2px solid #ddd;cursor:pointer;border-radius:8px;transition:all .3s;font-weight:500;white-space:nowrap;flex-shrink:0;}
        .tab:hover {background:#f8f9fa;}
        .tab.active {background:#3498db;color:white;border-color:#3498db;}
        .tab.disabled {opacity:.5;cursor:not-allowed;}
        .tab-content {display:none;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .tab-content.active {display:block;}
        .table-wrapper {overflow-x:auto;-webkit-overflow-scrolling:touch;}
        table {width:100%;border-collapse:collapse;margin-top:20px;min-width:600px;}
        th,td {padding:12px;text-align:right;border:1px solid #ddd;}
        th {background:#34495e;color:white;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer;}
        tr:nth-child(even) {background:#f8f9fa;}
        tr:hover {background:#e8f4fd;}
        .low-stock {background-color:#ffebee!important;color:#c62828;font-weight:bold;}
        .expiring-soon {background-color:#fff3e0!important;color:#ef6c00;}
        .form-group {margin-bottom:20px;}
        label {display:block;margin-bottom:5px;font-weight:600;color:#555;}
        input,select {width:100%;padding:12px;border:1px solid #ddd;border-radius:4px;font-size:16px;-webkit-appearance:none;}
        input:focus,select:focus {outline:none;border-color:#3498db;box-shadow:0 0 0 2px rgba(52,152,219,0.2);}
        button {background:#3498db;color:white;padding:12px 30px;border:none;border-radius:4px;cursor:pointer;font-size:16px;font-weight:600;transition:background .3s;width:auto;}
        button:hover {background:#2980b9;}
        button:disabled {background:#95a5a6;cursor:not-allowed;}
        .stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px;}
        .stat-card {background:white;padding:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);text-align:center;transition:transform .3s;}
        .stat-card:hover {transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.15);}
        .stat-card h3 {color:#7f8c8d;font-size:14px;margin-bottom:10px;}
        .stat-card .value {font-size:28px;font-weight:bold;color:#2c3e50;}
        .alert {padding:15px;margin-bottom:20px;border-radius:4px;display:flex;align-items:center;gap:10px;}
        .alert-warning {background:#fff3cd;color:#856404;border:1px solid #ffeeba;}
        .alert-danger {background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
        .alert-success {background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
        .form-row {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
        .user-list {margin-top:20px;}
        .user-card {background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
        .user-details {flex:1;}
        .user-actions {display:flex;gap:10px;}
        .btn-small {padding:6px 15px;font-size:14px;width:auto;}
        .btn-danger {background:#e74c3c;}
        .btn-danger:hover {background:#c0392b;}
        .btn-edit {background:#f39c12;}
        .btn-edit:hover {background:#e67e22;}
        .permission-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px;}
        .permission-item {display:flex;align-items:center;gap:10px;}
        
        /* Checkbox styles - better visibility */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        input[type="checkbox"]:checked {
            background-color: #3498db;
            border-color: #3498db;
        }
        input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        input[type="checkbox"]:hover {
            border-color: #3498db;
        }
        
        .expiring-critical {
            background-color: #ffcdd2 !important;
            color: #b71c1c;
            font-weight: bold;
        }
        .expiring-soon {
            background-color: #ffe0b2 !important;
            color: #e65100;
        }
        .expiring-warning {
            background-color: #fff9c4 !important;
            color: #f57f17;
        }
        
        .variant-row {
            background-color: #f9f9f9;
        }
        .expand-btn {
            cursor: pointer;
            padding: 2px 6px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            font-weight: bold;
        }
        .expand-btn:hover {
            background: #d5dbdb;
        }
        
        #editPickingListArea {
            max-height: 340px;
            overflow-y: auto;
            margin-bottom: 18px;
        }
	
        
        .modal-content .btn-main {
            min-width: 120px;
            width: auto;
            padding: 7px 22px;
            font-size: 1em;
            margin: 7px 6px 0 6px;
            display: inline-block;
            box-sizing: border-box;
        }
        
        .picking-table th, .picking-table td {
            padding: 6px 8px;
            font-size: 1em;
            white-space: nowrap;
            max-width: 140px;
            text-overflow: ellipsis;
            overflow: hidden;
        }
        
        .picking-table {
            width: auto;
            margin: 0 auto 10px auto;
            min-width: 0;
        }
		/* === Dark Mode Support === */
		/* CSS Variables for theming */
		:root {
			/* Light mode colors (default) */
			--bg-primary: #f5f5f5;
			--bg-secondary: #ffffff;
			--bg-nav: #2c3e50;
			--bg-modal: #fefefe;
			
			--text-primary: #333333;
			--text-secondary: #666666;
			--text-nav: #ffffff;
			
			--border-color: #dddddd;
			--border-light: #eeeeee;
			
			--shadow-light: rgba(0, 0, 0, 0.1);
			--shadow-medium: rgba(0, 0, 0, 0.2);
			
			--accent-primary: #3498db;
			--accent-hover: #2980b9;
			--accent-danger: #e74c3c;
			--accent-success: #27ae60;
			--accent-warning: #f39c12;
			
			/* Table colors */
			--table-header-bg: #34495e;
			--table-header-text: #ffffff;
			--table-row-even: #f8f9fa;
			--table-row-hover: #e8f4fd;
			
			/* Status colors */
			--status-danger-bg: #ffebee;
			--status-danger-text: #c62828;
			--status-warning-bg: #fff3e0;
			--status-warning-text: #ef6c00;
			--status-success-bg: #e8f5e9;
			--status-success-text: #2e7d32;
		}

		/* Dark mode colors */
		[data-theme="dark"] {
			--bg-primary: #1a1a1a;
			--bg-secondary: #2d2d2d;
			--bg-nav: #1a1a1a;
			--bg-modal: #2d2d2d;
			
			--text-primary: #e0e0e0;
			--text-secondary: #a0a0a0;
			--text-nav: #e0e0e0;
			
			--border-color: #404040;
			--border-light: #333333;
			
			--shadow-light: rgba(0, 0, 0, 0.3);
			--shadow-medium: rgba(0, 0, 0, 0.5);
			
			--accent-primary: #4fc3f7;
			--accent-hover: #29b6f6;
			--accent-danger: #ef5350;
			--accent-success: #66bb6a;
			--accent-warning: #ffa726;
			
			/* Table colors */
			--table-header-bg: #1a1a1a;
			--table-header-text: #e0e0e0;
			--table-row-even: #252525;
			--table-row-hover: #333333;
			
			/* Status colors */
			--status-danger-bg: rgba(244, 67, 54, 0.2);
			--status-danger-text: #ff8a80;
			--status-warning-bg: rgba(255, 152, 0, 0.2);
			--status-warning-text: #ffb74d;
			--status-success-bg: rgba(76, 175, 80, 0.2);
			--status-success-text: #81c784;
		}

		/* Auto theme - follows system */
		@media (prefers-color-scheme: dark) {
			:root:not([data-theme="light"]) {
				--bg-primary: #1a1a1a;
				--bg-secondary: #2d2d2d;
				--bg-nav: #1a1a1a;
				--bg-modal: #2d2d2d;
				
				--text-primary: #e0e0e0;
				--text-secondary: #a0a0a0;
				--text-nav: #e0e0e0;
				
				--border-color: #404040;
				--border-light: #333333;
				
				--shadow-light: rgba(0, 0, 0, 0.3);
				--shadow-medium: rgba(0, 0, 0, 0.5);
				
				--accent-primary: #4fc3f7;
				--accent-hover: #29b6f6;
				--accent-danger: #ef5350;
				--accent-success: #66bb6a;
				--accent-warning: #ffa726;
				
				--table-header-bg: #1a1a1a;
				--table-header-text: #e0e0e0;
				--table-row-even: #252525;
				--table-row-hover: #333333;
				
				--status-danger-bg: rgba(244, 67, 54, 0.2);
				--status-danger-text: #ff8a80;
				--status-warning-bg: rgba(255, 152, 0, 0.2);
				--status-warning-text: #ffb74d;
				--status-success-bg: rgba(76, 175, 80, 0.2);
				--status-success-text: #81c784;
			}
		}

		/* Apply CSS variables to elements */
		body {
			background-color: var(--bg-primary);
			color: var(--text-primary);
		}

		.main-container {
			background-color: var(--bg-primary);
		}

		.top-nav {
			background: var(--bg-nav);
			color: var(--text-nav);
		}

		.container {
			color: var(--text-primary);
		}

		/* Tabs */
		.tab {
			background: var(--bg-secondary);
			color: var(--text-primary);
			border-color: var(--border-color);
		}

		.tab:hover {
			background: var(--table-row-hover);
		}

		.tab.active {
			background: var(--accent-primary);
			color: white;
			border-color: var(--accent-primary);
		}

		/* Content areas */
		.tab-content {
			background: var(--bg-secondary);
			color: var(--text-primary);
			box-shadow: 0 2px 10px var(--shadow-light);
		}

		.stat-card {
			background: var(--bg-secondary);
			color: var(--text-primary);
			box-shadow: 0 2px 5px var(--shadow-light);
		}

		.stat-card h3 {
			color: var(--text-secondary);
		}

		.stat-card .value {
			color: var(--text-primary);
		}

		/* Forms */
		input, select, textarea {
			background: var(--bg-primary);
			color: var(--text-primary);
			border-color: var(--border-color);
		}

		input:focus, select:focus, textarea:focus {
			border-color: var(--accent-primary);
			box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
		}

		label {
			color: var(--text-primary);
		}

		/* Tables */
		table {
			background: var(--bg-secondary);
		}

		th {
			background: var(--table-header-bg);
			color: var(--table-header-text);
		}

		td {
			background: var(--bg-secondary);
			color: var(--text-primary);
			border-color: var(--border-color);
		}

		tr:nth-child(even) {
			background: var(--table-row-even);
		}

		tr:hover {
			background: var(--table-row-hover);
		}

		/* Status rows */
		.low-stock {
			background-color: var(--status-danger-bg) !important;
			color: var(--status-danger-text);
		}

		.expiring-soon {
			background-color: var(--status-warning-bg) !important;
			color: var(--status-warning-text);
		}

		.expiring-warning {
			background-color: var(--status-warning-bg) !important;
			color: var(--status-warning-text);
		}

		.expiring-critical {
			background-color: var(--status-danger-bg) !important;
			color: var(--status-danger-text);
		}

		/* Modals */
		.modal-content {
			background: var(--bg-modal);
			color: var(--text-primary);
		}

		.modal-header h2 {
			color: var(--text-primary);
		}

		.close {
			color: var(--text-secondary);
		}

		.close:hover {
			color: var(--text-primary);
		}

		/* Buttons */
		button {
			background: var(--accent-primary);
			color: white;
		}

		button:hover {
			background: var(--accent-hover);
		}

		.btn-danger {
			background: var(--accent-danger);
		}

		.btn-danger:hover {
			background: #c0392b;
		}

		.btn-edit {
			background: var(--accent-warning);
		}

		.btn-edit:hover {
			background: #e67e22;
		}

		/* Alerts */
		.alert-warning {
			background: var(--status-warning-bg);
			color: var(--status-warning-text);
			border-color: var(--accent-warning);
		}

		.alert-danger {
			background: var(--status-danger-bg);
			color: var(--status-danger-text);
			border-color: var(--accent-danger);
		}

		.alert-success {
			background: var(--status-success-bg);
			color: var(--status-success-text);
			border-color: var(--accent-success);
		}

		/* Other elements */
		.user-card {
			background: var(--table-row-even);
			color: var(--text-primary);
		}

		.expand-btn {
			background: var(--bg-primary);
			border-color: var(--border-color);
			color: var(--text-primary);
		}

		.expand-btn:hover {
			background: var(--table-row-hover);
		}

		.empty-state {
			color: var(--text-secondary);
		}

		.skeleton-loader {
			background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--border-color) 50%, var(--bg-secondary) 75%);
		}

		.skeleton-stat-card {
			background: var(--bg-secondary);
		}

		/* Login box */
		.login-box {
			background: var(--bg-secondary);
			color: var(--text-primary);
		}

		.login-box h1 {
			color: var(--text-primary);
		}

		/* Bottom navigation */
		.bottom-nav {
			background: var(--bg-secondary);
			border-top-color: var(--border-color);
		}

		.bottom-nav-item {
			color: var(--text-secondary);
		}

		.bottom-nav-item.active {
			color: var(--accent-primary);
		}

		/* FAB elements */
		.fab {
			background: var(--accent-primary);
		}

		.fab.menu-open {
			background: var(--accent-danger);
		}

		.fab-menu-label {
			background: var(--bg-secondary);
			color: var(--text-primary);
		}

		/* Theme toggle button */
		#themeToggle {
			background: transparent !important;
			border: 1px solid rgba(255,255,255,0.3) !important;
			color: var(--text-nav) !important;
		}

		#themeToggle:hover {
			background: rgba(255,255,255,0.1) !important;
		}

		/* Smooth transitions */
		* {
			transition: background-color 0.3s ease, 
						color 0.3s ease, 
						border-color 0.3s ease,
						box-shadow 0.3s ease;
		}

		/* Prevent transition on page load */
		.no-transition * {
			transition: none !important;
		}

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 4px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transform: translateY(100px);
            opacity: 0;
            transition: all .3s;
            z-index: 1000;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px;
            border-radius: 8px;
            z-index: 2000;
        }
        
        .error-message {
            color: #e74c3c;
            font-size: 14px;
            margin-top: 5px;
        }
        /* === Bottom Navigation === */
		.bottom-nav {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			background: white;
			box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
			display: flex;
			justify-content: space-around;
			padding: 8px 0;
			z-index: 100;
		}

		.bottom-nav-item {
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 4px;
			padding: 8px;
			cursor: pointer;
			background: transparent;
			border: none;
			color: #7f8c8d;
			font-family: inherit;
		}

		.bottom-nav-item.active {
			color: #3498db;
		}

		.bottom-nav-item span:first-child {
			font-size: 20px;
		}

		.bottom-nav-item span:last-child {
			font-size: 11px;
			font-weight: 500;
		}

		@media (max-width: 767px) {
			.main-container {
				padding-bottom: 70px;
			}
		}
		/* === Floating Action Button === */
		.fab {
			position: fixed;
			bottom: 80px; /* מעל הניווט התחתון */
			right: 20px;
			width: 56px;
			height: 56px;
			border-radius: 50%;
			background: #3498db;
			color: white;
			border: none;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			font-size: 24px;
			cursor: pointer;
			z-index: 99;
			transition: all 0.3s;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.fab:active {
			transform: scale(0.9);
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		}
		/* === FAB Menu === */
		.fab-menu {
			position: fixed;
			bottom: 0;
			right: 0;
			width: 100%;
			height: 100%;
			z-index: 98;
			pointer-events: none;
		}

		.fab-backdrop {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.3);
			opacity: 0;
			transition: opacity 0.3s;
			pointer-events: none;
		}

		.fab-menu.show .fab-backdrop {
			opacity: 1;
			pointer-events: all;
		}

		.fab-menu-items {
			position: absolute;
			bottom: 150px;
			right: 20px;
			display: flex;
			flex-direction: column-reverse;
			gap: 12px;
			transform: scale(0);
			transform-origin: bottom right;
			transition: transform 0.3s;
			pointer-events: none;
		}

		.fab-menu.show .fab-menu-items {
			transform: scale(1);
			pointer-events: all;
		}

		.fab-menu-item {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 12px;
			transform: translateX(20px);
			opacity: 0;
			transition: all 0.3s;
			pointer-events: all;
			z-index: 99;
		}

		.fab-menu.show .fab-menu-item {
			transform: translateX(0);
			opacity: 1;
		}

		.fab-menu-item:nth-child(1) { transition-delay: 0.05s; }
		.fab-menu-item:nth-child(2) { transition-delay: 0.1s; }
		.fab-menu-item:nth-child(3) { transition-delay: 0.15s; }

		.fab-menu-label {
			background: white;
			padding: 8px 16px;
			border-radius: 20px;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
			font-size: 14px;
			font-weight: 500;
			white-space: nowrap;
			pointer-events: all;
		}
		.fab-menu-item:hover .fab-menu-label {
			background: #f5f5f5;
		}

		.fab-menu-item:active .fab-menu-label {
			background: #e0e0e0;
		}
		.fab-menu-button {
			width: 48px;
			height: 48px;
			border-radius: 50%;
			border: none;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
			cursor: pointer;
			font-size: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: transform 0.2s;
			pointer-events: all;
			position: relative;
			z-index: 100;
		}

		.fab-menu-button:active {
			transform: scale(0.9);
		}

		.fab-menu-button.transaction {
			background: #27ae60;
			color: white;
		}

		.fab-menu-button.product {
			background: #e74c3c;
			color: white;
		}

		.fab-menu-button.user {
			background: #f39c12;
			color: white;
		}

		/* אנימציה לכפתור הראשי */
		.fab {
			transition: all 0.3s;
		}
		@media (min-width: 768px) {
			.fab {
				display: none !important;
			}
			.bottom-nav {
				display: none !important;
			}
		}
        @media (max-width:768px){
            .container{padding:10px;}
            .tabs{margin-bottom:15px;}
            .tab{padding:10px 15px;font-size:14px;}
            .tab-content{padding:15px;}
            .stats{grid-template-columns:1fr 1fr;gap:10px;}
            .stat-card{padding:15px;}
            .stat-card .value{font-size:24px;}
            table{font-size:14px;}
            th,td{padding:8px 6px;}
            .nav-brand{font-size:16px;}
            .user-info{display:none;}
            .form-row{grid-template-columns:1fr;}
        }
        
        @media (max-width:480px){
            .stats{grid-template-columns:1fr;}
            .login-box{padding:30px 20px;}
        }
		
		/* === Mobile Optimizations === */
		@media (max-width: 768px) {
			/* הסתר מידע משני במובייל */
			.user-info {
				display: none;
			}
			
			/* הגדל אזורי לחיצה */
			button, .btn-small {
				min-height: 44px;
				min-width: 44px;
			}
			
			/* התאם טאבים למובייל */
			.tabs {
				overflow-x: auto;
				-webkit-overflow-scrolling: touch;
				scrollbar-width: none;
			}
			
			.tabs::-webkit-scrollbar {
				display: none;
			}
			
			/* טבלאות עם גלילה */
			.table-wrapper {
				margin: 0 -15px;
				padding: 0 15px;
			}
			
			/* טפסים מותאמים */
			input, select {
				font-size: 16px; /* מונע זום אוטומטי */
			}
			
			/* כרטיסי סטטיסטיקה */
			.stats {
				grid-template-columns: repeat(2, 1fr);
			}
		}

		/* ביטול highlight בלחיצה */
		* {
			-webkit-tap-highlight-color: transparent;
		}

		/* תיקון גובה viewport ב-iOS */
		.main-container {
			min-height: 100vh;
			min-height: -webkit-fill-available;
		}
		/* === Pull to Refresh === */
		.pull-to-refresh {
			position: fixed;
			top: -60px;
			left: 50%;
			transform: translateX(-50%);
			width: 40px;
			height: 40px;
			background: white;
			border-radius: 50%;
			box-shadow: 0 2px 8px rgba(0,0,0,0.2);
			display: flex;
			align-items: center;
			justify-content: center;
			transition: top 0.3s;
			z-index: 90;
			font-size: 20px;
		}

		.pull-to-refresh.show {
			top: 70px;
		}

		.pull-to-refresh.refreshing {
			animation: spin 1s linear infinite;
		}

		@keyframes spin {
			from { transform: translateX(-50%) rotate(0deg); }
			to { transform: translateX(-50%) rotate(360deg); }
		}
		/* === Smooth Animations === */
		.tab-content {
			animation: fadeIn 0.3s ease-in-out;
		}

		@keyframes fadeIn {
			from { 
				opacity: 0; 
				transform: translateY(10px); 
			}
			to { 
				opacity: 1; 
				transform: translateY(0); 
			}
		}

		/* Active states for mobile */
		button:active, .btn:active {
			transform: scale(0.98);
		}

		.stat-card:active {
			transform: scale(0.98);
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}
		/* === Mobile Modal Optimizations === */
		@media (max-width: 768px) {
			/* התאמת מודאלים למובייל */
			.modal-content {
				width: 95% !important;
				max-width: none !important;
				margin: 10px auto !important;
				max-height: 90vh;
				overflow-y: auto;
				padding: 15px !important;
				border-radius: 12px;
			}
			
			/* כותרת מודאל */
			.modal-header {
				position: sticky;
				top: -15px;
				background: white;
				z-index: 10;
				padding-bottom: 10px;
				margin-bottom: 15px !important;
				border-bottom: 1px solid #eee;
			}
			
			.modal-header h2 {
				font-size: 1.3rem !important;
			}
			
			/* כפתור סגירה גדול יותר */
			.close {
				font-size: 32px !important;
				width: 44px;
				height: 44px;
				display: flex;
				align-items: center;
				justify-content: center;
				margin: -10px;
			}
			
			/* שדות טופס במודאל */
			.modal-content .form-row {
				grid-template-columns: 1fr !important;
				gap: 15px !important;
			}
			
			.modal-content .form-group {
				margin-bottom: 15px !important;
			}
			
			.modal-content label {
				font-size: 0.95rem !important;
				margin-bottom: 8px !important;
			}
			
			.modal-content input,
			.modal-content select {
				height: 48px !important;
				font-size: 16px !important; /* מונע זום אוטומטי */
				padding: 12px !important;
			}
			
			/* כפתורים במודאל */
			.modal-content button {
				min-height: 48px !important;
				font-size: 1.05rem !important;
				margin-top: 10px !important;
			}
			
			/* רשת הרשאות */
			.permission-grid {
				grid-template-columns: 1fr !important;
				gap: 12px !important;
			}
			
			.permission-item {
				background: #f5f5f5;
				padding: 12px;
				border-radius: 8px;
				display: flex;
				align-items: center;
				gap: 12px;
			}
			
			.permission-item input[type="checkbox"] {
				width: 24px !important;
				height: 24px !important;
				flex-shrink: 0;
			}
			
			.permission-item label {
				margin: 0 !important;
				flex: 1;
				font-size: 1rem !important;
			}
			
			/* גלילה חלקה */
			.modal-content {
				-webkit-overflow-scrolling: touch;
				scroll-behavior: smooth;
			}
			
			/* מרווח תחתון לגלילה */
			.modal-content form {
				padding-bottom: 20px;
			}
		}

		/* === טאב הוספת פריט === */
		@media (max-width: 768px) {
			#addItem .form-row {
				display: flex;
				flex-direction: column;
				gap: 15px;
			}
			
			/* כותרת "פריטים" */
			#addItem h3 {
				margin: 25px 0 15px;
				font-size: 1.2rem;
				color: #273c75;
			}
			
			/* מיכל וריאנטים */
			#variantsContainer {
				background: #f8f9fa;
				padding: 10px;
				border-radius: 8px;
				margin-bottom: 20px;
			}
			
			/* כל וריאנט */
			#variantsContainer .form-row {
				background: white;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 10px;
				border: 1px solid #e0e0e0;
			}
			
			/* כפתור הסרת וריאנט */
			#variantsContainer .btn-danger {
				width: 100%;
				margin-top: 10px;
			}
			
			/* כפתורי פעולה */
			#addItem button[type="button"],
			#addItem button[type="submit"] {
				width: 100%;
				margin: 5px 0;
			}
		}
		/* === טבלאות רספונסיביות בדוחות === */
		@media (max-width: 768px) {
			/* מיכל הדוחות */
			#reportContent {
				margin: 0 -10px;
				padding: 0 10px;
			}
			
			/* כותרות דוחות */
			#reportContent h3 {
				font-size: 1.2rem;
				margin-bottom: 15px;
				text-align: center;
			}
			
			/* טבלאות בדוחות - הפוך לכרטיסים */
			#reportContent table {
				display: block;
				border: none !important;
			}
			
			#reportContent thead {
				display: none; /* הסתר כותרות */
			}
			
			#reportContent tbody {
				display: block;
			}
			
			#reportContent tr {
				display: block;
				margin-bottom: 15px;
				background: white;
				border: 1px solid #ddd;
				border-radius: 8px;
				padding: 15px;
				box-shadow: 0 2px 4px rgba(0,0,0,0.1);
			}
			
			#reportContent td {
				display: block;
				border: none !important;
				padding: 8px 0 !important;
				position: relative;
				padding-right: 35% !important;
			}
			
			/* הוסף תוויות לפני כל שדה */
			#reportContent td:before {
				content: attr(data-label);
				position: absolute;
				right: 0;
				width: 30%;
				font-weight: bold;
				color: #666;
			}
			
			/* סטטוסים וצבעים */
			#reportContent tr[style*="background: #ffebee"] {
				border-right: 4px solid #f44336;
			}
			
			#reportContent tr[style*="background: #fff3e0"] {
				border-right: 4px solid #ff9800;
			}
			
			#reportContent tr[style*="background: #e8f5e9"] {
				border-right: 4px solid #4caf50;
			}
			
			/* כפתורי דוחות */
			#reports .form-row {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 10px;
			}
			
			#reports .btn-small {
				width: 100%;
				padding: 12px 10px;
				font-size: 0.9rem;
			}
			
			/* כפתורי ייצוא והדפסה */
			#reportContent button {
				width: 48%;
				margin: 10px 1%;
			}
		}

		/* === סגנון מיוחד לדוח מלאי === */
		@media (max-width: 768px) {
			/* checkbox להצגת וריאנטים */
			#reportContent input[type="checkbox"] {
				width: 20px;
				height: 20px;
				margin-left: 10px;
			}
			
			/* טבלת מלאי עם וריאנטים */
			#reportContent tr[style*="background: #ecf0f1"] {
				background: #2c3e50 !important;
				color: white;
				font-weight: bold;
				margin-bottom: 5px;
				border-radius: 8px 8px 0 0;
			}
			
			/* שורות וריאנטים */
			#reportContent tr td[style*="padding-right: 20px"] {
				background: #f8f9fa;
				margin-top: 0;
				border-radius: 0;
				margin-bottom: 2px;
			}
		}
		/* === טופס רישום תנועה במובייל === */
		@media (max-width: 768px) {
			/* שורות תנועה */
			#multiTransactionRows .form-row {
				background: #f5f5f5;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 15px;
				position: relative;
			}
			
			#multiTransactionRows .form-group {
				margin-bottom: 15px;
			}
			
			/* כפתור הסרה */
			#multiTransactionRows .btn-danger {
				position: absolute;
				top: 10px;
				left: 10px;
				width: auto;
				padding: 5px 10px;
				font-size: 0.9rem;
			}
			
			/* כפתורי פעולה */
			#transaction button[type="button"],
			#transaction button[type="submit"] {
				width: 100%;
				margin: 5px 0;
			}
			
			/* הודעת ליקוט */
			#pickingListContainer {
				margin: 20px 0;
				padding: 15px;
				background: #f8f9fa;
				border-radius: 8px;
			}
			
			#pickingListContainer .btn-main {
				width: 100%;
				margin: 5px 0;
			}
		}

		/* === טבלת מלאי נוכחי במובייל === */
		@media (max-width: 768px) {
			/* חיפוש וסינון */
			#inventory > div:first-child {
				flex-direction: column;
				gap: 10px;
			}
			
			#inventorySearch {
				width: 100% !important;
			}
			
			#categoryFilter {
				width: 100% !important;
			}
			
			/* טבלת מלאי - תצוגת כרטיסים */
			@media (max-width: 768px) {
				/* הקטנת גודל הטבלה */
				#inventoryTable {
					font-size: 0.85rem;
				}
				
				#inventoryTable th,
				#inventoryTable td {
					padding: 6px 4px !important;
					font-size: 0.85rem;
				}
				
				/* הסתרת עמודת הסטטוס הטקסטי */
				#inventoryTable th:nth-child(7),
				#inventoryTable td:nth-child(7) {
					display: none;
				}
				
				/* כפתורים קטנים יותר */
				#inventoryTable .btn-small {
					padding: 4px 8px;
					font-size: 0.8rem;
				}
			}

		/* === טבלת תנועות במובייל === */
		@media (max-width: 768px) {
			#movementsBody tr {
				font-size: 0.9rem;
			}
			
			#movementsBody td {
				padding: 8px 4px !important;
			}
			
			/* הסתר עמודות פחות חשובות */
			#movementsTable th:nth-child(2), /* שעה */
			#movementsTable td:nth-child(2),
			#movementsTable th:nth-child(7), /* הערות */
			#movementsTable td:nth-child(7) {
				display: none;
			}
		}

		/* === התראות במובייל === */
		@media (max-width: 768px) {
			.alert {
				font-size: 0.9rem;
				padding: 12px;
				margin-bottom: 10px;
			}
			
			#alerts {
				margin: 0 -10px 20px -10px;
				padding: 0 10px;
			}
		}

		/* === חלון משתמשים במובייל === */
		@media (max-width: 768px) {
			.user-card {
				flex-direction: column;
				align-items: stretch;
				padding: 15px;
			}
			
			.user-details {
				margin-bottom: 15px;
			}
			
			.user-actions {
				display: flex;
				gap: 10px;
			}
			
			.user-actions button {
				flex: 1;
			}
		}

		/* === שיפורי נגישות כלליים === */
		@media (max-width: 768px) {
			/* הגדל אזורי לחיצה */
			a, button, input[type="submit"], input[type="button"] {
				min-height: 44px;
				min-width: 44px;
			}
			
			/* מרווחים בין אלמנטים */
			.form-group + .form-group {
				margin-top: 15px;
			}
			
			/* גודל טקסט קריא */
			body {
				font-size: 16px;
			}
			
			/* מניעת גלילה אופקית */
			body {
				overflow-x: hidden;
			}
			
			.container {
				overflow-x: hidden;
			}
		}

		/* === אנימציות חלקות === */
		@media (max-width: 768px) {
			* {
				-webkit-transition: none !important;
				transition: none !important;
			}
			
			/* השאר רק אנימציות קריטיות */
			.fab-menu,
			.fab-menu-items,
			.toast {
				-webkit-transition: all 0.3s ease !important;
				transition: all 0.3s ease !important;
			}
		}
		@media (max-width: 768px) {
			/* הקטנת גודל הטבלה */
			#inventoryTable {
				font-size: 0.75rem;
			}
			
			#inventoryTable th,
			#inventoryTable td {
				padding: 6px 2px !important;
				font-size: 0.75rem;
			}
			
			/* הסתרת עמודות לא חיוניות במובייל */
			#inventoryTable th:nth-child(3), /* קטגוריה */
			#inventoryTable td:nth-child(3),
			#inventoryTable th:nth-child(5), /* מינימום */
			#inventoryTable td:nth-child(5) {
				display: none;
			}
			
			/* עמודת הסטטוס - וודא שהיא מוצגת */
			#inventoryTable th:nth-child(7),
			#inventoryTable td:nth-child(7) {
				display: table-cell !important;
				text-align: center;
			}
			
			/* כותרות קטנות יותר */
			#inventoryTable th {
				font-size: 0.7rem !important;
				font-weight: 600;
			}
			
			/* עיצוב מיוחד לעמודות במובייל */
			#inventoryTable th:nth-child(1),
			#inventoryTable td:nth-child(1) {
				width: 28px;
			}
			
			#inventoryTable th:nth-child(4),
			#inventoryTable td:nth-child(4) {
				text-align: center;
			}
			
			#inventoryTable th:nth-child(6),
			#inventoryTable td:nth-child(6) {
				font-size: 0.7rem;
			}
			
			/* כפתורים קטנים יותר */
			#inventoryTable .btn-small {
				padding: 2px;
				background: transparent;
				border: none;
			}
		}
		@media (max-width: 768px) {
			/* כפתור הרחבה נראה אבל קומפקטי */
			#inventoryTable .expand-btn {
				width: 22px !important;
				height: 22px !important;
				padding: 0 !important;
				font-size: 14px !important;
				line-height: 22px !important;
				border: 1px solid #ddd !important;
				background: #fff !important;
				border-radius: 3px !important;
				font-weight: bold !important;
				cursor: pointer;
				color: #333 !important;
				display: inline-flex !important;
				align-items: center !important;
				justify-content: center !important;
			}
			
			/* עמודת כפתור ההרחבה */
			#inventoryTable th:nth-child(1),
			#inventoryTable td:nth-child(1) {
				width: 26px !important;
				padding: 2px !important;
				text-align: center;
			}
		}
		/* Collapsible Alerts Styles */
		.alerts-wrapper {
			margin-bottom: 20px;
			border: 1px solid #ddd;
			border-radius: 8px;
			background: #f9f9f9;
			overflow: hidden;
		}

		.alerts-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 15px;
			background: #f0f0f0;
			border-bottom: 1px solid #ddd;
		}

		.alerts-title {
			font-size: 16px;
			color: #333;
		}

		.alerts-toggle-btn {
			background: #3498db;
			color: white;
			border: none;
			padding: 6px 15px;
			border-radius: 4px;
			cursor: pointer;
			font-size: 14px;
			display: flex;
			align-items: center;
			gap: 5px;
			transition: background 0.3s;
		}

		.alerts-toggle-btn:hover {
			background: #2980b9;
		}

		.toggle-icon {
			font-size: 12px;
			transition: transform 0.3s;
		}

		.alerts-list {
			max-height: 600px;
			overflow-y: auto;
		}

		.alerts-list .alert {
			margin: 0;
			border-radius: 0;
			border-bottom: 1px solid #eee;
		}

		.alerts-list .alert:last-child {
			border-bottom: none;
		}

		.alerts-hidden {
			animation: slideDown 0.3s ease-out;
		}

		@keyframes slideDown {
			from {
				opacity: 0;
				transform: translateY(-10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Mobile optimization for alerts */
		@media (max-width: 768px) {
			.alerts-header {
				flex-direction: column;
				gap: 10px;
				text-align: center;
			}
			
			.alerts-toggle-btn {
				width: 100%;
				justify-content: center;
			}
			
			.alerts-list {
				max-height: 400px;
			}
		}
		/* Alert badges */
		.alerts-summary {
			display: inline-flex;
			gap: 8px;
			margin-right: 10px;
		}

		.badge {
			padding: 2px 8px;
			border-radius: 12px;
			font-size: 12px;
			font-weight: bold;
		}

		.badge-danger {
			background: #e74c3c;
			color: white;
		}

		.badge-warning {
			background: #f39c12;
			color: white;
		}

		/* Smooth transitions */
		.alerts-hidden {
			transition: all 0.3s ease-out;
		}

		/* Alert type indicators */
		.alert-danger {
			border-right: 4px solid #e74c3c;
		}

		.alert-warning {
			border-right: 4px solid #f39c12;
		}

		.alert-info {
			border-right: 4px solid #3498db;
		}
		/* Dark Mode Support */
		@media (prefers-color-scheme: dark) {
			:root {
				--bg-primary: #1a1a1a;
				--bg-secondary: #2d2d2d;
				--text-primary: #e0e0e0;
				--accent: #4fc3f7;
			}
		}

		/* Animations */
		.card-enter {
			animation: slideIn 0.3s ease-out;
		}

		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Skeleton Loading Styles */
		.skeleton-loader {
			background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
			background-size: 200% 100%;
			animation: skeleton-loading 1.5s infinite;
			border-radius: 4px;
		}

		@keyframes skeleton-loading {
			0% {
				background-position: 200% 0;
			}
			100% {
				background-position: -200% 0;
			}
		}

		/* Skeleton Components */
		.skeleton-table {
			width: 100%;
			margin-top: 20px;
		}

		.skeleton-row {
			display: flex;
			gap: 10px;
			margin-bottom: 10px;
			padding: 10px;
		}

		.skeleton-cell {
			height: 20px;
			flex: 1;
		}

		.skeleton-cell.small {
			flex: 0.5;
		}

		.skeleton-cell.large {
			flex: 2;
		}

		.skeleton-stat-card {
			height: 100px;
			margin-bottom: 15px;
			padding: 20px;
			background: white;
			border-radius: 8px;
			box-shadow: 0 2px 5px rgba(0,0,0,0.1);
		}

		.skeleton-stat-value {
			height: 40px;
			width: 60%;
			margin: 10px 0;
		}

		.skeleton-stat-label {
			height: 16px;
			width: 40%;
		}

		/* Fade in animation for content */
		.fade-in {
			animation: fadeIn 0.3s ease-in-out;
		}

		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		/* Tab Transitions */
		.tab {
			position: relative;
			overflow: hidden;
			transition: all 0.3s ease;
		}

		.tab::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 50%;
			width: 0;
			height: 3px;
			background: #3498db;
			transition: all 0.3s ease;
			transform: translateX(-50%);
		}

		.tab.active::after {
			width: 100%;
		}

		.tab:hover {
			transform: translateY(-2px);
			box-shadow: 0 4px 8px rgba(0,0,0,0.1);
		}

		/* Tab Content Animations */
		.tab-content {
			opacity: 0;
			transform: translateX(20px);
			transition: all 0.3s ease;
		}

		.tab-content.active {
			opacity: 1;
			transform: translateX(0);
			animation: slideIn 0.3s ease-out;
		}

		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateX(20px);
			}
			to {
				opacity: 1;
				transform: translateX(0);
			}
		}

		/* Stat Cards Animations */
		.stat-card {
			transition: all 0.3s ease;
			transform: translateY(0);
		}

		.stat-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 8px 20px rgba(0,0,0,0.15);
		}

		.stat-card .value {
			transition: all 0.3s ease;
		}

		.stat-card:hover .value {
			transform: scale(1.05);
			color: #3498db;
		}

		/* Stagger animation for cards */
		.stats-enter {
			animation: statsEnter 0.5s ease-out forwards;
			opacity: 0;
		}

		.stats-enter:nth-child(1) { animation-delay: 0.1s; }
		.stats-enter:nth-child(2) { animation-delay: 0.2s; }
		.stats-enter:nth-child(3) { animation-delay: 0.3s; }
		.stats-enter:nth-child(4) { animation-delay: 0.4s; }

		@keyframes statsEnter {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		/* Number Counter Animation */
		@keyframes countUp {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		.counter-animate {
			animation: countUp 0.5s ease-out;
		}
		/* Table Row Animations */
		.table-row-enter {
			animation: tableRowEnter 0.3s ease-out;
		}

		@keyframes tableRowEnter {
			from {
				opacity: 0;
				transform: translateX(-20px);
			}
			to {
				opacity: 1;
				transform: translateX(0);
			}
		}

		/* Table hover effects */
		#inventoryTable tr,
		#movementsBody tr {
			transition: all 0.2s ease;
		}

		#inventoryTable tr:hover,
		#movementsBody tr:hover {
			transform: translateX(5px);
			box-shadow: -3px 0 10px rgba(0,0,0,0.1);
		}

		/* Expand/Collapse animation for variants */
		.variant-row {
			overflow: hidden;
			transition: all 0.3s ease;
		}

		.variant-row.collapsed {
			opacity: 0;
			transform: translateY(-10px);
			height: 0;
		}

		/* Delete row animation */
		@keyframes rowDelete {
			to {
				opacity: 0;
				transform: translateX(100%);
				height: 0;
				padding: 0;
				margin: 0;
			}
		}

		.row-delete {
			animation: rowDelete 0.3s ease-out forwards;
		}

		/* Sort animation */
		.sorting {
			position: relative;
		}

		.sorting::after {
			content: '';
			position: absolute;
			right: -20px;
			top: 50%;
			transform: translateY(-50%);
			width: 0;
			height: 0;
			border-left: 6px solid transparent;
			border-right: 6px solid transparent;
			border-bottom: 8px solid #3498db;
			opacity: 0;
			transition: all 0.3s ease;
		}

		.sorting.asc::after {
			opacity: 1;
			border-bottom-color: #3498db;
		}

		.sorting.desc::after {
			opacity: 1;
			transform: translateY(-50%) rotate(180deg);
			border-bottom-color: #3498db;
		}

		/* Button ripple effect */
		.btn-ripple {
			position: relative;
			overflow: hidden;
		}

		.btn-ripple::before {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.3);
			transform: translate(-50%, -50%);
			transition: width 0.6s, height 0.6s;
		}

		.btn-ripple:active::before {
			width: 300px;
			height: 300px;
		}

		/* Empty state animation */
		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: #95a5a6;
			animation: fadeIn 0.5s ease-out;
		}

		.empty-state-icon {
			font-size: 64px;
			margin-bottom: 20px;
			animation: bounce 2s ease-in-out infinite;
		}

		@keyframes bounce {
			0%, 100% { transform: translateY(0); }
			50% { transform: translateY(-20px); }
		}
		/* === FAB Menu Enhanced Animations === */
		.fab {
			transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
		}
		.fab.menu-open {
			transform: rotate(180deg) scale(1) !important;
			background: #e74c3c !important;
		}
		

		/* FAB Menu backdrop animation */
		.fab-menu {
			transition: visibility 0.3s;
		}

		.fab-backdrop {
			transition: opacity 0.3s ease;
		}

		/* FAB Menu Items enhanced animation */
		.fab-menu-items {
			transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
		}

		.fab-menu.show .fab-menu-items {
			transform: scale(1);
		}

		/* Individual menu items animation */
		.fab-menu-item {
			transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
		}

		.fab-menu.show .fab-menu-item {
			transform: translateX(0);
			opacity: 1;
		}

		/* Stagger delays for smooth cascade effect */
		.fab-menu.show .fab-menu-item:nth-child(1) { 
			transition-delay: 0.05s; 
		}
		.fab-menu.show .fab-menu-item:nth-child(2) { 
			transition-delay: 0.1s; 
		}
		.fab-menu.show .fab-menu-item:nth-child(3) { 
			transition-delay: 0.15s; 
		}

		/* Menu button hover effects */
		.fab-menu-button {
			transition: all 0.2s ease;
		}

		.fab-menu-button:hover {
			transform: scale(1.15);
			box-shadow: 0 4px 12px rgba(0,0,0,0.4);
		}

		/* Label hover effect */
		.fab-menu-item:hover .fab-menu-label {
			transform: translateX(-5px);
			box-shadow: 0 3px 10px rgba(0,0,0,0.2);
		}

		/* Pulse animation for FAB button */
		@keyframes fabPulse {
			0% {
				box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
			}
			50% {
				box-shadow: 0 4px 20px rgba(52, 152, 219, 0.6);
			}
			100% {
				box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
			}
		}
		/* Ripple effect on FAB click */

		/* Ripple effect for menu buttons */
		.fab-menu-button {
			position: relative;
			overflow: hidden;
		}

		.ripple {
			position: absolute;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.6);
			transform: scale(0);
			animation: ripple-animation 0.6s ease-out;
		}

		@keyframes ripple-animation {
			to {
				transform: scale(4);
				opacity: 0;
			}
		}
		/* תיקון צבעי טקסט בסיסיים */
		body {
			background-color: var(--bg-primary) !important;
			color: var(--text-primary) !important;
		}

		/* תיקון כותרות הטבלאות */
		th {
			background: var(--table-header-bg) !important;
			color: var(--table-header-text) !important;
		}

		/* תיקון רקע הטבלאות */
		table {
			background: var(--bg-secondary) !important;
		}

		td {
			background: inherit !important;
			color: var(--text-primary) !important;
		}

		/* תיקון צבעי טקסט בטפסים */
		input, select, textarea {
			background: var(--bg-primary) !important;
			color: var(--text-primary) !important;
			border-color: var(--border-color) !important;
		}

		/* תיקון labels */
		label {
			color: var(--text-primary) !important;
		}

		/* תיקון כותרות */
		h1, h2, h3, h4, h5, h6 {
			color: var(--text-primary) !important;
		}

		/* תיקון מודאלים */
		.modal-content {
			background: var(--bg-modal) !important;
			color: var(--text-primary) !important;
		}

		.modal-header h2 {
			color: var(--text-primary) !important;
		}

		/* תיקון טאבים */
		.tab {
			background: var(--bg-secondary) !important;
			color: var(--text-primary) !important;
			border-color: var(--border-color) !important;
		}

		/* תיקון כרטיסי סטטיסטיקה */
		.stat-card {
			background: var(--bg-secondary) !important;
			color: var(--text-primary) !important;
		}

		.stat-card h3 {
			color: var(--text-secondary) !important;
		}

		.stat-card .value {
			color: var(--text-primary) !important;
		}

		/* תיקון כרטיסי משתמשים */
		.user-card {
			background: var(--table-row-even) !important;
			color: var(--text-primary) !important;
		}

		.user-details {
			color: var(--text-primary) !important;
		}

		.user-details div {
			color: var(--text-secondary) !important;
		}

		/* תיקון FAB menu */
		.fab-menu-label {
			background: var(--bg-secondary) !important;
			color: var(--text-primary) !important;
		}

		/* תיקון כפתור ההרחבה */
		.expand-btn {
			background: var(--bg-primary) !important;
			border-color: var(--border-color) !important;
			color: var(--text-primary) !important;
		}

		/* תיקון alerts wrapper */
		.alerts-wrapper {
			background: var(--bg-secondary) !important;
			border-color: var(--border-color) !important;
		}

		.alerts-header {
			background: var(--table-row-even) !important;
			border-bottom-color: var(--border-color) !important;
		}

		.alerts-title {
			color: var(--text-primary) !important;
		}

		/* תיקון empty state */
		.empty-state {
			color: var(--text-secondary) !important;
		}

		/* תיקון permission items */
		.permission-item {
			background: var(--table-row-even) !important;
			color: var(--text-primary) !important;
		}

		.permission-item label {
			color: var(--text-primary) !important;
		}

		/* תיקון צבעי טקסט ב-inline styles */
		[style*="color: #333"] {
			color: var(--text-primary) !important;
		}

		[style*="color: #666"] {
			color: var(--text-secondary) !important;
		}

		[style*="color:#666"] {
			color: var(--text-secondary) !important;
		}

		[style*="color:#333"] {
			color: var(--text-primary) !important;
		}

		/* תיקון צבעי רקע */
		[style*="background: white"],
		[style*="background: #fff"],
		[style*="background:#fff"],
		[style*="background-color: white"],
		[style*="background-color: #fff"] {
			background: var(--bg-secondary) !important;
		}

		[style*="background: #f5f5f5"],
		[style*="background:#f5f5f5"],
		[style*="background-color: #f5f5f5"] {
			background: var(--table-row-even) !important;
		}

		[style*="background: #f8f9fa"],
		[style*="background:#f8f9fa"] {
			background: var(--table-row-even) !important;
		}

		/* תיקון דוחות */
		#reportContent table {
			background: var(--bg-secondary) !important;
		}

		#reportContent th {
			background: var(--table-header-bg) !important;
			color: var(--table-header-text) !important;
		}

		#reportContent td {
			color: var(--text-primary) !important;
			border-color: var(--border-color) !important;
		}

		/* תיקון קלט ב-edit picking modal */
		#editPickingListArea input[type="text"] {
			background: var(--bg-primary) !important;
			color: var(--text-primary) !important;
			border-color: var(--border-color) !important;
		}

		/* תיקון footer */
		footer {
			color: var(--text-secondary) !important;
		}

		/* תיקון toast */
		.toast {
			background: var(--bg-nav) !important;
			color: var(--text-nav) !important;
		}

		/* תיקון צבעי סטטוס - שמור על הצבעים המקוריים */
		.low-stock,
		.expiring-soon,
		.expiring-warning,
		.expiring-critical,
		.alert-warning,
		.alert-danger,
		.alert-success {
			/* אלה ישארו עם הצבעים המקוריים שלהם */
		}

		/* תיקון Bottom Navigation */
		.bottom-nav {
			background: var(--bg-secondary) !important;
			border-top-color: var(--border-color) !important;
		}

		.bottom-nav-item {
			color: var(--text-secondary) !important;
		}

		.bottom-nav-item.active {
			color: var(--accent-primary) !important;
		}

		/* תיקון variant rows */
		.variant-row {
			background-color: var(--table-row-even) !important;
		}

		/* תיקון קישורים */
		a {
			color: var(--accent-primary) !important;
		}

		/* הסר transitions בזמן החלפת theme */
		html.theme-transition,
		html.theme-transition *,
		html.theme-transition *:before,
		html.theme-transition *:after {
			transition: none !important;
		}

		/* וודא שהכפתורים נשארים עם הצבעים שלהם */
		button:not(.bottom-nav-item):not(.expand-btn):not(.alerts-toggle-btn) {
			/* כפתורים רגילים ישמרו על הצבע הכחול שלהם */
		}

		.btn-danger,
		.logout-btn {
			/* כפתורי מחיקה/יציאה ישמרו על הצבע האדום */
		}

		.btn-edit {
			/* כפתורי עריכה ישמרו על הצבע הכתום */
		}

		/* תיקון skeleton loaders */
		.skeleton-loader {
			background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--border-color) 50%, var(--bg-secondary) 75%) !important;
		}

		.skeleton-stat-card {
			background: var(--bg-secondary) !important;
		}

		/* תיקון picking list container */
		#pickingListContainer {
			color: var(--text-primary) !important;
		}

		/* תיקון multi transaction rows */
		#multiTransactionRows .form-row {
			background: var(--table-row-even) !important;
		}

		/* תיקון variants container במובייל */
		#variantsContainer > div {
			background: var(--table-row-even) !important;
		}

		/* תיקון loading spinner */
		#loadingSpinner {
			background: var(--bg-primary) !important;
		}

		/* תיקון מיוחד לטבלת דוחות */
		#reportContent tr[style*="background: #ecf0f1"] {
			background: var(--table-header-bg) !important;
			color: var(--table-header-text) !important;
		}

		#reportContent td[style*="background: #3498db"] {
			background: var(--accent-primary) !important;
			color: white !important;
		}

		/* תיקון pull to refresh */
		.pull-to-refresh {
			background: var(--bg-secondary) !important;
			box-shadow: 0 2px 8px var(--shadow-medium) !important;
		}
    </style>
</head>
<body>
	<!-- Pull to refresh indicator -->
	<div class="pull-to-refresh" id="pullToRefresh">↻</div>
    <div id="loadingSpinner" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000;"></div>
    
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>🎬 מערכת מלאי - סינמה סיטי חדרה 🍿</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">שם משתמש</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">סיסמה</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit">כניסה למערכת</button>
            </form>
        </div>
    </div>
    
    <!-- מסך ראשי -->
    <div class="main-container" id="mainScreen">
        <nav class="top-nav">
            <div class="nav-brand">
                <span>🎬</span>
                <span>מערכת ניהול מלאי סינמה סיטי חדרה</span>
                <span>🍿</span>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span id="currentUserName"></span>
                    <span class="user-role" id="currentUserRole"></span>
                </div>
				<button id="themeToggle" onclick="toggleTheme()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; margin-left: 10px; border-radius: 4px; cursor: pointer; color: white; font-size: 14px;">
					<span id="themeIcon">🌙</span>
				</button>
                <button class="logout-btn" onclick="logout()">יציאה</button>
            </div>
        </nav>
        
        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <h3>סה"כ מוצרים</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>מוצרים במלאי נמוך</h3>
                    <div class="value" id="lowStockCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>מוצרים לתפוגה קרובה</h3>
                    <div class="value" id="expiringCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>תנועות היום</h3>
                    <div class="value" id="todayMovements">0</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="inventory" data-permission="view_inventory" onclick="showTab(event, 'inventory')">מלאי נוכחי</div>
                <div class="tab" data-tab="movements" data-permission="view_movements" onclick="showTab(event, 'movements')">תנועות מלאי</div>
                <div class="tab" data-tab="transaction" data-permission="add_transaction" onclick="showTab(event, 'transaction')">רישום תנועה</div>
                <div class="tab" data-tab="addItem" data-permission="add_item" onclick="showTab(event, 'addItem')">הוספת פריט</div>
                <div class="tab" data-tab="users" data-permission="manage_users" onclick="showTab(event, 'users')">ניהול משתמשים</div>
                <div class="tab" data-tab="reports" data-permission="view_reports" onclick="showTab(event, 'reports')">דוחות</div>
                <div class="tab" data-tab="pickings" data-permission="view_pickings" onclick="showTab(event, 'pickings')">ליקוטים</div>
            </div>
            
            <!-- טאב מלאי נוכחי -->
            <div id="inventory" class="tab-content active">
                <h2>מלאי נוכחי</h2>
                <div style="display:flex; gap:15px; align-items:center; margin-bottom: 10px;">
                    <input type="text" id="inventorySearch" placeholder="חפש מוצר..." style="padding:10px; font-size:16px; width:250px; border-radius:6px; border:1px solid #ccc;">
                    <select id="categoryFilter" style="padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc;">
                        <option value="">כל הקטגוריות</option>
                        <option value="מזון">מזון</option>
                        <option value="משקאות">משקאות</option>
                        <option value="אריזות">אריזות</option>
                        <option value="ציוד">ציוד</option>
                        <option value="ניקיון">חומרי ניקיון</option>
                    </select>
                </div>
                <div id="alerts"></div>
                <div class="table-wrapper">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th onclick="sortInventory('name')">שם מוצר &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('category')">קטגוריה &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('quantity')">כמות זמינה &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('min')">מינימום &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('expiry')">תוקף קרוב &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('status')">סטטוס &#x25B2;&#x25BC;</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- טאב תנועות מלאי -->
            <div id="movements" class="tab-content">
                <h2>תנועות מלאי</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>תאריך</th>
                                <th>שעה</th>
                                <th>שם מוצר</th>
                                <th>פעולה</th>
                                <th>כמות</th>
                                <th>מבצע</th>
                                <th>הערות</th>
                                <th>פעולות</th>
                            </tr>
                        </thead>
                        <tbody id="movementsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- טאב רישום תנועה -->
            <div id="transaction" class="tab-content">
                <h2>רישום תנועת מלאי</h2>
                <form id="transactionForm">
                    <div id="multiTransactionRows"></div>
                    <div style="margin-top: 20px;">
                        <button type="button" onclick="addTransactionRow()">➕ הוסף מוצר</button>
                        <button type="button" onclick="startPickingList()">צור רשימת ליקוט ושלח</button>
                        <button type="submit">רשום תנועות במלאי</button>
                    </div>
                </form>
                <div id="pickingListContainer"></div>
            </div>
                        
            <!-- טאב הוספת פריט -->
            <div id="addItem" class="tab-content">
                <h2>הוספת מוצר חדש למלאי</h2>
                <form id="addItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemName">שם מוצר</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="itemCategory">קטגוריה</label>
                            <select id="itemCategory" required>
                                <option value="">בחר קטגוריה</option>
                                <option value="מזון">מזון</option>
                                <option value="משקאות">משקאות</option>
                                <option value="אריזות">אריזות</option>
                                <option value="ציוד">ציוד</option>
                                <option value="ניקיון">חומרי ניקיון</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="baseUnitSingular">יחידת מידה בסיסית (יחיד)</label>
                            <select id="baseUnitSingular" required></select>
                        </div>
                        <div class="form-group">
                            <label for="baseUnitPlural">יחידת מידה בסיסית (רבים)</label>
                            <select id="baseUnitPlural" required></select>
                        </div>
                        <div class="form-group">
                            <label for="packUnitSingular">שם יחידת אריזה (יחיד)</label>
                            <select id="packUnitSingular" required></select>
                        </div>
                        <div class="form-group">
                            <label for="packUnitPlural">שם יחידת אריזה (רבים)</label>
                            <select id="packUnitPlural" required></select>
                        </div>
                        <div class="form-group">
                            <label for="unitsPerPack">כמה יחידות בכל אריזה</label>
                            <input type="number" id="unitsPerPack" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="minPacks">כמות מינימום (בחבילות)</label>
                            <input type="number" id="minPacks" min="0" required>
                        </div>
                    </div>
                    <h3>פריטים</h3>
                    <div id="variantsContainer"></div>
                    <div style="margin-top: 20px;">
                        <button type="button" onclick="addVariant()">הוסף פריט</button>
                        <button type="submit">סיים</button>
                    </div>
                </form>
            </div>
            
            <!-- טאב ניהול משתמשים -->
            <div id="users" class="tab-content">
                <h2>ניהול משתמשים</h2>
                
                <h3>הוספת משתמש חדש</h3>
                <form id="addUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUsername">שם משתמש</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">סיסמה</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newFullName">שם מלא</label>
                            <input type="text" id="newFullName" required>
                        </div>
                        <div class="form-group">
                            <label for="newRole">תפקיד</label>
                            <select id="newRole" required>
                                <option value="">בחר תפקיד</option>
                                <option value="מנהל מערכת">מנהל מערכת</option>
                                <option value="מנהל מתחם">מנהל מתחם</option>
                                <option value="מנהל/ת משמרת">מנהל/ת משמרת</option>
                                <option value="מחסנאי">מחסנאי</option>
                                <option value="סופרווייזר">סופרווייזר</option>
                                <option value="מזנונאי">מזנונאי</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4>הרשאות</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_inventory" checked>
                            <label for="perm_view_inventory">צפייה במלאי</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_pickings">
                            <label for="perm_view_pickings">צפייה בליקוטים</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_movements" checked>
                            <label for="perm_view_movements">צפייה בתנועות</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_transaction">
                            <label for="perm_add_transaction">רישום תנועות</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_item">
                            <label for="perm_add_item">הוספת פריטים</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_manage_users">
                            <label for="perm_manage_users">ניהול משתמשים</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_reports">
                            <label for="perm_view_reports">צפייה בדוחות</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">הוסף משתמש</button>
                </form>
                
                <h3 style="margin-top: 40px;">משתמשים קיימים</h3>
                <div class="user-list" id="userList"></div>
            </div>
            
            <!-- טאב דוחות -->
            <div id="reports" class="tab-content">
                <h2>דוחות</h2>
                <div class="form-row">
                    <button onclick="generateReport('inventory')" class="btn-small">דוח מלאי מלא</button>
                    <button onclick="generateReport('lowStock')" class="btn-small">דוח חוסרים</button>
                    <button onclick="generateReport('expiring')" class="btn-small">דוח תפוגות</button>
                    <button onclick="generateReport('movements')" class="btn-small">דוח תנועות</button>
                </div>
                <div id="reportContent" style="margin-top: 30px;"></div>
            </div>
            
            <div id="pickings" class="tab-content">
                <h2>דוח ליקוטים</h2>
                <div id="pickingsTableContainer"></div>
            </div>
			<!-- Floating Action Button -->
			<button class="fab" id="fabButton" onclick="toggleFabMenu()" style="display: none;">➕</button>
			<!-- FAB Menu -->
			<div class="fab-menu" id="fabMenu" style="display: none;">
				<div class="fab-backdrop" onclick="closeFabMenu()"></div>
				<div class="fab-menu-items" id="fabMenuItems">
					<!-- הפריטים יתווספו דינמית לפי הרשאות -->
				</div>
			</div>
        </div>
        
        <!-- מודל עריכת וריאנט -->
        <div id="editVariantModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>עריכת וריאנט</h2>
                    <span class="close" onclick="closeEditVariantModal()">&times;</span>
                </div>
                <form id="editVariantForm">
                    <input type="hidden" id="editVariantProductName">
                    <input type="hidden" id="editVariantIndex">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editVariantQuantityPacks">כמות חבילות</label>
                            <input type="number" id="editVariantQuantityPacks" min="0" required>
                        </div>    
                        <div class="form-group">
                            <label for="editVariantQuantityUnits">יחידות בודדות</label>
                            <input type="number" id="editVariantQuantityUnits" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editVariantLocation">מיקום</label>
                            <select id="editVariantLocation" required>
                                <option value="">בחר מחסן</option>
                                <option value="מחסן שתיה">מחסן שתיה</option>
                                <option value="מחסן אולם 1">מחסן אולם 1</option>
                                <option value="מטבח VIP">מטבח VIP</option>
                                <option value="מחסן מיכלים">מחסן מיכלים</option>
                                <option value="טכני">טכני</option>
                                <option value="מחסן גלידות">מחסן גלידות</option>
                                <option value="ממד מנקים">ממד מנקים</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editVariantExpiry">תאריך תפוגה</label>
                            <input type="date" id="editVariantExpiry">
                        </div>
                    </div>
                    <button type="submit">שמור שינויים</button>
                </form>
            </div>
        </div>
        
        <!-- מודל עריכת תנועה -->
        <div id="editMovementModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>עריכת תנועה</h2>
					<span class="close" onclick="closeEditMovementModal()">&times;</span>
				</div>
				<form id="editMovementForm">
					<input type="hidden" id="editMovementId">
					<input type="hidden" id="editMovementOriginalQuantityPacks">
					<input type="hidden" id="editMovementOriginalQuantityUnits">
					<input type="hidden" id="editMovementOriginalType">
					<div class="form-row">
						<div class="form-group">
							<label for="editMovementProduct">מוצר</label>
							<input type="text" id="editMovementProduct" readonly style="background-color: #f0f0f0;">
						</div>
						<div class="form-group">
							<label for="editMovementType">סוג פעולה</label>
							<select id="editMovementType" required>
								<option value="הוצאה">הוצאה מהמלאי</option>
								<option value="הכנסה">הכנסה למלאי</option>
							</select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="editMovementLocation">מיקום</label>
							<select id="editMovementLocation" required>
								<option value="">בחר מחסן</option>
								<option value="מחסן שתיה">מחסן שתיה</option>
								<option value="מחסן אולם 1">מחסן אולם 1</option>
								<option value="מטבח VIP">מטבח VIP</option>
								<option value="מחסן מיכלים">מחסן מיכלים</option>
								<option value="טכני">טכני</option>
								<option value="מחסן גלידות">מחסן גלידות</option>
								<option value="ממד מנקים">ממד מנקים</option>
							</select>
						</div>
						<div class="form-group">
							<label for="editMovementExpiry">תאריך תפוגה</label>
							<input type="date" id="editMovementExpiry">
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="editMovementQuantityPacks">כמות חבילות</label>
							<input type="number" id="editMovementQuantityPacks" min="0" required>
						</div>
						<div class="form-group">
							<label for="editMovementQuantityUnits">כמות יחידות</label>
							<input type="number" id="editMovementQuantityUnits" min="0" required>
						</div>
						<div class="form-group">
							<label for="editMovementNotes">הערות</label>
							<input type="text" id="editMovementNotes">
						</div>
					</div>
					<div class="alert alert-warning" style="margin-top: 15px;">
						<strong>שים לב:</strong> שינוי הכמויות יעדכן את המלאי בהתאם
					</div>
					<button type="submit">שמור</button>
				</form>
			</div>
		</div>

        <!-- מודל עריכת מוצר -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>עריכת מוצר</h2>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <form id="editItemForm">
                    <input type="hidden" id="editItemOriginalName">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemName">שם מוצר</label>
                            <input type="text" id="editItemName" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemCategory">קטגוריה</label>
                            <select id="editItemCategory" required>
                                <option value="מזון">מזון</option>
                                <option value="משקאות">משקאות</option>
                                <option value="אריזות">אריזות</option>
                                <option value="ציוד">ציוד</option>
                                <option value="ניקיון">חומרי ניקיון</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editBaseUnitSingular">יחידת מידה בסיסית (יחיד)</label>
                            <input type="text" id="editBaseUnitSingular" required>
                        </div>
                        <div class="form-group">
                            <label for="editBaseUnitPlural">יחידת מידה בסיסית (רבים)</label>
                            <input type="text" id="editBaseUnitPlural" required>
                        </div>
                        <div class="form-group">
                            <label for="editPackUnitSingular">שם יחידת אריזה (יחיד)</label>
                            <input type="text" id="editPackUnitSingular" required>
                        </div>
                        <div class="form-group">
                            <label for="editPackUnitPlural">שם יחידת אריזה (רבים)</label>
                            <input type="text" id="editPackUnitPlural" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUnitsPerPack">מספר יחידות בכל אריזה</label>
                            <input type="number" id="editUnitsPerPack" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="editMinPacks">כמות מינימום במלאי (בחבילות)</label>
                            <input type="number" id="editMinPacks" min="0" required>
                        </div>
                    </div>
                    <button type="submit">שמור שינויים</button>
                </form>
            </div>
        </div>

        <div id="addVariantModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>הוספת וריאנט חדש</h2>
                    <span class="close" onclick="closeAddVariantModal()">&times;</span>
                </div>
                <form id="addVariantForm">
                    <input type="hidden" id="addVariantProductName">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addVariantQuantityPacks">כמות חבילות</label>
                            <input type="number" id="addVariantQuantityPacks" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="addVariantQuantityUnits">יחידות בודדות</label>
                            <input type="number" id="addVariantQuantityUnits" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="addVariantLocation">מיקום</label>
                            <select id="addVariantLocation" required>
                                <option value="">בחר מחסן</option>
                                <option value="מחסן שתיה">מחסן שתיה</option>
                                <option value="מחסן אולם 1">מחסן אולם 1</option>
                                <option value="מטבח VIP">מטבח VIP</option>
                                <option value="מחסן מיכלים">מחסן מיכלים</option>
                                <option value="טכני">טכני</option>
                                <option value="מחסן גלידות">מחסן גלידות</option>
                                <option value="ממד מנקים">ממד מנקים</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="addVariantExpiry">תאריך תפוגה</label>
                            <input type="date" id="addVariantExpiry">
                        </div>
                    </div>
                    <button type="submit">הוסף וריאנט</button>
                </form>
            </div>
        </div>
        
        <!-- מודל עריכת משתמש -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>עריכת משתמש</h2>
                    <span class="close" onclick="closeEditUserModal()">&times;</span>
                </div>
                <form id="editUserForm">
                    <input type="hidden" id="editUserOriginalUsername">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUsername">שם משתמש</label>
                            <input type="text" id="editUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="editPassword">סיסמה חדשה (השאר ריק אם לא רוצה לשנות)</label>
                            <input type="password" id="editPassword">
                        </div>
                        <div class="form-group">
                            <label for="editFullName">שם מלא</label>
                            <input type="text" id="editFullName" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserRole">תפקיד</label>
                            <select id="editUserRole" required>
                                <option value="">בחר תפקיד</option>
                                <option value="מנהל מערכת">מנהל מערכת</option>
                                <option value="מנהל מתחם">מנהל מתחם</option>
                                <option value="מנהל/ת משמרת">מנהל/ת משמרת</option>
                                <option value="מחסנאי">מחסנאי</option>
                                <option value="סופרווייזר">סופרווייזר</option>
                                <option value="מזנונאי">מזנונאי</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4>הרשאות</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_inventory">
                            <label for="edit_perm_view_inventory">צפייה במלאי</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_pickings">
                            <label for="edit_perm_view_pickings">צפייה בליקוטים</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_movements">
                            <label for="edit_perm_view_movements">צפייה בתנועות</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_transaction">
                            <label for="edit_perm_add_transaction">רישום תנועות</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_item">
                            <label for="edit_perm_add_item">הוספת פריטים</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_manage_users">
                            <label for="edit_perm_manage_users">ניהול משתמשים</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_reports">
                            <label for="edit_perm_view_reports">צפייה בדוחות</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">שמור שינויים</button>
                </form>
            </div>
        </div>
        
        <div id="editPickingModal" class="modal" style="display:none;direction:rtl;">
            <div class="modal-content" style="max-width:600px;margin:50px auto;background:#fff;padding:28px;border-radius:14px;box-shadow:0 6px 36px #0002;">
                <span class="close" onclick="closeEditPicking()" style="float:left;cursor:pointer;font-size:2em;">&times;</span>
                <h3 style="text-align:center;margin-top:0;">עריכת רשימת ליקוט</h3>
                <div id="editPickingListArea"></div>
            </div>
        </div>
		<nav class="bottom-nav" id="bottomNav" style="display: none;">
		<!-- הכפתורים יתווספו דינמית לפי הרשאות -->
		</nav>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- הגדרת Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg4keZ42SfFHhwjhkYbl7TdJnuN0WsuUc",
            authDomain: "inventory-57376.firebaseapp.com",
            projectId: "inventory-57376",
            storageBucket: "inventory-57376.appspot.com",
            messagingSenderId: "165204980655",
            appId: "1:165204980655:web:f7c5a78a0ae11f7191355a",
            measurementId: "G-E8EK3N3DLE"
        };
		// === Mobile Detection ===
		const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

		// === Mobile Features Initialization ===
		function initMobileFeatures() {
			if (!isMobile) return; // חוזרים לבדיקה הרגילה
    
			console.log('initMobileFeatures called');
			console.log('currentUser:', currentUser);
			// הצג ניווט תחתון
			const bottomNav = document.getElementById('bottomNav');
			if (bottomNav) {
				bottomNav.style.display = 'flex';
				bottomNav.innerHTML = ''; 
				
				// בנה את הכפתורים רק אם יש משתמש מחובר
				if (currentUser && currentUser.permissions) {
					bottomNav.innerHTML = '';
					
					// מלאי - תמיד מוצג למי שיש הרשאת צפייה
					if (currentUser.permissions.includes('view_inventory')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item active" onclick="quickNav('inventory')">
								<span>📦</span>
								<span>מלאי</span>
							</button>
						`;
					}
					
					// רישום תנועה
					if (currentUser.permissions.includes('add_transaction')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item" onclick="quickNav('transaction')">
								<span>➕</span>
								<span>רישום</span>
							</button>
						`;
					}
					
					// תנועות
					if (currentUser.permissions.includes('view_movements')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item" onclick="quickNav('movements')">
								<span>📊</span>
								<span>תנועות</span>
							</button>
						`;
					}
					
					// דוחות
					if (currentUser.permissions.includes('view_reports')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item" onclick="quickNav('reports')">
								<span>📈</span>
								<span>דוחות</span>
							</button>
						`;
					}
				}
			}
			
			    // התאם גובה למובייל
			const setVH = () => {
				const vh = window.innerHeight * 0.01;
				document.documentElement.style.setProperty('--vh', `${vh}px`);
			};
			setVH();
			window.addEventListener('resize', setVH);
			
			// הצג כפתור FAB
			const fab = document.getElementById('fabButton');
			if (fab && currentUser && currentUser.permissions) {
				const hasRelevantPermissions = 
					currentUser.permissions.includes('add_transaction') ||
					currentUser.permissions.includes('add_item') ||
					currentUser.permissions.includes('manage_users');
				
				if (hasRelevantPermissions) {
					fab.style.display = 'flex';
				} else {
					fab.style.display = 'none';
				}
			}
			
			// אתחל Pull to Refresh
			initPullToRefresh();
		}
		// === Quick Navigation for Bottom Nav ===
		function quickNav(tabName) {
			// הסר active מכל הכפתורים
			document.querySelectorAll('.bottom-nav-item').forEach(item => {
				item.classList.remove('active');
			});
			
			// הוסף active לכפתור הנוכחי
			event.currentTarget.classList.add('active');
			
			// הצג את הטאב
			showTab(tabName);
		}
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
		// אתחול Firebase Auth
		// const auth = firebase.auth();
		const auth = null

		// פונקציה ליצירת/עדכון משתמש ב-Auth
		async function createOrUpdateAuthUser(username, password, email = null) {
			try {
				const userEmail = email || `${username}@cinema-city-hadera.local`;
				
				try {
					// נסה להתחבר קודם (בדוק אם המשתמש קיים)
					const userCredential = await auth.signInWithEmailAndPassword(userEmail, password);
					
					// אם הצליח, עדכן סיסמה אם שונה
					if (password && password !== '1234') { // אל תעדכן סיסמה ברירת מחדל
						await userCredential.user.updatePassword(password);
					}
					
					return userCredential.user;
				} catch (error) {
					if (error.code === 'auth/user-not-found') {
						// משתמש לא קיים, צור חדש
						const userCredential = await auth.createUserWithEmailAndPassword(userEmail, password);
						return userCredential.user;
					} else if (error.code === 'auth/wrong-password') {
						// סיסמה שגויה - זה בסדר, המשתמש קיים
						return { uid: username }; // החזר uid זמני
					} else {
						throw error;
					}
				}
			} catch (error) {
				console.error('Error with auth user:', error);
				// לא לזרוק שגיאה - לאפשר למערכת לעבוד גם בלי Auth
				return null;
			}
		}
		
		// === Pull to Refresh ===
		let touchStartY = 0;
		let pullDistance = 0;

		function initPullToRefresh() {
			if (!isMobile) return;
			
			document.addEventListener('touchstart', (e) => {
				touchStartY = e.touches[0].clientY;
			}, { passive: true });
			
			document.addEventListener('touchmove', (e) => {
				if (window.scrollY === 0 && e.touches[0].clientY > touchStartY) {
					pullDistance = e.touches[0].clientY - touchStartY;
					
					if (pullDistance > 50) {
						document.getElementById('pullToRefresh').classList.add('show');
						
						if (pullDistance > 100) {
							document.getElementById('pullToRefresh').classList.add('refreshing');
						}
					}
				}
			}, { passive: true });
			
			document.addEventListener('touchend', async (e) => {
				if (pullDistance > 100) {
					await refreshData();
				}
				
				document.getElementById('pullToRefresh').classList.remove('show', 'refreshing');
				pullDistance = 0;
			}, { passive: true });
		}
		function addSwipeToCloseModals() {
			if (!isMobile) return;
			
			const modals = document.querySelectorAll('.modal-content');
			
			modals.forEach(modal => {
				let startY = 0;
				let currentY = 0;
				let startTime = 0;
				let isDragging = false;
				let modalElement = modal.closest('.modal');
				
				// הוסף אינדיקטור ויזואלי לגרירה
				const swipeIndicator = document.createElement('div');
				swipeIndicator.style.cssText = `
					position: absolute;
					top: 10px;
					left: 50%;
					transform: translateX(-50%);
					width: 40px;
					height: 4px;
					background: #ccc;
					border-radius: 2px;
					opacity: 0.5;
				`;
				modal.insertBefore(swipeIndicator, modal.firstChild);
				
				modal.addEventListener('touchstart', (e) => {
					// בדוק אם נגענו בחלק העליון של המודאל
					const rect = modal.getBoundingClientRect();
					const touchY = e.touches[0].clientY;
					
					// התחל גרירה רק אם נגענו ב-50 פיקסלים העליונים
					if (touchY - rect.top < 50) {
						startY = e.touches[0].clientY;
						startTime = Date.now();
						isDragging = true;
						modal.style.transition = 'none';
					}
				}, { passive: true });
				
				modal.addEventListener('touchmove', (e) => {
					if (!isDragging) return;
					
					currentY = e.touches[0].clientY;
					const deltaY = currentY - startY;
					
					// אפשר גרירה רק למטה
					if (deltaY > 0) {
						// בדוק אם המודאל בחלק העליון שלו
						if (modal.scrollTop === 0) {
							// החל טרנספורמציה רק אם גוררים למטה
							modal.style.transform = `translateY(${Math.min(deltaY, 300)}px)`;
							modal.style.opacity = Math.max(0.3, 1 - (deltaY / 300));
							
							// מנע גלילה של הדף מאחורי המודאל
							if (deltaY > 20) {
								document.body.style.overflow = 'hidden';
							}
						} else {
							// אם יש גלילה במודאל, בטל את הגרירה
							isDragging = false;
							modal.style.transform = '';
							modal.style.opacity = '';
						}
					}
				}, { passive: true });
				
				modal.addEventListener('touchend', (e) => {
					if (!isDragging) return;
					
					const deltaY = currentY - startY;
					const deltaTime = Date.now() - startTime;
					const velocity = deltaY / deltaTime;
					
					// אפשר טרנזישן חזרה
					modal.style.transition = 'all 0.3s ease';
					
					// סגור אם גררו מספיק או במהירות גבוהה
					if (deltaY > 100 || velocity > 0.5) {
						modal.style.transform = 'translateY(100%)';
						modal.style.opacity = '0';
						
						setTimeout(() => {
							if (modalElement) {
								modalElement.style.display = 'none';
								// איפוס הסגנונות
								modal.style.transform = '';
								modal.style.opacity = '';
								modal.style.transition = '';
							}
						}, 300);
					} else {
						// החזר למקום
						modal.style.transform = '';
						modal.style.opacity = '';
					}
					
					// החזר את הגלילה
					document.body.style.overflow = '';
					isDragging = false;
					startY = 0;
					currentY = 0;
				}, { passive: true });
				
				// בטל גרירה אם יצאנו מהאזור
				modal.addEventListener('touchcancel', () => {
					if (isDragging) {
						modal.style.transition = 'all 0.3s ease';
						modal.style.transform = '';
						modal.style.opacity = '';
						document.body.style.overflow = '';
						isDragging = false;
					}
				}, { passive: true });
			});
		}
		// פונקציה משופרת לטיפול בגלילה במודאלים
		function improveModalScrolling() {
			if (!isMobile) return;
			
			const modals = document.querySelectorAll('.modal');
			
			modals.forEach(modal => {
				// מנע גלילה של הרקע כשהמודאל פתוח
				const observer = new MutationObserver((mutations) => {
					mutations.forEach(mutation => {
						if (mutation.attributeName === 'style') {
							const isVisible = modal.style.display !== 'none';
							if (isVisible) {
								// שמור את מיקום הגלילה
								const scrollY = window.scrollY;
								document.body.dataset.scrollY = scrollY;
								document.body.style.position = 'fixed';
								document.body.style.top = `-${scrollY}px`;
								document.body.style.width = '100%';
							} else {
								// החזר את הגלילה
								const scrollY = parseInt(document.body.dataset.scrollY || '0');
								document.body.style.position = '';
								document.body.style.top = '';
								document.body.style.width = '';
								window.scrollTo(0, scrollY);
							}
						}
					});
				});
				
				observer.observe(modal, { attributes: true });
			});
		}
		document.addEventListener('DOMContentLoaded', () => {
			addSwipeToCloseModals();
			
			// הוסף מחוון טעינה למובייל
			if (isMobile) {
				const loadingIndicator = document.createElement('div');
				loadingIndicator.id = 'mobileLoadingBar';
				loadingIndicator.style.cssText = `
					position: fixed;
					top: 0;
					left: 0;
					width: 100%;
					height: 3px;
					background: linear-gradient(90deg, #3498db 0%, #2980b9 50%, #3498db 100%);
					background-size: 200% 100%;
					animation: loading 1.5s linear infinite;
					display: none;
					z-index: 9999;
				`;
				document.body.appendChild(loadingIndicator);
				
				// הוסף CSS לאנימציה
				const style = document.createElement('style');
				style.textContent = `
					@keyframes loading {
						0% { background-position: 200% 0; }
						100% { background-position: -200% 0; }
					}
				`;
				document.head.appendChild(style);
				
				// עדכן את showLoading
				const originalShowLoading = window.showLoading;
				window.showLoading = function(show) {
					originalShowLoading(show);
					if (isMobile) {
						loadingIndicator.style.display = show ? 'block' : 'none';
					}
				};
			}
		});

		// שיפור ביצועים במובייל - טעינה עצלה של תמונות ותוכן כבד
		function optimizePerformance() {
			if (!isMobile) return;
			
			// דחה טעינת תוכן לא קריטי
			const deferredElements = document.querySelectorAll('[data-defer]');
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						// טען את התוכן
						const element = entry.target;
						element.classList.remove('deferred');
						observer.unobserve(element);
					}
				});
			});
			
			deferredElements.forEach(el => observer.observe(el));
		}

		const swipeStyles = document.createElement('style');
		swipeStyles.textContent = `
			/* אנימציה לאינדיקטור */
			.modal-content {
				position: relative;
			}
			
			/* מנע בחירת טקסט בזמן גרירה */
			.modal-content.dragging {
				user-select: none;
				-webkit-user-select: none;
			}
			
			/* שיפור ביצועים */
			.modal-content {
				will-change: transform, opacity;
			}
			
			/* אינדיקטור ויזואלי למובייל */
			@media (max-width: 768px) {
				.modal-content::before {
					content: '';
					position: absolute;
					top: 10px;
					left: 50%;
					transform: translateX(-50%);
					width: 40px;
					height: 4px;
					background: #ccc;
					border-radius: 2px;
					opacity: 0.5;
					z-index: 1;
				}
			}
		`;
		document.head.appendChild(swipeStyles);

		// הפעל בטעינת הדף
		document.addEventListener('DOMContentLoaded', () => {
			addSwipeToCloseModals();
			improveModalScrolling();
		});

		// תיקון נוסף: וודא שאירועי touch לא מתנגשים עם גלילה רגילה
		document.addEventListener('DOMContentLoaded', () => {
			// הוסף passive: true לכל מאזיני ה-touch שלא צריכים preventDefault
			const touchElements = document.querySelectorAll('.table-wrapper, .tab-content, .container');
			
			touchElements.forEach(element => {
				element.addEventListener('touchstart', () => {}, { passive: true });
				element.addEventListener('touchmove', () => {}, { passive: true });
				element.addEventListener('touchend', () => {}, { passive: true });
			});
		});


		async function refreshData() {
			showToast('מרענן נתונים...', 'info');
			await loadAllData();
			updateStats();
			
			// רענן את התצוגה הנוכחית
			const activeTab = document.querySelector('.tab-content.active');
			if (activeTab) {
				const tabId = activeTab.id;
				if (tabId === 'inventory') displayInventory();
				else if (tabId === 'movements') displayMovements();
				else if (tabId === 'users') displayUsers();
				else if (tabId === 'pickings') displayPickings();
			}
			
			showToast('הנתונים רועננו!', 'success');
		}

		/*
		auth.onAuthStateChanged((firebaseUser) => {
			if (firebaseUser) {
				console.log('User authenticated:', firebaseUser.email);
			} else {
				console.log('User not authenticated');
				const savedUser = localStorage.getItem('currentUser');
				if (savedUser && window.location.pathname !== '/pick.html') {
					// logout();
				}
			}
		});
		*/

		// פונקציה לבדיקת הרשאות בזמן אמת
		async function checkRealtimePermissions() {
			if (!currentUser) return false;
			
			try {
				const userDoc = await db.collection('users').doc(currentUser.username).get();
				if (userDoc.exists) {
					const userData = userDoc.data();
					currentUser.permissions = userData.permissions || [];
					currentUser.role = userData.role;
					localStorage.setItem('currentUser', JSON.stringify(currentUser));
					updateTabsVisibility();
					return true;
				}
			} catch (error) {
				console.error('Error checking permissions:', error);
			}
			return false;
		}

        // --- משתנים גלובליים ---
        let users = [];
        let inventory = [];
        let movements = [];
        let currentUser = null;
        let baseUnitsSingularList = ['יחידה', 'פחית', 'בקבוק', 'כוס', 'כיס', 'גרם'];
        let baseUnitsPluralList = ['יחידות', 'פחיות', 'בקבוקים', 'כוסות', 'כיסים', 'גרם'];
        let packUnitsSingularList = ['קרטון', 'מארז', 'שקית', 'קופסה', 'ליטר'];
        let packUnitsPluralList = ['קרטונים', 'מארזים', 'שקיות', 'קופסאות', 'ליטרים'];
		let statsAnimated = false;
		
		function showToast(message, type = 'info') {
			const toast = document.getElementById('toast');
			if (!toast) {
				console.log(message);
				return;
			}
			
			toast.textContent = message;
			toast.className = 'toast show';
			
			if (type === 'error') toast.style.background = '#e74c3c';
			else if (type === 'success') toast.style.background = '#27ae60';
			else toast.style.background = '#333';
			
			setTimeout(() => {
				toast.classList.remove('show');
			}, 3000);
		}
        
        // טעינת נתונים מ-localStorage אם קיימים
        const savedBaseUnitsSingular = JSON.parse(localStorage.getItem('baseUnitsSingularList') || '[]');
        const savedBaseUnitsPlural = JSON.parse(localStorage.getItem('baseUnitsPluralList') || '[]');
        const savedPackUnitsSingular = JSON.parse(localStorage.getItem('packUnitsSingularList') || '[]');
        const savedPackUnitsPlural = JSON.parse(localStorage.getItem('packUnitsPluralList') || '[]');
        
        if (savedBaseUnitsSingular.length > 0) baseUnitsSingularList = savedBaseUnitsSingular;
        if (savedBaseUnitsPlural.length > 0) baseUnitsPluralList = savedBaseUnitsPlural;
        if (savedPackUnitsSingular.length > 0) packUnitsSingularList = savedPackUnitsSingular;
        if (savedPackUnitsPlural.length > 0) packUnitsPluralList = savedPackUnitsPlural;

        // מיון ומסנון המלאי
        let inventorySearch = '';
        let categoryFilter = '';
        let inventorySort = { by: '', dir: 1 };

        // --- פונקציות Firebase ---
        async function loadAllData() {
            showLoading(true, 'stats');
            try {
                // טען משתמשים
                users = [];
                const usersSnap = await db.collection('users').get();
                usersSnap.forEach(doc => users.push(doc.data()));
                
                if (users.length === 0) {
                    // יצירת משתמשים ברירת מחדל
                    const defaultUsers = [
                        {
                            username: 'admin',
                            password: '1234',
                            fullName: 'מנהל המערכת',
                            role: 'מנהל מערכת',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'manage_users', 'view_reports', 'view_pickings']
                        },
                        {
                            username: 'warehouse',
                            password: '1234',
                            fullName: 'יוסי כהן',
                            role: 'מחסנאי',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'view_reports']
                        },
                        {
                            username: 'staff',
                            password: '1234',
                            fullName: 'דני לוי',
                            role: 'צוות',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction']
                        }
                    ];
                    
                    for (const user of defaultUsers) {
                        await db.collection('users').doc(user.username).set(user);
                        users.push(user);
                    }
                }
                
                // טען מלאי
                inventory = [];
                const invSnap = await db.collection('inventory').get();
                invSnap.forEach(doc => inventory.push(doc.data()));
                
                // טען תנועות
                movements = [];
                const movSnap = await db.collection('movements').orderBy('date', 'desc').limit(200).get();
                movSnap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    movements.push(data);
                });
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('שגיאה בטעינת הנתונים: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
				// משתנה גלובלי לשמירת ה-interval
		let autoRefreshInterval = null;

		// פונקציה לרענון אוטומטי
		async function startAutoRefresh() {
			// עצור רענון קודם אם קיים
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}
			
			// הגדר רענון כל 45 שניות
			autoRefreshInterval = setInterval(async () => {
				try {
					console.log('רענון אוטומטי של הנתונים...');
					await loadAllData();
					updateStats();
					
					// רענן את התצוגה הנוכחית
					const activeTab = document.querySelector('.tab-content.active');
					if (activeTab) {
						const tabId = activeTab.id;
						if (tabId === 'inventory') displayInventory();
						else if (tabId === 'movements') displayMovements();
						else if (tabId === 'users') displayUsers();
						else if (tabId === 'pickings') displayPickings();
					}
				} catch (error) {
					console.error('שגיאה ברענון אוטומטי:', error);
				}
			}, 30000); // 45 שניות
		}

		// פונקציה לעצירת הרענון האוטומטי
		function stopAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
				autoRefreshInterval = null;
			}
		}
		
        async function loadMovementsOnly() {
            try {
                movements = [];
                const movSnap = await db.collection('movements').orderBy('date', 'desc').limit(200).get();
                movSnap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    movements.push(data);
                });
            } catch (error) {
                console.error('Error loading movements:', error);
                showToast('שגיאה בטעינת התנועות: ' + error.message, 'error');
            }
        }

        async function createPickingList(planList) {
            try {
                const now = new Date();
                const docRef = await db.collection('pickingLists').add({
                    date: getFormattedDate(),
                    time: getFormattedTime(),
                    createdBy: currentUser.fullName,
                    status: 'open',
                    plan: planList.map(p => ({
                        productName: p.productName,
                        takePacks: p.takePacks,
                        takeUnits: p.takeUnits,
                        location: p.location,
                        expiry: p.expiry
                    }))
                });
                return docRef.id;
            } catch (error) {
                console.error('Error creating picking list:', error);
                showToast('שגיאה ביצירת רשימת ליקוט: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveUser(user) {
			try {
				await db.collection('users').doc(user.username).set(user);
				// if (user.password && auth) {
				//     await createOrUpdateAuthUser(user.username, user.password);
				// }
				
			} catch (error) {
				console.error('Error saving user:', error);
				showToast('שגיאה בשמירת המשתמש: ' + error.message, 'error');
				throw error;
			}
		}

        async function deleteUserFromDB(username) {
            try {
                await db.collection('users').doc(username).delete();
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('שגיאה במחיקת המשתמש: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveInventoryItem(item) {
            try {
                await db.collection('inventory').doc(item.name).set(item);
            } catch (error) {
                console.error('Error saving inventory item:', error);
                showToast('שגיאה בשמירת הפריט: ' + error.message, 'error');
                throw error;
            }
        }

        async function deleteInventoryItem(name) {
            try {
                await db.collection('inventory').doc(name).delete();
            } catch (error) {
                console.error('Error deleting inventory item:', error);
                showToast('שגיאה במחיקת הפריט: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveMovement(movement) {
            try {
                await db.collection('movements').add(movement);
            } catch (error) {
                console.error('Error saving movement:', error);
                showToast('שגיאה בשמירת התנועה: ' + error.message, 'error');
                throw error;
            }
        }

        // --- פונקציות עזר ---
        function showLoading(show, type = 'general') {
			const loading = document.getElementById('loadingSpinner');
			if (!loading) return;
			
			if (show) {
				// צור skeleton loader בהתאם לסוג התוכן
				let skeletonHTML = '';
				
				switch(type) {
					case 'inventory':
						skeletonHTML = createInventorySkeletonHTML();
						break;
					case 'stats':
						skeletonHTML = createStatsSkeletonHTML();
						break;
					case 'movements':
						skeletonHTML = createMovementsSkeletonHTML();
						break;
					default:
						skeletonHTML = '<div class="skeleton-loader" style="height: 200px; width: 100%;"></div>';
				}
				
				loading.innerHTML = skeletonHTML;
				loading.style.display = 'block';
			} else {
				// הוסף fade out animation
				loading.style.opacity = '0';
				setTimeout(() => {
					loading.style.display = 'none';
					loading.style.opacity = '1';
					loading.innerHTML = '';
				}, 300);
			}
		}

		// פונקציות עזר ליצירת Skeleton HTML
		function createInventorySkeletonHTML() {
			let html = '<div class="skeleton-table">';
			for (let i = 0; i < 5; i++) {
				html += `
					<div class="skeleton-row">
						<div class="skeleton-loader skeleton-cell small"></div>
						<div class="skeleton-loader skeleton-cell large"></div>
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell small"></div>
					</div>
				`;
			}
			html += '</div>';
			return html;
		}

		function createStatsSkeletonHTML() {
			let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
			for (let i = 0; i < 4; i++) {
				html += `
					<div class="skeleton-stat-card">
						<div class="skeleton-loader skeleton-stat-label"></div>
						<div class="skeleton-loader skeleton-stat-value"></div>
					</div>
				`;
			}
			html += '</div>';
			return html;
		}

		function createMovementsSkeletonHTML() {
			let html = '<div class="skeleton-table">';
			for (let i = 0; i < 8; i++) {
				html += `
					<div class="skeleton-row">
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell small"></div>
						<div class="skeleton-loader skeleton-cell large"></div>
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell"></div>
					</div>
				`;
			}
			html += '</div>';
			return html;
		}

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (error) {
                return dateStr;
            }
        }

        function getUnitLabel(count, singular, plural) {
            if (typeof count === "undefined") return plural || '';
            return (count === 1) ? (singular || '') : (plural || '');
        }

        function totalPacksAndUnits(item) {
            let totalPacks = 0, looseUnits = 0;
            (item.variants || []).forEach(variant => {
                const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                if (daysToExpiry === null || daysToExpiry > 0) {
                    totalPacks += variant.quantityPacks || 0;
                    looseUnits += variant.quantityUnits || 0;
                }
            });
            totalPacks += Math.floor(looseUnits / (item.unitsPerPack || 1));
            looseUnits = looseUnits % (item.unitsPerPack || 1);
            return [totalPacks, looseUnits];
        }

        function getEarliestExpiry(item) {
            let earliest = null;
            (item.variants || []).forEach(variant => {
                if (variant.expiry && (!earliest || new Date(variant.expiry) < earliest)) {
                    earliest = new Date(variant.expiry);
                }
            });
            return earliest ? earliest.toISOString() : null;
        }

        function getGlobalStatus(totalPacks, minPacks, earliestExpiry) {
            if (totalPacks < minPacks) return '🔴 מתחת למינימום';
            if (earliestExpiry) {
                const days = Math.floor((new Date(earliestExpiry) - new Date()) / (1000 * 60 * 60 * 24));
                if (days <= 7) return '🔴 תפוגה קרובה';
                if (days <= 14) return '🟠 תפוגה באופק';
            }
            return '🟢 תקין';
        }

        function updateStats() {
			try {
				// הוסף אנימציה לכרטיסי הסטטיסטיקות
				const statCards = document.querySelectorAll('.stat-card');
				statCards.forEach((card, index) => {
					card.classList.remove('stats-enter');
					void card.offsetWidth; // Force reflow
					card.classList.add('stats-enter');
				});
				
				// סה"כ מוצרים
				const totalProductsCount = inventory.length;
				
				// ספירת מוצרים במלאי נמוך ותפוגות קרובות
				let lowStockCount = 0;
				let expiringCount = 0;
				const today = new Date();
				today.setHours(0, 0, 0, 0);
				
				inventory.forEach(item => {
					const [totalPacks, totalUnits] = totalPacksAndUnits(item);
					
					if (totalPacks < (item.minPacks || 0)) {
						lowStockCount++;
					}
					
					let hasExpiring = false;
					for (const variant of (item.variants || [])) {
						if (variant.expiry) {
							const expiryDate = new Date(variant.expiry);
							expiryDate.setHours(0, 0, 0, 0);
							const daysToExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
							
							if (daysToExpiry >= 0 && daysToExpiry <= 14) {
								if ((variant.quantityPacks || 0) > 0 || (variant.quantityUnits || 0) > 0) {
									expiringCount++;
									hasExpiring = true;
									break;
								}
							}
						}
					}
				});
				
				// ספירת תנועות היום
				const todayStr = getFormattedDate();
				let todayMovements = 0;
				
				movements.forEach(m => {
					if (m.date === todayStr) {
						todayMovements++;
					}
				});
				
				// עדכן את הערכים עם אנימציה רק אם זו הפעם הראשונה או אם הערכים השתנו
				if (!statsAnimated) {
					// פעם ראשונה - אנימציה מ-0
					animateValue('totalProducts', 0, totalProductsCount, 500);
					animateValue('lowStockCount', 0, lowStockCount, 600);
					animateValue('expiringCount', 0, expiringCount, 700);
					animateValue('todayMovements', 0, todayMovements, 800);
					statsAnimated = true;
				} else {
					// עדכונים - אנימציה מהערך הנוכחי לערך החדש
					updateValueWithAnimation('totalProducts', totalProductsCount, 300);
					updateValueWithAnimation('lowStockCount', lowStockCount, 300);
					updateValueWithAnimation('expiringCount', expiringCount, 300);
					updateValueWithAnimation('todayMovements', todayMovements, 300);
				}
				
				// הוסף עדכון של תצוגת התראות
				updateAlerts();
				
			} catch (error) {
				console.error('Error updating stats:', error);
				document.getElementById('totalProducts').textContent = '0';
				document.getElementById('lowStockCount').textContent = '0';
				document.getElementById('expiringCount').textContent = '0';
				document.getElementById('todayMovements').textContent = '0';
			}
		}

		// פונקציה חדשה לעדכון ערך עם אנימציה מהערך הנוכחי
		function updateValueWithAnimation(elementId, newValue, duration) {
			const element = document.getElementById(elementId);
			if (!element) return;
			
			const currentValue = parseInt(element.textContent) || 0;
			
			// אם אין שינוי, אל תעשה כלום
			if (currentValue === newValue) {
				return;
			}
			
			const range = newValue - currentValue;
			const startTime = performance.now();
			
			function updateValue(currentTime) {
				const elapsed = currentTime - startTime;
				const progress = Math.min(elapsed / duration, 1);
				
				// Easing function
				const easeOutQuart = 1 - Math.pow(1 - progress, 4);
				
				const value = Math.floor(currentValue + (range * easeOutQuart));
				element.textContent = value;
				
				if (progress < 1) {
					requestAnimationFrame(updateValue);
				} else {
					element.textContent = newValue;
				}
			}
			
		}
		
		function animateValue(elementId, start, end, duration) {
			const element = document.getElementById(elementId);
			if (!element) return;
			
			// אם אין הבדל, פשוט הצג את הערך
			if (start === end) {
				element.textContent = end;
				return;
			}
			
			element.classList.add('counter-animate');
			
			const range = end - start;
			const startTime = performance.now();
			
			function updateValue(currentTime) {
				const elapsed = currentTime - startTime;
				const progress = Math.min(elapsed / duration, 1);
				
				// Easing function
				const easeOutQuart = 1 - Math.pow(1 - progress, 4);
				
				const currentValue = Math.floor(start + (range * easeOutQuart));
				element.textContent = currentValue;
				
				if (progress < 1) {
					requestAnimationFrame(updateValue);
				} else {
					element.textContent = end;
				}
			}
			
			requestAnimationFrame(updateValue);
		}

		// פונקציה חדשה להצגת התראות
		function updateAlerts() {
			const alertsContainer = document.getElementById('alerts');
			if (!alertsContainer) return;
			
			// בדוק אם למשתמש יש הרשאה לראות התראות
			if (!currentUser || (currentUser.role !== 'מנהל מערכת' && currentUser.role !== 'מנהל מתחם')) {
				alertsContainer.innerHTML = '';
				alertsContainer.style.display = 'none';
				return;
			}
			
			// הצג את מיכל ההתראות
			alertsContainer.style.display = 'block';
			alertsContainer.innerHTML = '';
			const alerts = [];
			
			// בדוק מוצרים במלאי נמוך
			inventory.forEach(item => {
				const [totalPacks, totalUnits] = totalPacksAndUnits(item);
				
				if (totalPacks < (item.minPacks || 0)) {
					const shortage = (item.minPacks || 0) - totalPacks;
					alerts.push({
						type: 'danger',
						text: `${item.name}: מתחת למינימום! חסר ${shortage} ${getUnitLabel(shortage, item.packUnitSingular, item.packUnitPlural)}`
					});
				}
			});
			
			// בדוק תפוגות קרובות
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			inventory.forEach(item => {
				(item.variants || []).forEach(variant => {
					if (!variant.expiry) return;
					if ((variant.quantityPacks || 0) === 0 && (variant.quantityUnits || 0) === 0) return;
					
					const expiryDate = new Date(variant.expiry);
					expiryDate.setHours(0, 0, 0, 0);
					const daysToExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
					
					if (daysToExpiry < 0) {
						alerts.push({
							type: 'danger',
							text: `${item.name} ב${variant.location}: פג תוקף לפני ${Math.abs(daysToExpiry)} ימים!`
						});
					} else if (daysToExpiry === 0) {
						alerts.push({
							type: 'danger',
							text: `${item.name} ב${variant.location}: פג תוקף היום!`
						});
					} else if (daysToExpiry <= 7) {
						alerts.push({
							type: 'warning',
							text: `${item.name} ב${variant.location}: יפוג בעוד ${daysToExpiry} ימים`
						});
					}
				});
			});
			
			// מיון התראות - קריטיות קודם
			alerts.sort((a, b) => {
				if (a.type === 'danger' && b.type !== 'danger') return -1;
				if (a.type !== 'danger' && b.type === 'danger') return 1;
				return 0;
			});
			
			if (alerts.length === 0) return;
			
			// צור מיכל עם כותרת וכפתור
			const alertsWrapper = document.createElement('div');
			alertsWrapper.className = 'alerts-wrapper';
			
			// כותרת עם כפתור הרחבה
			const alertsHeader = document.createElement('div');
			alertsHeader.className = 'alerts-header';
			
			// ספירת סוגי התראות
			const dangerCount = alerts.filter(a => a.type === 'danger').length;
			const warningCount = alerts.filter(a => a.type === 'warning').length;
			
			alertsHeader.innerHTML = `
				<span class="alerts-title">
					<strong>⚠️ התראות (${alerts.length})</strong>
					<span class="alerts-summary">
						${dangerCount > 0 ? `<span class="badge badge-danger">${dangerCount} קריטיות</span>` : ''}
						${warningCount > 0 ? `<span class="badge badge-warning">${warningCount} אזהרות</span>` : ''}
					</span>
				</span>
				<button class="alerts-toggle-btn" onclick="toggleAlerts()" id="alertsToggleBtn">
					<span class="toggle-icon">▼</span> הצג התראות
				</button>
			`;
			
			// מיכל להתראות - מוסתר כברירת מחדל
			const alertsList = document.createElement('div');
			alertsList.className = 'alerts-list';
			alertsList.id = 'alertsList';
			alertsList.style.display = 'none';
			
			// הוסף את כל ההתראות למיכל המוסתר
			alerts.forEach(alert => {
				const alertDiv = document.createElement('div');
				alertDiv.className = `alert alert-${alert.type}`;
				alertDiv.innerHTML = `<strong>⚠️</strong> ${alert.text}`;
				alertsList.appendChild(alertDiv);
			});
			
			alertsWrapper.appendChild(alertsHeader);
			alertsWrapper.appendChild(alertsList);
			alertsContainer.appendChild(alertsWrapper);
			
			// שחזר מצב הרחבה מ-localStorage
			const wasExpanded = localStorage.getItem('alertsExpanded') === 'true';
			if (wasExpanded) {
				toggleAlerts(); // פתח אוטומטית אם היה פתוח קודם
			}
		}	
		// פונקציה להרחבה/כיווץ התראות
		function toggleAlerts() {
			const alertsList = document.getElementById('alertsList');
			const toggleBtn = document.getElementById('alertsToggleBtn');
			
			if (!alertsList || !toggleBtn) return;
			
			const isExpanded = alertsList.style.display !== 'none';
			
			if (isExpanded) {
				// כווץ
				alertsList.style.display = 'none';
				toggleBtn.innerHTML = '<span class="toggle-icon">▼</span> הצג התראות';
				localStorage.setItem('alertsExpanded', 'false');
			} else {
				// הרחב
				alertsList.style.display = 'block';
				toggleBtn.innerHTML = '<span class="toggle-icon">▲</span> הסתר התראות';
				localStorage.setItem('alertsExpanded', 'true');
			}
		}
        // --- LOGIN & BOOT ---
        // החלף את כל ה-event listener של loginForm בקוד הבא:
		document.getElementById('loginForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const username = document.getElementById('username').value;
			const password = document.getElementById('password').value;
			
			try {
				showLoading(true);
				await loadAllData();
				updateStats();
				
				const user = users.find(u => u.username === username && u.password === password);
				if (user) {
					currentUser = user;
					localStorage.setItem('currentUser', JSON.stringify(user));
					
					// נסה להתחבר ל-Firebase Auth (אופציונלי)
					try {
						const userEmail = `${username}@cinema-city-hadera.local`;
						await auth.signInWithEmailAndPassword(userEmail, password);
					} catch (authError) {
						// אם נכשל, נסה ליצור משתמש
						if (authError.code === 'auth/user-not-found') {
							try {
								await auth.createUserWithEmailAndPassword(userEmail, password);
							} catch (createError) {
								console.log('Auth is optional, continuing without it');
							}
						}
						// ממשיכים גם בלי Auth - זה אופציונלי
					}
					
					showMainScreen();
					showToast(`ברוך הבא, ${user.fullName}!`, 'success');
				} else {
					showToast('שם משתמש או סיסמה שגויים', 'error');
				}
			} catch (error) {
				console.error('Login error:', error);
				showToast('שגיאה בהתחברות. נסה שוב.', 'error');
			} finally {
				showLoading(false);
			}
		});

        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = currentUser.role;
            updateTabsVisibility();
			// אתחל תכונות מובייל אם צריך
			if (isMobile) {
				initMobileFeatures();
			}
            // הצגת טאב הראשון המורשה
            const firstAllowedTab = document.querySelector('.tab:not(.disabled)');
            if (firstAllowedTab) {
                const tabName = firstAllowedTab.getAttribute('data-tab');
                showTab(tabName);
            }
        }

        function updateTabsVisibility() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('disabled');
                tab.style.display = 'flex';
                
                const permission = tab.getAttribute('data-permission');
                if (permission && !currentUser.permissions.includes(permission)) {
                    tab.classList.add('disabled');
                    tab.style.display = 'none';
                }
            });
        }

        function logout() {
			// התנתק מ-Firebase Auth - מבוטל זמנית
			// if (auth) {
			//     auth.signOut().catch(error => console.error('Error signing out:', error));
			// }
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.style.display = 'none');
            
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        window.addEventListener('load', async function() {
			if (isMobile) {
				initMobileFeatures();
			}
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    await loadAllData();
                    updateStats();
                    
                    currentUser = JSON.parse(savedUser);
                    if (users.find(u => u.username === currentUser.username)) {
                        showMainScreen();
                    } else {
                        localStorage.removeItem('currentUser');
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
                showToast('שגיאה בטעינת הנתונים', 'error');
            }
        });

        // --- TAB HANDLERS ---
        window.showTab = async function(e, tabName) {
			if (isMobile) {
				window.scrollTo(0, 0);
			}
			
			let tabElement = null;
			
			// טיפול נכון בפרמטרים
			if (typeof e === 'string') {
				tabName = e;
				e = null;
			} else if (e && e.target) {
				e.preventDefault();
				tabElement = e.target;
			} else if (e && !e.target && typeof tabName === 'undefined') {
				tabName = e;
				e = null;
			}
			
			// בדיקת הרשאות
			if (tabElement) {
				const permission = tabElement.getAttribute('data-permission');
				if (permission && !currentUser.permissions.includes(permission)) {
					showToast('אין לך הרשאה לגשת לתפריט זה', 'error');
					return;
				}
			}
			
			// הוסף אנימציה של fade out לתוכן הנוכחי
			const currentActiveContent = document.querySelector('.tab-content.active');
			if (currentActiveContent) {
				currentActiveContent.style.opacity = '0';
				currentActiveContent.style.transform = 'translateX(-20px)';
			}
			
			// הצג אינדיקטור טעינה
			const loadingType = tabName === 'inventory' ? 'inventory' : 
							   tabName === 'movements' ? 'movements' : 
							   'general';
			showLoading(true, loadingType);
			
			try {
				// רענן נתונים מ-Firebase
				await loadAllData();
				updateStats();
				
				// ניקוי טאבים
				document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

				// הפעלת טאב
				if (tabElement) tabElement.classList.add('active');
				else {
					const targetTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
					if (targetTab) targetTab.classList.add('active');
				}

				const tabContent = document.getElementById(tabName);
				if (tabContent) {
					tabContent.classList.add('active');
					// אפס את הסגנונות לאנימציה החדשה
					tabContent.style.opacity = '';
					tabContent.style.transform = '';
				}

				// טעינת תוכן דינמי
				if (tabName === 'inventory') displayInventory();
				else if (tabName === 'movements') displayMovements();
				else if (tabName === 'transaction') {
					const cont = document.getElementById('multiTransactionRows');
					if (cont) {
						cont.innerHTML = '';
						addTransactionRow();
					}
				}
				else if (tabName === 'users') displayUsers();
				else if (tabName === 'addItem') {
					populateUnitsSelect(document.getElementById('baseUnitSingular'), baseUnitsSingularList);
					populateUnitsSelect(document.getElementById('baseUnitPlural'), baseUnitsPluralList);
					populateUnitsSelect(document.getElementById('packUnitSingular'), packUnitsSingularList);
					populateUnitsSelect(document.getElementById('packUnitPlural'), packUnitsPluralList);
				}
				else if (tabName === 'pickings') displayPickings();
				
			} catch (error) {
				console.error('שגיאה בטעינת הטאב:', error);
				showToast('שגיאה בטעינת הנתונים', 'error');
			} finally {
				showLoading(false);
			}
		};

        // --- תצוגת מלאי ---
        function displayInventory() {
			const tbody = document.getElementById('inventoryBody');
			if (!tbody) return;
			
			tbody.classList.add('fade-in');
			tbody.innerHTML = '';

			let filtered = [...inventory];

			// סינון לפי חיפוש
			if (inventorySearch) {
				filtered = filtered.filter(item => 
					item.name.toLowerCase().includes(inventorySearch.toLowerCase())
				);
			}
			
			// סינון לפי קטגוריה
			if (categoryFilter) {
				filtered = filtered.filter(item => item.category === categoryFilter);
			}

			// מיון
			if (inventorySort.by) {
				filtered.sort((a, b) => {
					let av, bv;
					switch (inventorySort.by) {
						case 'name': 
							av = a.name; 
							bv = b.name; 
							break;
						case 'category': 
							av = a.category; 
							bv = b.category; 
							break;
						case 'quantity': {
							const [ap] = totalPacksAndUnits(a);
							const [bp] = totalPacksAndUnits(b);
							av = ap;
							bv = bp;
						} break;
						case 'min': 
							av = a.minPacks || 0; 
							bv = b.minPacks || 0; 
							break;
						case 'expiry': {
							const ae = getEarliestExpiry(a);
							const be = getEarliestExpiry(b);
							av = ae ? new Date(ae) : new Date(3000,1,1);
							bv = be ? new Date(be) : new Date(3000,1,1);
						} break;
						default: 
							av = a.name; 
							bv = b.name;
					}
					
					if (typeof av === "string") {
						return inventorySort.dir * av.localeCompare(bv);
					} else {
						return inventorySort.dir * ((av > bv) - (av < bv));
					}
				});
			}

			// בדוק אם יש תוצאות
			if (filtered.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="8" class="empty-state">
							<div class="empty-state-icon">📦</div>
							<div>לא נמצאו מוצרים${inventorySearch || categoryFilter ? ' התואמים לחיפוש' : ''}</div>
						</td>
					</tr>
				`;
				return;
			}

			// הוסף את השורות עם אנימציה
			filtered.forEach((item, itemIndex) => {  // שינוי: הוספנו itemIndex כפרמטר
				const [totalPacks, looseUnits] = totalPacksAndUnits(item);
				const earliestExpiry = getEarliestExpiry(item);
				
				const row = tbody.insertRow();
				row.classList.add('summary-row', 'table-row-enter');
				row.style.animationDelay = `${itemIndex * 0.02}s`; // שינוי: השתמש ב-itemIndex
				
				row.innerHTML = `
					<td><button class="expand-btn btn-ripple" onclick="toggleVariants(this)">+</button></td>
					<td>${item.name}</td>
					<td>${item.category}</td>
					<td>
						${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
						${looseUnits > 0 ? `+ ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
					</td>
					<td>${item.minPacks || 0} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
					<td>${earliestExpiry ? formatDate(earliestExpiry) : '-'}</td>
					<td>${getGlobalStatus(totalPacks, item.minPacks || 0, earliestExpiry)}</td>
					<td>
						${(currentUser.permissions.includes('add_item') || currentUser.role === 'מנהל מערכת')
						? `${isMobile 
							? `<button class="btn-small btn-ripple" onclick="editProduct('${item.name}')" title="ערוך" style="background: transparent; border: none; font-size: 1.2em; padding: 4px;">✏️</button>
							   <button class="btn-small btn-ripple" onclick="openAddVariantModal('${item.name}')" title="הוסף וריאנט" style="background: transparent; border: none; font-size: 1.2em; padding: 4px;">➕</button>
							   <button class="btn-small btn-ripple" onclick="deleteProductWithAnimation('${item.name}')" title="מחק מוצר" style="background: transparent; border: none; font-size: 1.2em; padding: 4px;">🗑️</button>`
							: `<button class="btn-small btn-edit btn-ripple" onclick="editProduct('${item.name}')">ערוך</button>
							   <button class="btn-small btn-edit btn-ripple" onclick="openAddVariantModal('${item.name}')">➕ הוסף</button>
							   <button class="btn-small btn-danger btn-ripple" onclick="deleteProductWithAnimation('${item.name}')">מחק</button>`
						  }`
						: ''}
					</td>
				`;

				// הוספת שורות וריאנטים
				let variantRowIndex = 0;
				(item.variants || []).forEach((variant, index) => {
					const variantRow = tbody.insertRow();
					variantRow.classList.add('variant-row');
					variantRow.style.display = 'none';

					const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
					
					let expiryStatus = '-';
					if (daysToExpiry !== null && daysToExpiry >= 0) {
						if (daysToExpiry <= 7) expiryStatus = '🔴';
						else if (daysToExpiry <= 14) expiryStatus = '🟠';
						else if (daysToExpiry <= 30) expiryStatus = '🟡';
						else expiryStatus = '🟢';
					}

					// חשב אינדקס יחסי לווריאנטים עם אותו location ו-expiry
					let relativeIndex = 0;
					for (let i = 0; i < index; i++) {
						if (item.variants[i].location === variant.location && 
							(item.variants[i].expiry || '') === (variant.expiry || '')) {
							relativeIndex++;
						}
					}

					variantRow.innerHTML = `
						<td></td>
						<td ${!isMobile ? 'colspan="2"' : ''} style="padding-right: 20px;">${variant.location}</td>
						${isMobile ? '<td></td>' : ''}
						<td>
							${variant.quantityPacks || 0} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
							${variant.quantityUnits > 0 ? `+ ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
						</td>
						<td>-</td>
						<td>${formatDate(variant.expiry) || '-'}</td>
						<td>${expiryStatus}</td>
						<td>
							${(currentUser.permissions.includes('add_item') || currentUser.role === 'מנהל מערכת') 
								? `${isMobile 
									? `<button class="btn-small" onclick="editVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})" title="ערוך" style="background: transparent; border: none; font-size: 1.1em; padding: 4px;">✏️</button>
									   <button class="btn-small" onclick="deleteVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})" title="מחק" style="background: transparent; border: none; font-size: 1.1em; padding: 4px;">🗑️</button>`
									: `<button class="btn-small btn-edit" onclick="editVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})">ערוך</button>
									   <button class="btn-small btn-danger" onclick="deleteVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})">מחק</button>`
								  }`
								: ''}
						</td>
					`;
					variantRowIndex++;
				});
			});
		}
		
		window.deleteProductWithAnimation = async function(productName) {
			if (!confirm(`האם אתה בטוח שברצונך למחוק את המוצר "${productName}"?`)) {
				return;
			}
			
			// מצא את השורה
			const rows = document.querySelectorAll('#inventoryBody tr');
			let targetRow = null;
			let variantRows = [];
			
			rows.forEach(row => {
				if (row.cells[1] && row.cells[1].textContent === productName) {
					targetRow = row;
				} else if (targetRow && row.classList.contains('variant-row')) {
					variantRows.push(row);
				} else if (targetRow && !row.classList.contains('variant-row')) {
					// הגענו למוצר הבא
					return;
				}
			});
			
			// הוסף אנימציית מחיקה
			if (targetRow) {
				targetRow.classList.add('row-delete');
				variantRows.forEach(row => row.classList.add('row-delete'));
				
				// חכה לסיום האנימציה
				await new Promise(resolve => setTimeout(resolve, 300));
			}
			
			// המשך עם המחיקה הרגילה
			await deleteProduct(productName);
		};

        function toggleVariants(button) {
			const row = button.closest('tr');
			let nextRow = row.nextElementSibling;
			const isOpen = button.textContent === '-';
			
			// אנימציית סיבוב לכפתור
			button.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
			button.style.transition = 'transform 0.3s ease';
			button.textContent = isOpen ? '+' : '-';

			// אנימציה לשורות הווריאנטים
			let delay = 0;
			while (nextRow && nextRow.classList.contains('variant-row')) {
				if (isOpen) {
					nextRow.style.display = 'none';
					nextRow.classList.add('collapsed');
				} else {
					nextRow.style.display = '';
					nextRow.classList.remove('collapsed');
					nextRow.classList.add('table-row-enter');
					nextRow.style.animationDelay = `${delay * 0.05}s`;
					delay++;
				}
				nextRow = nextRow.nextElementSibling;
			}
		}

        // --- תצוגת תנועות ---
		function displayMovements() {
			const tbody = document.getElementById('movementsBody');
			if (!tbody) return;
			
			tbody.innerHTML = '';
			
			movements.forEach(movement => {
				if (!movement.product || !movement.type) return;
				
				const canEdit = ['מנהל מערכת','מנהל מתחם','מנהל/ת משמרת','מחסנאי'].includes(currentUser.role);
				const row = tbody.insertRow();
				
				// הוסף סימון לתנועות ביטול
				const isCancellation = movement.type && (movement.type.includes('ביטול') || movement.type === 'ביטול הוצאה' || movement.type === 'ביטול הכנסה');
				if (isCancellation) {
					row.style.backgroundColor = '#fff3cd';
					row.style.fontStyle = 'italic';
				}
				
				// הוסף סימון לתנועות ליקוט
				const isPicking = movement.notes && movement.notes.includes('ליקוט');
				if (isPicking) {
					row.style.backgroundColor = '#e8f4fd';
				}
				
				row.innerHTML = `
					<td>${movement.date || ''}</td>
					<td>${movement.time || ''}</td>
					<td>${movement.product}</td>
					<td>${movement.type}${isCancellation ? ' ⚠️' : ''}</td>
					<td>${movement.quantityPacks || 0} חב'${movement.quantityUnits > 0 ? ' + ' + movement.quantityUnits + ' יחידות' : ''}</td>
					<td>${movement.user || ''}</td>
					<td>${movement.notes || ''}</td>
					<td>
						${canEdit && !isCancellation ?
						  `<button class="btn-small btn-edit" onclick="editMovement('${movement.id || ''}')">ערוך</button>
						   <button class="btn-small btn-danger" onclick="deleteMovement('${movement.id || ''}')">מחק</button>`
						  : ''}
					</td>
				`;
			});
		}

        // --- תצוגת משתמשים ---
        function displayUsers() {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            userList.innerHTML = '';
            
            users.forEach(user => {
                const canDelete = user.username !== 'admin';
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-details">
                        <strong>${user.fullName}</strong>
                        <div style="font-size:14px;color:#666;">
                            שם משתמש: ${user.username} | תפקיד: ${user.role}
                        </div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">
                            הרשאות: ${(user.permissions || []).map(p => getPermissionName(p)).join(', ')}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-small btn-edit" onclick="editUser('${user.username}')">ערוך</button>
                        ${canDelete ? `<button class="btn-small btn-danger" onclick="deleteUser('${user.username}')">מחק</button>` : ''}
                    </div>
                `;
                userList.appendChild(userCard);
            });
        }

        function getPermissionName(permission) {
            const names = {
                'view_inventory': 'צפייה במלאי',
                'view_movements': 'צפייה בתנועות',
                'add_transaction': 'רישום תנועות',
                'add_item': 'הוספת פריטים',
                'manage_users': 'ניהול משתמשים',
                'view_reports': 'צפייה בדוחות',
                'view_pickings': 'צפייה בליקוטים'
            };
            return names[permission] || permission;
        }

        // --- תצוגת ליקוטים ---
        async function displayPickings() {
            const container = document.getElementById('pickingsTableContainer');
            if (!container) return;
            
            container.innerHTML = "טוען...";
            
            try {
                const pickingsSnap = await db.collection('pickingLists').orderBy('date', 'desc').get();
                const pickings = [];
                pickingsSnap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    pickings.push(data);
                });
                
                if (pickings.length === 0) {
                    container.innerHTML = "<div>לא קיימות רשימות ליקוט</div>";
                    return;
                }
                
                let html = `
                <table style="width:100%;text-align:right;">
                    <tr>
                        <th>תאריך</th>
                        <th>שעה</th>
                        <th>מי יצר</th>
                        <th>מלקט</th>
                        <th>סטטוס</th>
                        <th>פריטים</th>
                        <th>תוצאה</th>
                        <th>שיתוף</th>
                        <th>פעולות</th>
                    </tr>
                `;
                
                pickings.forEach(p => {
                    const link = `${window.location.origin}/pick.html?id=${p.id}`;
                    html += `
                    <tr>
                        <td>${p.date || ''}</td>
                        <td>${p.time || ''}</td>
                        <td>${p.createdBy || ''}</td>
                        <td>${p.pickedBy || ''}</td>
                        <td>${p.status || 'פתוח'}</td>
                        <td>
                            <ul style="padding-right: 18px;">
                                ${(p.plan || []).map(item =>
                                    `<li>${item.productName} — ${item.takePacks} חב'${item.takeUnits ? ' + ' + item.takeUnits + ' יחידות' : ''} — ${item.location}</li>`
                                ).join('')}
                            </ul>
                        </td>
                        <td>
                            ${(p.results && p.results.length) ? p.results.map((r, i) =>
                                `<div>שורה ${i+1}: ${r.status}</div>`
                            ).join('') : ''}
                        </td>
                        <td>
                            <button onclick="copyToClipboard('${link}')">העתק קישור</button>
                            <br>
                            <a href="${link}" target="_blank" style="font-size:12px;">פתח רשימה</a>
                        </td>
                        <td>
                            <button onclick="openEditPicking('${p.id}')">ערוך</button>
                            <button onclick="deletePicking('${p.id}')">מחק</button>
                        </td>
                    </tr>
                    `;
                });
                
                html += `</table>`;
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading pickings:', error);
                container.innerHTML = "<div>שגיאה בטעינת הליקוטים</div>";
            }
        }

        // --- פונקציות עבודה עם יחידות ---
        function populateUnitsSelect(selectElement, list, selectedValue = "") {
            if (!selectElement) return;
            
            selectElement.innerHTML = "";
            const defaultOpt = document.createElement("option");
            defaultOpt.value = "";
            defaultOpt.textContent = "בחר יחידה";
            defaultOpt.disabled = true;
            defaultOpt.selected = !selectedValue;
            selectElement.appendChild(defaultOpt);

            list.forEach(unit => {
                const option = document.createElement("option");
                option.value = unit;
                option.textContent = unit;
                option.selected = (selectedValue === unit);
                selectElement.appendChild(option);
            });
            
            const addNew = document.createElement("option");
            addNew.value = "__add_new__";
            addNew.textContent = "➕ הוסף יחידה חדשה...";
            selectElement.appendChild(addNew);
        }

        // --- פונקציות מיון וחיפוש ---
        function sortInventory(by) {
            if (inventorySort.by === by) {
                inventorySort.dir *= -1;
            } else {
                inventorySort.by = by;
                inventorySort.dir = 1;
            }
            displayInventory();
        }

        // האזנה לשדות החיפוש והסינון
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('inventorySearch');
            const categorySelect = document.getElementById('categoryFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    inventorySearch = this.value.trim();
                    displayInventory();
                });
            }
            
            if (categorySelect) {
                categorySelect.addEventListener('change', function() {
                    categoryFilter = this.value;
                    displayInventory();
                });
            }
        });

        // --- הוספת שורת תנועה ---
        function addTransactionRow() {
			const container = document.getElementById('multiTransactionRows');
			if (!container) return;

			const row = document.createElement('div');
			row.className = 'form-row';
			
			if (isMobile) {
				row.style.cssText = 'position: relative; padding-top: 15px;';
				row.innerHTML = `
					<button type="button" onclick="this.closest('.form-row').remove()" class="btn-small btn-danger" style="position: absolute; top: -5px; left: 10px; width: auto; padding: 5px 10px; font-size: 0.9rem; z-index: 10;">✕</button>
					<div class="form-group">
						<label>מוצר</label>
						<select class="transProductSelect" required>
							<option value="">בחר מוצר</option>
							${inventory.map(item => 
								`<option value="${item.name}">${item.name} (${item.category})</option>`
							).join('')}
						</select>
					</div>
					<div class="form-group">
						<label>סוג פעולה</label>
						<select class="transTypeSelect" required>
							<option value="">בחר פעולה</option>
							<option value="הוצאה">הוצאה מהמלאי</option>
							<option value="הכנסה">הכנסה למלאי</option>
						</select>
					</div>
					<div class="form-group">
						<label>כמות חבילות</label>
						<input type="number" class="transQuantityPacksInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>כמות יחידות</label>
						<input type="number" class="transQuantityUnitsInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>הערות</label>
						<input type="text" class="transNotesInput" placeholder="הערות">
					</div>
				`;
			} else {
				// דסקטופ - כפתור ההסרה ללא label
				row.innerHTML = `
					<div class="form-group">
						<label>מוצר</label>
						<select class="transProductSelect" required>
							<option value="">בחר מוצר</option>
							${inventory.map(item => 
								`<option value="${item.name}">${item.name} (${item.category})</option>`
							).join('')}
						</select>
					</div>
					<div class="form-group">
						<label>סוג פעולה</label>
						<select class="transTypeSelect" required>
							<option value="">בחר פעולה</option>
							<option value="הוצאה">הוצאה מהמלאי</option>
							<option value="הכנסה">הכנסה למלאי</option>
						</select>
					</div>
					<div class="form-group">
						<label>כמות חבילות</label>
						<input type="number" class="transQuantityPacksInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>כמות יחידות</label>
						<input type="number" class="transQuantityUnitsInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>הערות</label>
						<input type="text" class="transNotesInput" placeholder="הערות">
					</div>
					<div class="form-group">
						<label style="visibility: hidden;">פעולה</label>
						<button type="button" onclick="this.closest('.form-row').remove()" class="btn-small btn-danger">❌ הסר</button>
					</div>
				`;
			}
			
			container.appendChild(row);
		}

        // --- הוספת וריאנט ---
        function addVariant() {
            const container = document.getElementById('variantsContainer');
            if (!container) return;
            
            const variantDiv = document.createElement('div');
            variantDiv.className = 'form-row';
            variantDiv.innerHTML = `
				${isMobile ? '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' : ''}
				<div class="form-group">
					<label>כמות חבילות</label>
					<input type="number" class="variant-quantityPacks" min="0" value="0" required>
				</div>
				<div class="form-group">
					<label>כמות יחידות בודדות</label>
					<input type="number" class="variant-quantityUnits" min="0" value="0" required>
				</div>
				<div class="form-group">
					<label>מיקום</label>
					<select class="variant-location" required>
						<option value="">בחר מחסן</option>
						<option value="מחסן שתיה">מחסן שתיה</option>
						<option value="מחסן אולם 1">מחסן אולם 1</option>
						<option value="מטבח VIP">מטבח VIP</option>
						<option value="מחסן מיכלים">מחסן מיכלים</option>
						<option value="טכני">טכני</option>
						<option value="מחסן גלידות">מחסן גלידות</option>
						<option value="ממד מנקים">ממד מנקים</option>
					</select>
				</div>
				<div class="form-group">
					<label>תאריך תפוגה</label>
					<input type="date" class="variant-expiry">
				</div>
				<div class="form-group">
					<button type="button" onclick="this.closest('.form-row').remove()" class="btn-small btn-danger" style="width: 100%;">הסר פריט</button>
				</div>
				${isMobile ? '</div>' : ''}
			`;
            container.appendChild(variantDiv);
        }

        // --- ליקוט ---
        async function startPickingList() {
			const rows = document.querySelectorAll('#multiTransactionRows .form-row');
			const pickingPlan = [];
			const pickingMap = new Map(); // למניעת כפילויות

			for (const row of rows) {
				const productSelect = row.querySelector('.transProductSelect');
				const quantityUnitsInput = row.querySelector('.transQuantityUnitsInput');
				const quantityPacksInput = row.querySelector('.transQuantityPacksInput');

				if (!productSelect.value) continue;

				const productName = productSelect.value;
				let requiredUnits = parseInt(quantityUnitsInput.value) || 0;
				let requiredPacks = parseInt(quantityPacksInput.value) || 0;

				if (requiredPacks === 0 && requiredUnits === 0) continue;

				const item = inventory.find(x => x.name === productName);
				if (!item) continue;

				// מיין וריאנטים לפי תוקף (FEFO)
				const sortedVariants = (item.variants || [])
					.map((v, idx) => ({...v, originalIndex: idx}))
					.filter(v => (v.quantityPacks || 0) > 0 || (v.quantityUnits || 0) > 0)
					.sort((a, b) => {
						if (!a.expiry && !b.expiry) return 0;
						if (!a.expiry) return 1;
						if (!b.expiry) return -1;
						return new Date(a.expiry) - new Date(b.expiry);
					});

				// תכנון ליקוט משולב
				for (const variant of sortedVariants) {
					if (requiredPacks <= 0 && requiredUnits <= 0) break;
					
					let takePacks = 0;
					let takeUnits = 0;
					
					// קח חבילות
					if (requiredPacks > 0 && (variant.quantityPacks || 0) > 0) {
						takePacks = Math.min(requiredPacks, variant.quantityPacks);
						requiredPacks -= takePacks;
					}
					
					// קח יחידות
					if (requiredUnits > 0 && (variant.quantityUnits || 0) > 0) {
						takeUnits = Math.min(requiredUnits, variant.quantityUnits);
						requiredUnits -= takeUnits;
					}
					
					// אם צריך יחידות ויש רק חבילות, פרוט חבילה
					if (requiredUnits > 0 && takePacks < variant.quantityPacks && item.unitsPerPack > 0) {
						const availablePacksForBreaking = variant.quantityPacks - takePacks;
						const packsToBreak = Math.min(
							Math.ceil(requiredUnits / item.unitsPerPack),
							availablePacksForBreaking
						);
						
						if (packsToBreak > 0) {
							takePacks += packsToBreak;
							const unitsFromPacks = packsToBreak * item.unitsPerPack;
							const actualUnitsNeeded = Math.min(requiredUnits, unitsFromPacks);
							takeUnits += actualUnitsNeeded;
							requiredUnits -= actualUnitsNeeded;
							
							// יחידות שיוחזרו למלאי
							const returnUnits = unitsFromPacks - actualUnitsNeeded;
							if (returnUnits > 0) {
								takeUnits -= returnUnits; // התאם את הרישום
							}
						}
					}
					
					if (takePacks > 0 || takeUnits > 0) {
						// צור מפתח ייחודי לווריאנט
						const key = `${productName}|${variant.location}|${variant.expiry || 'no-expiry'}`;
						
						if (pickingMap.has(key)) {
							// עדכן רשומה קיימת
							const existing = pickingMap.get(key);
							existing.takePacks += takePacks;
							existing.takeUnits += takeUnits;
						} else {
							// צור רשומה חדשה
							pickingMap.set(key, {
								productName,
								takePacks,
								takeUnits,
								location: variant.location,
								expiry: variant.expiry
							});
						}
					}
				}

				// טפל בחוסרים
				if (requiredPacks > 0 || requiredUnits > 0) {
					const key = `${productName}|חסר במלאי|missing`;
					if (pickingMap.has(key)) {
						const existing = pickingMap.get(key);
						existing.takePacks += requiredPacks;
						existing.takeUnits += requiredUnits;
					} else {
						pickingMap.set(key, {
							productName,
							takePacks: requiredPacks,
							takeUnits: requiredUnits,
							location: "חסר במלאי",
							expiry: ""
						});
					}
				}
			}

			// המר את המפה לרשימה
			pickingMap.forEach(item => pickingPlan.push(item));

			if (pickingPlan.length === 0) {
				showToast('לא נבחרו מוצרים לליקוט', 'error');
				return;
			}

			try {
				const pickId = await createPickingList(pickingPlan);
				const link = `${window.location.origin}/pick.html?id=${pickId}`;
				
				// הודעה מפורטת על מה שנוצר
				let summaryText = `נוצרה רשימת ליקוט עם ${pickingPlan.length} פריטים:\n`;
				pickingPlan.forEach(item => {
					summaryText += `• ${item.productName} - `;
					if (item.takePacks > 0) summaryText += `${item.takePacks} חב'`;
					if (item.takePacks > 0 && item.takeUnits > 0) summaryText += ' + ';
					if (item.takeUnits > 0) summaryText += `${item.takeUnits} יחידות`;
					summaryText += ` מ${item.location}\n`;
				});
				
				const shareHtml = `
					<div style="background:#e8f5e8; padding:15px; border-radius:8px; margin:15px 0;">
						<strong>✅ רשימת ליקוט נוצרה בהצלחה!</strong><br>
						<small>מזהה: ${pickId}</small>
					</div>
					<div style="margin:18px 0; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
						<button class="btn-main" onclick="shareWhatsapp('${link}', '${encodeURIComponent(summaryText)}')">📱 שלח ב־WhatsApp</button>
						<button class="btn-main" onclick="shareTelegram('${link}')">✈️ שלח ב־Telegram</button>
						<button class="btn-main" onclick="shareEmail('${link}')">📧 שלח באימייל</button>
						<button class="btn-main" onclick="copyToClipboard('${link}')">📋 העתק קישור</button>
					</div>
					<div style="background:#f0f8ff; padding:10px; border-radius:6px; font-size:14px;">
						<strong>סיכום הליקוט:</strong><br>
						${pickingPlan.map(item => {
							let text = `• ${item.productName} - `;
							if (item.takePacks > 0) text += `${item.takePacks} חב'`;
							if (item.takePacks > 0 && item.takeUnits > 0) text += ' + ';
							if (item.takeUnits > 0) text += `${item.takeUnits} יח'`;
							text += ` מ${item.location}`;
							if (item.location === "חסר במלאי") text = `<span style="color:#e74c3c;">${text}</span>`;
							return text;
						}).join('<br>')}
					</div>
					<div id="shareResultMsg" style="margin-top:10px; text-align:center;"></div>
				`;
				document.getElementById('pickingListContainer').innerHTML = shareHtml;
				
				// איפוס הטופס
				document.getElementById('multiTransactionRows').innerHTML = '';
				addTransactionRow();
				
				showToast('רשימת ליקוט נוצרה ומוכנה לשיתוף!', 'success');
			} catch (error) {
				showToast('שגיאה ביצירת רשימת ליקוט', 'error');
			}
		}

        // --- פונקציות שיתוף ---
        function shareWhatsapp(link, summaryText = '') {
            let text = 'רשימת ליקוט מסינמה סיטי חדרה 🎬🍿\n\n';
            if (summaryText) {
                text += decodeURIComponent(summaryText) + '\n';
            }
            text += '\nקישור לליקוט: ' + link;
            text += '\n\n👆 לחץ על הקישור לפתיחת רשימת הליקוט';
            
            const encodedText = encodeURIComponent(text);
            window.open(`https://wa.me/?text=${encodedText}`, '_blank');
        }

        function shareTelegram(link) {
            const text = encodeURIComponent('רשימת ליקוט מסינמה סיטי חדרה 🎬\nקישור: ' + link);
            window.open(`https://t.me/share/url?url=${text}`, '_blank');
        }

        function shareEmail(link) {
            const subject = encodeURIComponent('רשימת ליקוט - סינמה סיטי חדרה');
            const body = encodeURIComponent('שלום,\n\nנוצרה רשימת ליקוט חדשה:\n\n' + link + '\n\nבברכה,\nמערכת ניהול המלאי');
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
        }

        function copyToClipboard(link) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    const msg = document.getElementById('shareResultMsg');
                    if (msg) msg.textContent = 'הקישור הועתק!';
                    showToast('הקישור הועתק ללוח', 'success');
                }, () => {
                    fallbackCopyToClipboard(link);
                });
            } else {
                fallbackCopyToClipboard(link);
            }
        }
		// פונקציה לנרמול שם מוצר
		function normalizeProductName(name) {
			return name
				.trim() // הסר רווחים מההתחלה והסוף
				.replace(/\s+/g, ' ') // החלף רווחים מרובים ברווח בודד
				.toLowerCase(); // המר לאותיות קטנות לצורך השוואה
		}

		// פונקציה למציאת מוצרים דומים
		function findSimilarProducts(name, threshold = 0.8) {
			const normalized = normalizeProductName(name);
			const similar = [];
			
			inventory.forEach(item => {
				const itemNormalized = normalizeProductName(item.name);
				
				// בדיקת זהות מלאה
				if (itemNormalized === normalized) {
					similar.push({ name: item.name, similarity: 1.0 });
					return;
				}
				
				// בדיקת דמיון (אלגוריתם פשוט)
				const similarity = calculateSimilarity(normalized, itemNormalized);
				if (similarity >= threshold) {
					similar.push({ name: item.name, similarity });
				}
			});
			
			return similar.sort((a, b) => b.similarity - a.similarity);
		}

		// אלגוריתם פשוט לחישוב דמיון בין מחרוזות
		function calculateSimilarity(str1, str2) {
			const longer = str1.length > str2.length ? str1 : str2;
			const shorter = str1.length > str2.length ? str2 : str1;
			
			if (longer.length === 0) return 1.0;
			
			// בדוק אם אחת המילים מכילה את השנייה
			if (longer.includes(shorter) || shorter.includes(longer)) {
				return shorter.length / longer.length;
			}
			
			// חישוב דמיון בסיסי
			const editDistance = getEditDistance(str1, str2);
			return (longer.length - editDistance) / longer.length;
		}

		// מרחק עריכה (Levenshtein distance)
		function getEditDistance(str1, str2) {
			const m = str1.length;
			const n = str2.length;
			const dp = Array(m + 1).fill().map(() => Array(n + 1).fill(0));
			
			for (let i = 0; i <= m; i++) dp[i][0] = i;
			for (let j = 0; j <= n; j++) dp[0][j] = j;
			
			for (let i = 1; i <= m; i++) {
				for (let j = 1; j <= n; j++) {
					if (str1[i - 1] === str2[j - 1]) {
						dp[i][j] = dp[i - 1][j - 1];
					} else {
						dp[i][j] = Math.min(
							dp[i - 1][j] + 1,    // deletion
							dp[i][j - 1] + 1,    // insertion
							dp[i - 1][j - 1] + 1 // substitution
						);
					}
				}
			}
			
			return dp[m][n];
		}

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('הקישור הועתק ללוח', 'success');
            } catch (err) {
                showToast('שגיאה בהעתקת הקישור', 'error');
            }
            document.body.removeChild(textArea);
        }
		
		// פונקציה עזר לפורמט תאריך אחיד
		function getFormattedDate() {
			const now = new Date();
			const day = String(now.getDate()).padStart(2, '0');
			const month = String(now.getMonth() + 1).padStart(2, '0');
			const year = now.getFullYear();
			return `${day}/${month}/${year}`;
		}

		function getFormattedTime() {
			const now = new Date();
			return now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
		}
		window.editProduct = function(productName) {
            const item = inventory.find(i => i.name === productName);
            if (!item) {
                showToast('המוצר לא נמצא', 'error');
                return;
            }
            
            document.getElementById('editItemOriginalName').value = item.name;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemCategory').value = item.category;
            document.getElementById('editBaseUnitSingular').value = item.baseUnitSingular;
            document.getElementById('editBaseUnitPlural').value = item.baseUnitPlural;
            document.getElementById('editPackUnitSingular').value = item.packUnitSingular;
            document.getElementById('editPackUnitPlural').value = item.packUnitPlural;
            document.getElementById('editUnitsPerPack').value = item.unitsPerPack || 1;
            document.getElementById('editMinPacks').value = item.minPacks || 0;
            
            document.getElementById('editModal').style.display = 'block';
        };

        window.deleteProduct = async function(productName) {
            if (!confirm(`האם אתה בטוח שברצונך למחוק את המוצר "${productName}"?\nפעולה זו תמחק את כל הווריאנטים של המוצר ולא ניתן לבטלה.`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                // מחק מ-Firebase
                await deleteInventoryItem(productName);
                
                // מחק מהמערך המקומי
                inventory = inventory.filter(i => i.name !== productName);
                
                // עדכן תצוגה
                updateStats();
                displayInventory();
                
                showToast(`המוצר "${productName}" נמחק בהצלחה`, 'success');
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('שגיאה במחיקת המוצר: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

		window.deleteVariantByIdentifier = async function(productName, location, expiry) {
			if (!confirm('האם אתה בטוח שברצונך למחוק את הווריאנט?')) return;
			
			try {
				const item = inventory.find(i => i.name === productName);
				if (item && item.variants) {
					// מצא את האינדקס הנכון של הווריאנט
					const variantIndex = item.variants.findIndex(v => 
						v.location === location && 
						(v.expiry || '') === expiry
					);
					
					if (variantIndex === -1) {
						showToast('הווריאנט לא נמצא', 'error');
						return;
					}
					
					item.variants.splice(variantIndex, 1);
					await saveInventoryItem(item);
					await loadAllData();
					updateStats();
					displayInventory();
					showToast('הווריאנט נמחק בהצלחה', 'success');
				}
			} catch (error) {
				showToast('שגיאה במחיקת הווריאנט', 'error');
			}
		};
		
		// פונקציה עזר חדשה לפרסור תאריך עברי
		function parseHebrewDate(dateStr) {
			if (!dateStr) return null;
			
			try {
				// נסה כמה פורמטים נפוצים
				let parts;
				let day, month, year;
				
				if (dateStr.includes('/')) {
					// פורמט: DD/MM/YYYY או D/M/YYYY
					parts = dateStr.split('/');
					if (parts.length === 3) {
						day = parseInt(parts[0], 10);
						month = parseInt(parts[1], 10);
						year = parseInt(parts[2], 10);
						
						// תיקון שנה דו-ספרתית
						if (year < 100) {
							year += 2000;
						}
					}
				} else if (dateStr.includes('.')) {
					// פורמט: DD.MM.YYYY
					parts = dateStr.split('.');
					if (parts.length === 3) {
						day = parseInt(parts[0], 10);
						month = parseInt(parts[1], 10);
						year = parseInt(parts[2], 10);
						
						if (year < 100) {
							year += 2000;
						}
					}
				} else if (dateStr.includes('-')) {
					// פורמט ISO: YYYY-MM-DD
					const date = new Date(dateStr);
					if (!isNaN(date.getTime())) {
						return date;
					}
				}
				
				// בדוק תקינות
				if (day && month && year && day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2020) {
					// חשוב: חודשים ב-JavaScript מתחילים מ-0
					return new Date(year, month - 1, day);
				}
				
				return null;
			} catch (error) {
				console.error('Error parsing date:', dateStr, error);
				return null;
			}
		}

		// החלף את החלק הרלוונטי בפונקציה generateReport:
		

		window.editVariantByIdentifier = function(productName, location, expiry, rowIndex) {
			const item = inventory.find(i => i.name === productName);
			if (!item || !item.variants) return;
			
			// ספור כמה וריאנטים תואמים יש לפני הנוכחי
			let matchCount = 0;
			let targetIndex = -1;
			
			for (let i = 0; i < item.variants.length; i++) {
				const v = item.variants[i];
				if (v.location === location && (v.expiry || '') === expiry) {
					if (matchCount === rowIndex) {
						targetIndex = i;
						break;
					}
					matchCount++;
				}
			}
			
			if (targetIndex === -1) {
				showToast('הווריאנט לא נמצא', 'error');
				return;
			}
			
			const variant = item.variants[targetIndex];
			
			document.getElementById('editVariantProductName').value = productName;
			document.getElementById('editVariantIndex').value = targetIndex;
			document.getElementById('editVariantQuantityPacks').value = variant.quantityPacks || 0;
			document.getElementById('editVariantQuantityUnits').value = variant.quantityUnits || 0;
			document.getElementById('editVariantLocation').value = variant.location || '';
			document.getElementById('editVariantExpiry').value = variant.expiry || '';
			document.getElementById('editVariantModal').style.display = 'block';
		};

		window.deleteVariantByIdentifier = async function(productName, location, expiry, rowIndex) {
			if (!confirm('האם אתה בטוח שברצונך למחוק את הווריאנט?')) return;
			
			try {
				const item = inventory.find(i => i.name === productName);
				if (item && item.variants) {
					// ספור כמה וריאנטים תואמים יש לפני הנוכחי
					let matchCount = 0;
					let targetIndex = -1;
					
					for (let i = 0; i < item.variants.length; i++) {
						const v = item.variants[i];
						if (v.location === location && (v.expiry || '') === expiry) {
							if (matchCount === rowIndex) {
								targetIndex = i;
								break;
							}
							matchCount++;
						}
					}
					
					if (targetIndex === -1) {
						showToast('הווריאנט לא נמצא', 'error');
						return;
					}
					
					item.variants.splice(targetIndex, 1);
					await saveInventoryItem(item);
					await loadAllData();
					updateStats();
					displayInventory();
					showToast('הווריאנט נמחק בהצלחה', 'success');
				}
			} catch (error) {
				showToast('שגיאה במחיקת הווריאנט', 'error');
			}
		};

        window.deleteVariant = async function(productName, variantIndex) {
            if (!confirm('האם אתה בטוח שברצונך למחוק את הווריאנט?')) return;
            
            try {
                const item = inventory.find(i => i.name === productName);
                if (item && item.variants) {
                    item.variants.splice(variantIndex, 1);
                    await saveInventoryItem(item);
                    await loadAllData();
                    updateStats();
                    displayInventory();
                    showToast('הווריאנט נמחק בהצלחה', 'success');
                }
            } catch (error) {
                showToast('שגיאה במחיקת הווריאנט', 'error');
            }
        };

        window.editVariant = function(productName, variantIndex) {
            const item = inventory.find(i => i.name === productName);
            if (!item || !item.variants || !item.variants[variantIndex]) return;
            
            const variant = item.variants[variantIndex];
            
            document.getElementById('editVariantProductName').value = productName;
            document.getElementById('editVariantIndex').value = variantIndex;
            document.getElementById('editVariantQuantityPacks').value = variant.quantityPacks || 0;
            document.getElementById('editVariantQuantityUnits').value = variant.quantityUnits || 0;
            document.getElementById('editVariantLocation').value = variant.location || '';
            document.getElementById('editVariantExpiry').value = variant.expiry || '';
            document.getElementById('editVariantModal').style.display = 'block';
        };

        window.openAddVariantModal = function(productName) {
            document.getElementById('addVariantProductName').value = productName;
            document.getElementById('addVariantQuantityPacks').value = 0;
            document.getElementById('addVariantQuantityUnits').value = 0;
            document.getElementById('addVariantLocation').value = '';
            document.getElementById('addVariantExpiry').value = '';
            document.getElementById('addVariantModal').style.display = 'block';
        };

        window.closeAddVariantModal = function() {
            document.getElementById('addVariantModal').style.display = 'none';
            document.getElementById('addVariantForm').reset();
        };

        window.closeEditVariantModal = function() {
            document.getElementById('editVariantModal').style.display = 'none';
            document.getElementById('editVariantForm').reset();
        };

        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editItemForm').reset();
        };

        // --- עריכת תנועות ---
        window.editMovement = function(id) {
			const movement = movements.find(m => m.id === id);
			if (!movement) return;
			
			// אל תאפשר עריכת תנועות ביטול
			if (movement.type && movement.type.includes('ביטול')) {
				showToast('לא ניתן לערוך תנועות ביטול', 'error');
				return;
			}
			
			document.getElementById('editMovementId').value = movement.id;
			document.getElementById('editMovementProduct').value = movement.product;
			document.getElementById('editMovementType').value = movement.type;
			document.getElementById('editMovementLocation').value = movement.location || '';
			document.getElementById('editMovementExpiry').value = movement.expiry || '';
			document.getElementById('editMovementQuantityPacks').value = movement.quantityPacks || 0;
			document.getElementById('editMovementQuantityUnits').value = movement.quantityUnits || 0;
			document.getElementById('editMovementNotes').value = movement.notes || '';
			
			// שמור את הערכים המקוריים
			document.getElementById('editMovementOriginalQuantityPacks').value = movement.quantityPacks || 0;
			document.getElementById('editMovementOriginalQuantityUnits').value = movement.quantityUnits || 0;
			document.getElementById('editMovementOriginalType').value = movement.type;
			
			document.getElementById('editMovementModal').style.display = 'block';
		};

		// עדכן את ה-event listener של editMovementForm
		document.getElementById('editMovementForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			
			try {
				const id = document.getElementById('editMovementId').value;
				const productName = document.getElementById('editMovementProduct').value;
				const newType = document.getElementById('editMovementType').value;
				const newLocation = document.getElementById('editMovementLocation').value;
				const newExpiry = document.getElementById('editMovementExpiry').value;
				const newQuantityPacks = parseInt(document.getElementById('editMovementQuantityPacks').value) || 0;
				const newQuantityUnits = parseInt(document.getElementById('editMovementQuantityUnits').value) || 0;
				const notes = document.getElementById('editMovementNotes').value;
				
				// קח את הערכים המקוריים
				const originalQuantityPacks = parseInt(document.getElementById('editMovementOriginalQuantityPacks').value) || 0;
				const originalQuantityUnits = parseInt(document.getElementById('editMovementOriginalQuantityUnits').value) || 0;
				const originalType = document.getElementById('editMovementOriginalType').value;
				
				// מצא את המוצר במלאי
				const item = inventory.find(i => i.name === productName);
				if (!item) {
					showToast('המוצר לא נמצא במלאי', 'error');
					return;
				}
				
				// בטל את ההשפעה של התנועה המקורית על המלאי
				let targetVariant = null;
				if (item.variants && newLocation) {
					targetVariant = item.variants.find(v => 
						v.location === newLocation && 
						((!v.expiry && !newExpiry) || (v.expiry === newExpiry))
					);
					
					// אם לא נמצא וריאנט מתאים, צור חדש
					if (!targetVariant) {
						targetVariant = {
							quantityPacks: 0,
							quantityUnits: 0,
							location: newLocation,
							expiry: newExpiry || ''
						};
						item.variants.push(targetVariant);
					}
				} else {
					// אם אין מיקום, השתמש בווריאנט הראשון
					if (!item.variants || item.variants.length === 0) {
						item.variants = [{
							quantityPacks: 0,
							quantityUnits: 0,
							location: 'מחסן ראשי',
							expiry: ''
						}];
					}
					targetVariant = item.variants[0];
				}
				
				// שלב 1: בטל את ההשפעה המקורית
				if (originalType === 'הוצאה') {
					// אם הייתה הוצאה, החזר למלאי
					targetVariant.quantityPacks += originalQuantityPacks;
					targetVariant.quantityUnits += originalQuantityUnits;
				} else if (originalType === 'הכנסה') {
					// אם הייתה הכנסה, הורד מהמלאי
					targetVariant.quantityPacks = Math.max(0, targetVariant.quantityPacks - originalQuantityPacks);
					targetVariant.quantityUnits = Math.max(0, targetVariant.quantityUnits - originalQuantityUnits);
				}
				
				// שלב 2: החל את ההשפעה החדשה
				if (newType === 'הוצאה') {
					// הורד מהמלאי
					targetVariant.quantityPacks = Math.max(0, targetVariant.quantityPacks - newQuantityPacks);
					targetVariant.quantityUnits = Math.max(0, targetVariant.quantityUnits - newQuantityUnits);
				} else if (newType === 'הכנסה') {
					// הוסף למלאי
					targetVariant.quantityPacks += newQuantityPacks;
					targetVariant.quantityUnits += newQuantityUnits;
				}
				
				// נרמל את היחידות
				if (targetVariant.quantityUnits >= item.unitsPerPack && item.unitsPerPack > 0) {
					const extraPacks = Math.floor(targetVariant.quantityUnits / item.unitsPerPack);
					targetVariant.quantityPacks += extraPacks;
					targetVariant.quantityUnits = targetVariant.quantityUnits % item.unitsPerPack;
				}
				
				// טפל ביחידות שליליות
				while (targetVariant.quantityUnits < 0 && targetVariant.quantityPacks > 0) {
					targetVariant.quantityPacks--;
					targetVariant.quantityUnits += item.unitsPerPack;
				}
				
				// וודא שאין ערכים שליליים
				targetVariant.quantityPacks = Math.max(0, targetVariant.quantityPacks);
				targetVariant.quantityUnits = Math.max(0, targetVariant.quantityUnits);
				
				// עדכן את התנועה ב-Firebase
				await db.collection('movements').doc(id).update({
					product: productName,
					type: newType,
					location: newLocation,
					expiry: newExpiry,
					quantityPacks: newQuantityPacks,
					quantityUnits: newQuantityUnits,
					notes: notes,
					lastEdited: new Date().toISOString(),
					editedBy: currentUser.fullName
				});
				
				// שמור את המוצר המעודכן
				await saveInventoryItem(item);
				
				// טען מחדש את הנתונים
				await loadAllData();
				updateStats();
				displayInventory();
				displayMovements();
				
				showToast('התנועה עודכנה בהצלחה!', 'success');
				closeEditMovementModal();
				
			} catch (error) {
				console.error('Error updating movement:', error);
				showToast('שגיאה בעדכון התנועה: ' + error.message, 'error');
			}
		});

        window.closeEditMovementModal = function() {
            document.getElementById('editMovementModal').style.display = 'none';
            document.getElementById('editMovementForm').reset();
        };

        window.deleteMovement = async function(id) {
			if (!confirm('האם למחוק תנועה זו? שים לב: המלאי יעודכן בהתאם.')) return;
			
			try {
				// קח את פרטי התנועה לפני המחיקה
				const movementDoc = await db.collection('movements').doc(id).get();
				if (!movementDoc.exists) {
					showToast('התנועה לא נמצאה', 'error');
					return;
				}
				
				const movement = movementDoc.data();
				
				// בדוק אם יש מספיק מידע לעדכון המלאי
				if (!movement.product || !movement.type) {
					if (!confirm('חסרים פרטים בתנועה זו. למחוק בכל זאת ללא עדכון המלאי?')) {
						return;
					}
					// מחק רק את התנועה
					await db.collection('movements').doc(id).delete();
					await loadMovementsOnly();
					displayMovements();
					showToast('התנועה נמחקה (ללא עדכון מלאי)', 'warning');
					return;
				}
				
				// מצא את המוצר במלאי
				const item = inventory.find(i => i.name === movement.product);
				if (!item) {
					if (!confirm(`המוצר "${movement.product}" לא נמצא במלאי. למחוק את התנועה בלבד?`)) {
						return;
					}
					// מחק רק את התנועה
					await db.collection('movements').doc(id).delete();
					await loadMovementsOnly();
					displayMovements();
					showToast('התנועה נמחקה (המוצר לא נמצא במלאי)', 'warning');
					return;
				}
				
				// חשב את הכמויות להחזרה
				const quantityPacks = movement.quantityPacks || 0;
				const quantityUnits = movement.quantityUnits || 0;
				
				// מצא את הווריאנט המתאים או השתמש בראשון
				let targetVariant = null;
				
				if (movement.location && item.variants) {
					// נסה למצוא וריאנט מתאים
					targetVariant = item.variants.find(v => 
						v.location === movement.location && 
						((!v.expiry && !movement.expiry) || (v.expiry === movement.expiry))
					);
				}
				
				// אם לא נמצא וריאנט מתאים, השתמש בראשון או צור חדש
				if (!targetVariant) {
					if (item.variants && item.variants.length > 0) {
						targetVariant = item.variants[0];
						showToast('הווריאנט המקורי לא נמצא, המלאי יעודכן בווריאנט הראשון', 'warning');
					} else {
						// צור וריאנט חדש
						item.variants = [{
							quantityPacks: 0,
							quantityUnits: 0,
							location: movement.location || 'מחסן ראשי',
							expiry: movement.expiry || ''
						}];
						targetVariant = item.variants[0];
					}
				}
				
				// עדכן את המלאי בהתאם לסוג התנועה
				if (movement.type === 'הוצאה') {
					// אם הייתה הוצאה, החזר למלאי
					targetVariant.quantityPacks = (targetVariant.quantityPacks || 0) + quantityPacks;
					targetVariant.quantityUnits = (targetVariant.quantityUnits || 0) + quantityUnits;
				} else if (movement.type === 'הכנסה') {
					// אם הייתה הכנסה, הורד מהמלאי
					targetVariant.quantityPacks = Math.max(0, (targetVariant.quantityPacks || 0) - quantityPacks);
					targetVariant.quantityUnits = Math.max(0, (targetVariant.quantityUnits || 0) - quantityUnits);
				}
				
				// נרמל את היחידות (המר יחידות עודפות לחבילות)
				if (targetVariant.quantityUnits >= item.unitsPerPack && item.unitsPerPack > 0) {
					const extraPacks = Math.floor(targetVariant.quantityUnits / item.unitsPerPack);
					targetVariant.quantityPacks += extraPacks;
					targetVariant.quantityUnits = targetVariant.quantityUnits % item.unitsPerPack;
				}
				
				// שמור את המוצר המעודכן
				await saveInventoryItem(item);
				
				// מחק את התנועה
				await db.collection('movements').doc(id).delete();
				
				// צור תנועת ביטול לתיעוד
				await saveMovement({
					date: getFormattedDate(),
					time: getFormattedTime(),
					product: movement.product,
					location: targetVariant.location,
					expiry: targetVariant.expiry,
					type: movement.type === 'הוצאה' ? 'ביטול הוצאה' : 'ביטול הכנסה',
					quantityPacks: quantityPacks,
					quantityUnits: quantityUnits,
					user: currentUser.fullName,
					notes: `ביטול תנועה מתאריך ${movement.date || 'לא ידוע'} (${movement.user || 'משתמש לא ידוע'})`
				});
				
				// טען מחדש את כל הנתונים
				await loadAllData();
				updateStats();
				displayInventory();
				displayMovements();
				
				showToast('התנועה נמחקה והמלאי עודכן בהצלחה!', 'success');
				
			} catch (error) {
				console.error('Error deleting movement:', error);
				showToast('שגיאה במחיקת התנועה: ' + error.message, 'error');
			}
		};

        // --- עריכת משתמשים ---
        window.editUser = function(username) {
            if (!currentUser.permissions.includes('manage_users')) {
                showToast('אין לך הרשאה לערוך משתמשים', 'error');
                return;
            }
            
            const user = users.find(u => u.username === username);
            if (!user) {
                showToast('משתמש לא נמצא', 'error');
                return;
            }
            
            document.getElementById('editUserOriginalUsername').value = user.username;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editFullName').value = user.fullName;
            document.getElementById('editUserRole').value = user.role || '';
            
            // איפוס כל ה-checkboxes
            document.querySelectorAll('#editUserForm input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // סימון ההרשאות הקיימות
            (user.permissions || []).forEach(perm => {
                const checkbox = document.getElementById('edit_perm_' + perm);
                if (checkbox) checkbox.checked = true;
            });
            
            document.getElementById('editUserModal').style.display = 'block';
        };

        window.closeEditUserModal = function() {
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserForm').reset();
        };

        window.deleteUser = async function(username) {
            if (!confirm('האם אתה בטוח שברצונך למחוק משתמש זה?')) return;
            
            try {
                await deleteUserFromDB(username);
                users = users.filter(u => u.username !== username);
                displayUsers();
                showToast('המשתמש נמחק בהצלחה', 'success');
            } catch (error) {
                showToast('שגיאה במחיקת המשתמש', 'error');
            }
        };

        // --- עריכת ליקוטים ---
        window.openEditPicking = async function(pickId) {
            try {
                const pickSnap = await db.collection('pickingLists').doc(pickId).get();
                if (!pickSnap.exists) {
                    showToast('רשימת הליקוט לא קיימת', 'error');
                    return;
                }
                
                const pick = pickSnap.data();
                window.currentEditPickId = pickId;

                let html = `<table class="picking-table"><tr>
                    <th>מוצר</th>
                    <th>כמות</th>
                    <th>מיקום</th>
                    <th>תוקף</th>
                    <th>הערה</th>
                    <th>נלקח</th>
                </tr>`;
                
                (pick.plan || []).forEach((row, i) => {
                    html += `<tr>
                        <td>${row.productName}</td>
                        <td>${row.takePacks} חב'${row.takeUnits ? ' + ' + row.takeUnits + ' יחידות' : ''}</td>
                        <td>${row.location || ''}</td>
                        <td>${row.expiry ? formatDate(row.expiry) : ''}</td>
                        <td>
                            <input type="text" id="edit_note_${i}" value="${row.note || ''}" style="width:95%;padding:4px 7px;">
                        </td>
                        <td style="text-align:center">
                            <input type="checkbox" class="edit-pick-checkbox" data-index="${i}" id="edit_pick_checkbox_${i}" checked>
                        </td>
                    </tr>`;
                });

                html += `</table>
                <div style="text-align:center; margin-top:14px;">
                    <button class="btn-main" onclick="selectAllPicking(true)">בחר הכל</button>
                    <button class="btn-main" onclick="selectAllPicking(false)">נקה הכל</button>
                    <button class="btn-main" onclick="saveEditPicking()">אשר וסגור</button>
                </div>`;
                
                document.getElementById('editPickingListArea').innerHTML = html;
                document.getElementById('editPickingModal').style.display = "block";
                selectAllPicking(true);
            } catch (error) {
                showToast('שגיאה בטעינת רשימת הליקוט', 'error');
            }
        }

        window.closeEditPicking = function() {
            document.getElementById('editPickingModal').style.display = "none";
            window.lastEditPickingResults = null;
        }
		
		window.saveEditPicking = async function() {
			console.log('saveEditPicking called');
			try {
				const pickId = window.currentEditPickId;
				console.log('pickId:', pickId);
				
				if (!pickId) {
					showToast('לא נמצא מזהה ליקוט', 'error');
					return;
				}
				
				const pickSnap = await db.collection('pickingLists').doc(pickId).get();
				if (!pickSnap.exists) {
					showToast('רשימת הליקוט לא קיימת', 'error');
					return;
				}
				
				const pick = pickSnap.data();
				console.log('pick data:', pick);
				
				// בדוק אם הליקוט כבר בוצע
				if (pick.status === 'done') {
					if (!confirm('ליקוט זה כבר בוצע. האם לעדכן בכל זאת?')) {
						return;
					}
				}
				
				const results = [];
				const updatedPlan = [...(pick.plan || [])];
				
				// אסוף את התוצאות וההערות
				for (let i = 0; i < updatedPlan.length; i++) {
					const cb = document.getElementById('edit_pick_checkbox_' + i);
					const noteInput = document.getElementById('edit_note_' + i);
					
					if (!cb) {
						console.error(`Checkbox not found for index ${i}`);
						continue;
					}
					
					const result = {
						status: cb.checked ? "נלקח" : "לא נלקח",
						note: noteInput ? noteInput.value.trim() : ''
					};
					
					results.push(result);
					
					// עדכון ההערה ב-plan
					if (noteInput && noteInput.value.trim()) {
						updatedPlan[i].note = noteInput.value.trim();
					}
				}
				
				console.log('results:', results);
				
				// ודא שיש לפחות פריט אחד מסומן
				const hasCheckedItems = results.some(r => r.status === "נלקח");
				if (!hasCheckedItems) {
					if (!confirm('לא סומנו פריטים לליקוט. האם להמשיך בכל זאת?')) {
						return;
					}
				}
				
				// עדכן את רשימת הליקוט
				await db.collection('pickingLists').doc(pickId).update({
					status: 'done',
					results: results,
					plan: updatedPlan,
					pickedBy: currentUser.fullName,
					pickedAt: new Date().toISOString()
				});
				
				// עדכן את המלאי רק עבור הפריטים שנלקחו
				for (let i = 0; i < updatedPlan.length; i++) {
					if (results[i].status !== 'נלקח') continue;
					
					const row = updatedPlan[i];
					
					// מצא את המוצר במלאי
					const item = inventory.find(it => it.name === row.productName);
					if (!item) {
						console.error(`Product not found: ${row.productName}`);
						continue;
					}
					
					// מצא את הווריאנט המתאים
					let variantFound = false;
					for (let j = 0; j < (item.variants || []).length; j++) {
						const variant = item.variants[j];
						if (variant.location === row.location && 
							((!variant.expiry && !row.expiry) || (variant.expiry === row.expiry))) {
							
							// חשב את הכמויות החדשות
							let newPacks = (variant.quantityPacks || 0) - (row.takePacks || 0);
							let newUnits = (variant.quantityUnits || 0) - (row.takeUnits || 0);
							
							// טפל במקרה של יחידות שליליות
							while (newUnits < 0 && newPacks > 0) {
								newPacks--;
								newUnits += item.unitsPerPack;
							}
							
							// וודא שאין ערכים שליליים
							variant.quantityPacks = Math.max(0, newPacks);
							variant.quantityUnits = Math.max(0, newUnits);
							
							variantFound = true;
							break;
						}
					}
					
					if (!variantFound) {
						console.error(`Variant not found for ${row.productName} at ${row.location}`);
						continue;
					}
					
					// שמור את המוצר המעודכן
					await saveInventoryItem(item);
					
					// צור תנועת מלאי
					await saveMovement({
						date: getFormattedDate(),
						time: getFormattedTime(),
						product: row.productName,
						location: row.location,
						expiry: row.expiry,
						type: "הוצאה",
						quantityPacks: row.takePacks || 0,
						quantityUnits: row.takeUnits || 0,
						user: currentUser.fullName,
						notes: `ליקוט - ${results[i].note || 'ללא הערות'}`
					});
				}
				
				// טען מחדש את הנתונים
				await loadAllData();
				updateStats();
				displayInventory();
				
				showToast('הליקוט נשמר והמלאי עודכן בהצלחה', 'success');
				closeEditPicking();
				displayPickings();
				
			} catch (error) {
				console.error('Error in saveEditPicking:', error);
				showToast('שגיאה בשמירת הליקוט: ' + error.message, 'error');
			}
		};

        window.selectAllPicking = function(val = true) {
            const checkboxes = document.querySelectorAll('.edit-pick-checkbox');
            checkboxes.forEach(cb => cb.checked = val);
        }

        window.approvePicking = async function(pickId, results = null) {
			try {
				const pickSnap = await db.collection('pickingLists').doc(pickId).get();
				if (!pickSnap.exists) {
					showToast('רשימת הליקוט לא קיימת', 'error');
					return;
				}
				
				const pick = pickSnap.data();
				
				// אם לא סופקו תוצאות, הנח שהכל נלקח
				if (!results) {
					results = (pick.plan || []).map(() => ({ status: "נלקח" }));
				}
				
				// בדוק אם הליקוט כבר בוצע
				if (pick.status === 'done') {
					showToast('ליקוט זה כבר בוצע', 'error');
					return;
				}

				// עדכן את רשימת הליקוט
				await db.collection('pickingLists').doc(pickId).update({
					status: 'done',
					results: results,
					pickedBy: currentUser.fullName,
					pickedAt: new Date().toISOString()
				});

				// עדכון המלאי ויצירת תנועות
				let successCount = 0;
				let errorCount = 0;
				
				for (let i = 0; i < (pick.plan || []).length; i++) {
					if (results[i].status !== 'נלקח') continue;
					
					const row = pick.plan[i];
					
					try {
						// מצא את המוצר במלאי
						const item = inventory.find(it => it.name === row.productName);
						if (!item) {
							console.error(`Product not found: ${row.productName}`);
							errorCount++;
							continue;
						}
						
						// מצא את הווריאנט המתאים
						let variantFound = false;
						for (const variant of (item.variants || [])) {
							if (variant.location === row.location && 
								((!variant.expiry && !row.expiry) || (variant.expiry === row.expiry))) {
								
								// הורד את הכמויות
								let newPacks = (variant.quantityPacks || 0) - (row.takePacks || 0);
								let newUnits = (variant.quantityUnits || 0) - (row.takeUnits || 0);
								
								// טפל ביחידות שליליות
								while (newUnits < 0 && newPacks > 0) {
									newPacks--;
									newUnits += item.unitsPerPack;
								}
								
								variant.quantityPacks = Math.max(0, newPacks);
								variant.quantityUnits = Math.max(0, newUnits);
								
								variantFound = true;
								successCount++;
								break;
							}
						}
						
						if (!variantFound) {
							console.error(`Variant not found for ${row.productName} at ${row.location}`);
							errorCount++;
							continue;
						}
						
						// שמור את המוצר המעודכן
						await saveInventoryItem(item);
						
						// צור תנועת מלאי
						await saveMovement({
							date: getFormattedDate(),
							time: getFormattedTime(),
							product: row.productName,
							location: row.location,
							expiry: row.expiry,
							type: "הוצאה",
							quantityPacks: row.takePacks || 0,
							quantityUnits: row.takeUnits || 0,
							user: currentUser.fullName,
							notes: 'ליקוט מאושר'
						});
						
					} catch (itemError) {
						console.error(`Error processing item ${row.productName}:`, itemError);
						errorCount++;
					}
				}

				// טען מחדש את הנתונים
				await loadAllData();
				updateStats();
				displayInventory();
				
				// הודעה מסכמת
				let message = `הליקוט אושר בהצלחה!`;
				if (successCount > 0) {
					message += ` ${successCount} פריטים עודכנו במלאי.`;
				}
				if (errorCount > 0) {
					message += ` ${errorCount} פריטים לא עודכנו בגלל שגיאות.`;
				}
				
				showToast(message, errorCount > 0 ? 'warning' : 'success');
				displayPickings();
				
			} catch (error) {
				console.error('Error in approvePicking:', error);
				showToast('שגיאה באישור הליקוט: ' + error.message, 'error');
			}
		};


        window.deletePicking = async function(pickId) {
            if (!confirm("האם למחוק את הליקוט?")) return;
            
            try {
                await db.collection('pickingLists').doc(pickId).delete();
                displayPickings();
                showToast('הליקוט נמחק', 'success');
            } catch (error) {
                showToast('שגיאה במחיקת הליקוט', 'error');
            }
        }

        // --- דוחות ---
        window.generateReport = function(type) {
			const reportContent = document.getElementById('reportContent');
			if (!reportContent) return;
			
			let html = '';
			
			switch(type) {
				case 'inventory':
					html = '<h3>דוח מלאי מלא</h3>';
					html += '<div style="margin: 10px 0;">';
					html += '<label><input type="checkbox" id="showVariantsCheckbox" checked onchange="regenerateReport(\'inventory\')"> הצג פירוט לפי מיקומים</label>';
					html += '</div>';
					
					const showVariants = document.getElementById('showVariantsCheckbox')?.checked ?? true;
					
					html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
					
					if (showVariants) {
						// תצוגה עם וריאנטים
						html += '<thead><tr style="background: #34495e; color: white;">';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">שם מוצר</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">קטגוריה</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">מיקום</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">כמות</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">תפוגה</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">סטטוס</th>';
						html += '</tr></thead>';
						html += '<tbody>';
						
						inventory.forEach(item => {
							const [totalPacks, totalUnits] = totalPacksAndUnits(item);
							const hasVariants = item.variants && item.variants.length > 0;
							
							if (!hasVariants) {
								// מוצר ללא וריאנטים
								html += `<tr style="border: 1px solid #ddd;">
									<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
									<td style="padding: 8px; border: 1px solid #ddd;">${item.category}</td>
									<td style="padding: 8px; border: 1px solid #ddd;">-</td>
									<td style="padding: 8px; border: 1px solid #ddd;">0</td>
									<td style="padding: 8px; border: 1px solid #ddd;">-</td>
									<td style="padding: 8px; border: 1px solid #ddd;">ללא מלאי</td>
								</tr>`;
							} else {
								// שורת סיכום למוצר
								html += `<tr style="background: #ecf0f1; font-weight: bold; border: 2px solid #34495e;">
									<td style="padding: 8px; border: 1px solid #ddd;" rowspan="${item.variants.length + 1}">${item.name}</td>
									<td style="padding: 8px; border: 1px solid #ddd;" rowspan="${item.variants.length + 1}">${item.category}</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">סה"כ</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">
										${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
										${totalUnits > 0 ? ` + ${totalUnits} ${getUnitLabel(totalUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
									</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">-</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">
										${totalPacks < (item.minPacks || 0) ? '🔴 מתחת למינימום' : '🟢 תקין'}
									</td>
								</tr>`;
								
								// שורות וריאנטים
								item.variants.forEach(variant => {
									let expiryStatus = '';
									let rowStyle = '';
									
									if (variant.expiry) {
										const daysToExpiry = Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24));
										if (daysToExpiry < 0) {
											expiryStatus = '🔴 פג תוקף';
											rowStyle = 'background: #ffebee;';
										} else if (daysToExpiry <= 7) {
											expiryStatus = '🟠 תפוגה קרובה';
											rowStyle = 'background: #fff3e0;';
										} else if (daysToExpiry <= 30) {
											expiryStatus = '🟡 תפוגה בחודש הקרוב';
											rowStyle = 'background: #fffde7;';
										} else {
											expiryStatus = '🟢 תקין';
										}
									}
									
									html += `<tr style="${rowStyle} border: 1px solid #ddd;">
										<td style="padding: 8px; padding-right: 20px; border: 1px solid #ddd;">↳ ${variant.location}</td>
										<td style="padding: 8px; border: 1px solid #ddd;">
											${variant.quantityPacks || 0} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
											${variant.quantityUnits > 0 ? ` + ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
										</td>
										<td style="padding: 8px; border: 1px solid #ddd;">${variant.expiry ? formatDate(variant.expiry) : '-'}</td>
										<td style="padding: 8px; border: 1px solid #ddd;">${expiryStatus}</td>
									</tr>`;
								});
							}
						});
						
					} else {
						// תצוגה מסכמת בלבד
						html += '<thead><tr style="background: #34495e; color: white;">';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">שם מוצר</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">קטגוריה</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">כמות כוללת</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">מינימום</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">תפוגה קרובה</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">סטטוס</th>';
						html += '</tr></thead>';
						html += '<tbody>';
						
						inventory.forEach(item => {
							const [totalPacks, looseUnits] = totalPacksAndUnits(item);
							const earliestExpiry = getEarliestExpiry(item);
							const status = getGlobalStatus(totalPacks, item.minPacks || 0, earliestExpiry);
							
							let rowStyle = '';
							if (totalPacks < (item.minPacks || 0)) {
								rowStyle = 'background: #ffebee;';
							}
							
							html += `<tr style="${rowStyle} border: 1px solid #ddd;">
								<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${item.category}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">
									${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
									${looseUnits > 0 ? ` + ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
								</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${item.minPacks || 0} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${earliestExpiry ? formatDate(earliestExpiry) : '-'}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
							</tr>`;
						});
					}
					
					html += '</tbody></table>';
					break;

				case 'lowStock':
					html = '<h3>דוח חוסרים במלאי</h3>';
					html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
					html += '<thead><tr style="background: #34495e; color: white;">';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">שם מוצר</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">כמות נוכחית</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">כמות מינימום</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">חוסר</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">אחוז מהמינימום</th>';
					html += '</tr></thead>';
					html += '<tbody>';
					
					const lowStockItems = [];
					inventory.forEach(item => {
						const [totalPacks, looseUnits] = totalPacksAndUnits(item);
						if (totalPacks < (item.minPacks || 0)) {
							const shortage = (item.minPacks || 0) - totalPacks;
							const percentage = item.minPacks > 0 ? Math.round((totalPacks / item.minPacks) * 100) : 0;
							lowStockItems.push({ item, totalPacks, looseUnits, shortage, percentage });
						}
					});
					
					// מיון לפי אחוז - הכי נמוך קודם
					lowStockItems.sort((a, b) => a.percentage - b.percentage);
					
					lowStockItems.forEach(({ item, totalPacks, looseUnits, shortage, percentage }) => {
						let rowStyle = '';
						if (percentage === 0) {
							rowStyle = 'background: #ffcdd2; font-weight: bold;'; // אין מלאי כלל
						} else if (percentage < 25) {
							rowStyle = 'background: #ffebee;'; // פחות מ-25%
						} else if (percentage < 50) {
							rowStyle = 'background: #fff3e0;'; // פחות מ-50%
						}
						
						html += `<tr style="${rowStyle} border: 1px solid #ddd;">
							<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
							<td style="padding: 8px; border: 1px solid #ddd;">
								${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
								${looseUnits > 0 ? ` + ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${item.minPacks || 0} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
							<td style="padding: 8px; border: 1px solid #ddd; color: #c62828; font-weight: bold;">
								${shortage} ${getUnitLabel(shortage, item.packUnitSingular, item.packUnitPlural)}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">
								<div style="display: flex; align-items: center;">
									<div style="width: 100px; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-left: 10px;">
										<div style="width: ${percentage}%; height: 100%; background: ${percentage < 25 ? '#f44336' : percentage < 50 ? '#ff9800' : '#ffc107'};"></div>
									</div>
									<span>${percentage}%</span>
								</div>
							</td>
						</tr>`;
					});
					
					if (lowStockItems.length === 0) {
						html += '<tr><td colspan="5" style="text-align: center; padding: 20px;">אין מוצרים מתחת למינימום 🎉</td></tr>';
					}
					
					html += '</tbody></table>';
					break;

				case 'expiring':
					html = '<h3>דוח תפוגות קרובות</h3>';
					html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
					html += '<thead><tr style="background: #34495e; color: white;">';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">שם מוצר</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">מיקום</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">כמות</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">תאריך תפוגה</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">ימים לתפוגה</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">סטטוס</th>';
					html += '</tr></thead>';
					html += '<tbody>';
					
					const expiringItems = [];
					inventory.forEach(item => {
						(item.variants || []).forEach(variant => {
							if (!variant.expiry) return;
							if ((variant.quantityPacks || 0) === 0 && (variant.quantityUnits || 0) === 0) return;
							
							const daysToExpiry = Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24));
							if (daysToExpiry <= 30) {
								expiringItems.push({ item, variant, daysToExpiry });
							}
						});
					});
					
					// מיון לפי ימים לתפוגה
					expiringItems.sort((a, b) => a.daysToExpiry - b.daysToExpiry);
					
					expiringItems.forEach(({ item, variant, daysToExpiry }) => {
						let status, rowStyle;
						
						if (daysToExpiry < 0) {
							status = '🔴 פג תוקף!';
							rowStyle = 'background: #ffcdd2; font-weight: bold;';
						} else if (daysToExpiry === 0) {
							status = '🔴 פג היום!';
							rowStyle = 'background: #ffcdd2;';
						} else if (daysToExpiry <= 7) {
							status = '🟠 תפוגה השבוע';
							rowStyle = 'background: #ffebee;';
						} else if (daysToExpiry <= 14) {
							status = '🟡 תפוגה בשבועיים';
							rowStyle = 'background: #fff3e0;';
						} else {
							status = '🟢 תפוגה בחודש הקרוב';
							rowStyle = 'background: #fffde7;';
						}
						
						html += `<tr style="${rowStyle} border: 1px solid #ddd;">
							<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${variant.location}</td>
							<td style="padding: 8px; border: 1px solid #ddd;">
								${variant.quantityPacks || 0} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
								${variant.quantityUnits > 0 ? ` + ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${formatDate(variant.expiry)}</td>
							<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: ${daysToExpiry < 0 ? '#d32f2f' : daysToExpiry <= 7 ? '#f57c00' : '#f9a825'};">
								${daysToExpiry < 0 ? `${Math.abs(daysToExpiry)} ימים אחרי` : `${daysToExpiry} ימים`}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
						</tr>`;
					});
					
					if (expiringItems.length === 0) {
						html += '<tr><td colspan="6" style="text-align: center; padding: 20px;">אין מוצרים עם תפוגה קרובה 🎉</td></tr>';
					}
					
					html += '</tbody></table>';
					break;

				case 'movements':
					html = '<h3>דוח תנועות אחרונות</h3>';
					html += '<div style="margin: 10px 0;">';
					html += '<label>תקופה: ';
					html += '<select id="movementsPeriod" onchange="regenerateReport(\'movements\')" style="padding: 5px;">';
					html += '<option value="7">7 ימים אחרונים</option>';
					html += '<option value="30" selected>30 ימים אחרונים</option>';
					html += '<option value="90">90 ימים אחרונים</option>';
					html += '<option value="all">הכל</option>';
					html += '</select></label>';
					html += '</div>';
					
					const periodDays = parseInt(document.getElementById('movementsPeriod')?.value || '30');
					const cutoffDate = new Date();
					if (periodDays !== 'all') {
						cutoffDate.setDate(cutoffDate.getDate() - periodDays);
					}

					const recentMovements = movements.filter(m => {
						if (!m.date) return false;
						if (periodDays === 'all') return true;
						
						const moveDate = parseHebrewDate(m.date);
						if (!moveDate) return false;
						
						return moveDate >= cutoffDate;
					});

					// מיון לפי תאריך יורד
					recentMovements.sort((a, b) => {
						const dateA = parseHebrewDate(a.date);
						const dateB = parseHebrewDate(b.date);
						if (!dateA || !dateB) return 0;
						return dateB - dateA;
					});

					if (recentMovements.length === 0) {
						html += '<p style="text-align: center; padding: 20px;">אין תנועות בתקופה שנבחרה</p>';
					} else {
						html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
						html += '<thead><tr style="background: #34495e; color: white;">';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">תאריך</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">שעה</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">מוצר</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">פעולה</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">כמות</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">מיקום</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">משתמש</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">הערות</th>';
						html += '</tr></thead>';
						html += '<tbody>';
						
						recentMovements.forEach(movement => {
							let rowStyle = '';
							if (movement.type === 'הוצאה') {
								rowStyle = 'background: #ffebee;';
							} else if (movement.type === 'הכנסה') {
								rowStyle = 'background: #e8f5e9;';
							} else if (movement.type && movement.type.includes('ביטול')) {
								rowStyle = 'background: #fff3cd; font-style: italic;';
							}
							
							html += `<tr style="${rowStyle} border: 1px solid #ddd;">
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.date}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.time || ''}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.product}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.type}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.quantityPacks || 0} חב'${movement.quantityUnits > 0 ? ' + ' + movement.quantityUnits + ' יחידות' : ''}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.location || '-'}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.user || ''}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.notes || ''}</td>
							</tr>`;
						});
						
						html += '</tbody></table>';
						
						// סיכום סטטיסטי
						const inMovements = recentMovements.filter(m => m.type === 'הכנסה').length;
						const outMovements = recentMovements.filter(m => m.type === 'הוצאה').length;
						const cancelMovements = recentMovements.filter(m => m.type && m.type.includes('ביטול')).length;
						
						html += '<div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">';
						html += '<h4>סיכום:</h4>';
						html += `<p>סה"כ תנועות: ${recentMovements.length}</p>`;
						html += `<p>הכנסות: ${inMovements} | הוצאות: ${outMovements} | ביטולים: ${cancelMovements}</p>`;
						html += '</div>';
					}
					break;
			}
			
			html += '<div style="margin-top:30px; text-align: center;">';
			html += `<button onclick="exportReport('${type}')" class="btn-small" style="margin-right:10px;">ייצוא ל-CSV</button>`;
			html += `<button onclick="printReport('${type}')" class="btn-small">הדפסה</button>`;
			html += '</div>';
			
			reportContent.innerHTML = html;
		};
		
		function updateGenerateReportForMobile() {
			const originalGenerateReport = window.generateReport;
			
			window.generateReport = function(type) {
				// קרא לפונקציה המקורית
				originalGenerateReport(type);
				
				// הוסף תוויות data-label לטבלאות במובייל
				if (window.innerWidth <= 768) {
					setTimeout(() => {
						const tables = document.querySelectorAll('#reportContent table');
						tables.forEach(table => {
							const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
							
							table.querySelectorAll('tbody tr').forEach(row => {
								const cells = row.querySelectorAll('td');
								cells.forEach((cell, index) => {
									if (headers[index]) {
										cell.setAttribute('data-label', headers[index] + ':');
									}
								});
							});
						});
					}, 100);
				}
			};
		}

		// הפעל את העדכון
		document.addEventListener('DOMContentLoaded', updateGenerateReportForMobile);

		// פונקציה לרענון דוח
		window.regenerateReport = function(type) {
			generateReport(type);
		};
        window.exportReport = function(type) {
            // פונקציונליות ייצוא CSV נשארת כפי שהייתה
            showToast('ייצוא CSV לא זמין בדמו זה', 'info');
        };

        window.printReport = function(type) {
            window.print();
        };

        // --- טפסים ---
        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			// בדוק שלא נבחר "הוסף יחידה חדשה"
			const unitFields = ['baseUnitSingular', 'baseUnitPlural', 'packUnitSingular', 'packUnitPlural'];
			for (const fieldId of unitFields) {
				const field = document.getElementById(fieldId);
				if (field && field.value === '__add_new__') {
					showToast('יש לבחור יחידת מידה או להוסיף חדשה', 'error');
					field.focus();
					return;
				}
				if (field && !field.value) {
					showToast('יש למלא את כל שדות יחידות המידה', 'error');
					field.focus();
					return;
				}
			}

			try {
				// נרמל את שם המוצר
				const rawName = document.getElementById('itemName').value;
				const normalizedName = rawName.trim().replace(/\s+/g, ' ');
				
				if (normalizedName.length < 2) {
					showToast('שם המוצר חייב להכיל לפחות 2 תווים', 'error');
					document.getElementById('itemName').focus();
					return;
				}
				
				// בדוק אם המוצר כבר קיים (בדיקה מדויקת)
				const exactMatch = inventory.find(item => 
					normalizeProductName(item.name) === normalizeProductName(normalizedName)
				);
				
				if (exactMatch) {
					showToast(`מוצר בשם "${exactMatch.name}" כבר קיים במערכת`, 'error');
					document.getElementById('itemName').focus();
					return;
				}
				
				// חפש מוצרים דומים
				const similarProducts = findSimilarProducts(normalizedName, 0.7);
				
				if (similarProducts.length > 0) {
					const similarNames = similarProducts.slice(0, 3).map(p => p.name).join(', ');
					const message = `נמצאו מוצרים דומים: ${similarNames}.\nהאם אתה בטוח שברצונך להוסיף מוצר חדש?`;
					
					if (!confirm(message)) {
						document.getElementById('itemName').focus();
						return;
					}
				}
				
				const variants = [];
				const variantRows = document.querySelectorAll('#variantsContainer .form-row');
				
				if (variantRows.length === 0) {
					showToast('יש להוסיף לפחות פריט אחד', 'error');
					return;
				}
				
				// בדוק תקינות של כל וריאנט
				const variantKeys = new Set();
				
				for (const variantRow of variantRows) {
					const location = variantRow.querySelector('.variant-location').value;
					if (!location) {
						showToast('יש לבחור מיקום לכל הפריטים', 'error');
						variantRow.querySelector('.variant-location').focus();
						return;
					}
					
					const quantityPacks = parseInt(variantRow.querySelector('.variant-quantityPacks').value) || 0;
					const quantityUnits = parseInt(variantRow.querySelector('.variant-quantityUnits').value) || 0;
					const expiry = variantRow.querySelector('.variant-expiry').value;
					
					if (quantityPacks === 0 && quantityUnits === 0) {
						showToast('יש להזין כמות לכל פריט (חבילות או יחידות)', 'error');
						variantRow.querySelector('.variant-quantityPacks').focus();
						return;
					}
					
					// בדוק כפילות וריאנטים
					const variantKey = `${location}|${expiry}`;
					if (variantKeys.has(variantKey)) {
						showToast(`כבר קיים פריט עם אותו מיקום ותאריך תפוגה (${location})`, 'error');
						variantRow.querySelector('.variant-location').focus();
						return;
					}
					variantKeys.add(variantKey);
					
					variants.push({
						quantityPacks: quantityPacks,
						quantityUnits: quantityUnits,
						location: location,
						expiry: expiry
					});
				}

				const newItem = {
					name: normalizedName, // השתמש בשם המנורמל
					category: document.getElementById('itemCategory').value,
					minPacks: parseInt(document.getElementById('minPacks').value) || 0,
					baseUnitSingular: document.getElementById('baseUnitSingular').value,
					baseUnitPlural: document.getElementById('baseUnitPlural').value,
					packUnitSingular: document.getElementById('packUnitSingular').value,
					packUnitPlural: document.getElementById('packUnitPlural').value,
					unitsPerPack: parseInt(document.getElementById('unitsPerPack').value) || 1,
					variants: variants
				};

				await saveInventoryItem(newItem);
				inventory.push(newItem);
				updateStats();
				showToast('הפריט נוסף בהצלחה!', 'success');
				this.reset();
				document.getElementById('variantsContainer').innerHTML = '';
				addVariant(); // הוסף וריאנט ריק חדש
				showTab('inventory');
				
			} catch (error) {
				console.error('Error adding item:', error);
				showToast('שגיאה בהוספת הפריט: ' + error.message, 'error');
			}
		});

        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const now = new Date();
            const date = getFormattedDate();
            const time = getFormattedTime();
            const user = currentUser.fullName;

            const rows = document.querySelectorAll('#multiTransactionRows .form-row');
            let anySuccess = false;
            const errorMessages = [];

            for (const row of rows) {
                const productSelect = row.querySelector('.transProductSelect');
                const typeSelect = row.querySelector('.transTypeSelect');
                const quantityPacksInput = row.querySelector('.transQuantityPacksInput');
                const quantityUnitsInput = row.querySelector('.transQuantityUnitsInput');
                const notesInput = row.querySelector('.transNotesInput');

                if (!productSelect.value || !typeSelect.value) {
                    errorMessages.push('לא נבחר מוצר או סוג פעולה באחת השורות');
                    continue;
                }

                const productName = productSelect.value;
                const transType = typeSelect.value;
                const quantityPacks = parseInt(quantityPacksInput.value) || 0;
                const quantityUnits = parseInt(quantityUnitsInput.value) || 0;
                const notes = notesInput.value;

                if (quantityPacks === 0 && quantityUnits === 0) {
                    errorMessages.push(`יש להזין כמות חוקית ב-${productName}`);
                    continue;
                }

                const item = inventory.find(i => i.name === productName);
                if (!item) {
                    errorMessages.push(`המוצר "${productName}" לא נמצא`);
                    continue;
                }

                try {
                    if (transType === 'הוצאה') {
						// לוגיקה להוצאה מהמלאי
						const { plan, leftPacks, leftUnits } = pickVariantsForQuantity(item, quantityPacks, quantityUnits);
						
						if (leftPacks > 0 || leftUnits > 0) {
							errorMessages.push(`אין מספיק מלאי ל-${item.name} (חסרות ${leftPacks} חבילות ו-${leftUnits} יחידות)`);
							continue;
						}

						for (const pick of plan) {
							const variant = item.variants[pick.variantIndex];
							
							// הורד את החבילות
							variant.quantityPacks -= pick.takePacks;
							
							// הורד את היחידות
							variant.quantityUnits -= pick.takeUnits;
							
							// אם פרטנו חבילות, הוסף בחזרה את היחידות העודפות
							if (pick.returnUnits > 0) {
								variant.quantityUnits += pick.returnUnits;
							}
							
							// חשב את הכמות נטו שנלקחה
							const netUnits = (pick.takePacks * item.unitsPerPack) + pick.takeUnits - (pick.returnUnits || 0);
							const netPacks = Math.floor(netUnits / item.unitsPerPack);
							const netLooseUnits = netUnits % item.unitsPerPack;
							
							await saveMovement({
								date, time,
								product: item.name,
								location: variant.location,
								expiry: variant.expiry,
								type: transType,
								quantityPacks: netPacks,
								quantityUnits: netLooseUnits,
								user,
								notes: notes + (pick.returnUnits > 0 ? ` (פורטה חבילה)` : '')
							});
						}
						
						anySuccess = true;
					} else {
                        // הכנסה למלאי - הוספה לווריאנט הראשון
                        if (!item.variants || item.variants.length === 0) {
                            errorMessages.push(`אין וריאנטים פעילים ל-${item.name}`);
                            continue;
                        }
                        
                        item.variants[0].quantityPacks += quantityPacks;
                        item.variants[0].quantityUnits += quantityUnits;
                        
                        await saveMovement({
                            date, time,
                            product: item.name,
                            location: item.variants[0].location,
                            expiry: item.variants[0].expiry,
                            type: transType,
                            quantityPacks,
                            quantityUnits,
                            user,
                            notes
                        });
                        
                        anySuccess = true;
                    }
                    
                    await saveInventoryItem(item);
                    
                } catch (error) {
                    console.error('Error processing transaction:', error);
                    errorMessages.push(`שגיאה בעיבוד ${productName}: ${error.message}`);
                }
            }

            if (anySuccess) {
                await loadAllData();
                updateStats();
                showToast('התנועות נרשמו בהצלחה!', 'success');
                this.reset();
                document.getElementById('multiTransactionRows').innerHTML = '';
                addTransactionRow();
                displayMovements();
            }
            
            if (errorMessages.length) {
                showToast(errorMessages.join('\n'), 'error');
            }
        });

        // פונקציה עזר לחלוקת וריאנטים
        function pickVariantsForQuantity(item, packsNeeded, unitsNeeded) {
			const plan = [];
			let toTakePacks = packsNeeded;
			let toTakeUnits = unitsNeeded;
			
			// מיון וריאנטים לפי תוקף עולה (FEFO)
			const sortedVariants = (item.variants || []).map((v, idx) => ({...v, idx}))
				.sort((a, b) => {
					if (!a.expiry) return 1;
					if (!b.expiry) return -1;
					return new Date(a.expiry) - new Date(b.expiry);
				});

			// שלב 1: נסה לקחת חבילות שלמות
			for (const variant of sortedVariants) {
				if (toTakePacks <= 0) break;
				
				const availablePacks = variant.quantityPacks || 0;
				if (availablePacks > 0) {
					const takePacks = Math.min(toTakePacks, availablePacks);
					plan.push({
						variantIndex: variant.idx,
						takePacks: takePacks,
						takeUnits: 0,
						location: variant.location,
						expiry: variant.expiry
					});
					toTakePacks -= takePacks;
				}
			}

			// שלב 2: נסה לקחת יחידות בודדות
			for (const variant of sortedVariants) {
				if (toTakeUnits <= 0) break;
				
				const availableUnits = variant.quantityUnits || 0;
				if (availableUnits > 0) {
					const takeUnits = Math.min(toTakeUnits, availableUnits);
					// בדוק אם כבר יש תוכנית לווריאנט הזה
					const existingPlan = plan.find(p => p.variantIndex === variant.idx);
					if (existingPlan) {
						existingPlan.takeUnits += takeUnits;
					} else {
						plan.push({
							variantIndex: variant.idx,
							takePacks: 0,
							takeUnits: takeUnits,
							location: variant.location,
							expiry: variant.expiry
						});
					}
					toTakeUnits -= takeUnits;
				}
			}

			// שלב 3: אם עדיין חסרות יחידות, נסה לפרוט חבילות
			if (toTakeUnits > 0 && item.unitsPerPack > 0) {
				for (const variant of sortedVariants) {
					if (toTakeUnits <= 0) break;
					
					const availablePacks = variant.quantityPacks || 0;
					// בדוק כמה חבילות כבר מתוכננות לקחת מווריאנט זה
					const plannedPacks = plan.find(p => p.variantIndex === variant.idx)?.takePacks || 0;
					const remainingPacks = availablePacks - plannedPacks;
					
					if (remainingPacks > 0) {
						// חשב כמה חבילות נצטרך לפרוט
						const packsToBreak = Math.ceil(toTakeUnits / item.unitsPerPack);
						const actualPacksToBreak = Math.min(packsToBreak, remainingPacks);
						
						if (actualPacksToBreak > 0) {
							// מצא או צור תוכנית לווריאנט הזה
							const existingPlan = plan.find(p => p.variantIndex === variant.idx);
							if (existingPlan) {
								existingPlan.takePacks += actualPacksToBreak;
								// נותן את כל היחידות מהחבילות שנפרטו, פחות מה שאנחנו צריכים
								const totalUnitsFromPacks = actualPacksToBreak * item.unitsPerPack;
								const unitsToReturn = Math.max(0, totalUnitsFromPacks - toTakeUnits);
								existingPlan.returnUnits = (existingPlan.returnUnits || 0) + unitsToReturn;
							} else {
								const totalUnitsFromPacks = actualPacksToBreak * item.unitsPerPack;
								const unitsToReturn = Math.max(0, totalUnitsFromPacks - toTakeUnits);
								plan.push({
									variantIndex: variant.idx,
									takePacks: actualPacksToBreak,
									takeUnits: 0,
									returnUnits: unitsToReturn,
									location: variant.location,
									expiry: variant.expiry
								});
							}
							toTakeUnits -= Math.min(toTakeUnits, actualPacksToBreak * item.unitsPerPack);
						}
					}
				}
			}
			
			return {plan, leftPacks: toTakePacks, leftUnits: toTakeUnits};
		}
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser.permissions.includes('manage_users')) {
                showToast('אין לך הרשאה לנהל משתמשים', 'error');
                return;
            }
            
            try {
                const permissions = [];
                document.querySelectorAll('#addUserForm input[type="checkbox"]:checked').forEach(cb => {
                    permissions.push(cb.id.replace('perm_', ''));
                });
                
                const newUser = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    fullName: document.getElementById('newFullName').value,
                    role: document.getElementById('newRole').value,
                    permissions: permissions
                };
                
                if (users.find(u => u.username === newUser.username)) {
                    showToast('שם משתמש זה כבר קיים במערכת', 'error');
                    return;
                }
                
                await saveUser(newUser);
                users.push(newUser);
                showToast('המשתמש נוסף בהצלחה!', 'success');
                this.reset();
                displayUsers();
            } catch (error) {
                showToast('שגיאה בהוספת המשתמש', 'error');
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const originalUsername = document.getElementById('editUserOriginalUsername').value;
                const newUsername = document.getElementById('editUsername').value;

                const user = users.find(u => u.username === originalUsername);
                if (!user) {
                    showToast('משתמש לא נמצא', 'error');
                    return;
                }

                // עדכון פרטי המשתמש
                user.fullName = document.getElementById('editFullName').value;
                user.role = document.getElementById('editUserRole').value;

                // עדכון שם משתמש (אם שונה)
                if (originalUsername !== newUsername) {
                    await deleteUserFromDB(originalUsername);
                    user.username = newUsername;
                }

                // עדכון סיסמה רק אם הוזנה סיסמה חדשה
                const newPassword = document.getElementById('editPassword').value;
                if (newPassword) {
                    user.password = newPassword;
                }

                // עדכון הרשאות
                const permissions = [];
                document.querySelectorAll('#editUserForm input[type="checkbox"]:checked').forEach(cb => {
                    permissions.push(cb.id.replace('edit_perm_', ''));
                });
                user.permissions = permissions;

                await saveUser(user);
                showToast('המשתמש עודכן בהצלחה!', 'success');
                closeEditUserModal();
                displayUsers();
            } catch (error) {
                showToast('שגיאה בעדכון המשתמש', 'error');
            }
        });

        document.getElementById('editItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const originalName = document.getElementById('editItemOriginalName').value;
                const item = inventory.find(i => i.name === originalName);
                if (!item) return;

                const newName = document.getElementById('editItemName').value;

                item.name = newName;
                item.category = document.getElementById('editItemCategory').value;
                item.baseUnitSingular = document.getElementById('editBaseUnitSingular').value;
                item.baseUnitPlural = document.getElementById('editBaseUnitPlural').value;
                item.packUnitSingular = document.getElementById('editPackUnitSingular').value;
                item.packUnitPlural = document.getElementById('editPackUnitPlural').value;
                item.unitsPerPack = parseInt(document.getElementById('editUnitsPerPack').value) || 1;
                item.minPacks = parseInt(document.getElementById('editMinPacks').value) || 0;

                // אם השם השתנה, מחק את המוצר הקודם ב־Firebase
                if (originalName !== newName) {
                    await deleteInventoryItem(originalName);
                }

                await saveInventoryItem(item);
                await loadAllData();
                updateStats();
                showToast('המוצר עודכן בהצלחה!', 'success');
                closeEditModal();
                displayInventory();
            } catch (error) {
                showToast('שגיאה בעדכון המוצר', 'error');
            }
        });

        document.getElementById('editVariantForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const productName = document.getElementById('editVariantProductName').value;
                const variantIndex = parseInt(document.getElementById('editVariantIndex').value);
                const item = inventory.find(i => i.name === productName);

                if (!item || !item.variants || !item.variants[variantIndex]) return;

                item.variants[variantIndex] = {
                    quantityPacks: parseInt(document.getElementById('editVariantQuantityPacks').value) || 0,
                    quantityUnits: parseInt(document.getElementById('editVariantQuantityUnits').value) || 0,
                    location: document.getElementById('editVariantLocation').value,
                    expiry: document.getElementById('editVariantExpiry').value
                };

                await saveInventoryItem(item);
                await loadAllData();
                updateStats();
                showToast('הווריאנט עודכן בהצלחה!', 'success');
                closeEditVariantModal();
                displayInventory();
            } catch (error) {
                showToast('שגיאה בעדכון הווריאנט', 'error');
            }
        });

        document.getElementById('addVariantForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const productName = document.getElementById('addVariantProductName').value;
                const item = inventory.find(i => i.name === productName);
                if (!item) {
                    showToast('מוצר לא נמצא', 'error');
                    return;
                }
                
                const newVariant = {
                    quantityPacks: parseInt(document.getElementById('addVariantQuantityPacks').value) || 0,
                    quantityUnits: parseInt(document.getElementById('addVariantQuantityUnits').value) || 0,
                    location: document.getElementById('addVariantLocation').value,
                    expiry: document.getElementById('addVariantExpiry').value
                };
                
                if (!item.variants) item.variants = [];
                item.variants.push(newVariant);
                
                await saveInventoryItem(item);
                await loadAllData();
                updateStats();
                showToast('הווריאנט נוסף בהצלחה!', 'success');
                closeAddVariantModal();
                displayInventory();
            } catch (error) {
                showToast('שגיאה בהוספת הווריאנט', 'error');
            }
        });

        document.getElementById('editMovementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const id = document.getElementById('editMovementId').value;
                await db.collection('movements').doc(id).update({
                    product: document.getElementById('editMovementProduct').value,
                    type: document.getElementById('editMovementType').value,
                    quantityPacks: parseInt(document.getElementById('editMovementQuantityPacks').value) || 0,
                    quantityUnits: parseInt(document.getElementById('editMovementQuantityUnits').value) || 0,
                    notes: document.getElementById('editMovementNotes').value
                });
                
                await loadMovementsOnly();
                displayMovements();
                showToast('התנועה עודכנה בהצלחה!', 'success');
                closeEditMovementModal();
            } catch (error) {
                showToast('שגיאה בעדכון התנועה', 'error');
            }
        });

        // --- טיפול בבחירה "הוסף יחידה חדשה" ---
        document.addEventListener('change', function(e) {
			if (!e.target || !e.target.tagName || e.target.tagName !== 'SELECT') return;
			
			const handleUnitChange = (targetId, list, storageKey, promptText) => {
				if (e.target.id === targetId && e.target.value === '__add_new__') {
					e.preventDefault();
					
					const newUnit = prompt(promptText);
					if (newUnit && newUnit.trim()) {
						const trimmedUnit = newUnit.trim();
						
						// בדוק אם היחידה כבר קיימת
						if (list.includes(trimmedUnit)) {
							alert('יחידה זו כבר קיימת ברשימה');
							populateUnitsSelect(e.target, list);
							return;
						}
						
						// הוסף לרשימה
						list.push(trimmedUnit);
						list.sort(); // מיון אלפביתי
						
						// שמור ב-localStorage
						localStorage.setItem(storageKey, JSON.stringify(list));
						
						// עדכן את הרשימה הנפתחת עם הערך החדש כברירת מחדל
						populateUnitsSelect(e.target, list, trimmedUnit);
						
						// כפה את הערך החדש על ה-select
						setTimeout(() => {
							e.target.value = trimmedUnit;
						}, 0);
					} else {
						// אם ביטלו או לא הזינו כלום, אפס את הבחירה
						e.target.value = "";
					}
				}
			};

			handleUnitChange('baseUnitSingular', baseUnitsSingularList, 'baseUnitsSingularList', 'הזן שם יחידת מידה בסיסית (יחיד) חדשה:');
			handleUnitChange('baseUnitPlural', baseUnitsPluralList, 'baseUnitsPluralList', 'הזן שם יחידת מידה בסיסית (רבים) חדשה:');
			handleUnitChange('packUnitSingular', packUnitsSingularList, 'packUnitsSingularList', 'הזן שם יחידת אריזה (יחיד) חדשה:');
			handleUnitChange('packUnitPlural', packUnitsPluralList, 'packUnitsPluralList', 'הזן שם יחידת אריזה (רבים) חדשה:');
		});

		// עדכן גם את הפונקציה populateUnitsSelect:
		function populateUnitsSelect(selectElement, list, selectedValue = "") {
			if (!selectElement) return;
			
			// שמור את הערך הנוכחי אם לא סופק ערך חדש
			const currentValue = selectedValue || selectElement.value;
			
			selectElement.innerHTML = "";
			
			// אופציית ברירת מחדל
			const defaultOpt = document.createElement("option");
			defaultOpt.value = "";
			defaultOpt.textContent = "בחר יחידה";
			defaultOpt.disabled = true;
			defaultOpt.selected = !currentValue;
			selectElement.appendChild(defaultOpt);

			// הוסף את כל האופציות
			list.forEach(unit => {
				const option = document.createElement("option");
				option.value = unit;
				option.textContent = unit;
				option.selected = (currentValue === unit);
				selectElement.appendChild(option);
			});
			
			// אופציה להוספת יחידה חדשה
			const addNew = document.createElement("option");
			addNew.value = "__add_new__";
			addNew.textContent = "➕ הוסף יחידה חדשה...";
			addNew.style.fontWeight = "bold";
			addNew.style.borderTop = "1px solid #ddd";
			selectElement.appendChild(addNew);
			
			// וודא שהערך נבחר
			if (currentValue && currentValue !== "__add_new__") {
				selectElement.value = currentValue;
			}
		}

		// עדכן גם את הפונקציה populateUnitsSelect:
		function populateUnitsSelect(selectElement, list, selectedValue = "") {
			if (!selectElement) return;
			
			// שמור את הערך הנוכחי אם לא סופק ערך חדש
			const currentValue = selectedValue || selectElement.value;
			
			selectElement.innerHTML = "";
			
			// אופציית ברירת מחדל
			const defaultOpt = document.createElement("option");
			defaultOpt.value = "";
			defaultOpt.textContent = "בחר יחידה";
			defaultOpt.disabled = true;
			defaultOpt.selected = !currentValue;
			selectElement.appendChild(defaultOpt);

			// הוסף את כל האופציות
			list.forEach(unit => {
				const option = document.createElement("option");
				option.value = unit;
				option.textContent = unit;
				option.selected = (currentValue === unit);
				selectElement.appendChild(option);
			});
			
			// אופציה להוספת יחידה חדשה
			const addNew = document.createElement("option");
			addNew.value = "__add_new__";
			addNew.textContent = "➕ הוסף יחידה חדשה...";
			addNew.style.fontWeight = "bold";
			addNew.style.borderTop = "1px solid #ddd";
			selectElement.appendChild(addNew);
			
			// וודא שהערך נבחר
			if (currentValue && currentValue !== "__add_new__") {
				selectElement.value = currentValue;
			}
		}

        // --- סגירת מודלים בלחיצה מחוץ לתוכן ---
        window.onclick = function(event) {
            const modals = ['editModal', 'editVariantModal', 'editUserModal', 'addVariantModal', 'editMovementModal', 'editPickingModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // --- אתחול ---
        document.addEventListener('DOMContentLoaded', function() {
            // הוספת שורת תנועה ראשונה
            const transactionContainer = document.getElementById('multiTransactionRows');
            if (transactionContainer) {
                addTransactionRow();
            }

            // הוספת וריאנט ראשון בהוספת מוצר
            const variantsContainer = document.getElementById('variantsContainer');
            if (variantsContainer) {
                addVariant();
            }
        });
		
		// רענון אוטומטי של סטטיסטיקות כל דקה
		let statsInterval = null;

		function startStatsRefresh() {
			// עצור רענון קודם אם קיים
			if (statsInterval) {
				clearInterval(statsInterval);
			}
			
			// עדכן מיידית
			updateStats();
			
			// הגדר רענון כל 60 שניות
			statsInterval = setInterval(() => {
				updateStats();
				
				// בדוק אם עברנו לתאריך חדש (אחרי חצות)
				const currentDate = getFormattedDate();
				if (window.lastCheckedDate && window.lastCheckedDate !== currentDate) {
					// טען מחדש את התנועות אם עבר יום
					loadMovementsOnly().then(() => {
						updateStats();
					});
				}
				window.lastCheckedDate = currentDate;
				
			}, 60000); // כל 60 שניות
		}
		
		// === FAB Menu Functions ===
		function toggleFabMenu() {
			const fabMenu = document.getElementById('fabMenu');
			const fabButton = document.getElementById('fabButton');
			
			if (fabMenu.classList.contains('show')) {
				closeFabMenu();
			} else {
				openFabMenu();
			}
		}

		function openFabMenu() {
			const fabMenu = document.getElementById('fabMenu');
			const fabButton = document.getElementById('fabButton');
			const fabMenuItems = document.getElementById('fabMenuItems');
			
			// שנה את התוכן ל-X
			fabButton.innerHTML = '✕';
			
			// בנה את התפריט לפי הרשאות
			fabMenuItems.innerHTML = '';
			
			// רישום תנועה
			if (currentUser.permissions.includes('add_transaction')) {
				const item = createFabMenuItem('📝', 'רישום תנועה', 'transaction', () => {
					closeFabMenu();
					showTab('transaction');
				});
				fabMenuItems.appendChild(item);
			}
			
			// הוספת מוצר
			if (currentUser.permissions.includes('add_item')) {
				const item = createFabMenuItem('📦', 'מוצר חדש', 'product', () => {
					closeFabMenu();
					showTab('addItem');
				});
				fabMenuItems.appendChild(item);
			}
			
			// הוספת משתמש
			if (currentUser.permissions.includes('manage_users')) {
				const item = createFabMenuItem('👤', 'משתמש חדש', 'user', () => {
					closeFabMenu();
					showTab('users');
					setTimeout(() => {
						document.getElementById('addUserForm').scrollIntoView({ behavior: 'smooth' });
					}, 300);
				});
				fabMenuItems.appendChild(item);
			}
			
			// הצג את התפריט
			fabMenu.style.display = 'block';
			fabMenu.style.visibility = 'visible';
			
			// הוסף אנימציה עם delay קטן
			requestAnimationFrame(() => {
				fabButton.classList.add('menu-open');
				fabMenu.classList.add('show');
			});
		}

		function closeFabMenu() {
			const fabMenu = document.getElementById('fabMenu');
			const fabButton = document.getElementById('fabButton');
			
			// החזר את התוכן ל-+
			fabButton.innerHTML = '➕';
			
			// הסר את המחלקות לאנימציית סגירה
			fabButton.classList.remove('menu-open');
			fabMenu.classList.remove('show');
			
			// הסתר לגמרי אחרי האנימציה
			setTimeout(() => {
				fabMenu.style.visibility = 'hidden';
				fabMenu.style.display = 'none';
			}, 300);
		}

		// עדכן את createFabMenuItem להוסיף אפקט hover
		function createFabMenuItem(icon, label, className, onClick) {
			const item = document.createElement('div');
			item.className = 'fab-menu-item';
			item.style.cursor = 'pointer';
			
			const labelEl = document.createElement('span');
			labelEl.className = 'fab-menu-label';
			labelEl.textContent = label;
			
			const button = document.createElement('button');
			button.className = `fab-menu-button ${className}`;
			button.innerHTML = icon;
			button.type = 'button';
			
			// אפקט ripple על לחיצה
			button.addEventListener('click', function(e) {
				const ripple = document.createElement('span');
				ripple.className = 'ripple';
				this.appendChild(ripple);
				
				const rect = this.getBoundingClientRect();
				const x = e.clientX - rect.left;
				const y = e.clientY - rect.top;
				
				ripple.style.left = x + 'px';
				ripple.style.top = y + 'px';
				
				setTimeout(() => ripple.remove(), 600);
			});
			
			// פונקציית הלחיצה
			const handleClick = function(e) {
				e.preventDefault();
				e.stopPropagation();
				onClick();
			};
			
			item.addEventListener('click', handleClick);
			button.addEventListener('click', handleClick);
			
			item.appendChild(labelEl);
			item.appendChild(button);
			
			return item;
		}

		function stopStatsRefresh() {
			if (statsInterval) {
				clearInterval(statsInterval);
				statsInterval = null;
			}
		}
		
		function toggleTheme() {
			const html = document.documentElement;
			const currentTheme = html.getAttribute('data-theme');
			
			// הוסף class למניעת transitions
			html.classList.add('theme-transition');
			
			if (currentTheme === 'dark') {
				html.setAttribute('data-theme', 'light');
				localStorage.setItem('theme', 'light');
				document.getElementById('themeIcon').textContent = '🌙';
			} else {
				html.setAttribute('data-theme', 'dark');
				localStorage.setItem('theme', 'dark');
				document.getElementById('themeIcon').textContent = '☀️';
			}
			
			// הסר את ה-class אחרי קצת זמן
			setTimeout(() => {
				html.classList.remove('theme-transition');
			}, 100);
		}

		function applyTheme(theme) {
			const root = document.documentElement;
			const icon = document.getElementById('themeIcon');
			
			if (theme === 'dark') {
				root.setAttribute('data-theme', 'dark');
				icon.textContent = '☀️';
			} else if (theme === 'light') {
				root.setAttribute('data-theme', 'light');
				icon.textContent = '🌙';
			} else {
				root.removeAttribute('data-theme');
				icon.textContent = '🌓';
			}
		}

		// Apply saved theme on load
		window.addEventListener('DOMContentLoaded', () => {
			const savedTheme = localStorage.getItem('theme');
			
			// הוסף class למניעת transitions בטעינה ראשונית
			document.documentElement.classList.add('theme-transition');
			
			if (savedTheme === 'dark') {
				document.documentElement.setAttribute('data-theme', 'dark');
				document.getElementById('themeIcon').textContent = '☀️';
			} else {
				document.documentElement.setAttribute('data-theme', 'light');
				document.getElementById('themeIcon').textContent = '🌙';
			}
			
			// הסר את ה-class אחרי הטעינה
			setTimeout(() => {
				document.documentElement.classList.remove('theme-transition');
			}, 100);
		});

		// עדכן את showMainScreen להפעיל רענון אוטומטי
		const originalShowMainScreen = showMainScreen;
		showMainScreen = function() {
			originalShowMainScreen();
			startStatsRefresh();
		};

		// עדכן את logout לעצור רענון אוטומטי
		const originalLogout = logout;
		logout = function() {
			stopStatsRefresh();
			originalLogout();
		};

		// עדכן את window.addEventListener כדי לנקות בעת סגירת הדף
		window.addEventListener('beforeunload', () => {
			stopStatsRefresh();
		});
		
		// בדוק הרשאות כל 5 דקות
		setInterval(() => {
			if (currentUser) {
				checkRealtimePermissions();
			}
		}, 300000); // 300000ms = 5 דקות
		
		// PWA Support
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/sw.js').catch(() => {
				// Service worker registration failed
			});
		}

		// Add to home screen prompt
		let deferredPrompt;
		window.addEventListener('beforeinstallprompt', (e) => {
			e.preventDefault();
			deferredPrompt = e;
		});
		
		// === Create Service Worker File ===
		function createServiceWorker() {
			const swContent = `
		// Service Worker for offline support
		const CACHE_NAME = 'cinema-inventory-v1';
		const urlsToCache = [
		  '/',
		  '/index.html',
		  '/pick.html'
		];

		self.addEventListener('install', event => {
		  event.waitUntil(
			caches.open(CACHE_NAME)
			  .then(cache => cache.addAll(urlsToCache))
		  );
		});

		self.addEventListener('fetch', event => {
		  event.respondWith(
			caches.match(event.request)
			  .then(response => response || fetch(event.request))
		  );
		});`;
			
			console.log('Service Worker code:', swContent);
			console.log('צור קובץ בשם sw.js והעתק את הקוד מה-console');
		}
    </script>

    <footer style="text-align:center; padding:20px 0; color:#666; background:transparent; font-size:14px;">
        © 2025 כל הזכויות שמורות לחיליק ביטאן
    </footer>
</body>
</html>