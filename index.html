<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××œ××™ - ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×”</title>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; }
        
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background-color:#f5f5f5;color:#333;line-height:1.6;min-height:100vh;}
        .login-container {display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
        .login-box {background:white;padding:40px;border-radius:12px;box-shadow:0 15px 35px rgba(0,0,0,0.2);width:90%;max-width:400px;}
        .login-box h1 {text-align:center;margin-bottom:30px;color:#333;}
        .main-container {display:none;min-height:100vh;}
        .top-nav {background:#2c3e50;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
        .nav-brand {font-size:20px;font-weight:bold;display:flex;align-items:center;gap:10px;}
        .nav-user {display:flex;align-items:center;gap:15px;}
        .user-info {display:flex;flex-direction:column;align-items:flex-end;font-size:14px;}
        .user-role {font-size:12px;opacity:.8;}
        .logout-btn {background:#e74c3c;color:white;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;font-size:14px;}
        .logout-btn:hover {background:#c0392b;}
        .container {max-width:1400px;margin:0 auto;padding:20px;}
        .tabs {display:flex;gap:5px;margin-bottom:20px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:5px;}
        .tab {padding:12px 20px;background:white;border:2px solid #ddd;cursor:pointer;border-radius:8px;transition:all .3s;font-weight:500;white-space:nowrap;flex-shrink:0;}
        .tab:hover {background:#f8f9fa;}
        .tab.active {background:#3498db;color:white;border-color:#3498db;}
        .tab.disabled {opacity:.5;cursor:not-allowed;}
        .tab-content {display:none;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .tab-content.active {display:block;}
        .table-wrapper {overflow-x:auto;-webkit-overflow-scrolling:touch;}
        table {width:100%;border-collapse:collapse;margin-top:20px;min-width:600px;}
        th,td {padding:12px;text-align:right;border:1px solid #ddd;}
        th {background:#34495e;color:white;font-weight:600;position:sticky;top:0;z-index:10;}
        tr:nth-child(even) {background:#f8f9fa;}
        tr:hover {background:#e8f4fd;}
        .low-stock {background-color:#ffebee!important;color:#c62828;font-weight:bold;}
        .expiring-soon {background-color:#fff3e0!important;color:#ef6c00;}
        .form-group {margin-bottom:20px;}
        label {display:block;margin-bottom:5px;font-weight:600;color:#555;}
        input,select {width:100%;padding:12px;border:1px solid #ddd;border-radius:4px;font-size:16px;-webkit-appearance:none;}
        input:focus,select:focus {outline:none;border-color:#3498db;box-shadow:0 0 0 2px rgba(52,152,219,0.2);}
        button {background:#3498db;color:white;padding:12px 30px;border:none;border-radius:4px;cursor:pointer;font-size:16px;font-weight:600;transition:background .3s;width:auto;}
        button:hover {background:#2980b9;}
        button:disabled {background:#95a5a6;cursor:not-allowed;}
        .stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px;}
        .stat-card {background:white;padding:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);text-align:center;transition:transform .3s;}
        .stat-card:hover {transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.15);}
        .stat-card h3 {color:#7f8c8d;font-size:14px;margin-bottom:10px;}
        .stat-card .value {font-size:28px;font-weight:bold;color:#2c3e50;}
        .alert {padding:15px;margin-bottom:20px;border-radius:4px;display:flex;align-items:center;gap:10px;}
        .alert-warning {background:#fff3cd;color:#856404;border:1px solid #ffeeba;}
        .alert-danger {background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
        .alert-success {background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
        .form-row {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
        .user-list {margin-top:20px;}
        .user-card {background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
        .user-details {flex:1;}
        .user-actions {display:flex;gap:10px;}
        .btn-small {padding:6px 15px;font-size:14px;width:auto;}
        .btn-danger {background:#e74c3c;}
        .btn-danger:hover {background:#c0392b;}
        .permission-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px;}
        .permission-item {display:flex;align-items:center;gap:10px;}
        /* Checkbox styles - better visibility */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        input[type="checkbox"]:checked {
            background-color: #3498db;
            border-color: #3498db;
        }
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        input[type="checkbox"]:hover {
            border-color: #3498db;
        }
		.expiring-critical {
			background-color: #ffcdd2 !important;
			color: #b71c1c;
			font-weight: bold;
		}
		.expiring-soon {
			background-color: #ffe0b2 !important;
			color: #e65100;
		}
		.expiring-warning {
			background-color: #fff9c4 !important;
			color: #f57f17;
}
        .permission-item input[type="checkbox"] {width:20px;height:20px;cursor:pointer;}
        .toast {position:fixed;bottom:20px;right:20px;background:#333;color:white;padding:15px 25px;border-radius:4px;box-shadow:0 4px 10px rgba(0,0,0,0.3);transform:translateY(100px);opacity:0;transition:all .3s;z-index:1000;}
        .toast.show {transform:translateY(0);opacity:1;}
        @media (max-width:768px){.container{padding:10px;}.tabs{margin-bottom:15px;}.tab{padding:10px 15px;font-size:14px;}.tab-content{padding:15px;}.stats{grid-template-columns:1fr 1fr;gap:10px;}.stat-card{padding:15px;}.stat-card .value{font-size:24px;}table{font-size:14px;}th,td{padding:8px 6px;}.nav-brand{font-size:16px;}.user-info{display:none;}.form-row{grid-template-columns:1fr;}}
        @media (max-width:480px){.stats{grid-template-columns:1fr;}.login-box{padding:30px 20px;}}
		.variant-row {
            background-color: #f9f9f9;
        }
        .expand-btn {
            cursor: pointer;
            padding: 2px 6px;
        }
		
		#editPickingListArea {
			max-height: 340px;
			overflow-y: auto;
			margin-bottom: 18px;
		}
		.modal-content button.btn-main {
			min-width: 120px;
			width: auto;
			padding: 7px 22px;
			font-size: 1em;
			margin: 7px 6px 0 6px;
			display: inline-block;
			box-sizing: border-box;
		}
		.picking-table th, .picking-table td {
			padding: 6px 8px;
			font-size: 1em;
			white-space: nowrap;
			max-width: 140px;
			text-overflow: ellipsis;
			overflow: hidden;
		}
		.picking-table {
			width: auto;
			margin: 0 auto 10px auto;
			min-width: 0;
		}
        /* ×ª×™×§×•×Ÿ ×ª×¦×•×’×ª ×›××•×™×•×ª ×©×œ×™×œ×™×•×ª */
        input[type="number"] {
            min: 0;
        }
        .error-input {
            border-color: #e74c3c !important;
            background-color: #ffe6e6 !important;
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ¬ ××¢×¨×›×ª ××œ××™ - ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×” ğŸ¿</h1>
			<form id="loginForm">
				<div class="form-group">
					<label for="username">×©× ××©×ª××©</label>
					<input type="text" id="username" required autocomplete="username">
				</div>
				<div class="form-group">
					<label for="password">×¡×™×¡××”</label>
					<input type="password" id="password" required autocomplete="current-password">
				</div>
				<button type="submit">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
			</form>
        </div>
    </div>
    
    <!-- ××¡×š ×¨××©×™ -->
    <div class="main-container" id="mainScreen">
        <nav class="top-nav">
            <div class="nav-brand">
                <span>ğŸ¬</span>
                <span>××¢×¨×›×ª × ×™×”×•×œ ××œ××™ ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×”</span>
				<span>ğŸ¿</span>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span id="currentUserName"></span>
                    <span class="user-role" id="currentUserRole"></span>
                </div>
                <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
            </div>
        </nav>
        
        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <h3>×¡×”"×› ××•×¦×¨×™×</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>××•×¦×¨×™× ×‘××œ××™ × ××•×š</h3>
                    <div class="value" id="lowStockCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>××•×¦×¨×™× ×œ×ª×¤×•×’×” ×§×¨×•×‘×”</h3>
                    <div class="value" id="expiringCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>×ª× ×•×¢×•×ª ×”×™×•×</h3>
                    <div class="value" id="todayMovements">0</div>
                </div>
            </div>
            
			<div class="tabs">
				<div class="tab active" data-tab="inventory" data-permission="view_inventory" onclick="showTab(event, 'inventory')">××œ××™ × ×•×›×—×™</div>
				<div class="tab" data-tab="movements" data-permission="view_movements" onclick="showTab(event, 'movements')">×ª× ×•×¢×•×ª ××œ××™</div>
				<div class="tab" data-tab="transaction" data-permission="add_transaction" onclick="showTab(event, 'transaction')">×¨×™×©×•× ×ª× ×•×¢×”</div>
				<div class="tab" data-tab="addItem" data-permission="add_item" onclick="showTab(event, 'addItem')">×”×•×¡×¤×ª ×¤×¨×™×˜</div>
				<div class="tab" data-tab="users" data-permission="manage_users" onclick="showTab(event, 'users')">× ×™×”×•×œ ××©×ª××©×™×</div>
				<div class="tab" data-tab="reports" data-permission="view_reports" onclick="showTab(event, 'reports')">×“×•×—×•×ª</div>
				<div class="tab" data-tab="pickings" data-permission="view_pickings" onclick="showTab(event, 'pickings')">×œ×™×§×•×˜×™×</div>

			</div>
            
            <!-- ×˜××‘ ××œ××™ × ×•×›×—×™ -->
            <div id="inventory" class="tab-content active">
                <h2>××œ××™ × ×•×›×—×™</h2>
				<div style="display:flex; gap:15px; align-items:center; margin-bottom: 10px;">
					<input type="text" id="inventorySearch" placeholder="×—×¤×© ××•×¦×¨..." style="padding:10px; font-size:16px; width:250px; border-radius:6px; border:1px solid #ccc;">
					<select id="categoryFilter" style="padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc;" aria-label="×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”" title="×‘×—×¨ ×§×˜×’×•×¨×™×” ×œ×¡×™× ×•×Ÿ">
						<option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
						<option value="××–×•×Ÿ">××–×•×Ÿ</option>
						<option value="××©×§××•×ª">××©×§××•×ª</option>
						<option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
						<option value="×¦×™×•×“">×¦×™×•×“</option>
						<option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
					</select>
				</div>
                <div id="alerts"></div>
                <div class="table-wrapper">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
								<th></th>
								<th onclick="sortInventory('name')">×©× ××•×¦×¨ &#x25B2;&#x25BC;</th>
								<th onclick="sortInventory('category')">×§×˜×’×•×¨×™×” &#x25B2;&#x25BC;</th>
								<th onclick="sortInventory('quantity')">×›××•×ª ×–××™× ×” &#x25B2;&#x25BC;</th>
								<th onclick="sortInventory('min')">××™× ×™××•× &#x25B2;&#x25BC;</th>
								<th onclick="sortInventory('expiry')">×ª×•×§×£ ×§×¨×•×‘ &#x25B2;&#x25BC;</th>
								<th onclick="sortInventory('status')">×¡×˜×˜×•×¡ &#x25B2;&#x25BC;</th>
								<th></th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ×˜××‘ ×ª× ×•×¢×•×ª ××œ××™ -->
            <div id="movements" class="tab-content">
                <h2>×ª× ×•×¢×•×ª ××œ××™</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>×ª××¨×™×š</th>
                                <th>×©×¢×”</th>
                                <th>×©× ××•×¦×¨</th>
                                <th>××™×§×•×</th>
                                <th>×ª×•×§×£</th>
                                <th>×¤×¢×•×œ×”</th>
                                <th>×›××•×ª</th>
                                <th>××‘×¦×¢</th>
                                <th>×”×¢×¨×•×ª</th>
								<th></th>
                            </tr>
                        </thead>
                        <tbody id="movementsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ×˜××‘ ×¨×™×©×•× ×ª× ×•×¢×” -->
			<div id="transaction" class="tab-content">
				<h2>×¨×™×©×•× ×ª× ×•×¢×ª ××œ××™</h2>
				<form id="transactionForm">
					<div id="multiTransactionRows"></div>
					<button type="button" onclick="addTransactionRow()">â• ×”×•×¡×£ ××•×¦×¨/×•×¨×™×× ×˜</button>
					<button type="submit">×¨×©×•× ×ª× ×•×¢×”</button>
					<div id="pickingListContainer" style="margin: 15px 0;"></div>
				</form>
			</div>
						
            <!-- ×˜××‘ ×”×•×¡×¤×ª ×¤×¨×™×˜ -->
            <div id="addItem" class="tab-content">
				<h2>×”×•×¡×¤×ª ××•×¦×¨ ×—×“×© ×œ××œ××™</h2>
				<form id="addItemForm">
					<div class="form-row">
						<div class="form-group">
							<label for="itemName">×©× ××•×¦×¨</label>
							<input type="text" id="itemName" required>
						</div>
						<div class="form-group">
							<label for="itemCategory">×§×˜×’×•×¨×™×”</label>
							<select id="itemCategory" required aria-label="×§×˜×’×•×¨×™×™×ª ×”××•×¦×¨" title="×‘×—×¨ ×§×˜×’×•×¨×™×” ×œ××•×¦×¨">
								<option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
								<option value="××–×•×Ÿ">××–×•×Ÿ</option>
								<option value="××©×§××•×ª">××©×§××•×ª</option>
								<option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
								<option value="×¦×™×•×“">×¦×™×•×“</option>
								<option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
							</select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="baseUnitSingular">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×™×—×™×“)</label>
								<select id="baseUnitSingular" required aria-label="×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª ×‘×™×—×™×“" title="×‘×—×¨ ×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª ×‘×™×—×™×“"></select>
						</div>
						<div class="form-group">
							<label for="baseUnitPlural">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×¨×‘×™×)</label>
							<select id="baseUnitPlural" required aria-label="×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª ×‘×¨×‘×™×" title="×‘×—×¨ ×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª ×‘×¨×‘×™×"></select>
						</div>
						<div class="form-group">
							<label for="packUnitSingular">×©× ×™×—×™×“×ª ××¨×™×–×” (×™×—×™×“)</label>
							<select id="packUnitSingular" required aria-label="×™×—×™×“×ª ××¨×™×–×” ×‘×™×—×™×“" title="×‘×—×¨ ×™×—×™×“×ª ××¨×™×–×” ×‘×™×—×™×“"></select>
						</div>
						<div class="form-group">
							<label for="packUnitPlural">×©× ×™×—×™×“×ª ××¨×™×–×” (×¨×‘×™×)</label>
							<select id="packUnitPlural" required aria-label="×™×—×™×“×ª ××¨×™×–×” ×‘×¨×‘×™×" title="×‘×—×¨ ×™×—×™×“×ª ××¨×™×–×” ×‘×¨×‘×™×"></select>
						</div>
						<div class="form-group">
							<label for="unitsPerPack">×›××” ×™×—×™×“×•×ª ×‘×›×œ ××¨×™×–×”</label>
							<input type="number" id="unitsPerPack" min="1" required>
						</div>
						<div class="form-group">
							<label for="minPacks">×›××•×ª ××™× ×™××•× (×‘×—×‘×™×œ×•×ª)</label>
							<input type="number" id="minPacks" min="0" required>
						</div>
					</div>
					<h3>×¤×¨×™×˜×™×</h3>
					<div id="variantsContainer"></div>
					<button type="button" onclick="addVariant()">×”×•×¡×£ ×¤×¨×™×˜</button>
					<button type="submit" style="margin-top: 20px;">×¡×™×™×</button>
				</form>
            </div>
            
            <!-- ×˜××‘ × ×™×”×•×œ ××©×ª××©×™× -->
            <div id="users" class="tab-content">
                <h2>× ×™×”×•×œ ××©×ª××©×™×</h2>
                
                <h3>×”×•×¡×¤×ª ××©×ª××© ×—×“×©</h3>
                <form id="addUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUsername">×©× ××©×ª××©</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">×¡×™×¡××”</label>
                            <input type="password" id="newPassword" required>
                        </div>
                         <div class="form-group">
							<label for="newFullName">×©× ××œ×</label>
							<input type="text" id="newFullName" required>
						</div>
						<div class="form-group">
							<label for="newRole">×ª×¤×§×™×“</label>
							<select id="newRole" required aria-label="×ª×¤×§×™×“ ×”××©×ª××©" title="×‘×—×¨ ×ª×¤×§×™×“ ×œ××©×ª××©">
								<option value="">×‘×—×¨ ×ª×¤×§×™×“</option>
								<option value="×× ×”×œ ××¢×¨×›×ª">×× ×”×œ ××¢×¨×›×ª</option>
								<option value="×× ×”×œ ××ª×—×">×× ×”×œ ××ª×—×</option>
								<option value="×× ×”×œ/×ª ××©××¨×ª">×× ×”×œ/×ª ××©××¨×ª</option>
								<option value="××—×¡× ××™">××—×¡× ××™</option>
								<option value="×¡×•×¤×¨×•×•×™×™×–×¨">×¡×•×¤×¨×•×•×™×™×–×¨</option>
								<option value="××–× ×•× ××™">××–× ×•× ××™</option>
							</select>
						</div>
                    </div>
                    
                    <h4>×”×¨×©××•×ª</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_inventory" checked>
                            <label for="perm_view_inventory">×¦×¤×™×™×” ×‘××œ××™</label>
                        </div>
						<div class="permission-item">
							<input type="checkbox" id="perm_view_pickings">
							<label for="perm_view_pickings">×¦×¤×™×™×” ×‘×œ×™×§×•×˜×™×</label>
						</div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_movements" checked>
                            <label for="perm_view_movements">×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_transaction">
                            <label for="perm_add_transaction">×¨×™×©×•× ×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_item">
                            <label for="perm_add_item">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_manage_users">
                            <label for="perm_manage_users">× ×™×”×•×œ ××©×ª××©×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_reports">
                            <label for="perm_view_reports">×¦×¤×™×™×” ×‘×“×•×—×•×ª</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">×”×•×¡×£ ××©×ª××©</button>
                </form>
                
                <h3 style="margin-top: 40px;">××©×ª××©×™× ×§×™×™××™×</h3>
                <div class="user-list" id="userList"></div>
            </div>
            
            <!-- ×˜××‘ ×“×•×—×•×ª -->
            <div id="reports" class="tab-content">
                <h2>×“×•×—×•×ª</h2>
                <div class="form-row">
                    <button onclick="generateReport('inventory')" class="btn-small">×“×•×— ××œ××™ ××œ×</button>
                    <button onclick="generateReport('lowStock')" class="btn-small">×“×•×— ×—×•×¡×¨×™×</button>
                    <button onclick="generateReport('expiring')" class="btn-small">×“×•×— ×ª×¤×•×’×•×ª</button>
                    <button onclick="generateReport('movements')" class="btn-small">×“×•×— ×ª× ×•×¢×•×ª</button>
                </div>
                <div id="reportContent" style="margin-top: 30px;"></div>
            </div>
			<div id="pickings" class="tab-content">
				<h2>×“×•×— ×œ×™×§×•×˜×™×</h2>
				<div id="pickingsTableContainer"></div>
			</div>
        </div>
        <!-- ××•×“×œ ×¢×¨×™×›×ª ×•×¨×™×× ×˜ -->
		<div id="editVariantModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>×¢×¨×™×›×ª ×•×¨×™×× ×˜</h2>
					<span class="close" onclick="closeEditVariantModal()">&times;</span>
				</div>
				<form id="editVariantForm">
					<input type="hidden" id="editVariantProductName">
					<input type="hidden" id="editVariantIndex">
					<div class="form-row">
						<div class="form-group">
							 <label for="editVariantQuantityPacks">×›××•×ª ×—×‘×™×œ×•×ª</label>
							<input type="number" id="editVariantQuantityPacks" min="0" required>
						</div>	
						<div class="form-group">
							<label for="editVariantQuantityUnits">×™×—×™×“×•×ª ×‘×•×“×“×•×ª</label>
							<input type="number" id="editVariantQuantityUnits" min="0" required>
						</div>
						
						<div class="form-group">
							<label for="editVariantLocation">××™×§×•×</label>
							<select id="editVariantLocation" required aria-label="××™×§×•× ×”××—×¡×Ÿ" title="×‘×—×¨ ××™×§×•× ××—×¡×Ÿ">
								<option value="">×‘×—×¨ ××—×¡×Ÿ</option>
								<option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
								<option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
								<option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
								<option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
								<option value="×˜×›× ×™">×˜×›× ×™</option>
								<option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
								<option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
							</select>
						</div>
						<div class="form-group">
							 <label for="editVariantExpiry">×ª××¨×™×š ×ª×¤×•×’×”</label>
							<input type="date" id="editVariantExpiry">
						</div>
					</div>

					<button type="submit">×©××•×¨ ×©×™× ×•×™×™×</button>
				</form>
			</div>
		</div>
		
		<!-- ××•×“×œ ×¢×¨×™×›×ª ×ª× ×•×¢×” -->
		<div id="editMovementModal" class="modal">
		  <div class="modal-content">
			<div class="modal-header">
			  <h2>×¢×¨×™×›×ª ×ª× ×•×¢×”</h2>
			  <span class="close" onclick="closeEditMovementModal()">&times;</span>
			</div>
			<form id="editMovementForm">
			  <input type="hidden" id="editMovementId">
			  <div class="form-row">
				<div class="form-group">
				  <label for="editMovementProduct">××•×¦×¨</label>
				  <input type="text" id="editMovementProduct" required>
				</div>
				<div class="form-group">
				  <label for="editMovementType">×¡×•×’ ×¤×¢×•×œ×”</label>
				  <select id="editMovementType" required aria-label="×¡×•×’ ×”×¤×¢×•×œ×”" title="×‘×—×¨ ×¡×•×’ ×¤×¢×•×œ×”">
					<option value="×”×•×¦××”">×”×•×¦××” ××”××œ××™</option>
					<option value="×”×›× ×¡×”">×”×›× ×¡×” ×œ××œ××™</option>
				  </select>
				</div>
			  </div>
			  <div class="form-row">
				<div class="form-group">
				  <label for="editMovementQuantityPacks">×›××•×ª ×—×‘×™×œ×•×ª</label>
				  <input type="number" id="editMovementQuantityPacks" min="0" required>
				</div>
				<div class="form-group">
				  <label for="editMovementQuantityUnits">×›××•×ª ×™×—×™×“×•×ª</label>
				  <input type="number" id="editMovementQuantityUnits" min="0" required>
				</div>
			  </div>
			  <div class="form-row">
				<div class="form-group">
				  <label for="editMovementLocation">××™×§×•×</label>
				  <input type="text" id="editMovementLocation">
				</div>
				<div class="form-group">
				  <label for="editMovementExpiry">×ª×•×§×£</label>
				  <input type="date" id="editMovementExpiry">
				</div>
				<div class="form-group">
				  <label for="editMovementNotes">×”×¢×¨×•×ª</label>
				  <input type="text" id="editMovementNotes">
				</div>
			  </div>
			  <button type="submit">×©××•×¨</button>
			</form>
		  </div>
		</div>

        <!-- ××•×“×œ ×¢×¨×™×›×ª ××•×¦×¨ -->
		<div id="editModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>×¢×¨×™×›×ª ××•×¦×¨</h2>
					<span class="close" onclick="closeEditModal()">&times;</span>
				</div>
				<form id="editItemForm">
					<input type="hidden" id="editItemOriginalName">
					<div class="form-row">
						<div class="form-group">
							<label for="editItemName">×©× ××•×¦×¨</label>
							<input type="text" id="editItemName" required>
						</div>
						<div class="form-group">
							<label for="editItemCategory">×§×˜×’×•×¨×™×”</label>
							<select id="editItemCategory" required aria-label="×§×˜×’×•×¨×™×™×ª ×”××•×¦×¨" title="×‘×—×¨ ×§×˜×’×•×¨×™×” ×œ××•×¦×¨">
								<option value="××–×•×Ÿ">××–×•×Ÿ</option>
								<option value="××©×§××•×ª">××©×§××•×ª</option>
								<option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
								<option value="×¦×™×•×“">×¦×™×•×“</option>
								<option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
							</select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="editBaseUnitSingular">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×™×—×™×“)</label>
							<input type="text" id="editBaseUnitSingular" required>
						</div>
						<div class="form-group">
							<label for="editBaseUnitPlural">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×¨×‘×™×)</label>
							<input type="text" id="editBaseUnitPlural" required>
						</div>
						<div class="form-group">
							<label for="editPackUnitSingular">×©× ×™×—×™×“×ª ××¨×™×–×” (×™×—×™×“)</label>
							<input type="text" id="editPackUnitSingular" required>
						</div>
						<div class="form-group">
							<label for="editPackUnitPlural">×©× ×™×—×™×“×ª ××¨×™×–×” (×¨×‘×™×)</label>
							<input type="text" id="editPackUnitPlural" required>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="editUnitsPerPack">××¡×¤×¨ ×™×—×™×“×•×ª ×‘×›×œ ××¨×™×–×”</label>
							<input type="number" id="editUnitsPerPack" min="1" required>
						</div>
						<div class="form-group">
							<label for="editMinPacks">×›××•×ª ××™× ×™××•× ×‘××œ××™ (×‘×—×‘×™×œ×•×ª)</label>
							<input type="number" id="editMinPacks" min="0" required>
						</div>
					</div>
					<button type="submit">×©××•×¨ ×©×™× ×•×™×™×</button>
				</form>
			</div>
		</div>

		<div id="addVariantModal" class="modal">
		  <div class="modal-content">
			<div class="modal-header">
			  <h2>×”×•×¡×¤×ª ×•×¨×™×× ×˜ ×—×“×©</h2>
			  <span class="close" onclick="closeAddVariantModal()">&times;</span>
			</div>
			<form id="addVariantForm">
			  <input type="hidden" id="addVariantProductName">
			  <div class="form-row">
				<div class="form-group">
				  <label for="addVariantQuantityPacks">×›××•×ª ×—×‘×™×œ×•×ª</label>
				  <input type="number" id="addVariantQuantityPacks" min="0" required>
				</div>
				<div class="form-group">
				  <label for="addVariantQuantityUnits">×™×—×™×“×•×ª ×‘×•×“×“×•×ª</label>
				  <input type="number" id="addVariantQuantityUnits" min="0" required>
				</div>
				<div class="form-group">
				  <label for="addVariantLocation">××™×§×•×</label>
				  <select id="addVariantLocation" required aria-label="××™×§×•× ×”××—×¡×Ÿ" title="×‘×—×¨ ××™×§×•× ××—×¡×Ÿ">
					<option value="">×‘×—×¨ ××—×¡×Ÿ</option>
					<option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
					<option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
					<option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
					<option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
					<option value="×˜×›× ×™">×˜×›× ×™</option>
					<option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
					<option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
				  </select>
				</div>
				<div class="form-group">
				  <label for="addVariantExpiry">×ª××¨×™×š ×ª×¤×•×’×”</label>
				  <input type="date" id="addVariantExpiry">
				</div>
			  </div>
			  <button type="submit">×”×•×¡×£ ×•×¨×™×× ×˜</button>
			</form>
		  </div>
		</div>
        
        <!-- ××•×“×œ ×¢×¨×™×›×ª ××©×ª××© -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>×¢×¨×™×›×ª ××©×ª××©</h2>
                    <span class="close" onclick="closeEditUserModal()">&times;</span>
                </div>
                <form id="editUserForm">
                    <input type="hidden" id="editUserOriginalUsername">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUsername">×©× ××©×ª××©</label>
                            <input type="text" id="editUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="editPassword">×¡×™×¡××” ×—×“×©×” (×”×©××¨ ×¨×™×§ ×× ×œ× ×¨×•×¦×” ×œ×©× ×•×ª)</label>
                            <input type="password" id="editPassword">
                        </div>
                        <div class="form-group">
                            <label for="editFullName">×©× ××œ×</label>
                            <input type="text" id="editFullName" required>
                        </div>
						<div class="form-group">
							<label for="editUserRole">×ª×¤×§×™×“</label>
							<select id="editUserRole" required aria-label="×ª×¤×§×™×“ ×”××©×ª××©" title="×‘×—×¨ ×ª×¤×§×™×“ ×œ××©×ª××©">
								<option value="">×‘×—×¨ ×ª×¤×§×™×“</option>
								<option value="×× ×”×œ ××¢×¨×›×ª">×× ×”×œ ××¢×¨×›×ª</option>
								<option value="×× ×”×œ ××ª×—×">×× ×”×œ ××ª×—×</option>
								<option value="×× ×”×œ/×ª ××©××¨×ª">×× ×”×œ/×ª ××©××¨×ª</option>
								<option value="××—×¡× ××™">××—×¡× ××™</option>
								<option value="×¡×•×¤×¨×•×•×™×™×–×¨">×¡×•×¤×¨×•×•×™×™×–×¨</option>
								<option value="××–× ×•× ××™">××–× ×•× ××™</option>
							</select>
						</div>
                    </div>
                    
                    <h4>×”×¨×©××•×ª</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_inventory">
                            <label for="edit_perm_view_inventory">×¦×¤×™×™×” ×‘××œ××™</label>
                        </div>
						<div class="permission-item">
							<input type="checkbox" id="edit_perm_view_pickings">
							<label for="edit_perm_view_pickings">×¦×¤×™×™×” ×‘×œ×™×§×•×˜×™×</label>
						</div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_movements">
                            <label for="edit_perm_view_movements">×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_transaction">
                            <label for="edit_perm_add_transaction">×¨×™×©×•× ×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_item">
                            <label for="edit_perm_add_item">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_manage_users">
                            <label for="edit_perm_manage_users">× ×™×”×•×œ ××©×ª××©×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_reports">
                            <label for="edit_perm_view_reports">×¦×¤×™×™×” ×‘×“×•×—×•×ª</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">×©××•×¨ ×©×™× ×•×™×™×</button>
                </form>
            </div>
        </div>
		
		<div id="editPickingModal" class="modal" style="display:none;direction:rtl;">
		  <div class="modal-content" style="max-width:600px;margin:50px auto;background:#fff;padding:28px;border-radius:14px;box-shadow:0 6px 36px #0002;">
			<span class="close" onclick="closeEditPicking()" style="float:left;cursor:pointer;font-size:2em;">&times;</span>
			<h3 style="text-align:center;margin-top:0;">×¢×¨×™×›×ª ×¨×©×™××ª ×œ×™×§×•×˜</h3>
			<div id="editPickingListArea"></div>
		  </div>
		</div>	
    </div>
	
	
	
	

    <script>
        // --- ×”×’×“×¨×ª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg4keZ42SfFHhwjhkYbl7TdJnuN0WsuUc",
            authDomain: "inventory-57376.firebaseapp.com",
            projectId: "inventory-57376",
            storageBucket: "inventory-57376.appspot.com",
            messagingSenderId: "165204980655",
            appId: "1:165204980655:web:f7c5a78a0ae11f7191355a",
            measurementId: "G-E8EK3N3DLE"
        };
        
        // ××ª×—×•×œ Firebase ×¢× ×˜×™×¤×•×œ ×‘×©×’×™××•×ª
        try {
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            
            // ×”×’×“×¨×ª Persistence (××•×¤×¦×™×•× ×œ×™ - ×œ×¢×‘×•×“×” ××•×¤×œ×™×™×Ÿ)
            db.enablePersistence()
                .catch((err) => {
                    if (err.code == 'failed-precondition') {
                        console.log('Multiple tabs open, persistence can only be enabled in one tab at a time.');
                    } else if (err.code == 'unimplemented') {
                        console.log('The current browser does not support persistence.');
                    }
                });
            
            // ×‘×“×™×§×ª ×—×™×‘×•×¨
            db.collection('_health_check').doc('test').get()
                .then(() => {
                    console.log('Firebase connected successfully');
                })
                .catch((error) => {
                    console.error('Firebase connection error:', error);
                    showConnectionError();
                });
                
        } catch (error) {
            console.error('Firebase initialization error:', error);
            showConnectionError();
        }
        
        // ×¤×•× ×§×¦×™×” ×œ×”×¦×’×ª ×©×’×™××ª ×—×™×‘×•×¨
        function showConnectionError() {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #f44336;
                color: white;
                padding: 15px 30px;
                border-radius: 5px;
                z-index: 9999;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            errorDiv.innerHTML = `
                <strong>âš ï¸ ×‘×¢×™×™×ª ×—×™×‘×•×¨</strong><br>
                ×œ× × ×™×ª×Ÿ ×œ×”×ª×—×‘×¨ ×œ×©×¨×ª. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•×¨×¢× ×Ÿ ××ª ×”×“×£.
            `;
            document.body.appendChild(errorDiv);
        }

        // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        let users = [];
        let inventory = [];
        let movements = [];
        let currentUser = null;
		let baseUnitsSingularList = ['×™×—×™×“×”', '×‘×§×‘×•×§', '×—×‘×™×œ×”', '×§×•×¤×¡×”', '×©×§×™×ª', '××¨×™×–×”'];
		let baseUnitsPluralList = ['×™×—×™×“×•×ª', '×‘×§×‘×•×§×™×', '×—×‘×™×œ×•×ª', '×§×•×¤×¡××•×ª', '×©×§×™×•×ª', '××¨×™×–×•×ª'];
		let packUnitsSingularList = ['×§×¨×˜×•×Ÿ', '××©×˜×—', '××¨×’×–', '×—×‘×™×œ×”', '×××¨×–'];
		let packUnitsPluralList = ['×§×¨×˜×•× ×™×', '××©×˜×—×™×', '××¨×’×–×™×', '×—×‘×™×œ×•×ª', '×××¨×–×™×'];
		if (localStorage.getItem('baseUnitsSingularList')) {
			try { baseUnitsSingularList = JSON.parse(localStorage.getItem('baseUnitsSingularList')); } catch {}
		}
		if (localStorage.getItem('baseUnitsPluralList')) {
			try { baseUnitsPluralList = JSON.parse(localStorage.getItem('baseUnitsPluralList')); } catch {}
		}
		if (localStorage.getItem('packUnitsSingularList')) {
			try { packUnitsSingularList = JSON.parse(localStorage.getItem('packUnitsSingularList')); } catch {}
		}
		if (localStorage.getItem('packUnitsPluralList')) {
			try { packUnitsPluralList = JSON.parse(localStorage.getItem('packUnitsPluralList')); } catch {}
		}

		
        // --- ×¤×•× ×§×¦×™×•×ª Firebase ×¢× retry ---
        async function loadAllDataWithRetry(retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    await loadAllData();
                    return; // ×”×¦×œ×—×”
                } catch (error) {
                    console.error(`Load attempt ${i + 1} failed:`, error);
                    if (i === retries - 1) {
                        throw error; // ×–×¨×•×§ ×©×’×™××” ××—×¨×™ ×›×œ ×”× ×™×¡×™×•× ×•×ª
                    }
                    // ×”××ª×Ÿ ×œ×¤× ×™ × ×™×¡×™×•×Ÿ × ×•×¡×£
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
        }
        
        async function loadAllData() {
            try {
                // ×˜×¢×Ÿ ××©×ª××©×™×
                users = [];
                let usersSnap = await db.collection('users').get();
                usersSnap.forEach(doc => users.push(doc.data()));
                if (users.length === 0) { // ×‘××™×“×” ×•×œ× ×§×™×™××™× ××©×ª××©×™× â€“ ×¦×•×¨ ×‘×¨×™×¨×ª ××—×“×œ
                    users = [
                        {
                            username: 'admin',
                            password: '1234',
                            fullName: '×× ×”×œ ×”××¢×¨×›×ª',
                            role: '×× ×”×œ',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'manage_users', 'view_reports', 'view_pickings']
                        },
                        {
                            username: 'warehouse',
                            password: '1234',
                            fullName: '×™×•×¡×™ ×›×”×Ÿ',
                            role: '××—×¡× ××™',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'view_reports', 'view_pickings']
                        },
                        {
                            username: 'staff',
                            password: '1234',
                            fullName: '×“× ×™ ×œ×•×™',
                            role: '×¦×•×•×ª',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction']
                        }
                    ];
                    for (const u of users) {
                        await db.collection('users').doc(u.username).set(u);
                    }
                }
                // ×˜×¢×Ÿ ××œ××™
                inventory = [];
                let invSnap = await db.collection('inventory').get();
                invSnap.forEach(doc => inventory.push(doc.data()));
                
                // ×˜×¢×Ÿ ×ª× ×•×¢×•×ª
                movements = [];
                let movSnap = await db.collection('movements').orderBy('date', 'desc').limit(200).get();
                movSnap.forEach(doc => {
                    let data = doc.data();
                    data.id = doc.id; // ×©××™×¨×ª ××–×”×” ×”××¡××š
                    movements.push(data);
                });
            } catch (error) {
                console.error('Error loading data:', error);
                if (error.code === 'unavailable') {
                    throw new Error('××™×Ÿ ×—×™×‘×•×¨ ×œ×©×¨×ª. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
                }
                throw error;
            }
        }
		
		async function loadMovementsOnly() {
			movements = [];
			let movSnap = await db.collection('movements').orderBy('date', 'desc').limit(200).get();
			movSnap.forEach(doc => {
				let data = doc.data();
				data.id = doc.id; // ×©××™×¨×ª ××–×”×” ×”××¡××š
				movements.push(data);
			});
		}

		async function createPickingList(plan) {
		  const now = new Date();
		  const docRef = await db.collection('pickingLists').add({
			date: now.toLocaleDateString('he-IL'),
			time: now.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}),
			createdBy: currentUser.fullName,
			status: 'open',
			plan: plan
		  });
		  await docRef.update({ id: docRef.id });
		  return docRef.id;
		}

        async function saveUser(user) {
            await db.collection('users').doc(user.username).set(user);
        }

        async function deleteUserFromDB(username) {
            await db.collection('users').doc(username).delete();
        }

        async function saveInventoryItem(item) {
            await db.collection('inventory').doc(item.name).set(item);
        }

        async function deleteInventoryItem(name) {
            await db.collection('inventory').doc(name).delete();
        }

        async function saveMovement(movement) {
            const docRef = await db.collection('movements').add(movement);
            return docRef.id;
        }
		
		async function savePickingListToDB(planList, creatorName) {
			const id = 'pick_' + Math.random().toString(36).substr(2, 8);
			const now = new Date();
			await db.collection('pickingLists').doc(id).set({
				id,
				date: now.toLocaleDateString('he-IL'),
				time: now.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}),
				createdBy: creatorName,
				plan: planList,
				status: 'open'
			});
			return id;
		}

        // --- LOGIN & BOOT ---
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                await loadAllDataWithRetry();
				updateStats();
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showMainScreen();
                    showToast(`×‘×¨×•×š ×”×‘×, ${user.fullName}!`, 'success');
                } else {
                    showToast('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                if (error.message && error.message.includes('××™×Ÿ ×—×™×‘×•×¨')) {
                    showToast(error.message, 'error');
                } else {
                    showToast('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª. × ×¡×” ×©×•×‘.', 'error');
                }
            }
        });
		
		async function displayPickings() {
			const container = document.getElementById('pickingsTableContainer');
			container.innerHTML = "×˜×•×¢×Ÿ...";
			// ×˜×¢×Ÿ ××ª ×”×œ×™×§×•×˜×™× ×Ö¾Firestore
			let pickingsSnap = await db.collection('pickingLists').orderBy('date', 'desc').get();
			let pickings = [];
			pickingsSnap.forEach(doc => {
				let data = doc.data();
				data.id = doc.id; // ×©××™×¨×” ×¢×œ ID ×’× ×× ×œ× × ×©××¨ ×‘×©×“×”
				pickings.push(data);
			});
			if (pickings.length === 0) {
				container.innerHTML = "<div>×œ× ×§×™×™××•×ª ×¨×©×™××•×ª ×œ×™×§×•×˜</div>";
				return;
			}
			let html = `
			<table style="width:100%;text-align:right;">
				<tr>
					<th>×ª××¨×™×š</th>
					<th>×©×¢×”</th>
					<th>××™ ×™×¦×¨</th>
					<th>××œ×§×˜</th>
					<th>×¡×˜×˜×•×¡</th>
					<th>×¤×¨×™×˜×™×</th>
					<th>×ª×•×¦××”</th>
					<th>×©×™×ª×•×£</th>
					<th>×¤×¢×•×œ×•×ª</th>
				</tr>
			`;
			pickings.forEach(p => {
				// ×™×¦×™×¨×ª ×§×™×©×•×¨ ×©×™×ª×•×£
				const link = `${window.location.origin}/pick.html?id=${p.id || p.id}`;
				
				// ×—×™×©×•×‘ ×ª×•×¦××•×ª
				let resultsHtml = '';
				if (p.results && p.results.length) {
					const takenCount = p.results.filter(r => r.status === '× ×œ×§×—').length;
					const notFoundCount = p.results.filter(r => r.status === '×œ× × ××¦×').length;
					resultsHtml = `
						<div style="text-align:center;">
							<span style="color:#28a745;">âœ“ ${takenCount}</span> | 
							<span style="color:#e74c3c;">âœ— ${notFoundCount}</span>
						</div>
					`;
				}
				
				html += `
				<tr>
					<td>${p.date || ''}</td>
					<td>${p.time || ''}</td>
					<td>${p.createdBy || ''}</td>
					<td>${p.pickedBy || '-'}</td>
					<td>${p.status === 'done' ? 'âœ“ ×‘×•×¦×¢' : 'â³ ×××ª×™×Ÿ'}</td>
					<td>
						<ul style="padding-right: 18px;">
							${(p.plan || []).map(item =>
								`<li>${item.productName} â€” ${item.takePacks} ×—×‘'${item.takeUnits ? ' + ' + item.takeUnits + ' ×™×—×™×“×•×ª' : ''} â€” ${item.location}</li>`
							).join('')}
						</ul>
					</td>
					<td>${resultsHtml}</td>
					<td>
						<button onclick="copyToClipboard('${link}')">×”×¢×ª×§ ×§×™×©×•×¨</button>
						<br>
						<a href="${link}" target="_blank" style="font-size:12px;">×¤×ª×— ×¨×©×™××”</a>
					</td>
					<td>
						<button onclick="openEditPicking('${p.id}')">×¢×¨×•×š</button>
						<button onclick="deletePicking('${p.id}')">××—×§</button>
					</td>
				</tr>
				`;
			});
			html += `</table>`;
			container.innerHTML = html;
		}

        function showMainScreen() {
			
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = currentUser.role;
            updateTabsVisibility();
			document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
			document.querySelector(`.tab[data-permission="view_inventory"]`).classList.add('active');
			document.getElementById('inventory').classList.add('active');
            displayInventory();
        }

		function updateTabsVisibility() {
			const tabs = document.querySelectorAll('.tab');
			tabs.forEach(tab => {
				// ×”×—×–×¨ ×œ×›×œ ×”×˜××‘×™× ×ª×¦×•×’×” ×¨×’×™×œ×” ×‘×”×ª×—×œ×”
				tab.classList.remove('disabled');
				tab.style.display = 'flex'; // ××• 'flex' ×× ×–×” ×œ× ×¢×•×‘×“ ×˜×•×‘ ×¢× ×¨×¡×¤×•× ×¡×™×‘×™×•×ª
				const permission = tab.getAttribute('data-permission');
				if (permission && !currentUser.permissions.includes(permission)) {
					tab.classList.add('disabled');
					tab.style.display = 'none';
				}
			});
		}


        function logout() {
			const editModal = document.getElementById('editModal');
			if (editModal) editModal.style.display = 'none';
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        window.addEventListener('load', async function() {
            try {
                await loadAllDataWithRetry();
				updateStats();
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    if (users.find(u => u.username === currentUser.username)) {
                        showMainScreen();
                    } else {
                        localStorage.removeItem('currentUser');
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™× - ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜', 'error');
                // ×”×¦×’ ×›×¤×ª×•×¨ ×¨×¢× ×•×Ÿ
                const refreshBtn = document.createElement('button');
                refreshBtn.textContent = '× ×¡×” ×©×•×‘';
                refreshBtn.style.cssText = 'margin-top: 20px;';
                refreshBtn.onclick = () => location.reload();
                document.querySelector('.login-box').appendChild(refreshBtn);
            }
        });

        // --- TAB HANDLERS ---
		window.showTab = function(e, tabName) {
			let tabElement = null;

			if (typeof e === 'string') {
				tabName = e;
			} else {
				e.preventDefault();
				tabElement = e.target;
			}

			// ×‘×“×™×§×ª ×”×¨×©××•×ª
			if (tabElement) {
				const permission = tabElement.getAttribute('data-permission');
				if (permission && !currentUser.permissions.includes(permission)) {
					showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×’×©×ª ×œ×ª×¤×¨×™×˜ ×–×”', 'error');
					return;
				}
			}

			// × ×™×§×•×™ ×˜××‘×™×
			document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
			document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

			// ×”×¤×¢×œ×ª ×˜××‘
			if (tabElement) tabElement.classList.add('active');
			else document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

			document.getElementById(tabName).classList.add('active');

			// ×˜×¢×™× ×ª ×ª×•×›×Ÿ ×“×™× ××™
			if (tabName === 'inventory') displayInventory();
			else if (tabName === 'movements') displayMovements();
			else if (tabName === 'transaction') {
				const cont = document.getElementById('multiTransactionRows');
				if (cont) {
					cont.innerHTML = '';
					addTransactionRow();
				}
			}
			else if (tabName === 'users') displayUsers();
			else if (tabName === 'addItem') {
				populateUnitsSelect(document.getElementById('baseUnitSingular'), baseUnitsSingularList);
				populateUnitsSelect(document.getElementById('baseUnitPlural'), baseUnitsPluralList);
				populateUnitsSelect(document.getElementById('packUnitSingular'), packUnitsSingularList);
				populateUnitsSelect(document.getElementById('packUnitPlural'), packUnitsPluralList);
			}
			else if (tabName === 'pickings') displayPickings();			
		};


		function displayInventory() {
			const tbody = document.getElementById('inventoryBody');
			tbody.innerHTML = '';

			let filtered = [...inventory];

			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×—×™×¤×•×©
			if (inventorySearch) {
				filtered = filtered.filter(item => item.name.includes(inventorySearch));
			}
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”
			if (categoryFilter) {
				filtered = filtered.filter(item => item.category === categoryFilter);
			}

			// ××™×•×Ÿ
			if (inventorySort.by) {
				filtered.sort((a, b) => {
					let av, bv;
					switch (inventorySort.by) {
						case 'name': av = a.name; bv = b.name; break;
						case 'category': av = a.category; bv = b.category; break;
						case 'quantity': {
							// ×—×™×©×•×‘ ×›××• ××¦×œ×š
							let [ap, au] = totalPacksAndUnits(a);
							let [bp, bu] = totalPacksAndUnits(b);
							av = ap + au / (a.unitsPerPack || 1);
							bv = bp + bu / (b.unitsPerPack || 1);
						} break;
						case 'min': av = a.minPacks; bv = b.minPacks; break;
						case 'expiry': {
							let ae = getEarliestExpiry(a);
							let be = getEarliestExpiry(b);
							av = ae ? new Date(ae) : new Date(3000,1,1);
							bv = be ? new Date(be) : new Date(3000,1,1);
						} break;
						case 'status': av = getGlobalStatusStr(a); bv = getGlobalStatusStr(b); break;
						default: av = a.name; bv = b.name;
					}
					if (typeof av === "string") return inventorySort.dir * av.localeCompare(bv);
					else return inventorySort.dir * ((av > bv) - (av < bv));
				});
			}

			filtered.forEach(item => {
				let totalAvailable = 0;
				let earliestExpiry = null;

				(item.variants || []).forEach((variant, index) => {
					const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
					if (daysToExpiry === null || daysToExpiry > 0) {
						totalAvailable += variant.quantity;
					}
					if (daysToExpiry !== null && daysToExpiry >= 0) {
						const expiryDate = new Date(variant.expiry);
						if (!earliestExpiry || expiryDate < earliestExpiry) {
							earliestExpiry = expiryDate;
						}
					}
				});

				let totalPacks = 0;
				let looseUnits = 0;

				(item.variants || []).forEach(variant => {
					const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
					if (daysToExpiry === null || daysToExpiry > 0) {
						totalPacks += variant.quantityPacks;
						looseUnits += variant.quantityUnits;
					}
				});

				totalPacks += Math.floor(looseUnits / item.unitsPerPack);
				looseUnits = looseUnits % item.unitsPerPack;
				const row = tbody.insertRow();
				row.classList.add('summary-row');
				row.innerHTML = `
					<td><button class="expand-btn" onclick="toggleVariants(this)">+</button></td>
					<td>${item.name}</td>
					<td>${item.category}</td>
					<td>
						${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
						${looseUnits > 0 ? `+ ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
					</td>
					<td>${item.minPacks} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
					<td>${earliestExpiry ? formatDate(earliestExpiry.toISOString()) : '-'}</td>
					<td>${getGlobalStatus(totalPacks, item.minPacks, earliestExpiry)}</td>
					<td>
						${(currentUser.permissions.includes('add_item') || currentUser.role === '×× ×”×œ ××¢×¨×›×ª')
						? `<button class="btn-small btn-edit" onclick="editProduct('${item.name}')">×¢×¨×•×š</button>
						<button class="btn-small btn-edit" onclick="openAddVariantModal('${item.name}')">â• ×”×•×¡×£ ×¤×¨×™×˜×™×</button>
						<button class="btn-small btn-danger" onclick="deleteProduct('${item.name}')">××—×§</button>`
						: ''}
					</td>
				`;

				(item.variants || []).forEach((variant, index) => {
					const variantRow = tbody.insertRow();
					variantRow.classList.add('variant-row');
					variantRow.style.display = 'none';

					const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
					
					let expiryStatus = '-';
					if (daysToExpiry !== null && daysToExpiry >= 0) {
						if (daysToExpiry <= 7) expiryStatus = 'ğŸ”´';
						else if (daysToExpiry <= 14) expiryStatus = 'ğŸŸ ';
						else if (daysToExpiry <= 30) expiryStatus = 'ğŸŸ¡';
						else expiryStatus = 'ğŸŸ¢';
					}

					variantRow.innerHTML = `
						<td></td>
						<td colspan="2">${variant.location}</td>
						<td>
						${variant.quantityPacks} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
						${variant.quantityUnits > 0 ? `+ ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
						</td>
						<td>-</td>
						<td>${formatDate(variant.expiry) || '-'}</td>
						<td>${expiryStatus}</td>
						<td>
							${(currentUser.permissions.includes('add_item') || currentUser.role === '×× ×”×œ ××¢×¨×›×ª') 
								? `<button class="btn-small btn-edit" onclick="editVariant('${item.name}', ${index})">×¢×¨×•×š</button>
								   <button class="btn-small btn-danger" onclick="deleteVariant('${item.name}', ${index})">××—×§</button>`
								: ''}
						</td>
					`;
				});

			});
		}
		
		function populateUnitsSelect(selectElement, list, selectedValue = "") {
			selectElement.innerHTML = "";
			const defaultOpt = document.createElement("option");
			defaultOpt.value = "";
			defaultOpt.textContent = "×‘×—×¨ ×™×—×™×“×”";
			defaultOpt.disabled = true;
			defaultOpt.selected = !selectedValue;
			selectElement.appendChild(defaultOpt);

			list.forEach(unit => {
				const option = document.createElement("option");
				option.value = unit;
				option.textContent = unit;
				option.selected = (selectedValue === unit);
				selectElement.appendChild(option);
			});
			const addNew = document.createElement("option");
			addNew.value = "__add_new__";
			addNew.textContent = "â• ×”×•×¡×£ ×™×—×™×“×” ×—×“×©×”...";
			selectElement.appendChild(addNew);
		}
		
		function toggleVariants(button) {
			const row = button.closest('tr');
			let nextRow = row.nextElementSibling;
			const isOpen = button.textContent === '-';
			button.textContent = isOpen ? '+' : '-';

			while (nextRow && nextRow.classList.contains('variant-row')) {
				nextRow.style.display = isOpen ? 'none' : '';
				nextRow = nextRow.nextElementSibling;
			}
		}

		function getGlobalStatus(totalPacks, minPacks, earliestExpiry) {
			if (totalPacks < minPacks) return 'ğŸ”´ ××ª×—×ª ×œ××™× ×™××•×';
			if (earliestExpiry) {
				const days = Math.floor((earliestExpiry - new Date()) / (1000 * 60 * 60 * 24));
				if (days <= 7) return 'ğŸ”´ ×ª×¤×•×’×” ×§×¨×•×‘×”';
				if (days <= 14) return 'ğŸŸ  ×ª×¤×•×’×” ×‘××•×¤×§';
			}
			return 'ğŸŸ¢ ×ª×§×™×Ÿ';
		}

        function getStatus(variant, daysToExpiry, isLowStock) {
			if (variant.quantity == 0) return 'âŒ ××™×Ÿ ××œ××™';
			if (variant.quantity < variant.minQuantity) return 'ğŸ”´ ××ª×—×ª ×œ××™× ×™××•×';
			if (variant.quantity < variant.minQuantity * 1.12) return 'ğŸŸ  ×§×¨×•×‘ ×œ××™× ×™××•×';
            if (daysToExpiry !== null) {
				if (daysToExpiry <= 7) return 'ğŸ”´ ×ª×¤×•×’×” ×§×¨×™×˜×™×ª';
				if (daysToExpiry <= 14) return 'ğŸŸ  ×ª×¤×•×’×” ×§×¨×•×‘×”';
				if (daysToExpiry <= 30) return 'ğŸŸ¡ ×ª×¤×•×’×” ×‘××•×¤×§';
			}
            return 'ğŸŸ¢ ×ª×§×™×Ÿ';
        }
		
		// ×¤×ª×™×—×ª ××•×“×œ ×¢×¨×™×›×ª ×ª× ×•×¢×”
		window.editMovement = function(id) {
			const movement = movements.find(m => m.id === id);
			if (!movement) return;
			document.getElementById('editMovementId').value = movement.id;
			document.getElementById('editMovementProduct').value = movement.product;
			document.getElementById('editMovementType').value = movement.type;
			document.getElementById('editMovementQuantityPacks').value = movement.quantityPacks || 0;
			document.getElementById('editMovementQuantityUnits').value = movement.quantityUnits || 0;
			document.getElementById('editMovementLocation').value = movement.location || '';
			document.getElementById('editMovementExpiry').value = movement.expiry || '';
			document.getElementById('editMovementNotes').value = movement.notes || '';
			document.getElementById('editMovementModal').style.display = 'block';
		};	
		
		window.openEditPicking = async function(pickId) {
			const pickSnap = await db.collection('pickingLists').doc(pickId).get();
			if (!pickSnap.exists) return showToast('×¨×©×™××ª ×”×œ×™×§×•×˜ ×œ× ×§×™×™××ª', 'error');
			const pick = pickSnap.data();
			window.currentEditPickId = pickId;

			// ×‘× ×” ×˜×‘×œ×” ×œ×¢×¨×™×›×” ×¢× checkbox
			let html = `<table class="picking-table"><tr>
				<th>××•×¦×¨</th>
				<th>×›××•×ª</th>
				<th>××™×§×•×</th>
				<th>×ª×•×§×£</th>
				<th>×”×¢×¨×”</th>
				<th>× ×œ×§×—</th>
			</tr>`;
			pick.plan.forEach((row, i) => {
				html += `<tr>
					<td>${row.productName}</td>
					<td>${row.takePacks} ×—×‘'${row.takeUnits ? ' + ' + row.takeUnits + ' ×™×—×™×“×•×ª' : ''}</td>
					<td>${row.location || ''}</td>
					<td>${row.expiry ? formatDate(row.expiry) : ''}</td>
					<td>
						<input type="text" id="edit_note_${i}" value="${row.note || ''}" style="width:95%;padding:4px 7px;">
					</td>
					<td style="text-align:center">
						<input type="checkbox" class="edit-pick-checkbox" data-index="${i}" id="edit_pick_checkbox_${i}" checked>
					</td>
				</tr>`;
			});

			html += `</table>
			<div style="text-align:center; margin-top:14px;">
			  <button class="btn-main" onclick="selectAllPicking(true)">×‘×—×¨ ×”×›×œ</button>
			  <button class="btn-main" onclick="selectAllPicking(false)">× ×§×” ×”×›×œ</button>
			  <button class="btn-main" onclick="saveEditPicking()">××©×¨ ×•×¡×’×•×¨</button>
			</div>
			`;
			document.getElementById('editPickingListArea').innerHTML = html;
			document.getElementById('editPickingModal').style.display = "block";
			selectAllPicking(true);
		}

		// ×¡×’×•×¨ ××ª ×”××•×“×œ
		window.closeEditPicking = function() {
			document.getElementById('editPickingModal').style.display = "none";
			window.lastEditPickingResults = null;
		}

		// ×›×¤×ª×•×¨ "×‘×—×¨ ×”×›×œ" ××• "× ×§×” ×”×›×œ"
		window.selectAllPicking = function(val=true) {
			const pickModal = document.getElementById('editPickingListArea');
			if (!pickModal) return;
			const checkboxes = pickModal.querySelectorAll('.edit-pick-checkbox');
			checkboxes.forEach(cb => cb.checked = val);
		}


		// ××©×¨ ××ª ×”×¢×¨×™×›×”
		window.saveEditPicking = async function() {
			const pickId = window.currentEditPickId;
			const pickSnap = await db.collection('pickingLists').doc(pickId).get();
			if (!pickSnap.exists) return showToast('×¨×©×™××ª ×”×œ×™×§×•×˜ ×œ× ×§×™×™××ª', 'error');
			const pick = pickSnap.data();

			// ××•×¡×£ ×ª×•×¦××•×ª ××”-checkbox×™×
			const results = [];
			pick.plan.forEach((row, i) => {
				const cb = document.getElementById('edit_pick_checkbox_' + i);
				results.push({ status: cb.checked ? "× ×œ×§×—" : "×œ× × ×œ×§×—" });
			});

			// ×‘×“×•×§ ×©×¡×•××Ÿ ×œ×›×œ ×”×©×•×¨×•×ª ××©×”×• (×œ× ×—×•×‘×” â€” ×¢×›×©×™×• ××™×Ÿ ×¨×“×™×•)
			// ××¤×©×¨ ×œ×•×•×ª×¨ ×¢×œ ×‘×“×™×§×”, ×›×™ ×‘×¨×™×¨×ª ××—×“×œ ×”×™× "×œ× × ×œ×§×—"

			// ×©×•××¨ ×ª×•×¦××•×ª ×‘×–×™×›×¨×•×Ÿ ×–×× ×™ ×¢×‘×•×¨ approvePicking
			window.lastEditPickingResults = results;

			// ×××©×¨ ×”×œ×™×§×•×˜ ×¢× ×”×¢×¨×™×›×”!
			await approvePicking(pickId, true);

			closeEditPicking();
		}

	
		// ×¡×’×™×¨×ª ×”××•×“×œ
		window.closeEditMovementModal = function() {
			document.getElementById('editMovementModal').style.display = 'none';
			document.getElementById('editMovementForm').reset();
		};
		
		window.approvePicking = async function(pickId, manual = false) {
			const pickSnap = await db.collection('pickingLists').doc(pickId).get();
			if (!pickSnap.exists) return showToast('×¨×©×™××ª ×”×œ×™×§×•×˜ ×œ× ×§×™×™××ª', 'error');
			const pick = pickSnap.data();

			// ×‘××¦×‘ ×¨×’×™×œ â€” ×××©×¨ ×”×›×œ ××•×˜×•××˜×™×ª
			let results = [];
			if (!manual) {
				results = pick.plan.map(() => ({ status: "× ×œ×§×—" }));
			} else {
				// ×× ×¢×•×¨×š, × ×§×‘×œ ××ª ×”××¢×¨×š ×-modal ×”×¢×¨×™×›×” (× ×‘× ×” ×‘×”××©×š)
				results = window.lastEditPickingResults || pick.plan.map(() => ({ status: "" }));
			}

			// ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×•×”×¨×©×™××”
			await db.collection('pickingLists').doc(pickId).update({
				status: 'done',
				results,
				pickedBy: currentUser.fullName,
				pickedAt: new Date().toISOString()
			});

			// ×™×™×¦×•×¨ ×ª× ×•×¢×•×ª ××œ××™ ×‘×¤×•×¢×œ ×œ×›×œ ××” ×©×¡×•××Ÿ "× ×œ×§×—"
			for (let i = 0; i < pick.plan.length; i++) {
				if (results[i].status !== '× ×œ×§×—') continue;
				const row = pick.plan[i];
				
				// ×—×¤×© ××ª ×”××•×¦×¨ ×•×”×•×•×¨×™×× ×˜ ×”××ª××™×
				const item = inventory.find(inv => inv.name === row.productName);
				if (!item) continue;
				
				// ××¦× ××ª ×”×•×•×¨×™×× ×˜ ×”××“×•×™×§ ×œ×¤×™ ××™×§×•× ×•×ª××¨×™×š ×ª×¤×•×’×”
				const variantIndex = item.variants.findIndex(v => 
					v.location === row.location && 
					v.expiry === row.expiry
				);
				
				if (variantIndex === -1) continue;
				
				// ×¢×“×›×Ÿ ××ª ×”×›××•×ª ×‘×•×•×¨×™×× ×˜
				const variant = item.variants[variantIndex];
				variant.quantityPacks -= row.takePacks;
				variant.quantityUnits -= row.takeUnits;
				
				// ×× ×™×© ×™×•×ª×¨ ×™×—×™×“×•×ª ×× ×“×¨×© ×œ×—×‘×™×œ×”, ×”××¨ ×œ×—×‘×™×œ×•×ª
				if (variant.quantityUnits < 0) {
					const neededPacks = Math.ceil(Math.abs(variant.quantityUnits) / item.unitsPerPack);
					variant.quantityPacks -= neededPacks;
					variant.quantityUnits += neededPacks * item.unitsPerPack;
				}
				
				// ×©××•×¨ ××ª ×”××•×¦×¨ ×”××¢×•×“×›×Ÿ
				await saveInventoryItem(item);
				
				// ×¨×©×•× ×ª× ×•×¢×”
				await saveMovement({
					date: new Date().toLocaleDateString('he-IL'),
					time: new Date().toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' }),
					product: row.productName,
					location: row.location,
					expiry: row.expiry,
					type: "×”×•×¦××”",
					quantityPacks: row.takePacks,
					quantityUnits: row.takeUnits,
					user: currentUser.fullName,
					notes: '×œ×™×§×•×˜ ××•×˜×•××˜×™!'
				});
			}

			// ×˜×¢×Ÿ ××—×“×© ××ª ×”× ×ª×•× ×™×
			await loadAllData();
			updateStats();
			
			showToast('×”×œ×™×§×•×˜ ××•×©×¨ ×‘×”×¦×œ×—×”', 'success');
			displayPickings();
		}

		// ×©××™×¨×ª ×¢×¨×™×›×”
		document.getElementById('editMovementForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const id = document.getElementById('editMovementId').value;
			// ×”×˜×•×¤×¡ ×œ× ×›×•×œ×œ ×ª××¨×™×š/×©×¢×”/××©×ª××© ×›×“×™ ×©×œ× ×ª×•×›×œ ×œ×©× ×•×ª ××—×•×¨×” ×ª× ×•×¢×•×ª ×©×œ ××—×¨×™×
			await db.collection('movements').doc(id).update({
				product: document.getElementById('editMovementProduct').value,
				type: document.getElementById('editMovementType').value,
				quantityPacks: parseInt(document.getElementById('editMovementQuantityPacks').value),
				quantityUnits: parseInt(document.getElementById('editMovementQuantityUnits').value),
				location: document.getElementById('editMovementLocation').value,
				expiry: document.getElementById('editMovementExpiry').value,
				notes: document.getElementById('editMovementNotes').value
			});
			await loadMovementsOnly();
			displayMovements();
			showToast('×”×ª× ×•×¢×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!', 'success');
			closeEditMovementModal();
		});

		// ××—×™×§×ª ×ª× ×•×¢×”
		window.deleteMovement = async function(id) {
			if (!confirm('×”×× ×œ××—×•×§ ×ª× ×•×¢×” ×–×•?')) return;
			await db.collection('movements').doc(id).delete();
			await loadMovementsOnly();
			displayMovements();
			showToast('×”×ª× ×•×¢×” × ××—×§×” ×‘×”×¦×œ×—×”!', 'success');
		};

		function updateStats() {
			document.getElementById('totalProducts').textContent = inventory.length;
			let lowStockCount = 0, expiringCount = 0;
			inventory.forEach(item => {
				let totalPacks = 0, looseUnits = 0;
				let hasExpiringVariant = false;
				
				(item.variants || []).forEach(v => {
					const daysToExpiry = v.expiry ? Math.floor((new Date(v.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
					if (daysToExpiry === null || daysToExpiry > 0) {
						totalPacks += v.quantityPacks || 0;
						looseUnits += v.quantityUnits || 0;
					}
					// ×‘×“×™×§×ª ×ª×¤×•×’×” ×§×¨×•×‘×”
					if (daysToExpiry !== null && daysToExpiry <= 14 && daysToExpiry >= 0 && !hasExpiringVariant) {
						hasExpiringVariant = true;
						expiringCount++;
					}
				});
				
				totalPacks += Math.floor(looseUnits / item.unitsPerPack);
				if (totalPacks < item.minPacks) lowStockCount++;
			});
			
			document.getElementById('lowStockCount').textContent = lowStockCount;
			document.getElementById('expiringCount').textContent = expiringCount;
			
			const today = new Date().toLocaleDateString('he-IL');
			const todayMovements = movements.filter(m => m.date === today).length;
			document.getElementById('todayMovements').textContent = todayMovements;
		}

        function displayMovements() {
			const tbody = document.getElementById('movementsBody');
			tbody.innerHTML = '';
			movements.forEach((movement, idx) => {
				// ×”×¦×’ ×¨×§ ×ª× ×•×¢×•×ª ×©×™×© ×œ×”×Ÿ ××•×¦×¨, ×¤×¢×•×œ×” ×•×›××•×ª
				if (!movement.product || !movement.type) return;
				let canEdit = ['×× ×”×œ ××¢×¨×›×ª','×× ×”×œ ××ª×—×','×× ×”×œ/×ª ××©××¨×ª','××—×¡× ××™'].includes(currentUser.role);
				let row = tbody.insertRow();
				row.innerHTML = `
					<td>${movement.date}</td>
					<td>${movement.time}</td>
					<td>${movement.product}</td>
					<td>${movement.location || '-'}</td>
					<td>${movement.expiry ? formatDate(movement.expiry) : '-'}</td>
					<td>${movement.type}</td>
					<td>${movement.quantityPacks} ×—×‘'${movement.quantityUnits > 0 ? ' + ' + movement.quantityUnits + ' ×™×—×™×“×•×ª' : ''}</td>
					<td>${movement.user}</td>
					<td>${movement.notes || ''}</td>
					<td>
						${canEdit ?
						  `<button class="btn-small btn-edit" onclick="editMovement('${movement.id || ''}')">×¢×¨×•×š</button>
						   <button class="btn-small btn-danger" onclick="deleteMovement('${movement.id || ''}')">××—×§</button>`
						  : ''}
					</td>
				`;
			});
		}

		function populateProductSelect() {
			const select = document.getElementById('transProduct');
			select.innerHTML = '<option value="">×‘×—×¨ ××•×¦×¨</option>';
			inventory.forEach(item => {
				(item.variants || []).forEach((variant, index) => {
					const option = document.createElement('option');
					option.value = `${item.name}||${index}`;
					option.textContent = `${item.name} - ${variant.location} (×›××•×ª: ${variant.quantityPacks} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}${variant.quantityUnits > 0 ? ' + ' + variant.quantityUnits + ' ' + getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural) : ''})`;
					select.appendChild(option);
				});
			});
		}
		
		window.editProduct = function(productName) {
			const item = inventory.find(i => i.name === productName);
			populateUnitsSelect(document.getElementById('editBaseUnitSingular'), baseUnitsSingularList, item.baseUnitSingular);
			populateUnitsSelect(document.getElementById('editBaseUnitPlural'), baseUnitsPluralList, item.baseUnitPlural);
			populateUnitsSelect(document.getElementById('editPackUnitSingular'), packUnitsSingularList, item.packUnitSingular);
			populateUnitsSelect(document.getElementById('editPackUnitPlural'), packUnitsPluralList, item.packUnitPlural);
			document.getElementById('editItemOriginalName').value = item.name;
			document.getElementById('editItemName').value = item.name;
			document.getElementById('editItemCategory').value = item.category;
			document.getElementById('editBaseUnitSingular').value = item.baseUnitSingular || '';
			document.getElementById('editBaseUnitPlural').value = item.baseUnitPlural || '';
			document.getElementById('editPackUnitSingular').value = item.packUnitSingular || '';
			document.getElementById('editPackUnitPlural').value = item.packUnitPlural || '';
			document.getElementById('editUnitsPerPack').value = item.unitsPerPack;
			document.getElementById('editMinPacks').value = item.minPacks;

			document.getElementById('editModal').style.display = 'block';
		};
		
		window.deleteProduct = async function(productName) {
			if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××•×¦×¨?')) return;
			await deleteInventoryItem(productName);
			await loadAllData();
			updateStats();
			showToast('×”××•×¦×¨ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
			displayInventory();
		};
		
		window.deleteVariant = async function(productName, variantIndex) {
			if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×•×•×¨×™×× ×˜?')) return;
			const item = inventory.find(i => i.name === productName);
			item.variants.splice(variantIndex, 1);
			await saveInventoryItem(item);
			await loadAllData();
			updateStats();
			displayInventory();
			showToast('×”×•×•×¨×™×× ×˜ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
		};
		
		window.editVariant = function(productName, variantIndex) {
			const item = inventory.find(i => i.name === productName);
			const variant = item.variants[variantIndex];
			
			document.getElementById('editVariantProductName').value = productName;
			document.getElementById('editVariantIndex').value = variantIndex;
			document.getElementById('editVariantQuantityPacks').value = variant.quantityPacks || 0;
			document.getElementById('editVariantQuantityUnits').value = variant.quantityUnits || 0;
			document.getElementById('editVariantLocation').value = variant.location || '';
			document.getElementById('editVariantExpiry').value = variant.expiry || '';

			document.getElementById('editVariantModal').style.display = 'block';
		};


		function addVariant() {
			const container = document.getElementById('variantsContainer');
			const variantDiv = document.createElement('div');
			variantDiv.className = 'form-row';
			variantDiv.innerHTML = `
				<div class="form-group">
					<label>×›××•×ª ×—×‘×™×œ×•×ª</label>
					<input type="number" class="variant-quantityPacks" min="0" required>
				</div>
				<div class="form-group">
					<label>×›××•×ª ×™×—×™×“×•×ª ×‘×•×“×“×•×ª</label>
					<input type="number" class="variant-quantityUnits" min="0" required>
				</div>
				<div class="form-group">
					<label>××™×§×•×</label>
					<select class="variant-location" required aria-label="××™×§×•× ×”××—×¡×Ÿ" title="×‘×—×¨ ××™×§×•× ××—×¡×Ÿ">
						<option value="">×‘×—×¨ ××—×¡×Ÿ</option>
						<option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
						<option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
						<option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
						<option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
						<option value="×˜×›× ×™">×˜×›× ×™</option>
						<option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
						<option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
					</select>
				</div>
				<div class="form-group">
					<label>×ª××¨×™×š ×ª×¤×•×’×”</label>
					<input type="date" class="variant-expiry">
				</div>
			`;

			
			container.appendChild(variantDiv);
		}

        // --- ×˜×¤×¡×™× ××œ××™/×ª× ×•×¢×•×ª/××©×ª××©×™× ---
		document.getElementById('addItemForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			const variants = [];
			document.querySelectorAll('#variantsContainer .form-row').forEach(variantRow => {
				variants.push({
					quantityPacks: parseInt(variantRow.querySelector('.variant-quantityPacks').value),
					quantityUnits: parseInt(variantRow.querySelector('.variant-quantityUnits').value),
					location: variantRow.querySelector('.variant-location').value,
					expiry: variantRow.querySelector('.variant-expiry').value
				});
			});

		const newItem = {
			name: document.getElementById('itemName').value,
			category: document.getElementById('itemCategory').value,
			minPacks: parseInt(document.getElementById('minPacks').value),
			baseUnitSingular: document.getElementById('baseUnitSingular').value,
			baseUnitPlural: document.getElementById('baseUnitPlural').value,
			packUnitSingular: document.getElementById('packUnitSingular').value,
			packUnitPlural: document.getElementById('packUnitPlural').value,
			unitsPerPack: parseInt(document.getElementById('unitsPerPack').value),
			variants: variants
		};

			inventory.push(newItem);
			await saveInventoryItem(newItem);
			await loadAllData();
			updateStats();
			showToast('×”×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
			this.reset();
			document.getElementById('variantsContainer').innerHTML = '';
			showTab('inventory');
		});


		document.getElementById('transactionForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			const now = new Date();
			const date = now.toLocaleDateString('he-IL');
			const time = now.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'});
			const user = currentUser.fullName;

			const rows = document.querySelectorAll('#multiTransactionRows .form-row');
			let anySuccess = false, errorMessages = [];
			let pickingPlan = []; // ×œ×¦×•×¨×š ×™×¦×™×¨×ª ×¨×©×™××ª ×œ×™×§×•×˜

			for (const row of rows) {
				const productSelect = row.querySelector('.transProductSelect');
				const typeSelect = row.querySelector('.transTypeSelect');
				const quantityPacksInput = row.querySelector('.transQuantityPacksInput');
				const quantityUnitsInput = row.querySelector('.transQuantityUnitsInput');
				const notesInput = row.querySelector('.transNotesInput');

				if (!productSelect.value || !typeSelect.value) {
					errorMessages.push('×œ× × ×‘×—×¨ ××•×¦×¨ ××• ×¡×•×’ ×¤×¢×•×œ×” ×‘××—×ª ×”×©×•×¨×•×ª');
					continue;
				}
				
				const productName = productSelect.value;
				const transType = typeSelect.value;
				const quantityPacks = parseInt(quantityPacksInput.value) || 0;
				const quantityUnits = parseInt(quantityUnitsInput.value) || 0;
				const notes = notesInput.value;

				// ×‘×“×™×§×ª ×›××•×™×•×ª ×©×œ×™×œ×™×•×ª
				if (quantityPacks < 0 || quantityUnits < 0) {
					errorMessages.push(`×œ× × ×™×ª×Ÿ ×œ×”×–×™×Ÿ ×›××•×™×•×ª ×©×œ×™×œ×™×•×ª`);
					quantityPacksInput.classList.add('error-input');
					quantityUnitsInput.classList.add('error-input');
					continue;
				}

				if ((quantityPacks === 0 && quantityUnits === 0)) {
					errorMessages.push(`×™×© ×œ×”×–×™×Ÿ ×›××•×ª ×—×•×§×™×ª ×‘-${productName}`);
					continue;
				}

				const item = inventory.find(i => i.name === productName);
				if (!item) {
					errorMessages.push(`×”××•×¦×¨ "${productName}" ×œ× × ××¦×`);
					continue;
				}

				if (transType === '×”×•×¦××”') {
					// ×—×™×©×•×‘ ×›××•×™×•×ª ×–××™× ×•×ª
					let availablePacks = 0;
					let availableUnits = 0;
					
					item.variants.forEach(v => {
						availablePacks += v.quantityPacks || 0;
						availableUnits += v.quantityUnits || 0;
					});
					
					// ×”××¨×ª ×™×—×™×“×•×ª ×œ×—×‘×™×œ×•×ª ×× ××¤×©×¨
					availablePacks += Math.floor(availableUnits / item.unitsPerPack);
					availableUnits = availableUnits % item.unitsPerPack;
					
					// ×‘×“×™×§×” ×× ×™×© ××¡×¤×™×§ ××œ××™
					const neededTotalUnits = (quantityPacks * item.unitsPerPack) + quantityUnits;
					const availableTotalUnits = (availablePacks * item.unitsPerPack) + availableUnits;
					
					if (neededTotalUnits > availableTotalUnits) {
						errorMessages.push(`××™×Ÿ ××¡×¤×™×§ ××œ××™ ×œ-${item.name}. ×–××™×Ÿ: ${availablePacks} ×—×‘×™×œ×•×ª + ${availableUnits} ×™×—×™×“×•×ª`);
						continue;
					}
					
					// ×œ×™×§×•×˜ ×—×›× ×œ×¤×™ ×ª×•×§×£ (FEFO)
					const sortedVariants = item.variants
						.map((v, idx) => ({...v, idx}))
						.filter(v => v.quantityPacks > 0 || v.quantityUnits > 0)
						.sort((a, b) => {
							if (!a.expiry && !b.expiry) return 0;
							if (!a.expiry) return 1;
							if (!b.expiry) return -1;
							return new Date(a.expiry) - new Date(b.expiry);
						});
					
					let remainingPacks = quantityPacks;
					let remainingUnits = quantityUnits;
					
					for (const variant of sortedVariants) {
						if (remainingPacks <= 0 && remainingUnits <= 0) break;
						
						const takePacks = Math.min(remainingPacks, variant.quantityPacks);
						const takeUnits = Math.min(remainingUnits, variant.quantityUnits);
						
						if (takePacks > 0 || takeUnits > 0) {
							// ×¢×“×›×•×Ÿ ×”×•×•×¨×™×× ×˜
							item.variants[variant.idx].quantityPacks -= takePacks;
							item.variants[variant.idx].quantityUnits -= takeUnits;
							
							// ×¨×™×©×•× ×ª× ×•×¢×”
							await saveMovement({
								date, time,
								product: item.name,
								location: variant.location,
								expiry: variant.expiry,
								type: transType,
								quantityPacks: takePacks,
								quantityUnits: takeUnits,
								user,
								notes
							});
							
							// ×”×•×¡×¤×” ×œ×ª×•×›× ×™×ª ×”×œ×™×§×•×˜
							if (takePacks > 0 || takeUnits > 0) {
								pickingPlan.push({
									productName: item.name,
									takePacks,
									takeUnits,
									location: variant.location,
									expiry: variant.expiry
								});
							}
							
							remainingPacks -= takePacks;
							remainingUnits -= takeUnits;
							anySuccess = true;
						}
					}
					
					// ×× × ×©××¨×• ×™×—×™×“×•×ª, × ×¡×” ×œ×”××™×¨ ××—×‘×™×œ×•×ª
					if (remainingUnits > 0) {
						for (const variant of sortedVariants) {
							if (remainingUnits <= 0) break;
							if (item.variants[variant.idx].quantityPacks > 0) {
								const packsToBreak = Math.ceil(remainingUnits / item.unitsPerPack);
								const actualPacksToBreak = Math.min(packsToBreak, item.variants[variant.idx].quantityPacks);
								
								item.variants[variant.idx].quantityPacks -= actualPacksToBreak;
								item.variants[variant.idx].quantityUnits += (actualPacksToBreak * item.unitsPerPack) - remainingUnits;
								
								await saveMovement({
									date, time,
									product: item.name,
									location: variant.location,
									expiry: variant.expiry,
									type: transType,
									quantityPacks: 0,
									quantityUnits: remainingUnits,
									user,
									notes: notes + ' (×”×•××¨ ××—×‘×™×œ×•×ª)'
								});
								
								pickingPlan.push({
									productName: item.name,
									takePacks: 0,
									takeUnits: remainingUnits,
									location: variant.location,
									expiry: variant.expiry
								});
								
								remainingUnits = 0;
								anySuccess = true;
								break;
							}
						}
					}
					
				} else { // ×”×›× ×¡×”
					if (!item.variants || item.variants.length === 0) {
						errorMessages.push(`××™×Ÿ ×•×¨×™×× ×˜×™× ×¤×¢×™×œ×™× ×œ-${item.name}`);
						continue;
					}
					
					// ×”×›× ×¡×” ×œ×•×•×¨×™×× ×˜ ×”×¨××©×•×Ÿ ×›×‘×¨×™×¨×ª ××—×“×œ
					item.variants[0].quantityPacks += quantityPacks;
					item.variants[0].quantityUnits += quantityUnits;
					
					await saveMovement({
						date, time,
						product: item.name,
						location: item.variants[0].location,
						expiry: item.variants[0].expiry,
						type: transType,
						quantityPacks,
						quantityUnits,
						user,
						notes
					});
					anySuccess = true;
				}
				
				await saveInventoryItem(item);
			}

			// ×™×¦×™×¨×ª ×¨×©×™××ª ×œ×™×§×•×˜ ×× ×”×™×• ×”×•×¦××•×ª
			if (pickingPlan.length > 0) {
				const pickId = await createPickingList(pickingPlan);
				const link = `${window.location.origin}/pick.html?id=${pickId}`;
				const shareHtml = `
					<h3>×¨×©×™××ª ×œ×™×§×•×˜ × ×•×¦×¨×”!</h3>
					<div style="margin:18px 0; display:flex; flex-wrap:wrap; gap:10px;">
						<button class="btn-main" onclick="shareWhatsapp('${link}')">×©×œ×— ×‘Ö¾WhatsApp</button>
						<button class="btn-main" onclick="shareTelegram('${link}')">×©×œ×— ×‘Ö¾Telegram</button>
						<button class="btn-main" onclick="shareEmail('${link}')">×©×œ×— ×‘××™××™×™×œ</button>
						<button class="btn-main" onclick="copyToClipboard('${link}')">×”×¢×ª×§ ×§×™×©×•×¨</button>
					</div>
					<div id="shareResultMsg" style="margin-top:10px; text-align:center;"></div>
				`;
				document.getElementById('pickingListContainer').innerHTML = shareHtml;
			}

			await loadAllData();
			updateStats();
			
			if (anySuccess) {
				showToast('×”×ª× ×•×¢×•×ª × ×¨×©××• ×‘×”×¦×œ×—×”!', 'success');
				this.reset();
				document.getElementById('multiTransactionRows').innerHTML = '';
				addTransactionRow();
				displayMovements();
			}
			
			if (errorMessages.length) {
				showToast(errorMessages.join('\n'), 'error');
			}
		});

        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentUser.permissions.includes('manage_users')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ× ×”×œ ××©×ª××©×™×', 'error');
                return;
            }
            const permissions = [];
            document.querySelectorAll('#addUserForm input[type="checkbox"]:checked').forEach(cb => {
                permissions.push(cb.id.replace('perm_', ''));
            });
            const newUser = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                fullName: document.getElementById('newFullName').value,
                role: document.getElementById('newRole').value,
                permissions: permissions
            };
            if (users.find(u => u.username === newUser.username)) {
                showToast('×©× ××©×ª××© ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª', 'error');
                return;
            }
            users.push(newUser);
            await saveUser(newUser);
            await loadAllData();
			updateStats();
            showToast('×”××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
            this.reset();
            displayUsers();
        });
		
		function getUnitLabel(count, singular, plural) {
			if (typeof count === "undefined") return plural;
			return (count === 1) ? singular : plural;
		}

        function displayUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            users.forEach((user, index) => {
                const canDelete = user.username !== 'admin';
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-details">
                        <strong>${user.fullName}</strong>
                        <div style="font-size:14px;color:#666;">
                            ×©× ××©×ª××©: ${user.username} | ×ª×¤×§×™×“: ${user.role}
                        </div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">
                            ×”×¨×©××•×ª: ${user.permissions.map(p => getPermissionName(p)).join(', ')}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-small" onclick="editUser('${user.username}')">×¢×¨×•×š</button>
                        ${canDelete ? `<button class="btn-small btn-danger" onclick="deleteUser('${user.username}')">××—×§</button>` : ''}
                    </div>
                `;
                userList.appendChild(userCard);
            });
        }

        function getPermissionName(permission) {
            const names = {
                'view_inventory': '×¦×¤×™×™×” ×‘××œ××™',
                'view_movements': '×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª',
                'add_transaction': '×¨×™×©×•× ×ª× ×•×¢×•×ª',
                'add_item': '×”×•×¡×¤×ª ×¤×¨×™×˜×™×',
                'manage_users': '× ×™×”×•×œ ××©×ª××©×™×',
                'view_reports': '×¦×¤×™×™×” ×‘×“×•×—×•×ª',
				'view_pickings': '×¦×¤×™×™×” ×‘×œ×™×§×•×˜×™×'
            };
            return names[permission] || permission;
        }

        window.deleteUser = async function(username) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××©×ª××© ×–×”?')) return;
            users = users.filter(u => u.username !== username);
            await deleteUserFromDB(username);
            await loadAllData();
			updateStats();
            showToast('×”××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”', 'success');
            displayUsers();
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
        function showToast(message, type = 'info') {
			const toast = document.getElementById('toast') || createToast();
			toast.textContent = message;
			toast.className = 'toast show';
			if (type === 'error') toast.style.background = '#e74c3c';
			else if (type === 'success') toast.style.background = '#27ae60';
			else toast.style.background = '#333';
			setTimeout(() => {
				toast.classList.remove('show');
			}, 3000);
		}
		
		function createToast() {
			const toast = document.createElement('div');
			toast.id = 'toast';
			toast.className = 'toast';
			document.body.appendChild(toast);
			return toast;
		}

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×¨×™×›×” ×•××—×™×§×ª ××•×¦×¨×™× ---
		window.editItemFromBtn = function(btn) {
			const itemName = btn.getAttribute('data-name');
			window.editItem(itemName);
		};
        
        window.deleteItem = async function(itemName) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××•×¦×¨ "${itemName}"?`)) return;
            
            inventory = inventory.filter(i => i.name !== itemName);
            await deleteInventoryItem(itemName);
            await loadAllData();
			updateStats();
            showToast('×”××•×¦×¨ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
            displayInventory();
        };
        
        window.deleteItemFromBtn = function(btn) {
            const itemName = btn.getAttribute('data-name');
            window.deleteItem(itemName);
        };
        
        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editItemForm').reset();
        };
        
        // --- ×¤×•× ×§×¦×™×•×ª ×¢×¨×™×›×ª ××©×ª××©×™× ---
        window.editUser = function(username) {
            if (!currentUser.permissions.includes('manage_users')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ××©×ª××©×™×', 'error');
                return;
            }
            
            const user = users.find(u => u.username === username);
            if (!user) {
                showToast('××©×ª××© ×œ× × ××¦×', 'error');
                return;
            }
            
            document.getElementById('editUserOriginalUsername').value = user.username;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editFullName').value = user.fullName;
			document.getElementById('editUserRole').value = user.role || '';
            
            // ××™×¤×•×¡ ×›×œ ×”-checkboxes
            document.querySelectorAll('#editUserForm input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // ×¡×™××•×Ÿ ×”×”×¨×©××•×ª ×”×§×™×™××•×ª
            user.permissions.forEach(perm => {
                const checkbox = document.getElementById('edit_perm_' + perm);
                if (checkbox) checkbox.checked = true;
            });
            
            document.getElementById('editUserModal').style.display = 'block';
        };
        
        window.closeEditUserModal = function() {
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserForm').reset();
        };
        
		document.getElementById('editUserForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			
			const originalUsername = document.getElementById('editUserOriginalUsername').value;
			const newUsername = document.getElementById('editUsername').value;

			let user = users.find(u => u.username === originalUsername);
			if (!user) {
				showToast('××©×ª××© ×œ× × ××¦×', 'error');
				return;
			}

			// ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×”××©×ª××©
			user.fullName = document.getElementById('editFullName').value;
			user.role = document.getElementById('editUserRole').value;

			// ×¢×“×›×•×Ÿ ×©× ××©×ª××© (×× ×©×•× ×”)
			if (originalUsername !== newUsername) {
				await deleteUserFromDB(originalUsername);
				user.username = newUsername;
			}

			// ×¢×“×›×•×Ÿ ×¡×™×¡××” ×¨×§ ×× ×”×•×–× ×” ×¡×™×¡××” ×—×“×©×”
			const newPassword = document.getElementById('editPassword').value;
			if (newPassword) {
				user.password = newPassword;
			}

			// ×¢×“×›×•×Ÿ ×”×¨×©××•×ª
			const permissions = [];
			document.querySelectorAll('#editUserForm input[type="checkbox"]:checked').forEach(cb => {
				permissions.push(cb.id.replace('edit_perm_', ''));
			});
			user.permissions = permissions;

			// ×©××™×¨×” ×‘-Firebase
			await saveUser(user);
			await loadAllData();
			updateStats();
			showToast('×”××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
			closeEditUserModal();
			displayUsers();
		});
        
		document.getElementById('editItemForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			const originalName = document.getElementById('editItemOriginalName').value;
			const item = inventory.find(i => i.name === originalName);

			item.name = document.getElementById('editItemName').value;
			item.category = document.getElementById('editItemCategory').value;
			item.baseUnitSingular = document.getElementById('editBaseUnitSingular').value;
			item.baseUnitPlural = document.getElementById('editBaseUnitPlural').value;
			item.packUnitSingular = document.getElementById('editPackUnitSingular').value;
			item.packUnitPlural = document.getElementById('editPackUnitPlural').value;
			item.unitsPerPack = parseInt(document.getElementById('editUnitsPerPack').value);
			item.minPacks = parseInt(document.getElementById('editMinPacks').value);

			// ×× ×”×©× ×”×©×ª× ×”, ××—×§ ××ª ×”××•×¦×¨ ×”×§×•×“× ×‘Ö¾Firebase
			if (originalName !== item.name) {
				await deleteInventoryItem(originalName);
			}

			await saveInventoryItem(item);
			await loadAllData();
			updateStats();
			showToast('×”××•×¦×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
			closeEditModal();
			displayInventory();
		});

        // ×¡×’×•×¨ ××ª ×”××•×“×œ ×× ×œ×•×—×¦×™× ××—×•×¥ ×œ×•
        window.onclick = function(event) {
            const editModal = document.getElementById('editModal');
			const editVariantModal = document.getElementById('editVariantModal');
			if (event.target === editVariantModal) {
				closeEditVariantModal();
			}
            const editUserModal = document.getElementById('editUserModal');
            if (event.target === editModal) {
                closeEditModal();
            } else if (event.target === editUserModal) {
                closeEditUserModal();
            }
        };

        // --- ×™×™×¦×•× ×“×•×—×•×ª ---
		window.generateReport = function(type) {
			const reportContent = document.getElementById('reportContent');
			let html = '';
			switch(type) {
				case 'inventory':
					html = '<h3>×“×•×— ××œ××™ ××œ×</h3>';
					html += '<table style="width:100%; margin-top:20px;">';
					html += '<thead><tr><th>×©× ××•×¦×¨</th><th>×§×˜×’×•×¨×™×”</th><th>×›××•×ª</th><th>××™× ×™××•×</th><th>×ª×¤×•×’×” ×§×¨×•×‘×”</th></tr></thead>';
					html += '<tbody>';
					inventory.forEach(item => {
						let totalPacks = 0, looseUnits = 0, earliestExpiry = null;
						(item.variants || []).forEach(v => {
							const daysToExpiry = v.expiry ? Math.floor((new Date(v.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
							if (daysToExpiry === null || daysToExpiry > 0) {
								totalPacks += v.quantityPacks || 0;
								looseUnits += v.quantityUnits || 0;
							}
							if (v.expiry && (earliestExpiry === null || new Date(v.expiry) < earliestExpiry)) {
								earliestExpiry = new Date(v.expiry);
							}
						});
						totalPacks += Math.floor(looseUnits / item.unitsPerPack);
						looseUnits = looseUnits % item.unitsPerPack;
						html += `<tr>
							<td>${item.name}</td>
							<td>${item.category}</td>
							<td>
								${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
								${looseUnits > 0 ? `+ ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
							</td>
							<td>${item.minPacks} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
							<td>${earliestExpiry ? earliestExpiry.toLocaleDateString('he-IL') : '-'}</td>
						</tr>`;
					});
					html += '</tbody></table>';
					break;

				case 'lowStock':
					html = '<h3>×“×•×— ×—×•×¡×¨×™× ×‘××œ××™</h3>';
					html += '<table style="width:100%; margin-top:20px;">';
					html += '<thead><tr><th>×©× ××•×¦×¨</th><th>×›××•×ª × ×•×›×—×™×ª</th><th>×›××•×ª ××™× ×™××•×</th></tr></thead>';
					html += '<tbody>';
					inventory.forEach(item => {
						let totalPacks = 0, looseUnits = 0;
						(item.variants || []).forEach(v => {
							const daysToExpiry = v.expiry ? Math.floor((new Date(v.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
							if (daysToExpiry === null || daysToExpiry > 0) {
								totalPacks += v.quantityPacks || 0;
								looseUnits += v.quantityUnits || 0;
							}
						});
						totalPacks += Math.floor(looseUnits / item.unitsPerPack);
						looseUnits = looseUnits % item.unitsPerPack;
						if (totalPacks < item.minPacks) {
							html += `<tr class="low-stock">
								<td>${item.name}</td>
								<td>
									${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
									${looseUnits > 0 ? `+ ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
								</td>
								<td>${item.minPacks} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
							</tr>`;
						}
					});
					html += '</tbody></table>';
					break;

				case 'expiring':
					html = '<h3>×“×•×— ×ª×¤×•×’×•×ª ×§×¨×•×‘×•×ª</h3>';
					html += '<table style="width:100%; margin-top:20px;">';
					html += '<thead><tr><th>×©× ××•×¦×¨</th><th>××™×§×•×</th><th>×›××•×ª</th><th>×ª××¨×™×š ×ª×¤×•×’×”</th><th>×™××™× ×œ×ª×¤×•×’×”</th></tr></thead>';
					html += '<tbody>';
					inventory.forEach(item => {
						(item.variants || []).forEach(variant => {
							const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
							if (daysToExpiry !== null && daysToExpiry <= 30 && daysToExpiry >= 0) {
								html += `<tr>
									<td>${item.name}</td>
									<td>${variant.location}</td>
									<td>
										${variant.quantityPacks} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
										${variant.quantityUnits > 0 ? `+ ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
									</td>
									<td>${variant.expiry ? new Date(variant.expiry).toLocaleDateString('he-IL') : '-'}</td>
									<td>${daysToExpiry}</td>
								</tr>`;
							}
						});
					});
					html += '</tbody></table>';
					break;

				case 'movements':
                    html = '<h3>×“×•×— ×ª× ×•×¢×•×ª ××—×¨×•× ×•×ª</h3>';
                    const last30Days = new Date();
					last30Days.setDate(last30Days.getDate() - 30);

					const recentMovements = movements.filter(m => {
						let moveDate;

						if (m.date && m.date.includes('/')) {
							// dd/mm/yyyy
							const parts = m.date.split('/');
							// ×”×’× ×” - ×ª×•××š ×’× ×‘-1/7/2025 ×•×’× ×‘-01/07/2025
							moveDate = new Date(
								Number(parts[2]),
								Number(parts[1]) - 1,
								Number(parts[0])
							);
						} else if (m.date && m.date.includes('.')) {
							// dd.mm.yyyy
							const parts = m.date.split('.');
							moveDate = new Date(
								Number(parts[2]),
								Number(parts[1]) - 1,
								Number(parts[0])
							);
						} else if (m.date && m.date.includes('-')) {
							// yyyy-mm-dd ××• yyyy-mm-ddTHH:mm:ssZ
							// ×××¤×©×¨ ×’× ×¤×•×¨××˜×™× ×›××• 2025-07-10T14:54:24.562Z
							moveDate = new Date(m.date);
						} else {
							// ×ª××¨×™×š ×œ× ××–×•×”×”
							return false;
						}

						// ×‘×“×™×§×ª ×ª×§×™× ×•×ª ×”×ª××¨×™×š
						if (isNaN(moveDate.getTime())) return false;

						return moveDate >= last30Days;
					});

                    
                    if (recentMovements.length === 0) {
                        html += '<p>××™×Ÿ ×ª× ×•×¢×•×ª ×‘-30 ×”×™××™× ×”××—×¨×•× ×™×</p>';
                    } else {
                        html += '<table style="width:100%; margin-top:20px;">';
                        html += '<thead><tr><th>×ª××¨×™×š</th><th>×©×¢×”</th><th>××•×¦×¨</th><th>×¤×¢×•×œ×”</th><th>×›××•×ª</th><th>××©×ª××©</th></tr></thead>';
                        html += '<tbody>';
                        recentMovements.forEach(movement => {
                            html += `<tr>
                                <td>${movement.date}</td>
                                <td>${movement.time}</td>
                                <td>${movement.product}</td>
                                <td>${movement.type}</td>
                                <td>${movement.quantityPacks} ×—×‘'${movement.quantityUnits > 0 ? ' + ' + movement.quantityUnits + ' ×™×—×™×“×•×ª' : ''}</td>
                                <td>${movement.user}</td>
                            </tr>`;
                        });
                        html += '</tbody></table>';
                    }
                    break;
            }
            
            html += '<div style="margin-top:30px;">';
            html += `<button onclick="exportReport('${type}')" class="btn-small" style="margin-right:10px;">×™×™×¦×•× ×œ-CSV</button>`;
            html += `<button onclick="printReport('${type}')" class="btn-small">×”×“×¤×¡×”</button>`;
            html += '</div>';
            
            reportContent.innerHTML = html;
        };
		
		window.closeEditVariantModal = function() {
			document.getElementById('editVariantModal').style.display = 'none';
			document.getElementById('editVariantForm').reset();
		};

		document.getElementById('editVariantForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			const productName = document.getElementById('editVariantProductName').value;
			const variantIndex = parseInt(document.getElementById('editVariantIndex').value);
			const item = inventory.find(i => i.name === productName);

			item.variants[variantIndex] = {
				quantityPacks: parseInt(document.getElementById('editVariantQuantityPacks').value),
				quantityUnits: parseInt(document.getElementById('editVariantQuantityUnits').value),
				location: document.getElementById('editVariantLocation').value,
				expiry: document.getElementById('editVariantExpiry').value
			};

			await saveInventoryItem(item);
			await loadAllData();
			updateStats();
			showToast('×”×•×•×¨×™×× ×˜ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
			closeEditVariantModal();
			displayInventory();
		});

        window.exportReport = function(type) {
            let csv = '';
            let filename = '';
            
            switch(type) {
                case 'inventory':
                    csv = '×©× ××•×¦×¨,×§×˜×’×•×¨×™×”,×›××•×ª ×—×‘×™×œ×•×ª,×›××•×ª ×™×—×™×“×•×ª,××™× ×™××•×,×ª×¤×•×’×” ×§×¨×•×‘×”,××™×§×•×\n';
                    inventory.forEach(item => {
						item.variants.forEach(variant => {
							csv += `"${item.name}","${item.category}",${variant.quantityPacks},${variant.quantityUnits},${item.minPacks},"${variant.expiry || ''}","${variant.location}"\n`;
						});
                    });
                    filename = '×“×•×—_××œ××™_××œ×.csv';
                    break;
                    
                case 'lowStock':
                    csv = '×©× ××•×¦×¨,×›××•×ª × ×•×›×—×™×ª ×—×‘×™×œ×•×ª,×›××•×ª ××™× ×™××•×,×—×•×¡×¨\n';
					inventory.forEach(item => {
						let totalPacks = 0;
						item.variants.forEach(v => totalPacks += v.quantityPacks);
						if (totalPacks < item.minPacks) {
							const shortage = item.minPacks - totalPacks;
							csv += `"${item.name}",${totalPacks},${item.minPacks},${shortage}\n`;
						}
					});
                    filename = '×“×•×—_×—×•×¡×¨×™×.csv';
                    break;
                    
                case 'expiring':
                    csv = '×©× ××•×¦×¨,××™×§×•×,×ª××¨×™×š ×ª×¤×•×’×”,×™××™× ×œ×ª×¤×•×’×”,×›××•×ª ×—×‘×™×œ×•×ª,×›××•×ª ×™×—×™×“×•×ª\n';
					inventory.forEach(item => {
						item.variants.forEach(variant => {
							if (variant.expiry) {
								const days = Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24));
								if (days <= 30 && days >= 0) {
									csv += `"${item.name}","${variant.location}","${variant.expiry}",${days},${variant.quantityPacks},${variant.quantityUnits}\n`;
								}
							}
						});
					});
                    filename = '×“×•×—_×ª×¤×•×’×•×ª.csv';
                    break;