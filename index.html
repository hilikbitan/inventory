<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××œ××™ - ××ª×—× ×§×•×œ× ×•×¢</title>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <style>
        /* ... ×©××•×¨ ××ª ×›×œ ×”Ö¾CSS ×©×œ×š ×œ×œ× ×©×™× ×•×™ ... */
		.modal { display: none; }
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background-color:#f5f5f5;color:#;line-height:1.6;min-height:100vh;}
        .login-container {display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
        .login-box {background:white;padding:40px;border-radius:12px;box-shadow:0 15px 35px rgba(0,0,0,0.2);width:90%;max-width:400px;}
        .login-box h1 {text-align:center;margin-bottom:30px;color:#333;}
        .main-container {display:none;min-height:100vh;}
        .top-nav {background:#2c3e50;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
        .nav-brand {font-size:20px;font-weight:bold;display:flex;align-items:center;gap:10px;}
        .nav-user {display:flex;align-items:center;gap:15px;}
        .user-info {display:flex;flex-direction:column;align-items:flex-end;font-size:14px;}
        .user-role {font-size:12px;opacity:.8;}
        .logout-btn {background:#e74c3c;color:white;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;font-size:14px;}
        .logout-btn:hover {background:#c0392b;}
        .container {max-width:1400px;margin:0 auto;padding:20px;}
        .tabs {display:flex;gap:5px;margin-bottom:20px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:5px;}
        .tab {padding:12px 20px;background:white;border:2px solid #ddd;cursor:pointer;border-radius:8px;transition:all .3s;font-weight:500;white-space:nowrap;flex-shrink:0;}
        .tab:hover {background:#f8f9fa;}
        .tab.active {background:#3498db;color:white;border-color:#3498db;}
        .tab.disabled {opacity:.5;cursor:not-allowed;}
        .tab-content {display:none;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .tab-content.active {display:block;}
        .table-wrapper {overflow-x:auto;-webkit-overflow-scrolling:touch;}
        table {width:100%;border-collapse:collapse;margin-top:20px;min-width:600px;}
        th,td {padding:12px;text-align:right;border:1px solid #ddd;}
        th {background:#34495e;color:white;font-weight:600;position:sticky;top:0;z-index:10;}
        tr:nth-child(even) {background:#f8f9fa;}
        tr:hover {background:#e8f4fd;}
        .low-stock {background-color:#ffebee!important;color:#c62828;font-weight:bold;}
        .expiring-soon {background-color:#fff3e0!important;color:#ef6c00;}
        .form-group {margin-bottom:20px;}
        label {display:block;margin-bottom:5px;font-weight:600;color:#555;}
        input,select {width:100%;padding:12px;border:1px solid #ddd;border-radius:4px;font-size:16px;-webkit-appearance:none;}
        input:focus,select:focus {outline:none;border-color:#3498db;box-shadow:0 0 0 2px rgba(52,152,219,0.2);}
        button {background:#3498db;color:white;padding:12px 30px;border:none;border-radius:4px;cursor:pointer;font-size:16px;font-weight:600;transition:background .3s;width:100%;}
        button:hover {background:#2980b9;}
        button:disabled {background:#95a5a6;cursor:not-allowed;}
        .stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px;}
        .stat-card {background:white;padding:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);text-align:center;transition:transform .3s;}
        .stat-card:hover {transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.15);}
        .stat-card h3 {color:#7f8c8d;font-size:14px;margin-bottom:10px;}
        .stat-card .value {font-size:28px;font-weight:bold;color:#2c3e50;}
        .alert {padding:15px;margin-bottom:20px;border-radius:4px;display:flex;align-items:center;gap:10px;}
        .alert-warning {background:#fff3cd;color:#856404;border:1px solid #ffeeba;}
        .alert-danger {background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
        .alert-success {background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
        .form-row {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
        .user-list {margin-top:20px;}
        .user-card {background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
        .user-details {flex:1;}
        .user-actions {display:flex;gap:10px;}
        .btn-small {padding:6px 15px;font-size:14px;width:auto;}
        .btn-danger {background:#e74c3c;}
        .btn-danger:hover {background:#c0392b;}
        .btn-edit {background:#f39c12;}
        .btn-edit:hover {background:#e67e22;}
        .permission-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px;}
        .permission-item {display:flex;align-items:center;gap:10px;}
        /* Checkbox styles - better visibility */
        input[type="checkbox"] {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background-color: white;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
        }
        input[type="checkbox"]:checked {
            background-color: #3498db;
            border-color: #3498db;
        }
        input[type="checkbox"]:checked::after {
            content: 'âœ“';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 14px;
            font-weight: bold;
        }
        input[type="checkbox"]:hover {
            border-color: #3498db;
        }
        .permission-item input[type="checkbox"] {width:20px;height:20px;cursor:pointer;}
        .toast {position:fixed;bottom:20px;right:20px;background:#333;color:white;padding:15px 25px;border-radius:4px;box-shadow:0 4px 10px rgba(0,0,0,0.3);transform:translateY(100px);opacity:0;transition:all .3s;z-index:1000;}
        .toast.show {transform:translateY(0);opacity:1;}
        /* Modal styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border: 1px solid #888;
            width: 90%;
            max-width: 600px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 20px;
            background-color: #34495e;
            color: white;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h2 {
            margin: 0;
        }
        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 20px;
        }
        .close:hover,
        .close:focus {
            color: #ccc;
        }
        .modal form {
            padding: 20px;
        }
        @media (max-width:768px){.container{padding:10px;}.tabs{margin-bottom:15px;}.tab{padding:10px 15px;font-size:14px;}.tab-content{padding:15px;}.stats{grid-template-columns:1fr 1fr;gap:10px;}.stat-card{padding:15px;}.stat-card .value{font-size:24px;}table{font-size:14px;}th,td{padding:8px 6px;}.nav-brand{font-size:16px;}.user-info{display:none;}.form-row{grid-template-columns:1fr;}}
        @media (max-width:480px){.stats{grid-template-columns:1fr;}.login-box{padding:30px 20px;}}
    </style>
</head>
<body>
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ¬ ××¢×¨×›×ª ××œ××™ - ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×” ğŸ¿</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">×©× ××©×ª××©</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">×¡×™×¡××”</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
            </form>
        </div>
    </div>
    
    <!-- ××¡×š ×¨××©×™ -->
    <div class="main-container" id="mainScreen">
        <nav class="top-nav">
            <div class="nav-brand">
                <span>ğŸ¬</span>
                <span>××¢×¨×›×ª × ×™×”×•×œ ××œ××™ ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×”</span>
				<span>ğŸ¿</span>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span id="currentUserName"></span>
                    <span class="user-role" id="currentUserRole"></span>
                </div>
                <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
            </div>
        </nav>
        
        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <h3>×¡×”"×› ××•×¦×¨×™×</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>××•×¦×¨×™× ×‘××œ××™ × ××•×š</h3>
                    <div class="value" id="lowStockCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>××•×¦×¨×™× ×œ×ª×¤×•×’×” ×§×¨×•×‘×”</h3>
                    <div class="value" id="expiringCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>×ª× ×•×¢×•×ª ×”×™×•×</h3>
                    <div class="value" id="todayMovements">0</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="showTab('inventory')" data-permission="view_inventory">××œ××™ × ×•×›×—×™</div>
                <div class="tab" onclick="showTab('movements')" data-permission="view_movements">×ª× ×•×¢×•×ª ××œ××™</div>
                <div class="tab" onclick="showTab('transaction')" data-permission="add_transaction">×¨×™×©×•× ×ª× ×•×¢×”</div>
                <div class="tab" onclick="showTab('addItem')" data-permission="add_item">×”×•×¡×¤×ª ×¤×¨×™×˜</div>
                <div class="tab" onclick="showTab('users')" data-permission="manage_users">× ×™×”×•×œ ××©×ª××©×™×</div>
                <div class="tab" onclick="showTab('reports')" data-permission="view_reports">×“×•×—×•×ª</div>
            </div>
            
            <!-- ×˜××‘ ××œ××™ × ×•×›×—×™ -->
            <div id="inventory" class="tab-content active">
                <h2>××œ××™ × ×•×›×—×™</h2>
                <div id="alerts"></div>
                <div class="table-wrapper">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th>×©× ××•×¦×¨</th>
                                <th>×§×˜×’×•×¨×™×”</th>
                                <th>×›××•×ª × ×•×›×—×™×ª</th>
                                <th>×›××•×ª ××™× ×™××•×</th>
                                <th>×™×—×™×“×ª ××™×“×”</th>
                                <th>×ª××¨×™×š ×ª×¤×•×’×”</th>
                                <th>××™×§×•×</th>
                                <th>×¡×˜×˜×•×¡</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ×˜××‘ ×ª× ×•×¢×•×ª ××œ××™ -->
            <div id="movements" class="tab-content">
                <h2>×ª× ×•×¢×•×ª ××œ××™</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>×ª××¨×™×š</th>
                                <th>×©×¢×”</th>
                                <th>×©× ××•×¦×¨</th>
                                <th>×¤×¢×•×œ×”</th>
                                <th>×›××•×ª</th>
                                <th>××‘×¦×¢</th>
                                <th>×”×¢×¨×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="movementsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ×˜××‘ ×¨×™×©×•× ×ª× ×•×¢×” -->
            <div id="transaction" class="tab-content">
                <h2>×¨×™×©×•× ×ª× ×•×¢×ª ××œ××™</h2>
                <form id="transactionForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transProduct">×‘×—×¨ ××•×¦×¨</label>
                            <select id="transProduct" required></select>
                        </div>
                        <div class="form-group">
                            <label for="transType">×¡×•×’ ×¤×¢×•×œ×”</label>
                            <select id="transType" required>
                                <option value="">×‘×—×¨ ×¤×¢×•×œ×”</option>
                                <option value="×”×•×¦××”">×”×•×¦××” ××”××œ××™</option>
                                <option value="×”×›× ×¡×”">×”×›× ×¡×” ×œ××œ××™</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="transQuantity">×›××•×ª</label>
                            <input type="number" id="transQuantity" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="transNotes">×”×¢×¨×•×ª</label>
                            <input type="text" id="transNotes" placeholder="×¡×™×‘×”/×”×¢×¨×•×ª">
                        </div>
                    </div>
                    
                    <button type="submit">×¨×©×•× ×ª× ×•×¢×”</button>
                </form>
            </div>
            
            <!-- ×˜××‘ ×”×•×¡×¤×ª ×¤×¨×™×˜ -->
            <div id="addItem" class="tab-content">
                <h2>×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×© ×œ××œ××™</h2>
                <form id="addItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemName">×©× ××•×¦×¨</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="itemCategory">×§×˜×’×•×¨×™×”</label>
                            <select id="itemCategory" required>
                                <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                                <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                                <option value="××©×§××•×ª">××©×§××•×ª</option>
                                <option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
                                <option value="×¦×™×•×“">×¦×™×•×“</option>
                                <option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemQuantity">×›××•×ª</label>
                            <input type="number" id="itemQuantity" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="itemMinQuantity">×›××•×ª ××™× ×™××•×</label>
                            <input type="number" id="itemMinQuantity" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="itemUnit">×™×—×™×“×ª ××™×“×”</label>
                            <select id="itemUnit" required>
                                <option value="">×‘×—×¨ ×™×—×™×“×”</option>
                                <option value="×™×—×™×“×•×ª">×™×—×™×“×•×ª</option>
                                <option value="×§×´×’">×§×´×’</option>
                                <option value="×œ×™×˜×¨">×œ×™×˜×¨</option>
                                <option value="×—×‘×™×œ×•×ª">×—×‘×™×œ×•×ª</option>
                                <option value="×§×•×¤×¡××•×ª">×§×•×¤×¡××•×ª</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemExpiry">×ª××¨×™×š ×ª×¤×•×’×”</label>
                            <input type="date" id="itemExpiry">
                        </div>
                        <div class="form-group">
                            <label for="itemLocation">××—×¡×Ÿ</label>
                            <select id="itemLocation" required>
							    <option value="">×‘×—×¨ ××—×¡×Ÿ</option>
                                <option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
                                <option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
                                <option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
                                <option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
                                <option value="×˜×›× ×™">×˜×›× ×™</option>
								<option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
								<option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
							</select>	
                        </div>
                    </div>
                    <button type="submit">×”×•×¡×£ ×¤×¨×™×˜</button>
                </form>
            </div>
            
            <!-- ×˜××‘ × ×™×”×•×œ ××©×ª××©×™× -->
            <div id="users" class="tab-content">
                <h2>× ×™×”×•×œ ××©×ª××©×™×</h2>
                
                <h3>×”×•×¡×¤×ª ××©×ª××© ×—×“×©</h3>
                <form id="addUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUsername">×©× ××©×ª××©</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">×¡×™×¡××”</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newFullName">×©× ××œ×</label>
                            <input type="text" id="newFullName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="newUserRole">×ª×¤×§×™×“</label>
                        <select id="newUserRole" required onchange="updatePermissionsByRole()">
                            <option value="">×‘×—×¨ ×ª×¤×§×™×“</option>
                            <option value="×× ×”×œ ××¢×¨×›×ª">×× ×”×œ ××¢×¨×›×ª</option>
                            <option value="×× ×”×œ ××ª×—×">×× ×”×œ ××ª×—×</option>
                            <option value="×× ×”×œ ××©××¨×ª">×× ×”×œ ××©××¨×ª</option>
                            <option value="×¡×•×¤×¨×•×•×™×–×¨">×¡×•×¤×¨×•×•×™×–×¨</option>
                            <option value="××—×¡× ××™">××—×¡× ××™</option>
                        </select>
                    </div>
                    
                    <h4>×”×¨×©××•×ª</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_inventory" checked>
                            <label for="perm_view_inventory">×¦×¤×™×™×” ×‘××œ××™</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_movements" checked>
                            <label for="perm_view_movements">×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_transaction">
                            <label for="perm_add_transaction">×¨×™×©×•× ×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_item">
                            <label for="perm_add_item">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_manage_users">
                            <label for="perm_manage_users">× ×™×”×•×œ ××©×ª××©×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_reports">
                            <label for="perm_view_reports">×¦×¤×™×™×” ×‘×“×•×—×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_edit_items">
                            <label for="perm_edit_items">×¢×¨×™×›×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_edit_users">
                            <label for="perm_edit_users">×¢×¨×™×›×ª ××©×ª××©×™×</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">×”×•×¡×£ ××©×ª××©</button>
                </form>
                
                <h3 style="margin-top: 40px;">××©×ª××©×™× ×§×™×™××™×</h3>
                <div class="user-list" id="userList"></div>
            </div>
            
            <!-- ×˜××‘ ×“×•×—×•×ª -->
            <div id="reports" class="tab-content">
                <h2>×“×•×—×•×ª</h2>
                <div class="form-row">
                    <button onclick="generateReport('inventory')" class="btn-small">×“×•×— ××œ××™ ××œ×</button>
                    <button onclick="generateReport('lowStock')" class="btn-small">×“×•×— ×—×•×¡×¨×™×</button>
                    <button onclick="generateReport('expiring')" class="btn-small">×“×•×— ×ª×¤×•×’×•×ª</button>
                    <button onclick="generateReport('movements')" class="btn-small">×“×•×— ×ª× ×•×¢×•×ª</button>
                </div>
                <div id="reportContent" style="margin-top: 30px;"></div>
            </div>
        </div>
        
        <!-- ××•×“×œ ×¢×¨×™×›×ª ××•×¦×¨ -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>×¢×¨×™×›×ª ××•×¦×¨</h2>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <form id="editItemForm">
                    <input type="hidden" id="editItemOriginalName">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemName">×©× ××•×¦×¨</label>
                            <input type="text" id="editItemName" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemCategory">×§×˜×’×•×¨×™×”</label>
                            <select id="editItemCategory" required>
                                <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                                <option value="××©×§××•×ª">××©×§××•×ª</option>
                                <option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
                                <option value="×¦×™×•×“">×¦×™×•×“</option>
                                <option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemQuantity">×›××•×ª</label>
                            <input type="number" id="editItemQuantity" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemMinQuantity">×›××•×ª ××™× ×™××•×</label>
                            <input type="number" id="editItemMinQuantity" min="0" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemUnit">×™×—×™×“×ª ××™×“×”</label>
                            <select id="editItemUnit" required>
                                <option value="×™×—×™×“×•×ª">×™×—×™×“×•×ª</option>
                                <option value="×§×´×’">×§×´×’</option>
                                <option value="×œ×™×˜×¨">×œ×™×˜×¨</option>
                                <option value="×—×‘×™×œ×•×ª">×—×‘×™×œ×•×ª</option>
                                <option value="×§×•×¤×¡××•×ª">×§×•×¤×¡××•×ª</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editItemExpiry">×ª××¨×™×š ×ª×¤×•×’×”</label>
                            <input type="date" id="editItemExpiry">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="editItemLocation">××™×§×•× ×‘××—×¡×Ÿ</label>
                        <select id="editItemLocation" required>
                            <option value="">×‘×—×¨ ××—×¡×Ÿ</option>
                            <option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
                            <option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
                            <option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
                            <option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
                            <option value="×˜×›× ×™">×˜×›× ×™</option>
                            <option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
                            <option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
                        </select>
                    </div>
                    <button type="submit">×©××•×¨ ×©×™× ×•×™×™×</button>
                </form>
            </div>
        </div>
        
        <!-- ××•×“×œ ×¢×¨×™×›×ª ××©×ª××© -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>×¢×¨×™×›×ª ××©×ª××©</h2>
                    <span class="close" onclick="closeEditUserModal()">&times;</span>
                </div>
                <form id="editUserForm">
                    <input type="hidden" id="editUserOriginalUsername">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUsername">×©× ××©×ª××©</label>
                            <input type="text" id="editUsername" required readonly>
                        </div>
                        <div class="form-group">
                            <label for="editUserPassword">×¡×™×¡××” ×—×“×©×” (×”×©××¨ ×¨×™×§ ×× ×œ× ×¨×•×¦×” ×œ×©× ×•×ª)</label>
                            <input type="password" id="editUserPassword">
                        </div>
                        <div class="form-group">
                            <label for="editUserFullName">×©× ××œ×</label>
                            <input type="text" id="editUserFullName" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="editUserRole">×ª×¤×§×™×“</label>
                        <select id="editUserRole" required onchange="updateEditPermissionsByRole()">
                            <option value="×× ×”×œ ××¢×¨×›×ª">×× ×”×œ ××¢×¨×›×ª</option>
                            <option value="×× ×”×œ ××ª×—×">×× ×”×œ ××ª×—×</option>
                            <option value="×× ×”×œ ××©××¨×ª">×× ×”×œ ××©××¨×ª</option>
                            <option value="×¡×•×¤×¨×•×•×™×–×¨">×¡×•×¤×¨×•×•×™×–×¨</option>
                            <option value="××—×¡× ××™">××—×¡× ××™</option>
                        </select>
                    </div>
                    
                    <h4>×”×¨×©××•×ª</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_inventory">
                            <label for="edit_perm_view_inventory">×¦×¤×™×™×” ×‘××œ××™</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_movements">
                            <label for="edit_perm_view_movements">×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_transaction">
                            <label for="edit_perm_add_transaction">×¨×™×©×•× ×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_item">
                            <label for="edit_perm_add_item">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_manage_users">
                            <label for="edit_perm_manage_users">× ×™×”×•×œ ××©×ª××©×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_reports">
                            <label for="edit_perm_view_reports">×¦×¤×™×™×” ×‘×“×•×—×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_edit_items">
                            <label for="edit_perm_edit_items">×¢×¨×™×›×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_edit_users">
                            <label for="edit_perm_edit_users">×¢×¨×™×›×ª ××©×ª××©×™×</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">×©××•×¨ ×©×™× ×•×™×™×</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>

    <script>
        // --- ×”×’×“×¨×ª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg4keZ42SfFHhwjhkYbl7TdJnuN0WsuUc",
            authDomain: "inventory-57376.firebaseapp.com",
            projectId: "inventory-57376",
            storageBucket: "inventory-57376.appspot.com",
            messagingSenderId: "165204980655",
            appId: "1:165204980655:web:f7c5a78a0ae11f7191355a",
            measurementId: "G-E8EK3N3DLE"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        let users = [];
        let inventory = [];
        let movements = [];
        let currentUser = null;

        // --- ×”×’×“×¨×ª ×”×¨×©××•×ª ×œ×¤×™ ×ª×¤×§×™×“ ---
        const rolePermissions = {
            '×× ×”×œ ××¢×¨×›×ª': ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'manage_users', 'view_reports', 'edit_items', 'edit_users'],
            '×× ×”×œ ××ª×—×': ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'manage_users', 'view_reports', 'edit_items', 'edit_users'],
            '×× ×”×œ ××©××¨×ª': ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'view_reports'],
            '×¡×•×¤×¨×•×•×™×–×¨': ['view_inventory', 'view_movements', 'add_transaction', 'view_reports'],
            '××—×¡× ××™': ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'view_reports', 'edit_items']
        };

        // --- ×¤×•× ×§×¦×™×•×ª Firebase ---
        async function loadAllData() {
            // ×˜×¢×Ÿ ××©×ª××©×™×
            users = [];
            let usersSnap = await db.collection('users').get();
            usersSnap.forEach(doc => users.push(doc.data()));
            if (users.length === 0) { // ×‘××™×“×” ×•×œ× ×§×™×™××™× ××©×ª××©×™× â€“ ×¦×•×¨ ×‘×¨×™×¨×ª ××—×“×œ
                users = [
                    {
                        username: 'admin',
                        password: '1234',
                        fullName: '×× ×”×œ ×”××¢×¨×›×ª',
                        role: '×× ×”×œ ××¢×¨×›×ª',
                        permissions: rolePermissions['×× ×”×œ ××¢×¨×›×ª']
                    },
                    {
                        username: 'warehouse',
                        password: '1234',
                        fullName: '×™×•×¡×™ ×›×”×Ÿ',
                        role: '××—×¡× ××™',
                        permissions: rolePermissions['××—×¡× ××™']
                    },
                    {
                        username: 'staff',
                        password: '1234',
                        fullName: '×“× ×™ ×œ×•×™',
                        role: '×¡×•×¤×¨×•×•×™×–×¨',
                        permissions: rolePermissions['×¡×•×¤×¨×•×•×™×–×¨']
                    }
                ];
                for (const u of users) {
                    await db.collection('users').doc(u.username).set(u);
                }
            }
            // ×˜×¢×Ÿ ××œ××™
            inventory = [];
            let invSnap = await db.collection('inventory').get();
            invSnap.forEach(doc => inventory.push(doc.data()));
            if (inventory.length === 0) { // ×‘×¨×™×¨×ª ××—×“×œ
                inventory = [
                    
                ];
                for (const item of inventory) {
                    await db.collection('inventory').doc(item.name).set(item);
                }
            }
            // ×˜×¢×Ÿ ×ª× ×•×¢×•×ª
            movements = [];
            let movSnap = await db.collection('movements').orderBy('date', 'desc').limit(200).get();
            movSnap.forEach(doc => movements.push(doc.data()));
        }

        async function saveUser(user) {
            await db.collection('users').doc(user.username).set(user);
        }

        async function deleteUserFromDB(username) {
            await db.collection('users').doc(username).delete();
        }

        async function saveInventoryItem(item) {
            await db.collection('inventory').doc(item.name).set(item);
        }

        async function deleteInventoryItem(name) {
            await db.collection('inventory').doc(name).delete();
        }

        async function saveMovement(movement) {
            await db.collection('movements').add(movement);
        }

        // --- LOGIN & BOOT ---
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                if (users.length === 0) await loadAllData();
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    showMainScreen();
                    showToast(`×‘×¨×•×š ×”×‘×, ${user.fullName}!`, 'success');
                } else {
                    showToast('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showToast('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª. × ×¡×” ×©×•×‘.', 'error');
            }
        });

        function showMainScreen() {
			
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = currentUser.role;
            updateTabsVisibility();
            displayInventory();
        }

		function updateTabsVisibility() {
			const tabs = document.querySelectorAll('.tab');
			tabs.forEach(tab => {
				// ×”×—×–×¨ ×œ×›×œ ×”×˜××‘×™× ×ª×¦×•×’×” ×¨×’×™×œ×” ×‘×”×ª×—×œ×”
				tab.classList.remove('disabled');
				tab.style.display = 'flex'; // ××• 'flex' ×× ×–×” ×œ× ×¢×•×‘×“ ×˜×•×‘ ×¢× ×¨×¡×¤×•× ×¡×™×‘×™×•×ª
				const permission = tab.getAttribute('data-permission');
				if (permission && !currentUser.permissions.includes(permission)) {
					tab.classList.add('disabled');
					tab.style.display = 'none';
				}
			});
		}


        function logout() {
			const editModal = document.getElementById('editModal');
			if (editModal) editModal.style.display = 'none';
            const editUserModal = document.getElementById('editUserModal');
            if (editUserModal) editUserModal.style.display = 'none';
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        window.addEventListener('load', async function() {
            try {
                await loadAllData();
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    if (users.find(u => u.username === currentUser.username)) {
                        showMainScreen();
                    } else {
                        localStorage.removeItem('currentUser');
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
            }
        });

        // --- TAB HANDLERS ---
        window.showTab = function(tabName) {
            const tabElement = event.target;
            const permission = tabElement.getAttribute('data-permission');
            if (permission && !currentUser.permissions.includes(permission)) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×’×©×ª ×œ×ª×¤×¨×™×˜ ×–×”', 'error');
                return;
            }
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            if (tabName === 'inventory') displayInventory();
            else if (tabName === 'movements') displayMovements();
            else if (tabName === 'transaction') populateProductSelect();
            else if (tabName === 'users') displayUsers();
        };

        function displayInventory() {
            const tbody = document.getElementById('inventoryBody');
            const alerts = document.getElementById('alerts');
            tbody.innerHTML = '';
            alerts.innerHTML = '';
            let lowStockItems = [];
            let expiringItems = [];
            inventory.forEach(item => {
                const row = tbody.insertRow();
                const isLowStock = item.quantity < item.minQuantity;
                const daysToExpiry = item.expiry ? Math.floor((new Date(item.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                const isExpiringSoon = daysToExpiry !== null && daysToExpiry <= 14;
                if (isLowStock) {
                    row.classList.add('low-stock');
                    lowStockItems.push(item.name);
                }
                if (isExpiringSoon) {
                    row.classList.add('expiring-soon');
                    expiringItems.push({name: item.name, days: daysToExpiry});
                }
                
                // ×‘×“×™×§×” ×”×× ×œ××©×ª××© ×™×© ×”×¨×©××ª ×¢×¨×™×›×ª ×¤×¨×™×˜×™×
                const canEditItems = currentUser.permissions.includes('edit_items');
                
				row.innerHTML = `
					<td>${item.name}</td>
					<td>${item.category}</td>
					<td>${item.quantity}</td>
					<td>${item.minQuantity}</td>
					<td>${item.unit}</td>
					<td>${item.expiry || '-'}</td>
					<td>${item.location}</td>
					<td>${getStatus(item, daysToExpiry)}</td>
					<td>
						${
							canEditItems
							? `
								<button class="btn-small btn-edit" data-name="${item.name}" onclick="editItemFromBtn(this)">×¢×¨×•×š</button>
								<button class="btn-small btn-danger" data-name="${item.name}" onclick="deleteItemFromBtn(this)">××—×§</button>
							`
							: ''
						}
					</td>
				`;

            });

            if (lowStockItems.length > 0) {
                alerts.innerHTML += `
                    <div class="alert alert-danger">
                        <span>âš ï¸</span>
                        <span>××œ××™ × ××•×š: ${lowStockItems.join(', ')}</span>
                    </div>
                `;
            }
            if (expiringItems.length > 0) {
                const expiringList = expiringItems.map(item => `${item.name} (${item.days} ×™××™×)`).join(', ');
                alerts.innerHTML += `
                    <div class="alert alert-warning">
                        <span>â°</span>
                        <span>×ª×¤×•×’×” ×§×¨×•×‘×”: ${expiringList}</span>
                    </div>
                `;
            }
            updateStats();
        }

        function getStatus(item, daysToExpiry) {
            if (item.quantity < item.minQuantity) return 'ğŸ”´ ××œ××™ × ××•×š';
            if (daysToExpiry !== null && daysToExpiry <= 14) return 'ğŸŸ¡ ×ª×¤×•×’×” ×§×¨×•×‘×”';
            return 'ğŸŸ¢ ×ª×§×™×Ÿ';
        }

        function updateStats() {
            document.getElementById('totalProducts').textContent = inventory.length;
            document.getElementById('lowStockCount').textContent = inventory.filter(item => item.quantity < item.minQuantity).length;
            const expiringCount = inventory.filter(item => {
                if (!item.expiry) return false;
                const days = Math.floor((new Date(item.expiry) - new Date()) / (1000 * 60 * 60 * 24));
                return days <= 14;
            }).length;
            document.getElementById('expiringCount').textContent = expiringCount;
            const today = new Date().toLocaleDateString('he-IL');
            const todayMovements = movements.filter(m => m.date === today).length;
            document.getElementById('todayMovements').textContent = todayMovements;
        }

        function displayMovements() {
            const tbody = document.getElementById('movementsBody');
            tbody.innerHTML = '';
            movements.forEach(movement => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${movement.date}</td>
                    <td>${movement.time}</td>
                    <td>${movement.product}</td>
                    <td>${movement.type}</td>
                    <td>${movement.quantity}</td>
                    <td>${movement.user}</td>
                    <td>${movement.notes || ''}</td>
                `;
            });
        }

        function populateProductSelect() {
            const select = document.getElementById('transProduct');
            select.innerHTML = '<option value="">×‘×—×¨ ××•×¦×¨</option>';
            inventory.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                option.textContent = `${item.name} (× ×•×›×—×™: ${item.quantity} ${item.unit})`;
                select.appendChild(option);
            });
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×“×›×•×Ÿ ×”×¨×©××•×ª ×œ×¤×™ ×ª×¤×§×™×“ ---
		window.updatePermissionsByRole = function() {
			const role = document.getElementById('newUserRole').value;
			if (role && rolePermissions[role]) {
				const permissions = rolePermissions[role];
				// ××¤×¡ ××ª ×›×œ ×”×¦'×§×‘×•×§×¡×™×
				document.querySelectorAll('#addUserForm input[type="checkbox"]').forEach(cb => {
					cb.checked = false;
				});
				// ×¡××Ÿ ××ª ×”×”×¨×©××•×ª
				permissions.forEach(perm => {
					const checkbox = document.getElementById('perm_' + perm);
					if (checkbox) checkbox.checked = true;
				});
			}
		};

        
        window.closeEditUserModal = function() {
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserForm').reset();
        };
        
		document.getElementById('editUserForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			const originalUsername = document.getElementById('editUserOriginalUsername').value;
			const permissions = [];
			document.querySelectorAll('#editUserForm input[type="checkbox"]:checked').forEach(cb => {
				permissions.push(cb.id.replace('edit_perm_', ''));
			});

			const updatedUser = {
				username: originalUsername, // ×©× ××©×ª××© ×œ× ××©×ª× ×”
				fullName: document.getElementById('editUserFullName').value,
				role: document.getElementById('editUserRole').value,
				permissions: permissions
			};

			// ×¢×“×›×Ÿ ×¡×™×¡××” ×¨×§ ×× ×”×•×–× ×” ×¡×™×¡××” ×—×“×©×”
			const newPassword = document.getElementById('editUserPassword').value;
			if (newPassword) {
				updatedUser.password = newPassword;
			} else {
				// ×©××•×¨ ××ª ×”×¡×™×¡××” ×”×§×™×™××ª
				const existingUser = users.find(u => u.username === originalUsername);
				if (existingUser) {
					updatedUser.password = existingUser.password;
				}
			}

			// ×¢×“×›×Ÿ ×‘××¢×¨×š ×”××§×•××™
			const index = users.findIndex(u => u.username === originalUsername);
			if (index !== -1) {
				users[index] = updatedUser;
			}

			// ×©××•×¨ ×‘-Firebase
			await saveUser(updatedUser);
			await loadAllData();

			showToast('×”××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
			closeEditUserModal();
			displayUsers();
		});


        window.updateEditPermissionsByRole = function() {
            const role = document.getElementById('editUserRole').value;
            if (role && rolePermissions[role]) {
                const permissions = rolePermissions[role];
                // ××¤×¡ ××ª ×›×œ ×”×¦'×§×‘×•×§×¡×™×
                document.querySelectorAll('#editUserForm input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                });
                // ×¡××Ÿ ××ª ×”×”×¨×©××•×ª ×”××ª××™××•×ª ×œ×ª×¤×§×™×“
                permissions.forEach(perm => {
                    const checkbox = document.getElementById('edit_perm_' + perm);
                    if (checkbox) checkbox.checked = true;
                });
            }
        };

        // --- ×˜×¤×¡×™× ××œ××™/×ª× ×•×¢×•×ª/××©×ª××©×™× ---
        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentUser.permissions.includes('add_item')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×”×•×¡×™×£ ×¤×¨×™×˜×™×', 'error');
                return;
            }
            const newItem = {
                name: document.getElementById('itemName').value,
                category: document.getElementById('itemCategory').value,
                quantity: parseInt(document.getElementById('itemQuantity').value),
                minQuantity: parseInt(document.getElementById('itemMinQuantity').value),
                unit: document.getElementById('itemUnit').value,
                expiry: document.getElementById('itemExpiry').value,
                location: document.getElementById('itemLocation').value
            };
            inventory.push(newItem);
            await saveInventoryItem(newItem);
            await loadAllData();
            showToast('×”×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
            this.reset();
            showTab('inventory');
        });

        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentUser.permissions.includes('add_transaction')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¨×©×•× ×ª× ×•×¢×•×ª', 'error');
                return;
            }
            const productName = document.getElementById('transProduct').value;
            const transType = document.getElementById('transType').value;
            const quantity = parseInt(document.getElementById('transQuantity').value);
            const notes = document.getElementById('transNotes').value;
            const item = inventory.find(i => i.name === productName);
            if (item) {
                if (transType === '×”×•×¦××”') {
                    if (item.quantity >= quantity) {
                        item.quantity -= quantity;
                    } else {
                        showToast('××™×Ÿ ××¡×¤×™×§ ×‘××œ××™!', 'error');
                        return;
                    }
                } else {
                    item.quantity += quantity;
                }
                await saveInventoryItem(item);
            }
            const now = new Date();
            const movement = {
                date: now.toLocaleDateString('he-IL'),
                time: now.toLocaleTimeString('he-IL', {hour: '2-digit', minute: '2-digit'}),
                product: productName,
                type: transType,
                quantity: quantity,
                user: currentUser.fullName,
                notes: notes
            };
            movements.push(movement);
            await saveMovement(movement);
            await loadAllData();
            showToast('×”×ª× ×•×¢×” × ×¨×©××” ×‘×”×¦×œ×—×”!', 'success');
            this.reset();
            displayInventory();
            updateStats();
        });

        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentUser.permissions.includes('manage_users')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ× ×”×œ ××©×ª××©×™×', 'error');
                return;
            }
            const permissions = [];
            document.querySelectorAll('#addUserForm input[type="checkbox"]:checked').forEach(cb => {
                permissions.push(cb.id.replace('perm_', ''));
            });
            const role = document.getElementById('newUserRole').value;
            const newUser = {
                username: document.getElementById('newUsername').value,
                password: document.getElementById('newPassword').value,
                fullName: document.getElementById('newFullName').value,
                role: role,
                permissions: permissions
            };
            if (users.find(u => u.username === newUser.username)) {
                showToast('×©× ××©×ª××© ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª', 'error');
                return;
            }
            users.push(newUser);
            await saveUser(newUser);
            await loadAllData();
            showToast('×”××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
            this.reset();
            displayUsers();
        });

        function displayUsers() {
            const userList = document.getElementById('userList');
            userList.innerHTML = '';
            users.forEach((user, index) => {
                const canDelete = user.username !== 'admin' && currentUser.permissions.includes('edit_users');
                const canEdit = currentUser.permissions.includes('edit_users');
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-details">
                        <strong>${user.fullName}</strong>
                        <div style="font-size:14px;color:#666;">
                            ×©× ××©×ª××©: ${user.username} | ×ª×¤×§×™×“: ${user.role}
                        </div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">
                            ×”×¨×©××•×ª: ${user.permissions.map(p => getPermissionName(p)).join(', ')}
                        </div>
                    </div>
                    <div class="user-actions">
                        ${canEdit ? `<button class="btn-small btn-edit" onclick="editUser('${user.username}')">×¢×¨×•×š</button>` : ''}
                        ${canDelete ? `<button class="btn-small btn-danger" onclick="deleteUser('${user.username}')">××—×§</button>` : ''}
                    </div>
                `;
                userList.appendChild(userCard);
            });
        }

        function getPermissionName(permission) {
            const names = {
                'view_inventory': '×¦×¤×™×™×” ×‘××œ××™',
                'view_movements': '×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª',
                'add_transaction': '×¨×™×©×•× ×ª× ×•×¢×•×ª',
                'add_item': '×”×•×¡×¤×ª ×¤×¨×™×˜×™×',
                'manage_users': '× ×™×”×•×œ ××©×ª××©×™×',
                'view_reports': '×¦×¤×™×™×” ×‘×“×•×—×•×ª',
                'edit_items': '×¢×¨×™×›×ª ×¤×¨×™×˜×™×',
                'edit_users': '×¢×¨×™×›×ª ××©×ª××©×™×'
            };
            return names[permission] || permission;
        }

        window.deleteUser = async function(username) {
            if (!currentUser.permissions.includes('edit_users')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ××—×•×§ ××©×ª××©×™×', 'error');
                return;
            }
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××©×ª××© ×–×”?')) return;
            users = users.filter(u => u.username !== username);
            await deleteUserFromDB(username);
            await loadAllData();
            showToast('×”××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”', 'success');
            displayUsers();
        };

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (type === 'error') toast.style.background = '#e74c3c';
            else if (type === 'success') toast.style.background = '#27ae60';
            else toast.style.background = '#333';
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×¨×™×›×” ×•××—×™×§×ª ××•×¦×¨×™× ---
		window.editItem = function(itemName) {
            if (!currentUser.permissions.includes('edit_items')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ×¤×¨×™×˜×™×', 'error');
                return;
            }
			const item = inventory.find(i => i.name === itemName);
			if (!item) {
				alert("×œ× × ××¦× ××•×¦×¨ ×‘×©×: " + itemName);
				return;
			}
            
            document.getElementById('editItemOriginalName').value = item.name;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemCategory').value = item.category;
            document.getElementById('editItemQuantity').value = item.quantity;
            document.getElementById('editItemMinQuantity').value = item.minQuantity;
            document.getElementById('editItemUnit').value = item.unit;
            document.getElementById('editItemExpiry').value = item.expiry || '';
            document.getElementById('editItemLocation').value = item.location;
            
            document.getElementById('editModal').style.display = 'block';
        };
		
		window.editItemFromBtn = function(btn) {
			const itemName = btn.getAttribute('data-name');
			window.editItem(itemName);
		};
        
        window.deleteItem = async function(itemName) {
            if (!currentUser.permissions.includes('edit_items')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ××—×•×§ ×¤×¨×™×˜×™×', 'error');
                return;
            }
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××•×¦×¨ "${itemName}"?`)) return;
            
            inventory = inventory.filter(i => i.name !== itemName);
            await deleteInventoryItem(itemName);
            await loadAllData();
            showToast('×”××•×¦×¨ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
            displayInventory();
        };

        window.deleteItemFromBtn = function(btn) {
            const itemName = btn.getAttribute('data-name');
            window.deleteItem(itemName);
        };
        
        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editItemForm').reset();
        };
        
        document.getElementById('editItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const originalName = document.getElementById('editItemOriginalName').value;
            const updatedItem = {
                name: document.getElementById('editItemName').value,
                category: document.getElementById('editItemCategory').value,
                quantity: parseInt(document.getElementById('editItemQuantity').value),
                minQuantity: parseInt(document.getElementById('editItemMinQuantity').value),
                unit: document.getElementById('editItemUnit').value,
                expiry: document.getElementById('editItemExpiry').value,
                location: document.getElementById('editItemLocation').value
            };
            
            // ×× ×”×©× ×”×©×ª× ×”, ××—×§ ××ª ×”×¤×¨×™×˜ ×”×™×©×Ÿ
            if (originalName !== updatedItem.name) {
                await deleteInventoryItem(originalName);
            }
            
            // ×¢×“×›×Ÿ ×‘××¢×¨×š ×”××§×•××™
            const index = inventory.findIndex(i => i.name === originalName);
            if (index !== -1) {
                inventory[index] = updatedItem;
            }
            
            // ×©××•×¨ ×‘-Firebase
            await saveInventoryItem(updatedItem);
            await loadAllData();
            
            showToast('×”××•×¦×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
            closeEditModal();
            displayInventory();
        });

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×¨×™×›×ª ××©×ª××© ---
        window.editUser = function(username) {
            if (!currentUser.permissions.includes('edit_users')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ××©×ª××©×™×', 'error');
                return;
            }
            const user = users.find(u => u.username === username);
            if (!user) {
                alert("×œ× × ××¦× ××©×ª××© ×‘×©×: " + username);
                return;
            }
            
            document.getElementById('editUserOriginalUsername').value = user.username;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editUserPassword').value = '';
            document.getElementById('editUserFullName').value = user.fullName;
            document.getElementById('editUserRole').value = user.role;
            
            // ××¤×¡ ××ª ×›×œ ×”×¦'×§×‘×•×§×¡×™×
            document.querySelectorAll('#editUserForm input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // ×¡××Ÿ ××ª ×”×”×¨×©××•×ª