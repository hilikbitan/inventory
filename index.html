<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="theme-color" content="#2c3e50">
	<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItee16LXqNeb16og16DXmdeU15XXnCDXnteZ15DXmSAtINeh15nXoNeV15Qg16HXmdeY15kiLAogICJzaG9ydF9uYW1lIjogItee15zXkNeZINeh15nXoNeV15QiLAogICJzdGFydF91cmwiOiAiLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2Y1ZjVmNSIsCiAgInRoZW1lX2NvbG9yIjogIiMyYzNlNTAiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImRhdGE6aW1hZ2UvcG5nO2Jhc2U2NCxpVkJPUncwS0dnb0FBQUFOU1VoRVVnQUFBSUFBQUFDQUNBWUFBQUREdDFkRkFBQUFCSE5DU1ZRSUNBZ0lmQWhraUFBQUFBbHdTRmx6QUFBQUJFZ0FBQUI0QVlnQlpBQUFBQUFCbDVqbGtBQUFBQUFBQUFBQUFBQUFBQkpSVTVFcmtKZ2dnPT0iLAogICAgICAic2l6ZXMiOiAiMTI4eDEyOCIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIKICAgIH0KICBdCn0=">
    <title>××¢×¨×›×ª × ×™×”×•×œ ××œ××™ - ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×”</title>
    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* Modal styles */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: 8px; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { margin: 0; }
        .close { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: black; }
        
        * {margin:0;padding:0;box-sizing:border-box;}
        body {font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;background-color:#f5f5f5;color:#333;line-height:1.6;min-height:100vh;}
        .login-container {display:flex;align-items:center;justify-content:center;min-height:100vh;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);}
        .login-box {background:white;padding:40px;border-radius:12px;box-shadow:0 15px 35px rgba(0,0,0,0.2);width:90%;max-width:400px;}
        .login-box h1 {text-align:center;margin-bottom:30px;color:#333;}
        .main-container {display:none;min-height:100vh;}
        .top-nav {background:#2c3e50;color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
        .nav-brand {font-size:20px;font-weight:bold;display:flex;align-items:center;gap:10px;}
        .nav-user {display:flex;align-items:center;gap:15px;}
        .user-info {display:flex;flex-direction:column;align-items:flex-end;font-size:14px;}
        .user-role {font-size:12px;opacity:.8;}
        .logout-btn {background:#e74c3c;color:white;border:none;padding:8px 20px;border-radius:4px;cursor:pointer;font-size:14px;}
        .logout-btn:hover {background:#c0392b;}
        .container {max-width:1400px;margin:0 auto;padding:20px;}
        .tabs {display:flex;gap:5px;margin-bottom:20px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:5px;}
        .tab {padding:12px 20px;background:white;border:2px solid #ddd;cursor:pointer;border-radius:8px;transition:all .3s;font-weight:500;white-space:nowrap;flex-shrink:0;}
        .tab:hover {background:#f8f9fa;}
        .tab.active {background:#3498db;color:white;border-color:#3498db;}
        .tab.disabled {opacity:.5;cursor:not-allowed;}
        .tab-content {display:none;background:white;padding:20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1);}
        .tab-content.active {display:block;}
        .table-wrapper {overflow-x:auto;-webkit-overflow-scrolling:touch;}
        table {width:100%;border-collapse:collapse;margin-top:20px;min-width:600px;}
        th,td {padding:12px;text-align:right;border:1px solid #ddd;}
        th {background:#34495e;color:white;font-weight:600;position:sticky;top:0;z-index:10;cursor:pointer;}
        tr:nth-child(even) {background:#f8f9fa;}
        tr:hover {background:#e8f4fd;}
        .low-stock {background-color:#ffebee!important;color:#c62828;font-weight:bold;}
        .expiring-soon {background-color:#fff3e0!important;color:#ef6c00;}
        .form-group {margin-bottom:20px;}
        label {display:block;margin-bottom:5px;font-weight:600;color:#555;}
        input,select {width:100%;padding:12px;border:1px solid #ddd;border-radius:4px;font-size:16px;-webkit-appearance:none;}
        input:focus,select:focus {outline:none;border-color:#3498db;box-shadow:0 0 0 2px rgba(52,152,219,0.2);}
        button {background:#3498db;color:white;padding:12px 30px;border:none;border-radius:4px;cursor:pointer;font-size:16px;font-weight:600;transition:background .3s;width:auto;}
        button:hover {background:#2980b9;}
        button:disabled {background:#95a5a6;cursor:not-allowed;}
        .stats {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:30px;}
        .stat-card {background:white;padding:20px;border-radius:8px;box-shadow:0 2px 5px rgba(0,0,0,0.1);text-align:center;transition:transform .3s;}
        .stat-card:hover {transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.15);}
        .stat-card h3 {color:#7f8c8d;font-size:14px;margin-bottom:10px;}
        .stat-card .value {font-size:28px;font-weight:bold;color:#2c3e50;}
        .alert {padding:15px;margin-bottom:20px;border-radius:4px;display:flex;align-items:center;gap:10px;}
        .alert-warning {background:#fff3cd;color:#856404;border:1px solid #ffeeba;}
        .alert-danger {background:#f8d7da;color:#721c24;border:1px solid #f5c6cb;}
        .alert-success {background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
        .form-row {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;}
        .user-list {margin-top:20px;}
        .user-card {background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:10px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;}
        .user-details {flex:1;}
        .user-actions {display:flex;gap:10px;}
        .btn-small {padding:6px 15px;font-size:14px;width:auto;}
        .btn-danger {background:#e74c3c;}
        .btn-danger:hover {background:#c0392b;}
        .btn-edit {background:#f39c12;}
        .btn-edit:hover {background:#e67e22;}
        .permission-grid {display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-top:20px;}
        .permission-item {display:flex;align-items:center;gap:10px;}
        
        /* ========================================
		   1. CSS Variables & Root Settings
		   ======================================== */
		:root {
			/* Colors - Light Theme (Default) */
			--bg-primary: #f5f5f5;
			--bg-secondary: #ffffff;
			--bg-nav: #2c3e50;
			--bg-modal: #fefefe;
			
			--text-primary: #333333;
			--text-secondary: #666666;
			--text-nav: #ffffff;
			
			--border-color: #dddddd;
			--border-light: #eeeeee;
			
			--shadow-light: rgba(0, 0, 0, 0.1);
			--shadow-medium: rgba(0, 0, 0, 0.2);
			
			--accent-primary: #3498db;
			--accent-hover: #2980b9;
			--accent-danger: #e74c3c;
			--accent-success: #27ae60;
			--accent-warning: #f39c12;
			
			/* Table Colors */
			--table-header-bg: #34495e;
			--table-header-text: #ffffff;
			--table-row-even: #f8f9fa;
			--table-row-hover: #e8f4fd;
			
			/* Status Colors */
			--status-danger-bg: #ffebee;
			--status-danger-text: #c62828;
			--status-warning-bg: #fff3e0;
			--status-warning-text: #ef6c00;
			--status-success-bg: #e8f5e9;
			--status-success-text: #2e7d32;
			
			/* Spacing */
			--spacing-xs: 5px;
			--spacing-sm: 10px;
			--spacing-md: 15px;
			--spacing-lg: 20px;
			--spacing-xl: 30px;
			
			/* Border Radius */
			--radius-sm: 4px;
			--radius-md: 8px;
			--radius-lg: 12px;
			--radius-round: 50%;
			
			/* Z-index Layers */
			--z-nav: 100;
			--z-modal: 1000;
			--z-toast: 2000;
		}

		/* Dark Theme */
		[data-theme="dark"] {
			--bg-primary: #1a1a1a;
			--bg-secondary: #2d2d2d;
			--bg-nav: #1a1a1a;
			--bg-modal: #2d2d2d;
			
			--text-primary: #e0e0e0;
			--text-secondary: #a0a0a0;
			--text-nav: #e0e0e0;
			
			--border-color: #404040;
			--border-light: #333333;
			
			--shadow-light: rgba(0, 0, 0, 0.3);
			--shadow-medium: rgba(0, 0, 0, 0.5);
			
			--accent-primary: #4fc3f7;
			--accent-hover: #29b6f6;
			--accent-danger: #ef5350;
			--accent-success: #66bb6a;
			--accent-warning: #ffa726;
			
			--table-header-bg: #1a1a1a;
			--table-header-text: #e0e0e0;
			--table-row-even: #252525;
			--table-row-hover: #333333;
			
			--status-danger-bg: rgba(244, 67, 54, 0.2);
			--status-danger-text: #ff8a80;
			--status-warning-bg: rgba(255, 152, 0, 0.2);
			--status-warning-text: #ffb74d;
			--status-success-bg: rgba(76, 175, 80, 0.2);
			--status-success-text: #81c784;
		}

		/* Auto Dark Theme */
		@media (prefers-color-scheme: dark) {
			:root:not([data-theme="light"]) {
				--bg-primary: #1a1a1a;
				--bg-secondary: #2d2d2d;
				--text-primary: #e0e0e0;
				--text-secondary: #a0a0a0;
				/* ... (×›×œ ×©××¨ ×”××©×ª× ×™× ×©×œ dark theme) */
			}
		}

		/* ========================================
		   2. Base Styles & Reset
		   ======================================== */
		* {
			margin: 0;
			padding: 0;
			box-sizing: border-box;
			-webkit-tap-highlight-color: transparent;
		}

		html {
			height: 100%;
			-webkit-text-size-adjust: 100%;
		}

		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
			background-color: var(--bg-primary);
			color: var(--text-primary);
			line-height: 1.6;
			min-height: 100vh;
			min-height: -webkit-fill-available;
			direction: rtl;
			overflow-x: hidden;
		}

		/* ========================================
		   3. Layout Components
		   ======================================== */

		/* Login Screen */
		.login-container {
			display: flex;
			align-items: center;
			justify-content: center;
			min-height: 100vh;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
		}

		.login-box {
			background: var(--bg-secondary);
			padding: 40px;
			border-radius: var(--radius-lg);
			box-shadow: 0 15px 35px var(--shadow-medium);
			width: 90%;
			max-width: 400px;
		}

		.login-box h1 {
			text-align: center;
			margin-bottom: var(--spacing-xl);
			color: var(--text-primary);
		}

		/* Main Container */
		.main-container {
			display: none;
			min-height: 100vh;
			background-color: var(--bg-primary);
		}

		/* Top Navigation */
		.top-nav {
			background: var(--bg-nav);
			color: var(--text-nav);
			padding: var(--spacing-md) var(--spacing-lg);
			display: flex;
			justify-content: space-between;
			align-items: center;
			box-shadow: 0 2px 5px var(--shadow-light);
			z-index: var(--z-nav);
		}

		.nav-brand {
			font-size: 20px;
			font-weight: bold;
			display: flex;
			align-items: center;
			gap: var(--spacing-sm);
		}

		.nav-user {
			display: flex;
			align-items: center;
			gap: var(--spacing-md);
		}

		.user-info {
			display: flex;
			flex-direction: column;
			align-items: flex-end;
			font-size: 14px;
		}

		.user-role {
			font-size: 12px;
			opacity: 0.8;
		}

		/* Container */
		.container {
			max-width: 1400px;
			margin: 0 auto;
			padding: var(--spacing-lg);
		}

		/* ========================================
		   4. Navigation Components
		   ======================================== */

		/* Tabs */
		.tabs {
			display: flex;
			gap: var(--spacing-xs);
			margin-bottom: var(--spacing-lg);
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
			padding-bottom: var(--spacing-xs);
			scrollbar-width: none;
		}

		.tabs::-webkit-scrollbar {
			display: none;
		}

		.tab {
			padding: 12px 20px;
			background: var(--bg-secondary);
			color: var(--text-primary);
			border: 2px solid var(--border-color);
			border-radius: var(--radius-md);
			cursor: pointer;
			transition: all 0.3s;
			font-weight: 500;
			white-space: nowrap;
			flex-shrink: 0;
			position: relative;
			overflow: hidden;
		}

		.tab::after {
			content: '';
			position: absolute;
			bottom: 0;
			left: 50%;
			width: 0;
			height: 3px;
			background: var(--accent-primary);
			transition: all 0.3s ease;
			transform: translateX(-50%);
		}

		.tab:hover {
			background: var(--table-row-hover);
			transform: translateY(-2px);
			box-shadow: 0 4px 8px var(--shadow-light);
		}

		.tab.active {
			background: var(--accent-primary);
			color: white;
			border-color: var(--accent-primary);
		}

		.tab.active::after {
			width: 100%;
		}

		.tab.disabled {
			opacity: 0.5;
			cursor: not-allowed;
			display: none;
		}

		/* Tab Content */
		.tab-content {
			display: none;
			background: var(--bg-secondary);
			padding: var(--spacing-lg);
			border-radius: var(--radius-md);
			box-shadow: 0 2px 10px var(--shadow-light);
			animation: fadeIn 0.3s ease-in-out;
		}

		.tab-content.active {
			display: block;
		}

		/* ========================================
		   5. UI Components
		   ======================================== */

		/* Stat Cards */
		.stats {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: var(--spacing-md);
			margin-bottom: var(--spacing-xl);
		}

		.stat-card {
			background: var(--bg-secondary);
			padding: var(--spacing-lg);
			border-radius: var(--radius-md);
			box-shadow: 0 2px 5px var(--shadow-light);
			text-align: center;
			transition: all 0.3s;
		}

		.stat-card:hover {
			transform: translateY(-5px);
			box-shadow: 0 8px 20px rgba(0,0,0,0.15);
		}

		.stat-card h3 {
			color: var(--text-secondary);
			font-size: 14px;
			margin-bottom: var(--spacing-sm);
		}

		.stat-card .value {
			font-size: 28px;
			font-weight: bold;
			color: var(--text-primary);
			transition: all 0.3s ease;
		}

		.stat-card:hover .value {
			transform: scale(1.05);
			color: var(--accent-primary);
		}

		/* Forms */
		.form-group {
			margin-bottom: var(--spacing-lg);
		}

		.form-row {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: var(--spacing-lg);
		}

		label {
			display: block;
			margin-bottom: var(--spacing-xs);
			font-weight: 600;
			color: var(--text-primary);
		}

		input,
		select,
		textarea {
			width: 100%;
			padding: 12px;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-sm);
			font-size: 16px;
			background: var(--bg-primary);
			color: var(--text-primary);
			-webkit-appearance: none;
			transition: all 0.3s;
		}

		input:focus,
		select:focus,
		textarea:focus {
			outline: none;
			border-color: var(--accent-primary);
			box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
		}

		/* Checkboxes */
		input[type="checkbox"] {
			appearance: none;
			width: 20px;
			height: 20px;
			border: 2px solid var(--border-color);
			border-radius: var(--radius-sm);
			background-color: var(--bg-secondary);
			cursor: pointer;
			position: relative;
			transition: all 0.3s;
		}

		input[type="checkbox"]:checked {
			background-color: var(--accent-primary);
			border-color: var(--accent-primary);
		}

		input[type="checkbox"]:checked::after {
			content: 'âœ“';
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			color: white;
			font-size: 14px;
			font-weight: bold;
		}

		input[type="checkbox"]:hover {
			border-color: var(--accent-primary);
		}

		/* Buttons */
		button {
			background: var(--accent-primary);
			color: white;
			padding: 12px 30px;
			border: none;
			border-radius: var(--radius-sm);
			cursor: pointer;
			font-size: 16px;
			font-weight: 600;
			transition: all 0.3s;
			position: relative;
			overflow: hidden;
		}

		button:hover {
			background: var(--accent-hover);
			transform: translateY(-2px);
			box-shadow: 0 4px 8px var(--shadow-light);
		}

		button:active {
			transform: scale(0.98);
		}

		button:disabled {
			background: #95a5a6;
			cursor: not-allowed;
			transform: none;
		}

		/* Button Variants */
		.btn-small {
			padding: 6px 15px;
			font-size: 14px;
		}

		.btn-danger {
			background: var(--accent-danger);
		}

		.btn-danger:hover {
			background: #c0392b;
		}

		.btn-edit {
			background: var(--accent-warning);
		}

		.btn-edit:hover {
			background: #e67e22;
		}

		.logout-btn {
			background: var(--accent-danger);
			color: white;
			border: none;
			padding: 8px 20px;
			border-radius: var(--radius-sm);
			cursor: pointer;
			font-size: 14px;
		}

		.logout-btn:hover {
			background: #c0392b;
		}

		/* ========================================
		   6. Tables
		   ======================================== */
		.table-wrapper {
			overflow-x: auto;
			-webkit-overflow-scrolling: touch;
		}

		table {
			width: 100%;
			border-collapse: collapse;
			margin-top: var(--spacing-lg);
			min-width: 600px;
			background: var(--bg-secondary);
		}

		th, td {
			padding: 12px;
			text-align: right;
			border: 1px solid var(--border-color);
		}

		th {
			background: var(--table-header-bg);
			color: var(--table-header-text);
			font-weight: 600;
			position: sticky;
			top: 0;
			z-index: 10;
			cursor: pointer;
		}

		tr {
			transition: all 0.2s ease;
		}

		tr:nth-child(even) {
			background: var(--table-row-even);
		}

		tr:hover {
			background: var(--table-row-hover);
			transform: translateX(5px);
			box-shadow: -3px 0 10px var(--shadow-light);
		}

		/* Table Status Rows */
		.low-stock {
			background-color: var(--status-danger-bg) !important;
			color: var(--status-danger-text);
			font-weight: bold;
		}

		.expiring-soon {
			background-color: var(--status-warning-bg) !important;
			color: var(--status-warning-text);
		}

		.expiring-warning {
			background-color: var(--status-warning-bg) !important;
			color: var(--status-warning-text);
		}

		.expiring-critical {
			background-color: var(--status-danger-bg) !important;
			color: var(--status-danger-text);
			font-weight: bold;
		}

		.variant-row {
			background-color: var(--table-row-even);
		}

		.expand-btn {
			cursor: pointer;
			padding: 2px 6px;
			background: var(--bg-primary);
			border: 1px solid var(--border-color);
			border-radius: 3px;
			font-weight: bold;
			color: var(--text-primary);
			transition: all 0.3s;
		}

		.expand-btn:hover {
			background: var(--table-row-hover);
		}

		/* ========================================
		   7. Modals
		   ======================================== */
		.modal {
			display: none;
			position: fixed;
			z-index: var(--z-modal);
			left: 0;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.4);
		}

		.modal-content {
			background-color: var(--bg-modal);
			color: var(--text-primary);
			margin: 5% auto;
			padding: 20px;
			border: 1px solid #888;
			width: 90%;
			max-width: 600px;
			border-radius: var(--radius-md);
			position: relative;
		}

		.modal-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: var(--spacing-lg);
		}

		.modal-header h2 {
			margin: 0;
			color: var(--text-primary);
		}

		.close {
			color: var(--text-secondary);
			font-size: 28px;
			font-weight: bold;
			cursor: pointer;
			transition: color 0.3s;
		}

		.close:hover,
		.close:focus {
			color: var(--text-primary);
		}

		/* ========================================
		   8. Alerts & Notifications
		   ======================================== */
		.alert {
			padding: 15px;
			margin-bottom: 20px;
			border-radius: var(--radius-sm);
			display: flex;
			align-items: center;
			gap: 10px;
		}

		.alert-warning {
			background: var(--status-warning-bg);
			color: var(--status-warning-text);
			border: 1px solid var(--accent-warning);
		}

		.alert-danger {
			background: var(--status-danger-bg);
			color: var(--status-danger-text);
			border: 1px solid var(--accent-danger);
		}

		.alert-success {
			background: var(--status-success-bg);
			color: var(--status-success-text);
			border: 1px solid var(--accent-success);
		}

		/* Alerts Wrapper */
		.alerts-wrapper {
			margin-bottom: 20px;
			border: 1px solid var(--border-color);
			border-radius: var(--radius-md);
			background: var(--bg-secondary);
			overflow: hidden;
		}

		.alerts-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			padding: 12px 15px;
			background: var(--table-row-even);
			border-bottom: 1px solid var(--border-color);
		}

		.alerts-title {
			font-size: 16px;
			color: var(--text-primary);
		}

		.alerts-toggle-btn {
			background: var(--accent-primary);
			color: white;
			border: none;
			padding: 6px 15px;
			border-radius: var(--radius-sm);
			cursor: pointer;
			font-size: 14px;
			display: flex;
			align-items: center;
			gap: 5px;
			transition: background 0.3s;
		}

		.alerts-toggle-btn:hover {
			background: var(--accent-hover);
		}

		.alerts-list {
			max-height: 600px;
			overflow-y: auto;
		}

		.alerts-list .alert {
			margin: 0;
			border-radius: 0;
			border-bottom: 1px solid #eee;
		}

		.alerts-list .alert:last-child {
			border-bottom: none;
		}

		/* Badges */
		.badge {
			padding: 2px 8px;
			border-radius: 12px;
			font-size: 12px;
			font-weight: bold;
		}

		.badge-danger {
			background: var(--accent-danger);
			color: white;
		}

		.badge-warning {
			background: var(--accent-warning);
			color: white;
		}

		/* Toast */
		.toast {
			position: fixed;
			bottom: 20px;
			right: 20px;
			background: #333;
			color: white;
			padding: 15px 25px;
			border-radius: var(--radius-sm);
			box-shadow: 0 4px 10px rgba(0,0,0,0.3);
			transform: translateY(100px);
			opacity: 0;
			transition: all 0.3s;
			z-index: var(--z-toast);
		}

		.toast.show {
			transform: translateY(0);
			opacity: 1;
		}

		/* ========================================
		   9. User Management
		   ======================================== */
		.user-list {
			margin-top: 20px;
		}

		.user-card {
			background: var(--table-row-even);
			padding: 15px;
			border-radius: var(--radius-md);
			margin-bottom: 10px;
			display: flex;
			justify-content: space-between;
			align-items: center;
			flex-wrap: wrap;
			gap: 10px;
		}

		.user-details {
			flex: 1;
			color: var(--text-primary);
		}

		.user-actions {
			display: flex;
			gap: 10px;
		}

		.permission-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			margin-top: 20px;
		}

		.permission-item {
			display: flex;
			align-items: center;
			gap: 10px;
			background: var(--table-row-even);
			padding: 10px;
			border-radius: var(--radius-sm);
		}

		/* ========================================
		   10. Utility Classes
		   ======================================== */
		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: var(--text-secondary);
			animation: fadeIn 0.5s ease-out;
		}

		.empty-state-icon {
			font-size: 64px;
			margin-bottom: 20px;
			animation: bounce 2s ease-in-out infinite;
		}

		.loading {
			display: none;
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			background: rgba(0,0,0,0.8);
			color: white;
			padding: 20px;
			border-radius: var(--radius-md);
			z-index: var(--z-toast);
		}

		.error-message {
			color: var(--accent-danger);
			font-size: 14px;
			margin-top: 5px;
		}

		/* ========================================
		   11. Mobile Specific Components
		   ======================================== */

		/* Bottom Navigation */
		.bottom-nav {
			position: fixed;
			bottom: 0;
			left: 0;
			right: 0;
			background: var(--bg-secondary);
			box-shadow: 0 -2px 10px var(--shadow-light);
			display: none;
			justify-content: space-around;
			padding: 8px 0;
			z-index: var(--z-nav);
			border-top: 1px solid var(--border-color);
		}

		.bottom-nav-item {
			flex: 1;
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 4px;
			padding: 8px;
			cursor: pointer;
			background: transparent;
			border: none;
			color: var(--text-secondary);
			font-family: inherit;
		}

		.bottom-nav-item.active {
			color: var(--accent-primary);
		}

		.bottom-nav-item span:first-child {
			font-size: 20px;
		}

		.bottom-nav-item span:last-child {
			font-size: 11px;
			font-weight: 500;
		}

		/* Floating Action Button */
		.fab {
			position: fixed;
			bottom: 80px;
			right: 20px;
			width: 56px;
			height: 56px;
			border-radius: var(--radius-round);
			background: var(--accent-primary);
			color: white;
			border: none;
			box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			font-size: 24px;
			cursor: pointer;
			z-index: 99;
			transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			display: none;
			align-items: center;
			justify-content: center;
		}

		.fab:active {
			transform: scale(0.9);
			box-shadow: 0 2px 8px rgba(0,0,0,0.3);
		}

		.fab.menu-open {
			transform: rotate(180deg) scale(1);
			background: var(--accent-danger);
		}

		/* FAB Menu */
		.fab-menu {
			position: fixed;
			bottom: 0;
			right: 0;
			width: 100%;
			height: 100%;
			z-index: 98;
			pointer-events: none;
			transition: visibility 0.3s;
		}

		.fab-backdrop {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.3);
			opacity: 0;
			transition: opacity 0.3s ease;
			pointer-events: none;
		}

		.fab-menu.show .fab-backdrop {
			opacity: 1;
			pointer-events: all;
		}

		.fab-menu-items {
			position: absolute;
			bottom: 150px;
			right: 20px;
			display: flex;
			flex-direction: column-reverse;
			gap: 12px;
			transform: scale(0);
			transform-origin: bottom right;
			transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
			pointer-events: none;
		}

		.fab-menu.show .fab-menu-items {
			transform: scale(1);
			pointer-events: all;
		}

		.fab-menu-item {
			display: flex;
			align-items: center;
			justify-content: flex-end;
			gap: 12px;
			transform: translateX(20px);
			opacity: 0;
			transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
			pointer-events: all;
			z-index: 99;
		}

		.fab-menu.show .fab-menu-item {
			transform: translateX(0);
			opacity: 1;
		}

		.fab-menu-item:nth-child(1) { transition-delay: 0.05s; }
		.fab-menu-item:nth-child(2) { transition-delay: 0.1s; }
		.fab-menu-item:nth-child(3) { transition-delay: 0.15s; }

		.fab-menu-label {
			background: var(--bg-secondary);
			color: var(--text-primary);
			padding: 8px 16px;
			border-radius: 20px;
			box-shadow: 0 2px 8px var(--shadow-medium);
			font-size: 14px;
			font-weight: 500;
			white-space: nowrap;
			pointer-events: all;
			transition: all 0.3s;
		}

		.fab-menu-item:hover .fab-menu-label {
			transform: translateX(-5px);
			box-shadow: 0 3px 10px var(--shadow-medium);
		}

		.fab-menu-button {
			width: 48px;
			height: 48px;
			border-radius: var(--radius-round);
			border: none;
			box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
			cursor: pointer;
			font-size: 20px;
			display: flex;
			align-items: center;
			justify-content: center;
			transition: all 0.2s;
			pointer-events: all;
			position: relative;
			z-index: 100;
			overflow: hidden;
		}

		.fab-menu-button:active {
			transform: scale(0.9);
		}

		.fab-menu-button:hover {
			transform: scale(1.15);
			box-shadow: 0 4px 12px rgba(0,0,0,0.4);
		}

		.fab-menu-button.transaction {
			background: var(--accent-success);
			color: white;
		}

		.fab-menu-button.product {
			background: var(--accent-danger);
			color: white;
		}

		.fab-menu-button.user {
			background: var(--accent-warning);
			color: white;
		}

		/* Pull to Refresh */
		.pull-to-refresh {
			position: fixed;
			top: -60px;
			left: 50%;
			transform: translateX(-50%);
			width: 40px;
			height: 40px;
			background: var(--bg-secondary);
			border-radius: var(--radius-round);
			box-shadow: 0 2px 8px var(--shadow-medium);
			display: flex;
			align-items: center;
			justify-content: center;
			transition: top 0.3s;
			z-index: 90;
			font-size: 20px;
		}

		.pull-to-refresh.show {
			top: 70px;
		}

		.pull-to-refresh.refreshing {
			animation: spin 1s linear infinite;
		}

		/* ========================================
		   12. Loading & Skeletons
		   ======================================== */
		.skeleton-loader {
			background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--border-color) 50%, var(--bg-secondary) 75%);
			background-size: 200% 100%;
			animation: skeleton-loading 1.5s infinite;
			border-radius: var(--radius-sm);
		}

		.skeleton-table {
			width: 100%;
			margin-top: 20px;
		}

		.skeleton-row {
			display: flex;
			gap: 10px;
			margin-bottom: 10px;
			padding: 10px;
		}

		.skeleton-cell {
			height: 20px;
			flex: 1;
		}

		.skeleton-cell.small { flex: 0.5; }
		.skeleton-cell.large { flex: 2; }

		.skeleton-stat-card {
			height: 100px;
			margin-bottom: 15px;
			padding: 20px;
			background: var(--bg-secondary);
			border-radius: var(--radius-md);
			box-shadow: 0 2px 5px var(--shadow-light);
		}

		.skeleton-stat-value {
			height: 40px;
			width: 60%;
			margin: 10px 0;
		}

		.skeleton-stat-label {
			height: 16px;
			width: 40%;
		}

		/* ========================================
		   13. Animations
		   ======================================== */
		@keyframes fadeIn {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes slideIn {
			from {
				opacity: 0;
				transform: translateX(20px);
			}
			to {
				opacity: 1;
				transform: translateX(0);
			}
		}

		@keyframes bounce {
			0%, 100% { transform: translateY(0); }
			50% { transform: translateY(-20px); }
		}

		@keyframes spin {
			from { transform: translateX(-50%) rotate(0deg); }
			to { transform: translateX(-50%) rotate(360deg); }
		}

		@keyframes skeleton-loading {
			0% { background-position: 200% 0; }
			100% { background-position: -200% 0; }
		}

		@keyframes countUp {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes statsEnter {
			from {
				opacity: 0;
				transform: translateY(20px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}

		@keyframes tableRowEnter {
			from {
				opacity: 0;
				transform: translateX(-20px);
			}
			to {
				opacity: 1;
				transform: translateX(0);
			}
		}

		@keyframes rowDelete {
			to {
				opacity: 0;
				transform: translateX(100%);
				height: 0;
				padding: 0;
				margin: 0;
			}
		}

		@keyframes ripple-animation {
			to {
				transform: scale(4);
				opacity: 0;
			}
		}

		/* Animation Classes */
		.fade-in {
			animation: fadeIn 0.3s ease-in-out;
		}

		.table-row-enter {
			animation: tableRowEnter 0.3s ease-out;
		}

		.row-delete {
			animation: rowDelete 0.3s ease-out forwards;
		}

		.counter-animate {
			animation: countUp 0.5s ease-out;
		}

		.stats-enter {
			animation: statsEnter 0.5s ease-out forwards;
			opacity: 0;
		}

		.stats-enter:nth-child(1) { animation-delay: 0.1s; }
		.stats-enter:nth-child(2) { animation-delay: 0.2s; }
		.stats-enter:nth-child(3) { animation-delay: 0.3s; }
		.stats-enter:nth-child(4) { animation-delay: 0.4s; }

		/* ========================================
		   14. Ripple Effect
		   ======================================== */
		.btn-ripple {
			position: relative;
			overflow: hidden;
		}

		.btn-ripple::before {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 0;
			height: 0;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.3);
			transform: translate(-50%, -50%);
			transition: width 0.6s, height 0.6s;
		}

		.btn-ripple:active::before {
			width: 300px;
			height: 300px;
		}

		.ripple {
			position: absolute;
			border-radius: 50%;
			background: rgba(255, 255, 255, 0.6);
			transform: scale(0);
			animation: ripple-animation 0.6s ease-out;
		}

		/* ========================================
		   15. Theme Transitions
		   ======================================== */
		.theme-transition * {
			transition: none !important;
		}

		/* Smooth theme transitions */
		* {
			transition: background-color 0.3s ease, 
						color 0.3s ease, 
						border-color 0.3s ease,
						box-shadow 0.3s ease;
		}

		/* ========================================
		   16. Responsive Design
		   ======================================== */
		@media (max-width: 768px) {
			/* Layout Adjustments */
			.container { 
				padding: 10px; 
			}
			
			.main-container {
				padding-bottom: 70px;
			}
			
			/* Navigation */
			.nav-brand { 
				font-size: 16px; 
			}
			
			.user-info { 
				display: none; 
			}
			
			.bottom-nav {
				display: flex;
			}
			
			.fab {
				display: flex;
			}
			
			/* Tabs */
			.tabs { 
				margin-bottom: 15px; 
			}
			
			.tab { 
				padding: 10px 15px; 
				font-size: 14px; 
			}
			
			/* Content */
			.tab-content { 
				padding: 15px; 
			}
			
			/* Stats Grid */
			.stats { 
				grid-template-columns: repeat(2, 1fr); 
				gap: 10px; 
			}
			
			.stat-card { 
				padding: 15px; 
			}
			
			.stat-card .value { 
				font-size: 24px; 
			}
			
			/* Forms */
			.form-row { 
				grid-template-columns: 1fr; 
			}
			
			input, select {
				font-size: 16px; /* Prevents zoom on iOS */
			}
			
			/* Tables */
			table { 
				font-size: 14px; 
			}
			
			th, td { 
				padding: 8px 6px; 
			}
			
			/* Modals */
			.modal-content {
				width: 95%;
				margin: 10px auto;
				max-height: 90vh;
				overflow-y: auto;
				padding: 15px;
			}
			
			.modal-header {
				position: sticky;
				top: -15px;
				background: var(--bg-modal);
				z-index: 10;
				padding-bottom: 10px;
				margin-bottom: 15px;
				border-bottom: 1px solid #eee;
			}
			
			.modal-header h2 {
				font-size: 1.3rem;
			}
			
			.close {
				font-size: 32px;
				width: 44px;
				height: 44px;
				display: flex;
				align-items: center;
				justify-content: center;
				margin: -10px;
			}
			
			/* Alerts */
			.alerts-header {
				flex-direction: column;
				gap: 10px;
				text-align: center;
			}
			
			.alerts-toggle-btn {
				width: 100%;
				justify-content: center;
			}
			
			.alerts-list {
				max-height: 400px;
			}
			
			/* User Cards */
			.user-card {
				flex-direction: column;
				align-items: stretch;
			}
			
			.user-details {
				margin-bottom: 15px;
			}
			
			.user-actions {
				display: flex;
				gap: 10px;
			}
			
			.user-actions button {
				flex: 1;
			}
			
			/* Accessibility */
			button, .btn {
				min-height: 44px;
				min-width: 44px;
			}
			
			/* Theme Toggle */
			#themeToggle {
				padding: 6px 12px;
				margin-left: 10px;
				font-size: 14px;
			}
		}

		@media (max-width: 480px) {
			.stats { 
				grid-template-columns: 1fr; 
			}
			
			.login-box { 
				padding: 30px 20px; 
			}
		}

		/* Desktop specific - Hide mobile elements */
		@media (min-width: 768px) {
			.fab,
			.bottom-nav {
				display: none !important;
			}
		}

		/* ========================================
		   17. Print Styles
		   ======================================== */
		@media print {
			body {
				background: white;
				color: black;
			}
			
			.top-nav,
			.tabs,
			.bottom-nav,
			.fab,
			button,
			.btn,
			.modal {
				display: none !important;
			}
			
			.container {
				max-width: 100%;
				padding: 0;
			}
			
			table {
				border: 1px solid black;
			}
			
			th, td {
				border: 1px solid black;
				padding: 5px;
			}
		}
    </style>
</head>
<body>
	<!-- Pull to refresh indicator -->
	<div class="pull-to-refresh" id="pullToRefresh">â†»</div>
    <div id="loadingSpinner" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 1000;"></div>
    
    <div class="login-container" id="loginScreen">
        <div class="login-box">
            <h1>ğŸ¬ ××¢×¨×›×ª ××œ××™ - ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×” ğŸ¿</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">×©× ××©×ª××©</label>
                    <input type="text" id="username" required autocomplete="username">
                </div>
                <div class="form-group">
                    <label for="password">×¡×™×¡××”</label>
                    <input type="password" id="password" required autocomplete="current-password">
                </div>
                <button type="submit">×›× ×™×¡×” ×œ××¢×¨×›×ª</button>
            </form>
        </div>
    </div>
    
    <!-- ××¡×š ×¨××©×™ -->
    <div class="main-container" id="mainScreen">
        <nav class="top-nav">
            <div class="nav-brand">
                <span>ğŸ¬</span>
                <span>××¢×¨×›×ª × ×™×”×•×œ ××œ××™ ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×”</span>
                <span>ğŸ¿</span>
            </div>
            <div class="nav-user">
                <div class="user-info">
                    <span id="currentUserName"></span>
                    <span class="user-role" id="currentUserRole"></span>
                </div>
				<button id="themeToggle" onclick="toggleTheme()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3); padding: 6px 12px; margin-left: 10px; border-radius: 4px; cursor: pointer; color: white; font-size: 14px;">
					<span id="themeIcon">ğŸŒ™</span>
				</button>
                <button class="logout-btn" onclick="logout()">×™×¦×™××”</button>
            </div>
        </nav>
        
        <div class="container">
            <div class="stats">
                <div class="stat-card">
                    <h3>×¡×”"×› ××•×¦×¨×™×</h3>
                    <div class="value" id="totalProducts">0</div>
                </div>
                <div class="stat-card">
                    <h3>××•×¦×¨×™× ×‘××œ××™ × ××•×š</h3>
                    <div class="value" id="lowStockCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>××•×¦×¨×™× ×œ×ª×¤×•×’×” ×§×¨×•×‘×”</h3>
                    <div class="value" id="expiringCount">0</div>
                </div>
                <div class="stat-card">
                    <h3>×ª× ×•×¢×•×ª ×”×™×•×</h3>
                    <div class="value" id="todayMovements">0</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" data-tab="inventory" data-permission="view_inventory" onclick="showTab(event, 'inventory')">××œ××™ × ×•×›×—×™</div>
                <div class="tab" data-tab="movements" data-permission="view_movements" onclick="showTab(event, 'movements')">×ª× ×•×¢×•×ª ××œ××™</div>
                <div class="tab" data-tab="transaction" data-permission="add_transaction" onclick="showTab(event, 'transaction')">×¨×™×©×•× ×ª× ×•×¢×”</div>
                <div class="tab" data-tab="addItem" data-permission="add_item" onclick="showTab(event, 'addItem')">×”×•×¡×¤×ª ×¤×¨×™×˜</div>
                <div class="tab" data-tab="users" data-permission="manage_users" onclick="showTab(event, 'users')">× ×™×”×•×œ ××©×ª××©×™×</div>
                <div class="tab" data-tab="reports" data-permission="view_reports" onclick="showTab(event, 'reports')">×“×•×—×•×ª</div>
                <div class="tab" data-tab="pickings" data-permission="view_pickings" onclick="showTab(event, 'pickings')">×œ×™×§×•×˜×™×</div>
            </div>
            
            <!-- ×˜××‘ ××œ××™ × ×•×›×—×™ -->
            <div id="inventory" class="tab-content active">
                <h2>××œ××™ × ×•×›×—×™</h2>
                <div style="display:flex; gap:15px; align-items:center; margin-bottom: 10px;">
                    <input type="text" id="inventorySearch" placeholder="×—×¤×© ××•×¦×¨..." style="padding:10px; font-size:16px; width:250px; border-radius:6px; border:1px solid #ccc;">
                    <select id="categoryFilter" style="padding:10px; font-size:16px; border-radius:6px; border:1px solid #ccc;">
                        <option value="">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>
                        <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                        <option value="××©×§××•×ª">××©×§××•×ª</option>
                        <option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
                        <option value="×¦×™×•×“">×¦×™×•×“</option>
                        <option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
                    </select>
                </div>
                <div id="alerts"></div>
                <div class="table-wrapper">
                    <table id="inventoryTable">
                        <thead>
                            <tr>
                                <th></th>
                                <th onclick="sortInventory('name')">×©× ××•×¦×¨ &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('category')">×§×˜×’×•×¨×™×” &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('quantity')">×›××•×ª ×–××™× ×” &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('min')">××™× ×™××•× &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('expiry')">×ª×•×§×£ ×§×¨×•×‘ &#x25B2;&#x25BC;</th>
                                <th onclick="sortInventory('status')">×¡×˜×˜×•×¡ &#x25B2;&#x25BC;</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ×˜××‘ ×ª× ×•×¢×•×ª ××œ××™ -->
            <div id="movements" class="tab-content">
                <h2>×ª× ×•×¢×•×ª ××œ××™</h2>
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>×ª××¨×™×š</th>
                                <th>×©×¢×”</th>
                                <th>×©× ××•×¦×¨</th>
                                <th>×¤×¢×•×œ×”</th>
                                <th>×›××•×ª</th>
                                <th>××‘×¦×¢</th>
                                <th>×”×¢×¨×•×ª</th>
                                <th>×¤×¢×•×œ×•×ª</th>
                            </tr>
                        </thead>
                        <tbody id="movementsBody"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- ×˜××‘ ×¨×™×©×•× ×ª× ×•×¢×” -->
            <div id="transaction" class="tab-content">
                <h2>×¨×™×©×•× ×ª× ×•×¢×ª ××œ××™</h2>
                <form id="transactionForm">
                    <div id="multiTransactionRows"></div>
                    <div style="margin-top: 20px;">
                        <button type="button" onclick="addTransactionRow()">â• ×”×•×¡×£ ××•×¦×¨</button>
                        <button type="button" onclick="startPickingList()">×¦×•×¨ ×¨×©×™××ª ×œ×™×§×•×˜ ×•×©×œ×—</button>
                        <button type="submit">×¨×©×•× ×ª× ×•×¢×•×ª ×‘××œ××™</button>
                    </div>
                </form>
                <div id="pickingListContainer"></div>
            </div>
                        
            <!-- ×˜××‘ ×”×•×¡×¤×ª ×¤×¨×™×˜ -->
            <div id="addItem" class="tab-content">
                <h2>×”×•×¡×¤×ª ××•×¦×¨ ×—×“×© ×œ××œ××™</h2>
                <form id="addItemForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="itemName">×©× ××•×¦×¨</label>
                            <input type="text" id="itemName" required>
                        </div>
                        <div class="form-group">
                            <label for="itemCategory">×§×˜×’×•×¨×™×”</label>
                            <select id="itemCategory" required>
                                <option value="">×‘×—×¨ ×§×˜×’×•×¨×™×”</option>
                                <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                                <option value="××©×§××•×ª">××©×§××•×ª</option>
                                <option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
                                <option value="×¦×™×•×“">×¦×™×•×“</option>
                                <option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="baseUnitSingular">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×™×—×™×“)</label>
                            <select id="baseUnitSingular" required></select>
                        </div>
                        <div class="form-group">
                            <label for="baseUnitPlural">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×¨×‘×™×)</label>
                            <select id="baseUnitPlural" required></select>
                        </div>
                        <div class="form-group">
                            <label for="packUnitSingular">×©× ×™×—×™×“×ª ××¨×™×–×” (×™×—×™×“)</label>
                            <select id="packUnitSingular" required></select>
                        </div>
                        <div class="form-group">
                            <label for="packUnitPlural">×©× ×™×—×™×“×ª ××¨×™×–×” (×¨×‘×™×)</label>
                            <select id="packUnitPlural" required></select>
                        </div>
                        <div class="form-group">
                            <label for="unitsPerPack">×›××” ×™×—×™×“×•×ª ×‘×›×œ ××¨×™×–×”</label>
                            <input type="number" id="unitsPerPack" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="minPacks">×›××•×ª ××™× ×™××•× (×‘×—×‘×™×œ×•×ª)</label>
                            <input type="number" id="minPacks" min="0" required>
                        </div>
                    </div>
                    <h3>×¤×¨×™×˜×™×</h3>
                    <div id="variantsContainer"></div>
                    <div style="margin-top: 20px;">
                        <button type="button" onclick="addVariant()">×”×•×¡×£ ×¤×¨×™×˜</button>
                        <button type="submit">×¡×™×™×</button>
                    </div>
                </form>
            </div>
            
            <!-- ×˜××‘ × ×™×”×•×œ ××©×ª××©×™× -->
            <div id="users" class="tab-content">
                <h2>× ×™×”×•×œ ××©×ª××©×™×</h2>
                
                <h3>×”×•×¡×¤×ª ××©×ª××© ×—×“×©</h3>
                <form id="addUserForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="newUsername">×©× ××©×ª××©</label>
                            <input type="text" id="newUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="newPassword">×¡×™×¡××”</label>
                            <input type="password" id="newPassword" required>
                        </div>
                        <div class="form-group">
                            <label for="newFullName">×©× ××œ×</label>
                            <input type="text" id="newFullName" required>
                        </div>
                        <div class="form-group">
                            <label for="newRole">×ª×¤×§×™×“</label>
                            <select id="newRole" required>
                                <option value="">×‘×—×¨ ×ª×¤×§×™×“</option>
                                <option value="×× ×”×œ ××¢×¨×›×ª">×× ×”×œ ××¢×¨×›×ª</option>
                                <option value="×× ×”×œ ××ª×—×">×× ×”×œ ××ª×—×</option>
                                <option value="×× ×”×œ/×ª ××©××¨×ª">×× ×”×œ/×ª ××©××¨×ª</option>
                                <option value="××—×¡× ××™">××—×¡× ××™</option>
                                <option value="×¡×•×¤×¨×•×•×™×™×–×¨">×¡×•×¤×¨×•×•×™×™×–×¨</option>
                                <option value="××–× ×•× ××™">××–× ×•× ××™</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4>×”×¨×©××•×ª</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_inventory" checked>
                            <label for="perm_view_inventory">×¦×¤×™×™×” ×‘××œ××™</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_pickings">
                            <label for="perm_view_pickings">×¦×¤×™×™×” ×‘×œ×™×§×•×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_movements" checked>
                            <label for="perm_view_movements">×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_transaction">
                            <label for="perm_add_transaction">×¨×™×©×•× ×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_add_item">
                            <label for="perm_add_item">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_manage_users">
                            <label for="perm_manage_users">× ×™×”×•×œ ××©×ª××©×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="perm_view_reports">
                            <label for="perm_view_reports">×¦×¤×™×™×” ×‘×“×•×—×•×ª</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">×”×•×¡×£ ××©×ª××©</button>
                </form>
                
                <h3 style="margin-top: 40px;">××©×ª××©×™× ×§×™×™××™×</h3>
                <div class="user-list" id="userList"></div>
            </div>
            
            <!-- ×˜××‘ ×“×•×—×•×ª -->
            <div id="reports" class="tab-content">
                <h2>×“×•×—×•×ª</h2>
                <div class="form-row">
                    <button onclick="generateReport('inventory')" class="btn-small">×“×•×— ××œ××™ ××œ×</button>
                    <button onclick="generateReport('lowStock')" class="btn-small">×“×•×— ×—×•×¡×¨×™×</button>
                    <button onclick="generateReport('expiring')" class="btn-small">×“×•×— ×ª×¤×•×’×•×ª</button>
                    <button onclick="generateReport('movements')" class="btn-small">×“×•×— ×ª× ×•×¢×•×ª</button>
                </div>
                <div id="reportContent" style="margin-top: 30px;"></div>
            </div>
            
            <div id="pickings" class="tab-content">
                <h2>×“×•×— ×œ×™×§×•×˜×™×</h2>
                <div id="pickingsTableContainer"></div>
            </div>
			<!-- Floating Action Button -->
			<button class="fab" id="fabButton" onclick="toggleFabMenu()" style="display: none;">â•</button>
			<!-- FAB Menu -->
			<div class="fab-menu" id="fabMenu" style="display: none;">
				<div class="fab-backdrop" onclick="closeFabMenu()"></div>
				<div class="fab-menu-items" id="fabMenuItems">
					<!-- ×”×¤×¨×™×˜×™× ×™×ª×•×•×¡×¤×• ×“×™× ××™×ª ×œ×¤×™ ×”×¨×©××•×ª -->
				</div>
			</div>
        </div>
        
        <!-- ××•×“×œ ×¢×¨×™×›×ª ×•×¨×™×× ×˜ -->
        <div id="editVariantModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>×¢×¨×™×›×ª ×•×¨×™×× ×˜</h2>
                    <span class="close" onclick="closeEditVariantModal()">&times;</span>
                </div>
                <form id="editVariantForm">
                    <input type="hidden" id="editVariantProductName">
                    <input type="hidden" id="editVariantIndex">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editVariantQuantityPacks">×›××•×ª ×—×‘×™×œ×•×ª</label>
                            <input type="number" id="editVariantQuantityPacks" min="0" required>
                        </div>    
                        <div class="form-group">
                            <label for="editVariantQuantityUnits">×™×—×™×“×•×ª ×‘×•×“×“×•×ª</label>
                            <input type="number" id="editVariantQuantityUnits" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="editVariantLocation">××™×§×•×</label>
                            <select id="editVariantLocation" required>
                                <option value="">×‘×—×¨ ××—×¡×Ÿ</option>
                                <option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
                                <option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
                                <option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
                                <option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
                                <option value="×˜×›× ×™">×˜×›× ×™</option>
                                <option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
                                <option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="editVariantExpiry">×ª××¨×™×š ×ª×¤×•×’×”</label>
                            <input type="date" id="editVariantExpiry">
                        </div>
                    </div>
                    <button type="submit">×©××•×¨ ×©×™× ×•×™×™×</button>
                </form>
            </div>
        </div>
        
        <!-- ××•×“×œ ×¢×¨×™×›×ª ×ª× ×•×¢×” -->
        <div id="editMovementModal" class="modal">
			<div class="modal-content">
				<div class="modal-header">
					<h2>×¢×¨×™×›×ª ×ª× ×•×¢×”</h2>
					<span class="close" onclick="closeEditMovementModal()">&times;</span>
				</div>
				<form id="editMovementForm">
					<input type="hidden" id="editMovementId">
					<input type="hidden" id="editMovementOriginalQuantityPacks">
					<input type="hidden" id="editMovementOriginalQuantityUnits">
					<input type="hidden" id="editMovementOriginalType">
					<div class="form-row">
						<div class="form-group">
							<label for="editMovementProduct">××•×¦×¨</label>
							<input type="text" id="editMovementProduct" readonly style="background-color: #f0f0f0;">
						</div>
						<div class="form-group">
							<label for="editMovementType">×¡×•×’ ×¤×¢×•×œ×”</label>
							<select id="editMovementType" required>
								<option value="×”×•×¦××”">×”×•×¦××” ××”××œ××™</option>
								<option value="×”×›× ×¡×”">×”×›× ×¡×” ×œ××œ××™</option>
							</select>
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="editMovementLocation">××™×§×•×</label>
							<select id="editMovementLocation" required>
								<option value="">×‘×—×¨ ××—×¡×Ÿ</option>
								<option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
								<option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
								<option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
								<option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
								<option value="×˜×›× ×™">×˜×›× ×™</option>
								<option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
								<option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
							</select>
						</div>
						<div class="form-group">
							<label for="editMovementExpiry">×ª××¨×™×š ×ª×¤×•×’×”</label>
							<input type="date" id="editMovementExpiry">
						</div>
					</div>
					<div class="form-row">
						<div class="form-group">
							<label for="editMovementQuantityPacks">×›××•×ª ×—×‘×™×œ×•×ª</label>
							<input type="number" id="editMovementQuantityPacks" min="0" required>
						</div>
						<div class="form-group">
							<label for="editMovementQuantityUnits">×›××•×ª ×™×—×™×“×•×ª</label>
							<input type="number" id="editMovementQuantityUnits" min="0" required>
						</div>
						<div class="form-group">
							<label for="editMovementNotes">×”×¢×¨×•×ª</label>
							<input type="text" id="editMovementNotes">
						</div>
					</div>
					<div class="alert alert-warning" style="margin-top: 15px;">
						<strong>×©×™× ×œ×‘:</strong> ×©×™× ×•×™ ×”×›××•×™×•×ª ×™×¢×“×›×Ÿ ××ª ×”××œ××™ ×‘×”×ª××
					</div>
					<button type="submit">×©××•×¨</button>
				</form>
			</div>
		</div>

        <!-- ××•×“×œ ×¢×¨×™×›×ª ××•×¦×¨ -->
        <div id="editModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>×¢×¨×™×›×ª ××•×¦×¨</h2>
                    <span class="close" onclick="closeEditModal()">&times;</span>
                </div>
                <form id="editItemForm">
                    <input type="hidden" id="editItemOriginalName">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editItemName">×©× ××•×¦×¨</label>
                            <input type="text" id="editItemName" required>
                        </div>
                        <div class="form-group">
                            <label for="editItemCategory">×§×˜×’×•×¨×™×”</label>
                            <select id="editItemCategory" required>
                                <option value="××–×•×Ÿ">××–×•×Ÿ</option>
                                <option value="××©×§××•×ª">××©×§××•×ª</option>
                                <option value="××¨×™×–×•×ª">××¨×™×–×•×ª</option>
                                <option value="×¦×™×•×“">×¦×™×•×“</option>
                                <option value="× ×™×§×™×•×Ÿ">×—×•××¨×™ × ×™×§×™×•×Ÿ</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editBaseUnitSingular">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×™×—×™×“)</label>
                            <input type="text" id="editBaseUnitSingular" required>
                        </div>
                        <div class="form-group">
                            <label for="editBaseUnitPlural">×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×¨×‘×™×)</label>
                            <input type="text" id="editBaseUnitPlural" required>
                        </div>
                        <div class="form-group">
                            <label for="editPackUnitSingular">×©× ×™×—×™×“×ª ××¨×™×–×” (×™×—×™×“)</label>
                            <input type="text" id="editPackUnitSingular" required>
                        </div>
                        <div class="form-group">
                            <label for="editPackUnitPlural">×©× ×™×—×™×“×ª ××¨×™×–×” (×¨×‘×™×)</label>
                            <input type="text" id="editPackUnitPlural" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUnitsPerPack">××¡×¤×¨ ×™×—×™×“×•×ª ×‘×›×œ ××¨×™×–×”</label>
                            <input type="number" id="editUnitsPerPack" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="editMinPacks">×›××•×ª ××™× ×™××•× ×‘××œ××™ (×‘×—×‘×™×œ×•×ª)</label>
                            <input type="number" id="editMinPacks" min="0" required>
                        </div>
                    </div>
                    <button type="submit">×©××•×¨ ×©×™× ×•×™×™×</button>
                </form>
            </div>
        </div>

        <div id="addVariantModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>×”×•×¡×¤×ª ×•×¨×™×× ×˜ ×—×“×©</h2>
                    <span class="close" onclick="closeAddVariantModal()">&times;</span>
                </div>
                <form id="addVariantForm">
                    <input type="hidden" id="addVariantProductName">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="addVariantQuantityPacks">×›××•×ª ×—×‘×™×œ×•×ª</label>
                            <input type="number" id="addVariantQuantityPacks" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="addVariantQuantityUnits">×™×—×™×“×•×ª ×‘×•×“×“×•×ª</label>
                            <input type="number" id="addVariantQuantityUnits" min="0" required>
                        </div>
                        <div class="form-group">
                            <label for="addVariantLocation">××™×§×•×</label>
                            <select id="addVariantLocation" required>
                                <option value="">×‘×—×¨ ××—×¡×Ÿ</option>
                                <option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
                                <option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
                                <option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
                                <option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
                                <option value="×˜×›× ×™">×˜×›× ×™</option>
                                <option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
                                <option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="addVariantExpiry">×ª××¨×™×š ×ª×¤×•×’×”</label>
                            <input type="date" id="addVariantExpiry">
                        </div>
                    </div>
                    <button type="submit">×”×•×¡×£ ×•×¨×™×× ×˜</button>
                </form>
            </div>
        </div>
        
        <!-- ××•×“×œ ×¢×¨×™×›×ª ××©×ª××© -->
        <div id="editUserModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>×¢×¨×™×›×ª ××©×ª××©</h2>
                    <span class="close" onclick="closeEditUserModal()">&times;</span>
                </div>
                <form id="editUserForm">
                    <input type="hidden" id="editUserOriginalUsername">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editUsername">×©× ××©×ª××©</label>
                            <input type="text" id="editUsername" required>
                        </div>
                        <div class="form-group">
                            <label for="editPassword">×¡×™×¡××” ×—×“×©×” (×”×©××¨ ×¨×™×§ ×× ×œ× ×¨×•×¦×” ×œ×©× ×•×ª)</label>
                            <input type="password" id="editPassword">
                        </div>
                        <div class="form-group">
                            <label for="editFullName">×©× ××œ×</label>
                            <input type="text" id="editFullName" required>
                        </div>
                        <div class="form-group">
                            <label for="editUserRole">×ª×¤×§×™×“</label>
                            <select id="editUserRole" required>
                                <option value="">×‘×—×¨ ×ª×¤×§×™×“</option>
                                <option value="×× ×”×œ ××¢×¨×›×ª">×× ×”×œ ××¢×¨×›×ª</option>
                                <option value="×× ×”×œ ××ª×—×">×× ×”×œ ××ª×—×</option>
                                <option value="×× ×”×œ/×ª ××©××¨×ª">×× ×”×œ/×ª ××©××¨×ª</option>
                                <option value="××—×¡× ××™">××—×¡× ××™</option>
                                <option value="×¡×•×¤×¨×•×•×™×™×–×¨">×¡×•×¤×¨×•×•×™×™×–×¨</option>
                                <option value="××–× ×•× ××™">××–× ×•× ××™</option>
                            </select>
                        </div>
                    </div>
                    
                    <h4>×”×¨×©××•×ª</h4>
                    <div class="permission-grid">
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_inventory">
                            <label for="edit_perm_view_inventory">×¦×¤×™×™×” ×‘××œ××™</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_pickings">
                            <label for="edit_perm_view_pickings">×¦×¤×™×™×” ×‘×œ×™×§×•×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_movements">
                            <label for="edit_perm_view_movements">×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_transaction">
                            <label for="edit_perm_add_transaction">×¨×™×©×•× ×ª× ×•×¢×•×ª</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_add_item">
                            <label for="edit_perm_add_item">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_manage_users">
                            <label for="edit_perm_manage_users">× ×™×”×•×œ ××©×ª××©×™×</label>
                        </div>
                        <div class="permission-item">
                            <input type="checkbox" id="edit_perm_view_reports">
                            <label for="edit_perm_view_reports">×¦×¤×™×™×” ×‘×“×•×—×•×ª</label>
                        </div>
                    </div>
                    
                    <button type="submit" style="margin-top: 20px;">×©××•×¨ ×©×™× ×•×™×™×</button>
                </form>
            </div>
        </div>
        
        <div id="editPickingModal" class="modal" style="display:none;direction:rtl;">
            <div class="modal-content" style="max-width:600px;margin:50px auto;background:#fff;padding:28px;border-radius:14px;box-shadow:0 6px 36px #0002;">
                <span class="close" onclick="closeEditPicking()" style="float:left;cursor:pointer;font-size:2em;">&times;</span>
                <h3 style="text-align:center;margin-top:0;">×¢×¨×™×›×ª ×¨×©×™××ª ×œ×™×§×•×˜</h3>
                <div id="editPickingListArea"></div>
            </div>
        </div>
		<nav class="bottom-nav" id="bottomNav" style="display: none;">
		<!-- ×”×›×¤×ª×•×¨×™× ×™×ª×•×•×¡×¤×• ×“×™× ××™×ª ×œ×¤×™ ×”×¨×©××•×ª -->
		</nav>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        // --- ×”×’×“×¨×ª Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyAg4keZ42SfFHhwjhkYbl7TdJnuN0WsuUc",
            authDomain: "inventory-57376.firebaseapp.com",
            projectId: "inventory-57376",
            storageBucket: "inventory-57376.appspot.com",
            messagingSenderId: "165204980655",
            appId: "1:165204980655:web:f7c5a78a0ae11f7191355a",
            measurementId: "G-E8EK3N3DLE"
        };
		// === Mobile Detection ===
		const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 768;

		// === Mobile Features Initialization ===
		function initMobileFeatures() {
			if (!isMobile) return; // ×—×•×–×¨×™× ×œ×‘×“×™×§×” ×”×¨×’×™×œ×”
    
			console.log('initMobileFeatures called');
			console.log('currentUser:', currentUser);
			// ×”×¦×’ × ×™×•×•×˜ ×ª×—×ª×•×Ÿ
			const bottomNav = document.getElementById('bottomNav');
			if (bottomNav) {
				bottomNav.style.display = 'flex';
				bottomNav.innerHTML = ''; 
				
				// ×‘× ×” ××ª ×”×›×¤×ª×•×¨×™× ×¨×§ ×× ×™×© ××©×ª××© ××—×•×‘×¨
				if (currentUser && currentUser.permissions) {
					bottomNav.innerHTML = '';
					
					// ××œ××™ - ×ª××™×“ ××•×¦×’ ×œ××™ ×©×™×© ×”×¨×©××ª ×¦×¤×™×™×”
					if (currentUser.permissions.includes('view_inventory')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item active" onclick="quickNav('inventory')">
								<span>ğŸ“¦</span>
								<span>××œ××™</span>
							</button>
						`;
					}
					
					// ×¨×™×©×•× ×ª× ×•×¢×”
					if (currentUser.permissions.includes('add_transaction')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item" onclick="quickNav('transaction')">
								<span>â•</span>
								<span>×¨×™×©×•×</span>
							</button>
						`;
					}
					
					// ×ª× ×•×¢×•×ª
					if (currentUser.permissions.includes('view_movements')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item" onclick="quickNav('movements')">
								<span>ğŸ“Š</span>
								<span>×ª× ×•×¢×•×ª</span>
							</button>
						`;
					}
					
					// ×“×•×—×•×ª
					if (currentUser.permissions.includes('view_reports')) {
						bottomNav.innerHTML += `
							<button class="bottom-nav-item" onclick="quickNav('reports')">
								<span>ğŸ“ˆ</span>
								<span>×“×•×—×•×ª</span>
							</button>
						`;
					}
				}
			}
			
			    // ×”×ª×× ×’×•×‘×” ×œ××•×‘×™×™×œ
			const setVH = () => {
				const vh = window.innerHeight * 0.01;
				document.documentElement.style.setProperty('--vh', `${vh}px`);
			};
			setVH();
			window.addEventListener('resize', setVH);
			
			// ×”×¦×’ ×›×¤×ª×•×¨ FAB
			const fab = document.getElementById('fabButton');
			if (fab && currentUser && currentUser.permissions) {
				const hasRelevantPermissions = 
					currentUser.permissions.includes('add_transaction') ||
					currentUser.permissions.includes('add_item') ||
					currentUser.permissions.includes('manage_users');
				
				if (hasRelevantPermissions) {
					fab.style.display = 'flex';
				} else {
					fab.style.display = 'none';
				}
			}
			
			// ××ª×—×œ Pull to Refresh
			initPullToRefresh();
		}
		// === Quick Navigation for Bottom Nav ===
		function quickNav(tabName) {
			// ×”×¡×¨ active ××›×œ ×”×›×¤×ª×•×¨×™×
			document.querySelectorAll('.bottom-nav-item').forEach(item => {
				item.classList.remove('active');
			});
			
			// ×”×•×¡×£ active ×œ×›×¤×ª×•×¨ ×”× ×•×›×—×™
			event.currentTarget.classList.add('active');
			
			// ×”×¦×’ ××ª ×”×˜××‘
			showTab(tabName);
		}
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
		// ××ª×—×•×œ Firebase Auth
		// const auth = firebase.auth();
		const auth = null

		// ×¤×•× ×§×¦×™×” ×œ×™×¦×™×¨×ª/×¢×“×›×•×Ÿ ××©×ª××© ×‘-Auth
		async function createOrUpdateAuthUser(username, password, email = null) {
			try {
				const userEmail = email || `${username}@cinema-city-hadera.local`;
				
				try {
					// × ×¡×” ×œ×”×ª×—×‘×¨ ×§×•×“× (×‘×“×•×§ ×× ×”××©×ª××© ×§×™×™×)
					const userCredential = await auth.signInWithEmailAndPassword(userEmail, password);
					
					// ×× ×”×¦×œ×™×—, ×¢×“×›×Ÿ ×¡×™×¡××” ×× ×©×•× ×”
					if (password && password !== '1234') { // ××œ ×ª×¢×“×›×Ÿ ×¡×™×¡××” ×‘×¨×™×¨×ª ××—×“×œ
						await userCredential.user.updatePassword(password);
					}
					
					return userCredential.user;
				} catch (error) {
					if (error.code === 'auth/user-not-found') {
						// ××©×ª××© ×œ× ×§×™×™×, ×¦×•×¨ ×—×“×©
						const userCredential = await auth.createUserWithEmailAndPassword(userEmail, password);
						return userCredential.user;
					} else if (error.code === 'auth/wrong-password') {
						// ×¡×™×¡××” ×©×’×•×™×” - ×–×” ×‘×¡×“×¨, ×”××©×ª××© ×§×™×™×
						return { uid: username }; // ×”×—×–×¨ uid ×–×× ×™
					} else {
						throw error;
					}
				}
			} catch (error) {
				console.error('Error with auth user:', error);
				// ×œ× ×œ×–×¨×•×§ ×©×’×™××” - ×œ××¤×©×¨ ×œ××¢×¨×›×ª ×œ×¢×‘×•×“ ×’× ×‘×œ×™ Auth
				return null;
			}
		}
		
		// === Pull to Refresh ===
		let touchStartY = 0;
		let pullDistance = 0;

		function initPullToRefresh() {
			if (!isMobile) return;
			
			document.addEventListener('touchstart', (e) => {
				touchStartY = e.touches[0].clientY;
			}, { passive: true });
			
			document.addEventListener('touchmove', (e) => {
				if (window.scrollY === 0 && e.touches[0].clientY > touchStartY) {
					pullDistance = e.touches[0].clientY - touchStartY;
					
					if (pullDistance > 50) {
						document.getElementById('pullToRefresh').classList.add('show');
						
						if (pullDistance > 100) {
							document.getElementById('pullToRefresh').classList.add('refreshing');
						}
					}
				}
			}, { passive: true });
			
			document.addEventListener('touchend', async (e) => {
				if (pullDistance > 100) {
					await refreshData();
				}
				
				document.getElementById('pullToRefresh').classList.remove('show', 'refreshing');
				pullDistance = 0;
			}, { passive: true });
		}
		function addSwipeToCloseModals() {
			if (!isMobile) return;
			
			const modals = document.querySelectorAll('.modal-content');
			
			modals.forEach(modal => {
				let startY = 0;
				let currentY = 0;
				let startTime = 0;
				let isDragging = false;
				let modalElement = modal.closest('.modal');
				
				// ×”×•×¡×£ ××™× ×“×™×§×˜×•×¨ ×•×™×–×•××œ×™ ×œ×’×¨×™×¨×”
				const swipeIndicator = document.createElement('div');
				swipeIndicator.style.cssText = `
					position: absolute;
					top: 10px;
					left: 50%;
					transform: translateX(-50%);
					width: 40px;
					height: 4px;
					background: #ccc;
					border-radius: 2px;
					opacity: 0.5;
				`;
				modal.insertBefore(swipeIndicator, modal.firstChild);
				
				modal.addEventListener('touchstart', (e) => {
					// ×‘×“×•×§ ×× × ×’×¢× ×• ×‘×—×œ×§ ×”×¢×œ×™×•×Ÿ ×©×œ ×”××•×“××œ
					const rect = modal.getBoundingClientRect();
					const touchY = e.touches[0].clientY;
					
					// ×”×ª×—×œ ×’×¨×™×¨×” ×¨×§ ×× × ×’×¢× ×• ×‘-50 ×¤×™×§×¡×œ×™× ×”×¢×œ×™×•× ×™×
					if (touchY - rect.top < 50) {
						startY = e.touches[0].clientY;
						startTime = Date.now();
						isDragging = true;
						modal.style.transition = 'none';
					}
				}, { passive: true });
				
				modal.addEventListener('touchmove', (e) => {
					if (!isDragging) return;
					
					currentY = e.touches[0].clientY;
					const deltaY = currentY - startY;
					
					// ××¤×©×¨ ×’×¨×™×¨×” ×¨×§ ×œ××˜×”
					if (deltaY > 0) {
						// ×‘×“×•×§ ×× ×”××•×“××œ ×‘×—×œ×§ ×”×¢×œ×™×•×Ÿ ×©×œ×•
						if (modal.scrollTop === 0) {
							// ×”×—×œ ×˜×¨× ×¡×¤×•×¨××¦×™×” ×¨×§ ×× ×’×•×¨×¨×™× ×œ××˜×”
							modal.style.transform = `translateY(${Math.min(deltaY, 300)}px)`;
							modal.style.opacity = Math.max(0.3, 1 - (deltaY / 300));
							
							// ×× ×¢ ×’×œ×™×œ×” ×©×œ ×”×“×£ ×××—×•×¨×™ ×”××•×“××œ
							if (deltaY > 20) {
								document.body.style.overflow = 'hidden';
							}
						} else {
							// ×× ×™×© ×’×œ×™×œ×” ×‘××•×“××œ, ×‘×˜×œ ××ª ×”×’×¨×™×¨×”
							isDragging = false;
							modal.style.transform = '';
							modal.style.opacity = '';
						}
					}
				}, { passive: true });
				
				modal.addEventListener('touchend', (e) => {
					if (!isDragging) return;
					
					const deltaY = currentY - startY;
					const deltaTime = Date.now() - startTime;
					const velocity = deltaY / deltaTime;
					
					// ××¤×©×¨ ×˜×¨× ×–×™×©×Ÿ ×—×–×¨×”
					modal.style.transition = 'all 0.3s ease';
					
					// ×¡×’×•×¨ ×× ×’×¨×¨×• ××¡×¤×™×§ ××• ×‘××”×™×¨×•×ª ×’×‘×•×”×”
					if (deltaY > 100 || velocity > 0.5) {
						modal.style.transform = 'translateY(100%)';
						modal.style.opacity = '0';
						
						setTimeout(() => {
							if (modalElement) {
								modalElement.style.display = 'none';
								// ××™×¤×•×¡ ×”×¡×’× ×•× ×•×ª
								modal.style.transform = '';
								modal.style.opacity = '';
								modal.style.transition = '';
							}
						}, 300);
					} else {
						// ×”×—×–×¨ ×œ××§×•×
						modal.style.transform = '';
						modal.style.opacity = '';
					}
					
					// ×”×—×–×¨ ××ª ×”×’×œ×™×œ×”
					document.body.style.overflow = '';
					isDragging = false;
					startY = 0;
					currentY = 0;
				}, { passive: true });
				
				// ×‘×˜×œ ×’×¨×™×¨×” ×× ×™×¦×× ×• ××”××–×•×¨
				modal.addEventListener('touchcancel', () => {
					if (isDragging) {
						modal.style.transition = 'all 0.3s ease';
						modal.style.transform = '';
						modal.style.opacity = '';
						document.body.style.overflow = '';
						isDragging = false;
					}
				}, { passive: true });
			});
		}
		// ×¤×•× ×§×¦×™×” ××©×•×¤×¨×ª ×œ×˜×™×¤×•×œ ×‘×’×œ×™×œ×” ×‘××•×“××œ×™×
		function improveModalScrolling() {
			if (!isMobile) return;
			
			const modals = document.querySelectorAll('.modal');
			
			modals.forEach(modal => {
				// ×× ×¢ ×’×œ×™×œ×” ×©×œ ×”×¨×§×¢ ×›×©×”××•×“××œ ×¤×ª×•×—
				const observer = new MutationObserver((mutations) => {
					mutations.forEach(mutation => {
						if (mutation.attributeName === 'style') {
							const isVisible = modal.style.display !== 'none';
							if (isVisible) {
								// ×©××•×¨ ××ª ××™×§×•× ×”×’×œ×™×œ×”
								const scrollY = window.scrollY;
								document.body.dataset.scrollY = scrollY;
								document.body.style.position = 'fixed';
								document.body.style.top = `-${scrollY}px`;
								document.body.style.width = '100%';
							} else {
								// ×”×—×–×¨ ××ª ×”×’×œ×™×œ×”
								const scrollY = parseInt(document.body.dataset.scrollY || '0');
								document.body.style.position = '';
								document.body.style.top = '';
								document.body.style.width = '';
								window.scrollTo(0, scrollY);
							}
						}
					});
				});
				
				observer.observe(modal, { attributes: true });
			});
		}
		document.addEventListener('DOMContentLoaded', () => {
			addSwipeToCloseModals();
			
			// ×”×•×¡×£ ××—×•×•×Ÿ ×˜×¢×™× ×” ×œ××•×‘×™×™×œ
			if (isMobile) {
				const loadingIndicator = document.createElement('div');
				loadingIndicator.id = 'mobileLoadingBar';
				loadingIndicator.style.cssText = `
					position: fixed;
					top: 0;
					left: 0;
					width: 100%;
					height: 3px;
					background: linear-gradient(90deg, #3498db 0%, #2980b9 50%, #3498db 100%);
					background-size: 200% 100%;
					animation: loading 1.5s linear infinite;
					display: none;
					z-index: 9999;
				`;
				document.body.appendChild(loadingIndicator);
				
				// ×”×•×¡×£ CSS ×œ×× ×™××¦×™×”
				const style = document.createElement('style');
				style.textContent = `
					@keyframes loading {
						0% { background-position: 200% 0; }
						100% { background-position: -200% 0; }
					}
				`;
				document.head.appendChild(style);
				
				// ×¢×“×›×Ÿ ××ª showLoading
				const originalShowLoading = window.showLoading;
				window.showLoading = function(show) {
					originalShowLoading(show);
					if (isMobile) {
						loadingIndicator.style.display = show ? 'block' : 'none';
					}
				};
			}
		});

		// ×©×™×¤×•×¨ ×‘×™×¦×•×¢×™× ×‘××•×‘×™×™×œ - ×˜×¢×™× ×” ×¢×¦×œ×” ×©×œ ×ª××•× ×•×ª ×•×ª×•×›×Ÿ ×›×‘×“
		function optimizePerformance() {
			if (!isMobile) return;
			
			// ×“×—×” ×˜×¢×™× ×ª ×ª×•×›×Ÿ ×œ× ×§×¨×™×˜×™
			const deferredElements = document.querySelectorAll('[data-defer]');
			const observer = new IntersectionObserver((entries) => {
				entries.forEach(entry => {
					if (entry.isIntersecting) {
						// ×˜×¢×Ÿ ××ª ×”×ª×•×›×Ÿ
						const element = entry.target;
						element.classList.remove('deferred');
						observer.unobserve(element);
					}
				});
			});
			
			deferredElements.forEach(el => observer.observe(el));
		}

		const swipeStyles = document.createElement('style');
		swipeStyles.textContent = `
			/* ×× ×™××¦×™×” ×œ××™× ×“×™×§×˜×•×¨ */
			.modal-content {
				position: relative;
			}
			
			/* ×× ×¢ ×‘×—×™×¨×ª ×˜×§×¡×˜ ×‘×–××Ÿ ×’×¨×™×¨×” */
			.modal-content.dragging {
				user-select: none;
				-webkit-user-select: none;
			}
			
			/* ×©×™×¤×•×¨ ×‘×™×¦×•×¢×™× */
			.modal-content {
				will-change: transform, opacity;
			}
			
			/* ××™× ×“×™×§×˜×•×¨ ×•×™×–×•××œ×™ ×œ××•×‘×™×™×œ */
			@media (max-width: 768px) {
				.modal-content::before {
					content: '';
					position: absolute;
					top: 10px;
					left: 50%;
					transform: translateX(-50%);
					width: 40px;
					height: 4px;
					background: #ccc;
					border-radius: 2px;
					opacity: 0.5;
					z-index: 1;
				}
			}
		`;
		document.head.appendChild(swipeStyles);

		// ×”×¤×¢×œ ×‘×˜×¢×™× ×ª ×”×“×£
		document.addEventListener('DOMContentLoaded', () => {
			addSwipeToCloseModals();
			improveModalScrolling();
		});

		// ×ª×™×§×•×Ÿ × ×•×¡×£: ×•×•×“× ×©××™×¨×•×¢×™ touch ×œ× ××ª× ×’×©×™× ×¢× ×’×œ×™×œ×” ×¨×’×™×œ×”
		document.addEventListener('DOMContentLoaded', () => {
			// ×”×•×¡×£ passive: true ×œ×›×œ ×××–×™× ×™ ×”-touch ×©×œ× ×¦×¨×™×›×™× preventDefault
			const touchElements = document.querySelectorAll('.table-wrapper, .tab-content, .container');
			
			touchElements.forEach(element => {
				element.addEventListener('touchstart', () => {}, { passive: true });
				element.addEventListener('touchmove', () => {}, { passive: true });
				element.addEventListener('touchend', () => {}, { passive: true });
			});
		});


		async function refreshData() {
			showToast('××¨×¢× ×Ÿ × ×ª×•× ×™×...', 'info');
			await loadAllData();
			updateStats();
			
			// ×¨×¢× ×Ÿ ××ª ×”×ª×¦×•×’×” ×”× ×•×›×—×™×ª
			const activeTab = document.querySelector('.tab-content.active');
			if (activeTab) {
				const tabId = activeTab.id;
				if (tabId === 'inventory') displayInventory();
				else if (tabId === 'movements') displayMovements();
				else if (tabId === 'users') displayUsers();
				else if (tabId === 'pickings') displayPickings();
			}
			
			showToast('×”× ×ª×•× ×™× ×¨×•×¢× × ×•!', 'success');
		}

		/*
		auth.onAuthStateChanged((firebaseUser) => {
			if (firebaseUser) {
				console.log('User authenticated:', firebaseUser.email);
			} else {
				console.log('User not authenticated');
				const savedUser = localStorage.getItem('currentUser');
				if (savedUser && window.location.pathname !== '/pick.html') {
					// logout();
				}
			}
		});
		*/

		// ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×”×¨×©××•×ª ×‘×–××Ÿ ×××ª
		async function checkRealtimePermissions() {
			if (!currentUser) return false;
			
			try {
				const userDoc = await db.collection('users').doc(currentUser.username).get();
				if (userDoc.exists) {
					const userData = userDoc.data();
					currentUser.permissions = userData.permissions || [];
					currentUser.role = userData.role;
					localStorage.setItem('currentUser', JSON.stringify(currentUser));
					updateTabsVisibility();
					return true;
				}
			} catch (error) {
				console.error('Error checking permissions:', error);
			}
			return false;
		}

        // --- ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ---
        let users = [];
        let inventory = [];
        let movements = [];
        let currentUser = null;
        let baseUnitsSingularList = ['×™×—×™×“×”', '×¤×—×™×ª', '×‘×§×‘×•×§', '×›×•×¡', '×›×™×¡', '×’×¨×'];
        let baseUnitsPluralList = ['×™×—×™×“×•×ª', '×¤×—×™×•×ª', '×‘×§×‘×•×§×™×', '×›×•×¡×•×ª', '×›×™×¡×™×', '×’×¨×'];
        let packUnitsSingularList = ['×§×¨×˜×•×Ÿ', '×××¨×–', '×©×§×™×ª', '×§×•×¤×¡×”', '×œ×™×˜×¨'];
        let packUnitsPluralList = ['×§×¨×˜×•× ×™×', '×××¨×–×™×', '×©×§×™×•×ª', '×§×•×¤×¡××•×ª', '×œ×™×˜×¨×™×'];
		let statsAnimated = false;
		
		function showToast(message, type = 'info') {
			const toast = document.getElementById('toast');
			if (!toast) {
				console.log(message);
				return;
			}
			
			toast.textContent = message;
			toast.className = 'toast show';
			
			if (type === 'error') toast.style.background = '#e74c3c';
			else if (type === 'success') toast.style.background = '#27ae60';
			else toast.style.background = '#333';
			
			setTimeout(() => {
				toast.classList.remove('show');
			}, 3000);
		}
        
        // ×˜×¢×™× ×ª × ×ª×•× ×™× ×-localStorage ×× ×§×™×™××™×
        const savedBaseUnitsSingular = JSON.parse(localStorage.getItem('baseUnitsSingularList') || '[]');
        const savedBaseUnitsPlural = JSON.parse(localStorage.getItem('baseUnitsPluralList') || '[]');
        const savedPackUnitsSingular = JSON.parse(localStorage.getItem('packUnitsSingularList') || '[]');
        const savedPackUnitsPlural = JSON.parse(localStorage.getItem('packUnitsPluralList') || '[]');
        
        if (savedBaseUnitsSingular.length > 0) baseUnitsSingularList = savedBaseUnitsSingular;
        if (savedBaseUnitsPlural.length > 0) baseUnitsPluralList = savedBaseUnitsPlural;
        if (savedPackUnitsSingular.length > 0) packUnitsSingularList = savedPackUnitsSingular;
        if (savedPackUnitsPlural.length > 0) packUnitsPluralList = savedPackUnitsPlural;

        // ××™×•×Ÿ ×•××¡× ×•×Ÿ ×”××œ××™
        let inventorySearch = '';
        let categoryFilter = '';
        let inventorySort = { by: '', dir: 1 };

        // --- ×¤×•× ×§×¦×™×•×ª Firebase ---
        async function loadAllData() {
            showLoading(true, 'stats');
            try {
                // ×˜×¢×Ÿ ××©×ª××©×™×
                users = [];
                const usersSnap = await db.collection('users').get();
                usersSnap.forEach(doc => users.push(doc.data()));
                
                if (users.length === 0) {
                    // ×™×¦×™×¨×ª ××©×ª××©×™× ×‘×¨×™×¨×ª ××—×“×œ
                    const defaultUsers = [
                        {
                            username: 'admin',
                            password: '1234',
                            fullName: '×× ×”×œ ×”××¢×¨×›×ª',
                            role: '×× ×”×œ ××¢×¨×›×ª',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'manage_users', 'view_reports', 'view_pickings']
                        },
                        {
                            username: 'warehouse',
                            password: '1234',
                            fullName: '×™×•×¡×™ ×›×”×Ÿ',
                            role: '××—×¡× ××™',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction', 'add_item', 'view_reports']
                        },
                        {
                            username: 'staff',
                            password: '1234',
                            fullName: '×“× ×™ ×œ×•×™',
                            role: '×¦×•×•×ª',
                            permissions: ['view_inventory', 'view_movements', 'add_transaction']
                        }
                    ];
                    
                    for (const user of defaultUsers) {
                        await db.collection('users').doc(user.username).set(user);
                        users.push(user);
                    }
                }
                
                // ×˜×¢×Ÿ ××œ××™
                inventory = [];
                const invSnap = await db.collection('inventory').get();
                invSnap.forEach(doc => inventory.push(doc.data()));
                
                // ×˜×¢×Ÿ ×ª× ×•×¢×•×ª
                movements = [];
                const movSnap = await db.collection('movements').orderBy('date', 'desc').limit(200).get();
                movSnap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    movements.push(data);
                });
                
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }
				// ××©×ª× ×” ×’×œ×•×‘×œ×™ ×œ×©××™×¨×ª ×”-interval
		let autoRefreshInterval = null;

		// ×¤×•× ×§×¦×™×” ×œ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
		async function startAutoRefresh() {
			// ×¢×¦×•×¨ ×¨×¢× ×•×Ÿ ×§×•×“× ×× ×§×™×™×
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
			}
			
			// ×”×’×“×¨ ×¨×¢× ×•×Ÿ ×›×œ 45 ×©× ×™×•×ª
			autoRefreshInterval = setInterval(async () => {
				try {
					console.log('×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×”× ×ª×•× ×™×...');
					await loadAllData();
					updateStats();
					
					// ×¨×¢× ×Ÿ ××ª ×”×ª×¦×•×’×” ×”× ×•×›×—×™×ª
					const activeTab = document.querySelector('.tab-content.active');
					if (activeTab) {
						const tabId = activeTab.id;
						if (tabId === 'inventory') displayInventory();
						else if (tabId === 'movements') displayMovements();
						else if (tabId === 'users') displayUsers();
						else if (tabId === 'pickings') displayPickings();
					}
				} catch (error) {
					console.error('×©×’×™××” ×‘×¨×¢× ×•×Ÿ ××•×˜×•××˜×™:', error);
				}
			}, 30000); // 45 ×©× ×™×•×ª
		}

		// ×¤×•× ×§×¦×™×” ×œ×¢×¦×™×¨×ª ×”×¨×¢× ×•×Ÿ ×”××•×˜×•××˜×™
		function stopAutoRefresh() {
			if (autoRefreshInterval) {
				clearInterval(autoRefreshInterval);
				autoRefreshInterval = null;
			}
		}
		
        async function loadMovementsOnly() {
            try {
                movements = [];
                const movSnap = await db.collection('movements').orderBy('date', 'desc').limit(200).get();
                movSnap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    movements.push(data);
                });
            } catch (error) {
                console.error('Error loading movements:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×ª× ×•×¢×•×ª: ' + error.message, 'error');
            }
        }

        async function createPickingList(planList) {
            try {
                const now = new Date();
                const docRef = await db.collection('pickingLists').add({
                    date: getFormattedDate(),
                    time: getFormattedTime(),
                    createdBy: currentUser.fullName,
                    status: 'open',
                    plan: planList.map(p => ({
                        productName: p.productName,
                        takePacks: p.takePacks,
                        takeUnits: p.takeUnits,
                        location: p.location,
                        expiry: p.expiry
                    }))
                });
                return docRef.id;
            } catch (error) {
                console.error('Error creating picking list:', error);
                showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×¨×©×™××ª ×œ×™×§×•×˜: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveUser(user) {
			try {
				await db.collection('users').doc(user.username).set(user);
				// if (user.password && auth) {
				//     await createOrUpdateAuthUser(user.username, user.password);
				// }
				
			} catch (error) {
				console.error('Error saving user:', error);
				showToast('×©×’×™××” ×‘×©××™×¨×ª ×”××©×ª××©: ' + error.message, 'error');
				throw error;
			}
		}

        async function deleteUserFromDB(username) {
            try {
                await db.collection('users').doc(username).delete();
            } catch (error) {
                console.error('Error deleting user:', error);
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”××©×ª××©: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveInventoryItem(item) {
            try {
                await db.collection('inventory').doc(item.name).set(item);
            } catch (error) {
                console.error('Error saving inventory item:', error);
                showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×™×˜: ' + error.message, 'error');
                throw error;
            }
        }

        async function deleteInventoryItem(name) {
            try {
                await db.collection('inventory').doc(name).delete();
            } catch (error) {
                console.error('Error deleting inventory item:', error);
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”×¤×¨×™×˜: ' + error.message, 'error');
                throw error;
            }
        }

        async function saveMovement(movement) {
            try {
                await db.collection('movements').add(movement);
            } catch (error) {
                console.error('Error saving movement:', error);
                showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×ª× ×•×¢×”: ' + error.message, 'error');
                throw error;
            }
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ---
        function showLoading(show, type = 'general') {
			const loading = document.getElementById('loadingSpinner');
			if (!loading) return;
			
			if (show) {
				// ×¦×•×¨ skeleton loader ×‘×”×ª×× ×œ×¡×•×’ ×”×ª×•×›×Ÿ
				let skeletonHTML = '';
				
				switch(type) {
					case 'inventory':
						skeletonHTML = createInventorySkeletonHTML();
						break;
					case 'stats':
						skeletonHTML = createStatsSkeletonHTML();
						break;
					case 'movements':
						skeletonHTML = createMovementsSkeletonHTML();
						break;
					default:
						skeletonHTML = '<div class="skeleton-loader" style="height: 200px; width: 100%;"></div>';
				}
				
				loading.innerHTML = skeletonHTML;
				loading.style.display = 'block';
			} else {
				// ×”×•×¡×£ fade out animation
				loading.style.opacity = '0';
				setTimeout(() => {
					loading.style.display = 'none';
					loading.style.opacity = '1';
					loading.innerHTML = '';
				}, 300);
			}
		}

		// ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ×œ×™×¦×™×¨×ª Skeleton HTML
		function createInventorySkeletonHTML() {
			let html = '<div class="skeleton-table">';
			for (let i = 0; i < 5; i++) {
				html += `
					<div class="skeleton-row">
						<div class="skeleton-loader skeleton-cell small"></div>
						<div class="skeleton-loader skeleton-cell large"></div>
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell small"></div>
					</div>
				`;
			}
			html += '</div>';
			return html;
		}

		function createStatsSkeletonHTML() {
			let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">';
			for (let i = 0; i < 4; i++) {
				html += `
					<div class="skeleton-stat-card">
						<div class="skeleton-loader skeleton-stat-label"></div>
						<div class="skeleton-loader skeleton-stat-value"></div>
					</div>
				`;
			}
			html += '</div>';
			return html;
		}

		function createMovementsSkeletonHTML() {
			let html = '<div class="skeleton-table">';
			for (let i = 0; i < 8; i++) {
				html += `
					<div class="skeleton-row">
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell small"></div>
						<div class="skeleton-loader skeleton-cell large"></div>
						<div class="skeleton-loader skeleton-cell"></div>
						<div class="skeleton-loader skeleton-cell"></div>
					</div>
				`;
			}
			html += '</div>';
			return html;
		}

        function formatDate(dateStr) {
            if (!dateStr) return '';
            try {
                const date = new Date(dateStr);
                if (isNaN(date.getTime())) return dateStr;
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}/${month}/${year}`;
            } catch (error) {
                return dateStr;
            }
        }

        function getUnitLabel(count, singular, plural) {
            if (typeof count === "undefined") return plural || '';
            return (count === 1) ? (singular || '') : (plural || '');
        }

        function totalPacksAndUnits(item) {
            let totalPacks = 0, looseUnits = 0;
            (item.variants || []).forEach(variant => {
                const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                if (daysToExpiry === null || daysToExpiry > 0) {
                    totalPacks += variant.quantityPacks || 0;
                    looseUnits += variant.quantityUnits || 0;
                }
            });
            totalPacks += Math.floor(looseUnits / (item.unitsPerPack || 1));
            looseUnits = looseUnits % (item.unitsPerPack || 1);
            return [totalPacks, looseUnits];
        }

        function getEarliestExpiry(item) {
            let earliest = null;
            (item.variants || []).forEach(variant => {
                if (variant.expiry && (!earliest || new Date(variant.expiry) < earliest)) {
                    earliest = new Date(variant.expiry);
                }
            });
            return earliest ? earliest.toISOString() : null;
        }

        function getGlobalStatus(totalPacks, minPacks, earliestExpiry) {
            if (totalPacks < minPacks) return 'ğŸ”´ ××ª×—×ª ×œ××™× ×™××•×';
            if (earliestExpiry) {
                const days = Math.floor((new Date(earliestExpiry) - new Date()) / (1000 * 60 * 60 * 24));
                if (days <= 7) return 'ğŸ”´ ×ª×¤×•×’×” ×§×¨×•×‘×”';
                if (days <= 14) return 'ğŸŸ  ×ª×¤×•×’×” ×‘××•×¤×§';
            }
            return 'ğŸŸ¢ ×ª×§×™×Ÿ';
        }

        function updateStats() {
			try {
				// ×”×•×¡×£ ×× ×™××¦×™×” ×œ×›×¨×˜×™×¡×™ ×”×¡×˜×˜×™×¡×˜×™×§×•×ª
				const statCards = document.querySelectorAll('.stat-card');
				statCards.forEach((card, index) => {
					card.classList.remove('stats-enter');
					void card.offsetWidth; // Force reflow
					card.classList.add('stats-enter');
				});
				
				// ×¡×”"×› ××•×¦×¨×™×
				const totalProductsCount = inventory.length;
				
				// ×¡×¤×™×¨×ª ××•×¦×¨×™× ×‘××œ××™ × ××•×š ×•×ª×¤×•×’×•×ª ×§×¨×•×‘×•×ª
				let lowStockCount = 0;
				let expiringCount = 0;
				const today = new Date();
				today.setHours(0, 0, 0, 0);
				
				inventory.forEach(item => {
					const [totalPacks, totalUnits] = totalPacksAndUnits(item);
					
					if (totalPacks < (item.minPacks || 0)) {
						lowStockCount++;
					}
					
					let hasExpiring = false;
					for (const variant of (item.variants || [])) {
						if (variant.expiry) {
							const expiryDate = new Date(variant.expiry);
							expiryDate.setHours(0, 0, 0, 0);
							const daysToExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
							
							if (daysToExpiry >= 0 && daysToExpiry <= 14) {
								if ((variant.quantityPacks || 0) > 0 || (variant.quantityUnits || 0) > 0) {
									expiringCount++;
									hasExpiring = true;
									break;
								}
							}
						}
					}
				});
				
				// ×¡×¤×™×¨×ª ×ª× ×•×¢×•×ª ×”×™×•×
				const todayStr = getFormattedDate();
				let todayMovements = 0;
				
				movements.forEach(m => {
					if (m.date === todayStr) {
						todayMovements++;
					}
				});
				
				// ×¢×“×›×Ÿ ××ª ×”×¢×¨×›×™× ×¢× ×× ×™××¦×™×” ×¨×§ ×× ×–×• ×”×¤×¢× ×”×¨××©×•× ×” ××• ×× ×”×¢×¨×›×™× ×”×©×ª× ×•
				if (!statsAnimated) {
					// ×¤×¢× ×¨××©×•× ×” - ×× ×™××¦×™×” ×-0
					animateValue('totalProducts', 0, totalProductsCount, 500);
					animateValue('lowStockCount', 0, lowStockCount, 600);
					animateValue('expiringCount', 0, expiringCount, 700);
					animateValue('todayMovements', 0, todayMovements, 800);
					statsAnimated = true;
				} else {
					// ×¢×“×›×•× ×™× - ×× ×™××¦×™×” ××”×¢×¨×š ×”× ×•×›×—×™ ×œ×¢×¨×š ×”×—×“×©
					updateValueWithAnimation('totalProducts', totalProductsCount, 300);
					updateValueWithAnimation('lowStockCount', lowStockCount, 300);
					updateValueWithAnimation('expiringCount', expiringCount, 300);
					updateValueWithAnimation('todayMovements', todayMovements, 300);
				}
				
				// ×”×•×¡×£ ×¢×“×›×•×Ÿ ×©×œ ×ª×¦×•×’×ª ×”×ª×¨××•×ª
				updateAlerts();
				
			} catch (error) {
				console.error('Error updating stats:', error);
				document.getElementById('totalProducts').textContent = '0';
				document.getElementById('lowStockCount').textContent = '0';
				document.getElementById('expiringCount').textContent = '0';
				document.getElementById('todayMovements').textContent = '0';
			}
		}

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×¢×“×›×•×Ÿ ×¢×¨×š ×¢× ×× ×™××¦×™×” ××”×¢×¨×š ×”× ×•×›×—×™
		function updateValueWithAnimation(elementId, newValue, duration) {
			const element = document.getElementById(elementId);
			if (!element) return;
			
			const currentValue = parseInt(element.textContent) || 0;
			
			// ×× ××™×Ÿ ×©×™× ×•×™, ××œ ×ª×¢×©×” ×›×œ×•×
			if (currentValue === newValue) {
				return;
			}
			
			const range = newValue - currentValue;
			const startTime = performance.now();
			
			function updateValue(currentTime) {
				const elapsed = currentTime - startTime;
				const progress = Math.min(elapsed / duration, 1);
				
				// Easing function
				const easeOutQuart = 1 - Math.pow(1 - progress, 4);
				
				const value = Math.floor(currentValue + (range * easeOutQuart));
				element.textContent = value;
				
				if (progress < 1) {
					requestAnimationFrame(updateValue);
				} else {
					element.textContent = newValue;
				}
			}
			
		}
		
		function animateValue(elementId, start, end, duration) {
			const element = document.getElementById(elementId);
			if (!element) return;
			
			// ×× ××™×Ÿ ×”×‘×“×œ, ×¤×©×•×˜ ×”×¦×’ ××ª ×”×¢×¨×š
			if (start === end) {
				element.textContent = end;
				return;
			}
			
			element.classList.add('counter-animate');
			
			const range = end - start;
			const startTime = performance.now();
			
			function updateValue(currentTime) {
				const elapsed = currentTime - startTime;
				const progress = Math.min(elapsed / duration, 1);
				
				// Easing function
				const easeOutQuart = 1 - Math.pow(1 - progress, 4);
				
				const currentValue = Math.floor(start + (range * easeOutQuart));
				element.textContent = currentValue;
				
				if (progress < 1) {
					requestAnimationFrame(updateValue);
				} else {
					element.textContent = end;
				}
			}
			
			requestAnimationFrame(updateValue);
		}

		// ×¤×•× ×§×¦×™×” ×—×“×©×” ×œ×”×¦×’×ª ×”×ª×¨××•×ª
		function updateAlerts() {
			const alertsContainer = document.getElementById('alerts');
			if (!alertsContainer) return;
			
			// ×‘×“×•×§ ×× ×œ××©×ª××© ×™×© ×”×¨×©××” ×œ×¨××•×ª ×”×ª×¨××•×ª
			if (!currentUser || (currentUser.role !== '×× ×”×œ ××¢×¨×›×ª' && currentUser.role !== '×× ×”×œ ××ª×—×')) {
				alertsContainer.innerHTML = '';
				alertsContainer.style.display = 'none';
				return;
			}
			
			// ×”×¦×’ ××ª ××™×›×œ ×”×”×ª×¨××•×ª
			alertsContainer.style.display = 'block';
			alertsContainer.innerHTML = '';
			const alerts = [];
			
			// ×‘×“×•×§ ××•×¦×¨×™× ×‘××œ××™ × ××•×š
			inventory.forEach(item => {
				const [totalPacks, totalUnits] = totalPacksAndUnits(item);
				
				if (totalPacks < (item.minPacks || 0)) {
					const shortage = (item.minPacks || 0) - totalPacks;
					alerts.push({
						type: 'danger',
						text: `${item.name}: ××ª×—×ª ×œ××™× ×™××•×! ×—×¡×¨ ${shortage} ${getUnitLabel(shortage, item.packUnitSingular, item.packUnitPlural)}`
					});
				}
			});
			
			// ×‘×“×•×§ ×ª×¤×•×’×•×ª ×§×¨×•×‘×•×ª
			const today = new Date();
			today.setHours(0, 0, 0, 0);
			
			inventory.forEach(item => {
				(item.variants || []).forEach(variant => {
					if (!variant.expiry) return;
					if ((variant.quantityPacks || 0) === 0 && (variant.quantityUnits || 0) === 0) return;
					
					const expiryDate = new Date(variant.expiry);
					expiryDate.setHours(0, 0, 0, 0);
					const daysToExpiry = Math.floor((expiryDate - today) / (1000 * 60 * 60 * 24));
					
					if (daysToExpiry < 0) {
						alerts.push({
							type: 'danger',
							text: `${item.name} ×‘${variant.location}: ×¤×’ ×ª×•×§×£ ×œ×¤× ×™ ${Math.abs(daysToExpiry)} ×™××™×!`
						});
					} else if (daysToExpiry === 0) {
						alerts.push({
							type: 'danger',
							text: `${item.name} ×‘${variant.location}: ×¤×’ ×ª×•×§×£ ×”×™×•×!`
						});
					} else if (daysToExpiry <= 7) {
						alerts.push({
							type: 'warning',
							text: `${item.name} ×‘${variant.location}: ×™×¤×•×’ ×‘×¢×•×“ ${daysToExpiry} ×™××™×`
						});
					}
				});
			});
			
			// ××™×•×Ÿ ×”×ª×¨××•×ª - ×§×¨×™×˜×™×•×ª ×§×•×“×
			alerts.sort((a, b) => {
				if (a.type === 'danger' && b.type !== 'danger') return -1;
				if (a.type !== 'danger' && b.type === 'danger') return 1;
				return 0;
			});
			
			if (alerts.length === 0) return;
			
			// ×¦×•×¨ ××™×›×œ ×¢× ×›×•×ª×¨×ª ×•×›×¤×ª×•×¨
			const alertsWrapper = document.createElement('div');
			alertsWrapper.className = 'alerts-wrapper';
			
			// ×›×•×ª×¨×ª ×¢× ×›×¤×ª×•×¨ ×”×¨×—×‘×”
			const alertsHeader = document.createElement('div');
			alertsHeader.className = 'alerts-header';
			
			// ×¡×¤×™×¨×ª ×¡×•×’×™ ×”×ª×¨××•×ª
			const dangerCount = alerts.filter(a => a.type === 'danger').length;
			const warningCount = alerts.filter(a => a.type === 'warning').length;
			
			alertsHeader.innerHTML = `
				<span class="alerts-title">
					<strong>âš ï¸ ×”×ª×¨××•×ª (${alerts.length})</strong>
					<span class="alerts-summary">
						${dangerCount > 0 ? `<span class="badge badge-danger">${dangerCount} ×§×¨×™×˜×™×•×ª</span>` : ''}
						${warningCount > 0 ? `<span class="badge badge-warning">${warningCount} ××–×”×¨×•×ª</span>` : ''}
					</span>
				</span>
				<button class="alerts-toggle-btn" onclick="toggleAlerts()" id="alertsToggleBtn">
					<span class="toggle-icon">â–¼</span> ×”×¦×’ ×”×ª×¨××•×ª
				</button>
			`;
			
			// ××™×›×œ ×œ×”×ª×¨××•×ª - ××•×¡×ª×¨ ×›×‘×¨×™×¨×ª ××—×“×œ
			const alertsList = document.createElement('div');
			alertsList.className = 'alerts-list';
			alertsList.id = 'alertsList';
			alertsList.style.display = 'none';
			
			// ×”×•×¡×£ ××ª ×›×œ ×”×”×ª×¨××•×ª ×œ××™×›×œ ×”××•×¡×ª×¨
			alerts.forEach(alert => {
				const alertDiv = document.createElement('div');
				alertDiv.className = `alert alert-${alert.type}`;
				alertDiv.innerHTML = `<strong>âš ï¸</strong> ${alert.text}`;
				alertsList.appendChild(alertDiv);
			});
			
			alertsWrapper.appendChild(alertsHeader);
			alertsWrapper.appendChild(alertsList);
			alertsContainer.appendChild(alertsWrapper);
			
			// ×©×—×–×¨ ××¦×‘ ×”×¨×—×‘×” ×-localStorage
			const wasExpanded = localStorage.getItem('alertsExpanded') === 'true';
			if (wasExpanded) {
				toggleAlerts(); // ×¤×ª×— ××•×˜×•××˜×™×ª ×× ×”×™×” ×¤×ª×•×— ×§×•×“×
			}
		}	
		// ×¤×•× ×§×¦×™×” ×œ×”×¨×—×‘×”/×›×™×•×•×¥ ×”×ª×¨××•×ª
		function toggleAlerts() {
			const alertsList = document.getElementById('alertsList');
			const toggleBtn = document.getElementById('alertsToggleBtn');
			
			if (!alertsList || !toggleBtn) return;
			
			const isExpanded = alertsList.style.display !== 'none';
			
			if (isExpanded) {
				// ×›×•×•×¥
				alertsList.style.display = 'none';
				toggleBtn.innerHTML = '<span class="toggle-icon">â–¼</span> ×”×¦×’ ×”×ª×¨××•×ª';
				localStorage.setItem('alertsExpanded', 'false');
			} else {
				// ×”×¨×—×‘
				alertsList.style.display = 'block';
				toggleBtn.innerHTML = '<span class="toggle-icon">â–²</span> ×”×¡×ª×¨ ×”×ª×¨××•×ª';
				localStorage.setItem('alertsExpanded', 'true');
			}
		}
        // --- LOGIN & BOOT ---
        // ×”×—×œ×£ ××ª ×›×œ ×”-event listener ×©×œ loginForm ×‘×§×•×“ ×”×‘×:
		document.getElementById('loginForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			const username = document.getElementById('username').value;
			const password = document.getElementById('password').value;
			
			try {
				showLoading(true);
				await loadAllData();
				updateStats();
				
				const user = users.find(u => u.username === username && u.password === password);
				if (user) {
					currentUser = user;
					localStorage.setItem('currentUser', JSON.stringify(user));
					
					// × ×¡×” ×œ×”×ª×—×‘×¨ ×œ-Firebase Auth (××•×¤×¦×™×•× ×œ×™)
					try {
						const userEmail = `${username}@cinema-city-hadera.local`;
						await auth.signInWithEmailAndPassword(userEmail, password);
					} catch (authError) {
						// ×× × ×›×©×œ, × ×¡×” ×œ×™×¦×•×¨ ××©×ª××©
						if (authError.code === 'auth/user-not-found') {
							try {
								await auth.createUserWithEmailAndPassword(userEmail, password);
							} catch (createError) {
								console.log('Auth is optional, continuing without it');
							}
						}
						// ×××©×™×›×™× ×’× ×‘×œ×™ Auth - ×–×” ××•×¤×¦×™×•× ×œ×™
					}
					
					showMainScreen();
					showToast(`×‘×¨×•×š ×”×‘×, ${user.fullName}!`, 'success');
				} else {
					showToast('×©× ××©×ª××© ××• ×¡×™×¡××” ×©×’×•×™×™×', 'error');
				}
			} catch (error) {
				console.error('Login error:', error);
				showToast('×©×’×™××” ×‘×”×ª×—×‘×¨×•×ª. × ×¡×” ×©×•×‘.', 'error');
			} finally {
				showLoading(false);
			}
		});

        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            document.getElementById('currentUserName').textContent = currentUser.fullName;
            document.getElementById('currentUserRole').textContent = currentUser.role;
            updateTabsVisibility();
			// ××ª×—×œ ×ª×›×•× ×•×ª ××•×‘×™×™×œ ×× ×¦×¨×™×š
			if (isMobile) {
				initMobileFeatures();
			}
            // ×”×¦×’×ª ×˜××‘ ×”×¨××©×•×Ÿ ×”××•×¨×©×”
            const firstAllowedTab = document.querySelector('.tab:not(.disabled)');
            if (firstAllowedTab) {
                const tabName = firstAllowedTab.getAttribute('data-tab');
                showTab(tabName);
            }
        }

        function updateTabsVisibility() {
            const tabs = document.querySelectorAll('.tab');
            tabs.forEach(tab => {
                tab.classList.remove('disabled');
                tab.style.display = 'flex';
                
                const permission = tab.getAttribute('data-permission');
                if (permission && !currentUser.permissions.includes(permission)) {
                    tab.classList.add('disabled');
                    tab.style.display = 'none';
                }
            });
        }

        function logout() {
			// ×”×ª× ×ª×§ ×-Firebase Auth - ××‘×•×˜×œ ×–×× ×™×ª
			// if (auth) {
			//     auth.signOut().catch(error => console.error('Error signing out:', error));
			// }
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => modal.style.display = 'none');
            
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            document.getElementById('loginForm').reset();
        }

        window.addEventListener('load', async function() {
			if (isMobile) {
				initMobileFeatures();
			}
            try {
                const savedUser = localStorage.getItem('currentUser');
                if (savedUser) {
                    await loadAllData();
                    updateStats();
                    
                    currentUser = JSON.parse(savedUser);
                    if (users.find(u => u.username === currentUser.username)) {
                        showMainScreen();
                    } else {
                        localStorage.removeItem('currentUser');
                    }
                }
            } catch (error) {
                console.error('Load error:', error);
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
            }
        });

        // --- TAB HANDLERS ---
        window.showTab = async function(e, tabName) {
			if (isMobile) {
				window.scrollTo(0, 0);
			}
			
			let tabElement = null;
			
			// ×˜×™×¤×•×œ × ×›×•×Ÿ ×‘×¤×¨××˜×¨×™×
			if (typeof e === 'string') {
				tabName = e;
				e = null;
			} else if (e && e.target) {
				e.preventDefault();
				tabElement = e.target;
			} else if (e && !e.target && typeof tabName === 'undefined') {
				tabName = e;
				e = null;
			}
			
			// ×‘×“×™×§×ª ×”×¨×©××•×ª
			if (tabElement) {
				const permission = tabElement.getAttribute('data-permission');
				if (permission && !currentUser.permissions.includes(permission)) {
					showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×’×©×ª ×œ×ª×¤×¨×™×˜ ×–×”', 'error');
					return;
				}
			}
			
			// ×”×•×¡×£ ×× ×™××¦×™×” ×©×œ fade out ×œ×ª×•×›×Ÿ ×”× ×•×›×—×™
			const currentActiveContent = document.querySelector('.tab-content.active');
			if (currentActiveContent) {
				currentActiveContent.style.opacity = '0';
				currentActiveContent.style.transform = 'translateX(-20px)';
			}
			
			// ×”×¦×’ ××™× ×“×™×§×˜×•×¨ ×˜×¢×™× ×”
			const loadingType = tabName === 'inventory' ? 'inventory' : 
							   tabName === 'movements' ? 'movements' : 
							   'general';
			showLoading(true, loadingType);
			
			try {
				// ×¨×¢× ×Ÿ × ×ª×•× ×™× ×-Firebase
				await loadAllData();
				updateStats();
				
				// × ×™×§×•×™ ×˜××‘×™×
				document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

				// ×”×¤×¢×œ×ª ×˜××‘
				if (tabElement) tabElement.classList.add('active');
				else {
					const targetTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
					if (targetTab) targetTab.classList.add('active');
				}

				const tabContent = document.getElementById(tabName);
				if (tabContent) {
					tabContent.classList.add('active');
					// ××¤×¡ ××ª ×”×¡×’× ×•× ×•×ª ×œ×× ×™××¦×™×” ×”×—×“×©×”
					tabContent.style.opacity = '';
					tabContent.style.transform = '';
				}

				// ×˜×¢×™× ×ª ×ª×•×›×Ÿ ×“×™× ××™
				if (tabName === 'inventory') displayInventory();
				else if (tabName === 'movements') displayMovements();
				else if (tabName === 'transaction') {
					const cont = document.getElementById('multiTransactionRows');
					if (cont) {
						cont.innerHTML = '';
						addTransactionRow();
					}
				}
				else if (tabName === 'users') displayUsers();
				else if (tabName === 'addItem') {
					populateUnitsSelect(document.getElementById('baseUnitSingular'), baseUnitsSingularList);
					populateUnitsSelect(document.getElementById('baseUnitPlural'), baseUnitsPluralList);
					populateUnitsSelect(document.getElementById('packUnitSingular'), packUnitsSingularList);
					populateUnitsSelect(document.getElementById('packUnitPlural'), packUnitsPluralList);
				}
				else if (tabName === 'pickings') displayPickings();
				
			} catch (error) {
				console.error('×©×’×™××” ×‘×˜×¢×™× ×ª ×”×˜××‘:', error);
				showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×', 'error');
			} finally {
				showLoading(false);
			}
		};

        // --- ×ª×¦×•×’×ª ××œ××™ ---
        function displayInventory() {
			const tbody = document.getElementById('inventoryBody');
			if (!tbody) return;
			
			tbody.classList.add('fade-in');
			tbody.innerHTML = '';

			let filtered = [...inventory];

			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×—×™×¤×•×©
			if (inventorySearch) {
				filtered = filtered.filter(item => 
					item.name.toLowerCase().includes(inventorySearch.toLowerCase())
				);
			}
			
			// ×¡×™× ×•×Ÿ ×œ×¤×™ ×§×˜×’×•×¨×™×”
			if (categoryFilter) {
				filtered = filtered.filter(item => item.category === categoryFilter);
			}

			// ××™×•×Ÿ
			if (inventorySort.by) {
				filtered.sort((a, b) => {
					let av, bv;
					switch (inventorySort.by) {
						case 'name': 
							av = a.name; 
							bv = b.name; 
							break;
						case 'category': 
							av = a.category; 
							bv = b.category; 
							break;
						case 'quantity': {
							const [ap] = totalPacksAndUnits(a);
							const [bp] = totalPacksAndUnits(b);
							av = ap;
							bv = bp;
						} break;
						case 'min': 
							av = a.minPacks || 0; 
							bv = b.minPacks || 0; 
							break;
						case 'expiry': {
							const ae = getEarliestExpiry(a);
							const be = getEarliestExpiry(b);
							av = ae ? new Date(ae) : new Date(3000,1,1);
							bv = be ? new Date(be) : new Date(3000,1,1);
						} break;
						default: 
							av = a.name; 
							bv = b.name;
					}
					
					if (typeof av === "string") {
						return inventorySort.dir * av.localeCompare(bv);
					} else {
						return inventorySort.dir * ((av > bv) - (av < bv));
					}
				});
			}

			// ×‘×“×•×§ ×× ×™×© ×ª×•×¦××•×ª
			if (filtered.length === 0) {
				tbody.innerHTML = `
					<tr>
						<td colspan="8" class="empty-state">
							<div class="empty-state-icon">ğŸ“¦</div>
							<div>×œ× × ××¦××• ××•×¦×¨×™×${inventorySearch || categoryFilter ? ' ×”×ª×•×××™× ×œ×—×™×¤×•×©' : ''}</div>
						</td>
					</tr>
				`;
				return;
			}

			// ×”×•×¡×£ ××ª ×”×©×•×¨×•×ª ×¢× ×× ×™××¦×™×”
			filtered.forEach((item, itemIndex) => {  // ×©×™× ×•×™: ×”×•×¡×¤× ×• itemIndex ×›×¤×¨××˜×¨
				const [totalPacks, looseUnits] = totalPacksAndUnits(item);
				const earliestExpiry = getEarliestExpiry(item);
				
				const row = tbody.insertRow();
				row.classList.add('summary-row', 'table-row-enter');
				row.style.animationDelay = `${itemIndex * 0.02}s`; // ×©×™× ×•×™: ×”×©×ª××© ×‘-itemIndex
				
				row.innerHTML = `
					<td><button class="expand-btn btn-ripple" onclick="toggleVariants(this)">+</button></td>
					<td>${item.name}</td>
					<td>${item.category}</td>
					<td>
						${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
						${looseUnits > 0 ? `+ ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
					</td>
					<td>${item.minPacks || 0} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
					<td>${earliestExpiry ? formatDate(earliestExpiry) : '-'}</td>
					<td>${getGlobalStatus(totalPacks, item.minPacks || 0, earliestExpiry)}</td>
					<td>
						${(currentUser.permissions.includes('add_item') || currentUser.role === '×× ×”×œ ××¢×¨×›×ª')
						? `${isMobile 
							? `<button class="btn-small btn-ripple" onclick="editProduct('${item.name}')" title="×¢×¨×•×š" style="background: transparent; border: none; font-size: 1.2em; padding: 4px;">âœï¸</button>
							   <button class="btn-small btn-ripple" onclick="openAddVariantModal('${item.name}')" title="×”×•×¡×£ ×•×¨×™×× ×˜" style="background: transparent; border: none; font-size: 1.2em; padding: 4px;">â•</button>
							   <button class="btn-small btn-ripple" onclick="deleteProductWithAnimation('${item.name}')" title="××—×§ ××•×¦×¨" style="background: transparent; border: none; font-size: 1.2em; padding: 4px;">ğŸ—‘ï¸</button>`
							: `<button class="btn-small btn-edit btn-ripple" onclick="editProduct('${item.name}')">×¢×¨×•×š</button>
							   <button class="btn-small btn-edit btn-ripple" onclick="openAddVariantModal('${item.name}')">â• ×”×•×¡×£</button>
							   <button class="btn-small btn-danger btn-ripple" onclick="deleteProductWithAnimation('${item.name}')">××—×§</button>`
						  }`
						: ''}
					</td>
				`;

				// ×”×•×¡×¤×ª ×©×•×¨×•×ª ×•×¨×™×× ×˜×™×
				let variantRowIndex = 0;
				(item.variants || []).forEach((variant, index) => {
					const variantRow = tbody.insertRow();
					variantRow.classList.add('variant-row');
					variantRow.style.display = 'none';

					const daysToExpiry = variant.expiry ? Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
					
					let expiryStatus = '-';
					if (daysToExpiry !== null && daysToExpiry >= 0) {
						if (daysToExpiry <= 7) expiryStatus = 'ğŸ”´';
						else if (daysToExpiry <= 14) expiryStatus = 'ğŸŸ ';
						else if (daysToExpiry <= 30) expiryStatus = 'ğŸŸ¡';
						else expiryStatus = 'ğŸŸ¢';
					}

					// ×—×©×‘ ××™× ×“×§×¡ ×™×—×¡×™ ×œ×•×•×¨×™×× ×˜×™× ×¢× ××•×ª×• location ×•-expiry
					let relativeIndex = 0;
					for (let i = 0; i < index; i++) {
						if (item.variants[i].location === variant.location && 
							(item.variants[i].expiry || '') === (variant.expiry || '')) {
							relativeIndex++;
						}
					}

					variantRow.innerHTML = `
						<td></td>
						<td ${!isMobile ? 'colspan="2"' : ''} style="padding-right: 20px;">${variant.location}</td>
						${isMobile ? '<td></td>' : ''}
						<td>
							${variant.quantityPacks || 0} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
							${variant.quantityUnits > 0 ? `+ ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ""}
						</td>
						<td>-</td>
						<td>${formatDate(variant.expiry) || '-'}</td>
						<td>${expiryStatus}</td>
						<td>
							${(currentUser.permissions.includes('add_item') || currentUser.role === '×× ×”×œ ××¢×¨×›×ª') 
								? `${isMobile 
									? `<button class="btn-small" onclick="editVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})" title="×¢×¨×•×š" style="background: transparent; border: none; font-size: 1.1em; padding: 4px;">âœï¸</button>
									   <button class="btn-small" onclick="deleteVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})" title="××—×§" style="background: transparent; border: none; font-size: 1.1em; padding: 4px;">ğŸ—‘ï¸</button>`
									: `<button class="btn-small btn-edit" onclick="editVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})">×¢×¨×•×š</button>
									   <button class="btn-small btn-danger" onclick="deleteVariantByIdentifier('${item.name}', '${variant.location}', '${variant.expiry || ''}', ${relativeIndex})">××—×§</button>`
								  }`
								: ''}
						</td>
					`;
					variantRowIndex++;
				});
			});
		}
		
		window.deleteProductWithAnimation = async function(productName) {
			if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××•×¦×¨ "${productName}"?`)) {
				return;
			}
			
			// ××¦× ××ª ×”×©×•×¨×”
			const rows = document.querySelectorAll('#inventoryBody tr');
			let targetRow = null;
			let variantRows = [];
			
			rows.forEach(row => {
				if (row.cells[1] && row.cells[1].textContent === productName) {
					targetRow = row;
				} else if (targetRow && row.classList.contains('variant-row')) {
					variantRows.push(row);
				} else if (targetRow && !row.classList.contains('variant-row')) {
					// ×”×’×¢× ×• ×œ××•×¦×¨ ×”×‘×
					return;
				}
			});
			
			// ×”×•×¡×£ ×× ×™××¦×™×™×ª ××—×™×§×”
			if (targetRow) {
				targetRow.classList.add('row-delete');
				variantRows.forEach(row => row.classList.add('row-delete'));
				
				// ×—×›×” ×œ×¡×™×•× ×”×× ×™××¦×™×”
				await new Promise(resolve => setTimeout(resolve, 300));
			}
			
			// ×”××©×š ×¢× ×”××—×™×§×” ×”×¨×’×™×œ×”
			await deleteProduct(productName);
		};

        function toggleVariants(button) {
			const row = button.closest('tr');
			let nextRow = row.nextElementSibling;
			const isOpen = button.textContent === '-';
			
			// ×× ×™××¦×™×™×ª ×¡×™×‘×•×‘ ×œ×›×¤×ª×•×¨
			button.style.transform = isOpen ? 'rotate(0deg)' : 'rotate(90deg)';
			button.style.transition = 'transform 0.3s ease';
			button.textContent = isOpen ? '+' : '-';

			// ×× ×™××¦×™×” ×œ×©×•×¨×•×ª ×”×•×•×¨×™×× ×˜×™×
			let delay = 0;
			while (nextRow && nextRow.classList.contains('variant-row')) {
				if (isOpen) {
					nextRow.style.display = 'none';
					nextRow.classList.add('collapsed');
				} else {
					nextRow.style.display = '';
					nextRow.classList.remove('collapsed');
					nextRow.classList.add('table-row-enter');
					nextRow.style.animationDelay = `${delay * 0.05}s`;
					delay++;
				}
				nextRow = nextRow.nextElementSibling;
			}
		}

        // --- ×ª×¦×•×’×ª ×ª× ×•×¢×•×ª ---
		function displayMovements() {
			const tbody = document.getElementById('movementsBody');
			if (!tbody) return;
			
			tbody.innerHTML = '';
			
			movements.forEach(movement => {
				if (!movement.product || !movement.type) return;
				
				const canEdit = ['×× ×”×œ ××¢×¨×›×ª','×× ×”×œ ××ª×—×','×× ×”×œ/×ª ××©××¨×ª','××—×¡× ××™'].includes(currentUser.role);
				const row = tbody.insertRow();
				
				// ×”×•×¡×£ ×¡×™××•×Ÿ ×œ×ª× ×•×¢×•×ª ×‘×™×˜×•×œ
				const isCancellation = movement.type && (movement.type.includes('×‘×™×˜×•×œ') || movement.type === '×‘×™×˜×•×œ ×”×•×¦××”' || movement.type === '×‘×™×˜×•×œ ×”×›× ×¡×”');
				if (isCancellation) {
					row.style.backgroundColor = '#fff3cd';
					row.style.fontStyle = 'italic';
				}
				
				// ×”×•×¡×£ ×¡×™××•×Ÿ ×œ×ª× ×•×¢×•×ª ×œ×™×§×•×˜
				const isPicking = movement.notes && movement.notes.includes('×œ×™×§×•×˜');
				if (isPicking) {
					row.style.backgroundColor = '#e8f4fd';
				}
				
				row.innerHTML = `
					<td>${movement.date || ''}</td>
					<td>${movement.time || ''}</td>
					<td>${movement.product}</td>
					<td>${movement.type}${isCancellation ? ' âš ï¸' : ''}</td>
					<td>${movement.quantityPacks || 0} ×—×‘'${movement.quantityUnits > 0 ? ' + ' + movement.quantityUnits + ' ×™×—×™×“×•×ª' : ''}</td>
					<td>${movement.user || ''}</td>
					<td>${movement.notes || ''}</td>
					<td>
						${canEdit && !isCancellation ?
						  `<button class="btn-small btn-edit" onclick="editMovement('${movement.id || ''}')">×¢×¨×•×š</button>
						   <button class="btn-small btn-danger" onclick="deleteMovement('${movement.id || ''}')">××—×§</button>`
						  : ''}
					</td>
				`;
			});
		}

        // --- ×ª×¦×•×’×ª ××©×ª××©×™× ---
        function displayUsers() {
            const userList = document.getElementById('userList');
            if (!userList) return;
            
            userList.innerHTML = '';
            
            users.forEach(user => {
                const canDelete = user.username !== 'admin';
                const userCard = document.createElement('div');
                userCard.className = 'user-card';
                userCard.innerHTML = `
                    <div class="user-details">
                        <strong>${user.fullName}</strong>
                        <div style="font-size:14px;color:#666;">
                            ×©× ××©×ª××©: ${user.username} | ×ª×¤×§×™×“: ${user.role}
                        </div>
                        <div style="font-size:14px;color:#666;margin-top:5px;">
                            ×”×¨×©××•×ª: ${(user.permissions || []).map(p => getPermissionName(p)).join(', ')}
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn-small btn-edit" onclick="editUser('${user.username}')">×¢×¨×•×š</button>
                        ${canDelete ? `<button class="btn-small btn-danger" onclick="deleteUser('${user.username}')">××—×§</button>` : ''}
                    </div>
                `;
                userList.appendChild(userCard);
            });
        }

        function getPermissionName(permission) {
            const names = {
                'view_inventory': '×¦×¤×™×™×” ×‘××œ××™',
                'view_movements': '×¦×¤×™×™×” ×‘×ª× ×•×¢×•×ª',
                'add_transaction': '×¨×™×©×•× ×ª× ×•×¢×•×ª',
                'add_item': '×”×•×¡×¤×ª ×¤×¨×™×˜×™×',
                'manage_users': '× ×™×”×•×œ ××©×ª××©×™×',
                'view_reports': '×¦×¤×™×™×” ×‘×“×•×—×•×ª',
                'view_pickings': '×¦×¤×™×™×” ×‘×œ×™×§×•×˜×™×'
            };
            return names[permission] || permission;
        }

        // --- ×ª×¦×•×’×ª ×œ×™×§×•×˜×™× ---
        async function displayPickings() {
            const container = document.getElementById('pickingsTableContainer');
            if (!container) return;
            
            container.innerHTML = "×˜×•×¢×Ÿ...";
            
            try {
                const pickingsSnap = await db.collection('pickingLists').orderBy('date', 'desc').get();
                const pickings = [];
                pickingsSnap.forEach(doc => {
                    const data = doc.data();
                    data.id = doc.id;
                    pickings.push(data);
                });
                
                if (pickings.length === 0) {
                    container.innerHTML = "<div>×œ× ×§×™×™××•×ª ×¨×©×™××•×ª ×œ×™×§×•×˜</div>";
                    return;
                }
                
                let html = `
                <table style="width:100%;text-align:right;">
                    <tr>
                        <th>×ª××¨×™×š</th>
                        <th>×©×¢×”</th>
                        <th>××™ ×™×¦×¨</th>
                        <th>××œ×§×˜</th>
                        <th>×¡×˜×˜×•×¡</th>
                        <th>×¤×¨×™×˜×™×</th>
                        <th>×ª×•×¦××”</th>
                        <th>×©×™×ª×•×£</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                `;
                
                pickings.forEach(p => {
                    const link = `${window.location.origin}/pick.html?id=${p.id}`;
                    html += `
                    <tr>
                        <td>${p.date || ''}</td>
                        <td>${p.time || ''}</td>
                        <td>${p.createdBy || ''}</td>
                        <td>${p.pickedBy || ''}</td>
                        <td>${p.status || '×¤×ª×•×—'}</td>
                        <td>
                            <ul style="padding-right: 18px;">
                                ${(p.plan || []).map(item =>
                                    `<li>${item.productName} â€” ${item.takePacks} ×—×‘'${item.takeUnits ? ' + ' + item.takeUnits + ' ×™×—×™×“×•×ª' : ''} â€” ${item.location}</li>`
                                ).join('')}
                            </ul>
                        </td>
                        <td>
                            ${(p.results && p.results.length) ? p.results.map((r, i) =>
                                `<div>×©×•×¨×” ${i+1}: ${r.status}</div>`
                            ).join('') : ''}
                        </td>
                        <td>
                            <button onclick="copyToClipboard('${link}')">×”×¢×ª×§ ×§×™×©×•×¨</button>
                            <br>
                            <a href="${link}" target="_blank" style="font-size:12px;">×¤×ª×— ×¨×©×™××”</a>
                        </td>
                        <td>
                            <button onclick="openEditPicking('${p.id}')">×¢×¨×•×š</button>
                            <button onclick="deletePicking('${p.id}')">××—×§</button>
                        </td>
                    </tr>
                    `;
                });
                
                html += `</table>`;
                container.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading pickings:', error);
                container.innerHTML = "<div>×©×’×™××” ×‘×˜×¢×™× ×ª ×”×œ×™×§×•×˜×™×</div>";
            }
        }

        // --- ×¤×•× ×§×¦×™×•×ª ×¢×‘×•×“×” ×¢× ×™×—×™×“×•×ª ---
        function populateUnitsSelect(selectElement, list, selectedValue = "") {
            if (!selectElement) return;
            
            selectElement.innerHTML = "";
            const defaultOpt = document.createElement("option");
            defaultOpt.value = "";
            defaultOpt.textContent = "×‘×—×¨ ×™×—×™×“×”";
            defaultOpt.disabled = true;
            defaultOpt.selected = !selectedValue;
            selectElement.appendChild(defaultOpt);

            list.forEach(unit => {
                const option = document.createElement("option");
                option.value = unit;
                option.textContent = unit;
                option.selected = (selectedValue === unit);
                selectElement.appendChild(option);
            });
            
            const addNew = document.createElement("option");
            addNew.value = "__add_new__";
            addNew.textContent = "â• ×”×•×¡×£ ×™×—×™×“×” ×—×“×©×”...";
            selectElement.appendChild(addNew);
        }

        // --- ×¤×•× ×§×¦×™×•×ª ××™×•×Ÿ ×•×—×™×¤×•×© ---
        function sortInventory(by) {
            if (inventorySort.by === by) {
                inventorySort.dir *= -1;
            } else {
                inventorySort.by = by;
                inventorySort.dir = 1;
            }
            displayInventory();
        }

        // ×”××–× ×” ×œ×©×“×•×ª ×”×—×™×¤×•×© ×•×”×¡×™× ×•×Ÿ
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('inventorySearch');
            const categorySelect = document.getElementById('categoryFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    inventorySearch = this.value.trim();
                    displayInventory();
                });
            }
            
            if (categorySelect) {
                categorySelect.addEventListener('change', function() {
                    categoryFilter = this.value;
                    displayInventory();
                });
            }
        });

        // --- ×”×•×¡×¤×ª ×©×•×¨×ª ×ª× ×•×¢×” ---
        function addTransactionRow() {
			const container = document.getElementById('multiTransactionRows');
			if (!container) return;

			const row = document.createElement('div');
			row.className = 'form-row';
			
			if (isMobile) {
				row.style.cssText = 'position: relative; padding-top: 15px;';
				row.innerHTML = `
					<button type="button" onclick="this.closest('.form-row').remove()" class="btn-small btn-danger" style="position: absolute; top: -5px; left: 10px; width: auto; padding: 5px 10px; font-size: 0.9rem; z-index: 10;">âœ•</button>
					<div class="form-group">
						<label>××•×¦×¨</label>
						<select class="transProductSelect" required>
							<option value="">×‘×—×¨ ××•×¦×¨</option>
							${inventory.map(item => 
								`<option value="${item.name}">${item.name} (${item.category})</option>`
							).join('')}
						</select>
					</div>
					<div class="form-group">
						<label>×¡×•×’ ×¤×¢×•×œ×”</label>
						<select class="transTypeSelect" required>
							<option value="">×‘×—×¨ ×¤×¢×•×œ×”</option>
							<option value="×”×•×¦××”">×”×•×¦××” ××”××œ××™</option>
							<option value="×”×›× ×¡×”">×”×›× ×¡×” ×œ××œ××™</option>
						</select>
					</div>
					<div class="form-group">
						<label>×›××•×ª ×—×‘×™×œ×•×ª</label>
						<input type="number" class="transQuantityPacksInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>×›××•×ª ×™×—×™×“×•×ª</label>
						<input type="number" class="transQuantityUnitsInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>×”×¢×¨×•×ª</label>
						<input type="text" class="transNotesInput" placeholder="×”×¢×¨×•×ª">
					</div>
				`;
			} else {
				// ×“×¡×§×˜×•×¤ - ×›×¤×ª×•×¨ ×”×”×¡×¨×” ×œ×œ× label
				row.innerHTML = `
					<div class="form-group">
						<label>××•×¦×¨</label>
						<select class="transProductSelect" required>
							<option value="">×‘×—×¨ ××•×¦×¨</option>
							${inventory.map(item => 
								`<option value="${item.name}">${item.name} (${item.category})</option>`
							).join('')}
						</select>
					</div>
					<div class="form-group">
						<label>×¡×•×’ ×¤×¢×•×œ×”</label>
						<select class="transTypeSelect" required>
							<option value="">×‘×—×¨ ×¤×¢×•×œ×”</option>
							<option value="×”×•×¦××”">×”×•×¦××” ××”××œ××™</option>
							<option value="×”×›× ×¡×”">×”×›× ×¡×” ×œ××œ××™</option>
						</select>
					</div>
					<div class="form-group">
						<label>×›××•×ª ×—×‘×™×œ×•×ª</label>
						<input type="number" class="transQuantityPacksInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>×›××•×ª ×™×—×™×“×•×ª</label>
						<input type="number" class="transQuantityUnitsInput" min="0" value="0" required>
					</div>
					<div class="form-group">
						<label>×”×¢×¨×•×ª</label>
						<input type="text" class="transNotesInput" placeholder="×”×¢×¨×•×ª">
					</div>
					<div class="form-group">
						<label style="visibility: hidden;">×¤×¢×•×œ×”</label>
						<button type="button" onclick="this.closest('.form-row').remove()" class="btn-small btn-danger">âŒ ×”×¡×¨</button>
					</div>
				`;
			}
			
			container.appendChild(row);
		}

        // --- ×”×•×¡×¤×ª ×•×¨×™×× ×˜ ---
        function addVariant() {
            const container = document.getElementById('variantsContainer');
            if (!container) return;
            
            const variantDiv = document.createElement('div');
            variantDiv.className = 'form-row';
            variantDiv.innerHTML = `
				${isMobile ? '<div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">' : ''}
				<div class="form-group">
					<label>×›××•×ª ×—×‘×™×œ×•×ª</label>
					<input type="number" class="variant-quantityPacks" min="0" value="0" required>
				</div>
				<div class="form-group">
					<label>×›××•×ª ×™×—×™×“×•×ª ×‘×•×“×“×•×ª</label>
					<input type="number" class="variant-quantityUnits" min="0" value="0" required>
				</div>
				<div class="form-group">
					<label>××™×§×•×</label>
					<select class="variant-location" required>
						<option value="">×‘×—×¨ ××—×¡×Ÿ</option>
						<option value="××—×¡×Ÿ ×©×ª×™×”">××—×¡×Ÿ ×©×ª×™×”</option>
						<option value="××—×¡×Ÿ ××•×œ× 1">××—×¡×Ÿ ××•×œ× 1</option>
						<option value="××˜×‘×— VIP">××˜×‘×— VIP</option>
						<option value="××—×¡×Ÿ ××™×›×œ×™×">××—×¡×Ÿ ××™×›×œ×™×</option>
						<option value="×˜×›× ×™">×˜×›× ×™</option>
						<option value="××—×¡×Ÿ ×’×œ×™×“×•×ª">××—×¡×Ÿ ×’×œ×™×“×•×ª</option>
						<option value="×××“ ×× ×§×™×">×××“ ×× ×§×™×</option>
					</select>
				</div>
				<div class="form-group">
					<label>×ª××¨×™×š ×ª×¤×•×’×”</label>
					<input type="date" class="variant-expiry">
				</div>
				<div class="form-group">
					<button type="button" onclick="this.closest('.form-row').remove()" class="btn-small btn-danger" style="width: 100%;">×”×¡×¨ ×¤×¨×™×˜</button>
				</div>
				${isMobile ? '</div>' : ''}
			`;
            container.appendChild(variantDiv);
        }

        // --- ×œ×™×§×•×˜ ---
        async function startPickingList() {
			const rows = document.querySelectorAll('#multiTransactionRows .form-row');
			const pickingPlan = [];
			const pickingMap = new Map(); // ×œ×× ×™×¢×ª ×›×¤×™×œ×•×™×•×ª

			for (const row of rows) {
				const productSelect = row.querySelector('.transProductSelect');
				const quantityUnitsInput = row.querySelector('.transQuantityUnitsInput');
				const quantityPacksInput = row.querySelector('.transQuantityPacksInput');

				if (!productSelect.value) continue;

				const productName = productSelect.value;
				let requiredUnits = parseInt(quantityUnitsInput.value) || 0;
				let requiredPacks = parseInt(quantityPacksInput.value) || 0;

				if (requiredPacks === 0 && requiredUnits === 0) continue;

				const item = inventory.find(x => x.name === productName);
				if (!item) continue;

				// ××™×™×Ÿ ×•×¨×™×× ×˜×™× ×œ×¤×™ ×ª×•×§×£ (FEFO)
				const sortedVariants = (item.variants || [])
					.map((v, idx) => ({...v, originalIndex: idx}))
					.filter(v => (v.quantityPacks || 0) > 0 || (v.quantityUnits || 0) > 0)
					.sort((a, b) => {
						if (!a.expiry && !b.expiry) return 0;
						if (!a.expiry) return 1;
						if (!b.expiry) return -1;
						return new Date(a.expiry) - new Date(b.expiry);
					});

				// ×ª×›× ×•×Ÿ ×œ×™×§×•×˜ ××©×•×œ×‘
				for (const variant of sortedVariants) {
					if (requiredPacks <= 0 && requiredUnits <= 0) break;
					
					let takePacks = 0;
					let takeUnits = 0;
					
					// ×§×— ×—×‘×™×œ×•×ª
					if (requiredPacks > 0 && (variant.quantityPacks || 0) > 0) {
						takePacks = Math.min(requiredPacks, variant.quantityPacks);
						requiredPacks -= takePacks;
					}
					
					// ×§×— ×™×—×™×“×•×ª
					if (requiredUnits > 0 && (variant.quantityUnits || 0) > 0) {
						takeUnits = Math.min(requiredUnits, variant.quantityUnits);
						requiredUnits -= takeUnits;
					}
					
					// ×× ×¦×¨×™×š ×™×—×™×“×•×ª ×•×™×© ×¨×§ ×—×‘×™×œ×•×ª, ×¤×¨×•×˜ ×—×‘×™×œ×”
					if (requiredUnits > 0 && takePacks < variant.quantityPacks && item.unitsPerPack > 0) {
						const availablePacksForBreaking = variant.quantityPacks - takePacks;
						const packsToBreak = Math.min(
							Math.ceil(requiredUnits / item.unitsPerPack),
							availablePacksForBreaking
						);
						
						if (packsToBreak > 0) {
							takePacks += packsToBreak;
							const unitsFromPacks = packsToBreak * item.unitsPerPack;
							const actualUnitsNeeded = Math.min(requiredUnits, unitsFromPacks);
							takeUnits += actualUnitsNeeded;
							requiredUnits -= actualUnitsNeeded;
							
							// ×™×—×™×“×•×ª ×©×™×•×—×–×¨×• ×œ××œ××™
							const returnUnits = unitsFromPacks - actualUnitsNeeded;
							if (returnUnits > 0) {
								takeUnits -= returnUnits; // ×”×ª×× ××ª ×”×¨×™×©×•×
							}
						}
					}
					
					if (takePacks > 0 || takeUnits > 0) {
						// ×¦×•×¨ ××¤×ª×— ×™×™×—×•×“×™ ×œ×•×•×¨×™×× ×˜
						const key = `${productName}|${variant.location}|${variant.expiry || 'no-expiry'}`;
						
						if (pickingMap.has(key)) {
							// ×¢×“×›×Ÿ ×¨×©×•××” ×§×™×™××ª
							const existing = pickingMap.get(key);
							existing.takePacks += takePacks;
							existing.takeUnits += takeUnits;
						} else {
							// ×¦×•×¨ ×¨×©×•××” ×—×“×©×”
							pickingMap.set(key, {
								productName,
								takePacks,
								takeUnits,
								location: variant.location,
								expiry: variant.expiry
							});
						}
					}
				}

				// ×˜×¤×œ ×‘×—×•×¡×¨×™×
				if (requiredPacks > 0 || requiredUnits > 0) {
					const key = `${productName}|×—×¡×¨ ×‘××œ××™|missing`;
					if (pickingMap.has(key)) {
						const existing = pickingMap.get(key);
						existing.takePacks += requiredPacks;
						existing.takeUnits += requiredUnits;
					} else {
						pickingMap.set(key, {
							productName,
							takePacks: requiredPacks,
							takeUnits: requiredUnits,
							location: "×—×¡×¨ ×‘××œ××™",
							expiry: ""
						});
					}
				}
			}

			// ×”××¨ ××ª ×”××¤×” ×œ×¨×©×™××”
			pickingMap.forEach(item => pickingPlan.push(item));

			if (pickingPlan.length === 0) {
				showToast('×œ× × ×‘×—×¨×• ××•×¦×¨×™× ×œ×œ×™×§×•×˜', 'error');
				return;
			}

			try {
				const pickId = await createPickingList(pickingPlan);
				const link = `${window.location.origin}/pick.html?id=${pickId}`;
				
				// ×”×•×“×¢×” ××¤×•×¨×˜×ª ×¢×œ ××” ×©× ×•×¦×¨
				let summaryText = `× ×•×¦×¨×” ×¨×©×™××ª ×œ×™×§×•×˜ ×¢× ${pickingPlan.length} ×¤×¨×™×˜×™×:\n`;
				pickingPlan.forEach(item => {
					summaryText += `â€¢ ${item.productName} - `;
					if (item.takePacks > 0) summaryText += `${item.takePacks} ×—×‘'`;
					if (item.takePacks > 0 && item.takeUnits > 0) summaryText += ' + ';
					if (item.takeUnits > 0) summaryText += `${item.takeUnits} ×™×—×™×“×•×ª`;
					summaryText += ` ×${item.location}\n`;
				});
				
				const shareHtml = `
					<div style="background:#e8f5e8; padding:15px; border-radius:8px; margin:15px 0;">
						<strong>âœ… ×¨×©×™××ª ×œ×™×§×•×˜ × ×•×¦×¨×” ×‘×”×¦×œ×—×”!</strong><br>
						<small>××–×”×”: ${pickId}</small>
					</div>
					<div style="margin:18px 0; display:flex; flex-wrap:wrap; gap:10px; justify-content:center;">
						<button class="btn-main" onclick="shareWhatsapp('${link}', '${encodeURIComponent(summaryText)}')">ğŸ“± ×©×œ×— ×‘Ö¾WhatsApp</button>
						<button class="btn-main" onclick="shareTelegram('${link}')">âœˆï¸ ×©×œ×— ×‘Ö¾Telegram</button>
						<button class="btn-main" onclick="shareEmail('${link}')">ğŸ“§ ×©×œ×— ×‘××™××™×™×œ</button>
						<button class="btn-main" onclick="copyToClipboard('${link}')">ğŸ“‹ ×”×¢×ª×§ ×§×™×©×•×¨</button>
					</div>
					<div style="background:#f0f8ff; padding:10px; border-radius:6px; font-size:14px;">
						<strong>×¡×™×›×•× ×”×œ×™×§×•×˜:</strong><br>
						${pickingPlan.map(item => {
							let text = `â€¢ ${item.productName} - `;
							if (item.takePacks > 0) text += `${item.takePacks} ×—×‘'`;
							if (item.takePacks > 0 && item.takeUnits > 0) text += ' + ';
							if (item.takeUnits > 0) text += `${item.takeUnits} ×™×—'`;
							text += ` ×${item.location}`;
							if (item.location === "×—×¡×¨ ×‘××œ××™") text = `<span style="color:#e74c3c;">${text}</span>`;
							return text;
						}).join('<br>')}
					</div>
					<div id="shareResultMsg" style="margin-top:10px; text-align:center;"></div>
				`;
				document.getElementById('pickingListContainer').innerHTML = shareHtml;
				
				// ××™×¤×•×¡ ×”×˜×•×¤×¡
				document.getElementById('multiTransactionRows').innerHTML = '';
				addTransactionRow();
				
				showToast('×¨×©×™××ª ×œ×™×§×•×˜ × ×•×¦×¨×” ×•××•×›× ×” ×œ×©×™×ª×•×£!', 'success');
			} catch (error) {
				showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×¨×©×™××ª ×œ×™×§×•×˜', 'error');
			}
		}

        // --- ×¤×•× ×§×¦×™×•×ª ×©×™×ª×•×£ ---
        function shareWhatsapp(link, summaryText = '') {
            let text = '×¨×©×™××ª ×œ×™×§×•×˜ ××¡×™× ××” ×¡×™×˜×™ ×—×“×¨×” ğŸ¬ğŸ¿\n\n';
            if (summaryText) {
                text += decodeURIComponent(summaryText) + '\n';
            }
            text += '\n×§×™×©×•×¨ ×œ×œ×™×§×•×˜: ' + link;
            text += '\n\nğŸ‘† ×œ×—×¥ ×¢×œ ×”×§×™×©×•×¨ ×œ×¤×ª×™×—×ª ×¨×©×™××ª ×”×œ×™×§×•×˜';
            
            const encodedText = encodeURIComponent(text);
            window.open(`https://wa.me/?text=${encodedText}`, '_blank');
        }

        function shareTelegram(link) {
            const text = encodeURIComponent('×¨×©×™××ª ×œ×™×§×•×˜ ××¡×™× ××” ×¡×™×˜×™ ×—×“×¨×” ğŸ¬\n×§×™×©×•×¨: ' + link);
            window.open(`https://t.me/share/url?url=${text}`, '_blank');
        }

        function shareEmail(link) {
            const subject = encodeURIComponent('×¨×©×™××ª ×œ×™×§×•×˜ - ×¡×™× ××” ×¡×™×˜×™ ×—×“×¨×”');
            const body = encodeURIComponent('×©×œ×•×,\n\n× ×•×¦×¨×” ×¨×©×™××ª ×œ×™×§×•×˜ ×—×“×©×”:\n\n' + link + '\n\n×‘×‘×¨×›×”,\n××¢×¨×›×ª × ×™×”×•×œ ×”××œ××™');
            window.open(`mailto:?subject=${subject}&body=${body}`, '_blank');
        }

        function copyToClipboard(link) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(link).then(() => {
                    const msg = document.getElementById('shareResultMsg');
                    if (msg) msg.textContent = '×”×§×™×©×•×¨ ×”×•×¢×ª×§!';
                    showToast('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—', 'success');
                }, () => {
                    fallbackCopyToClipboard(link);
                });
            } else {
                fallbackCopyToClipboard(link);
            }
        }
		// ×¤×•× ×§×¦×™×” ×œ× ×¨××•×œ ×©× ××•×¦×¨
		function normalizeProductName(name) {
			return name
				.trim() // ×”×¡×¨ ×¨×•×•×—×™× ××”×”×ª×—×œ×” ×•×”×¡×•×£
				.replace(/\s+/g, ' ') // ×”×—×œ×£ ×¨×•×•×—×™× ××¨×•×‘×™× ×‘×¨×•×•×— ×‘×•×“×“
				.toLowerCase(); // ×”××¨ ×œ××•×ª×™×•×ª ×§×˜× ×•×ª ×œ×¦×•×¨×š ×”×©×•×•××”
		}

		// ×¤×•× ×§×¦×™×” ×œ××¦×™××ª ××•×¦×¨×™× ×“×•××™×
		function findSimilarProducts(name, threshold = 0.8) {
			const normalized = normalizeProductName(name);
			const similar = [];
			
			inventory.forEach(item => {
				const itemNormalized = normalizeProductName(item.name);
				
				// ×‘×“×™×§×ª ×–×”×•×ª ××œ××”
				if (itemNormalized === normalized) {
					similar.push({ name: item.name, similarity: 1.0 });
					return;
				}
				
				// ×‘×“×™×§×ª ×“××™×•×Ÿ (××œ×’×•×¨×™×ª× ×¤×©×•×˜)
				const similarity = calculateSimilarity(normalized, itemNormalized);
				if (similarity >= threshold) {
					similar.push({ name: item.name, similarity });
				}
			});
			
			return similar.sort((a, b) => b.similarity - a.similarity);
		}

		// ××œ×’×•×¨×™×ª× ×¤×©×•×˜ ×œ×—×™×©×•×‘ ×“××™×•×Ÿ ×‘×™×Ÿ ××—×¨×•×–×•×ª
		function calculateSimilarity(str1, str2) {
			const longer = str1.length > str2.length ? str1 : str2;
			const shorter = str1.length > str2.length ? str2 : str1;
			
			if (longer.length === 0) return 1.0;
			
			// ×‘×“×•×§ ×× ××—×ª ×”××™×œ×™× ××›×™×œ×” ××ª ×”×©× ×™×™×”
			if (longer.includes(shorter) || shorter.includes(longer)) {
				return shorter.length / longer.length;
			}
			
			// ×—×™×©×•×‘ ×“××™×•×Ÿ ×‘×¡×™×¡×™
			const editDistance = getEditDistance(str1, str2);
			return (longer.length - editDistance) / longer.length;
		}

		// ××¨×—×§ ×¢×¨×™×›×” (Levenshtein distance)
		function getEditDistance(str1, str2) {
			const m = str1.length;
			const n = str2.length;
			const dp = Array(m + 1).fill().map(() => Array(n + 1).fill(0));
			
			for (let i = 0; i <= m; i++) dp[i][0] = i;
			for (let j = 0; j <= n; j++) dp[0][j] = j;
			
			for (let i = 1; i <= m; i++) {
				for (let j = 1; j <= n; j++) {
					if (str1[i - 1] === str2[j - 1]) {
						dp[i][j] = dp[i - 1][j - 1];
					} else {
						dp[i][j] = Math.min(
							dp[i - 1][j] + 1,    // deletion
							dp[i][j - 1] + 1,    // insertion
							dp[i - 1][j - 1] + 1 // substitution
						);
					}
				}
			}
			
			return dp[m][n];
		}

        function fallbackCopyToClipboard(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                showToast('×”×§×™×©×•×¨ ×”×•×¢×ª×§ ×œ×œ×•×—', 'success');
            } catch (err) {
                showToast('×©×’×™××” ×‘×”×¢×ª×§×ª ×”×§×™×©×•×¨', 'error');
            }
            document.body.removeChild(textArea);
        }
		
		// ×¤×•× ×§×¦×™×” ×¢×–×¨ ×œ×¤×•×¨××˜ ×ª××¨×™×š ××—×™×“
		function getFormattedDate() {
			const now = new Date();
			const day = String(now.getDate()).padStart(2, '0');
			const month = String(now.getMonth() + 1).padStart(2, '0');
			const year = now.getFullYear();
			return `${day}/${month}/${year}`;
		}

		function getFormattedTime() {
			const now = new Date();
			return now.toLocaleTimeString('he-IL', { hour: '2-digit', minute: '2-digit' });
		}
		window.editProduct = function(productName) {
            const item = inventory.find(i => i.name === productName);
            if (!item) {
                showToast('×”××•×¦×¨ ×œ× × ××¦×', 'error');
                return;
            }
            
            document.getElementById('editItemOriginalName').value = item.name;
            document.getElementById('editItemName').value = item.name;
            document.getElementById('editItemCategory').value = item.category;
            document.getElementById('editBaseUnitSingular').value = item.baseUnitSingular;
            document.getElementById('editBaseUnitPlural').value = item.baseUnitPlural;
            document.getElementById('editPackUnitSingular').value = item.packUnitSingular;
            document.getElementById('editPackUnitPlural').value = item.packUnitPlural;
            document.getElementById('editUnitsPerPack').value = item.unitsPerPack || 1;
            document.getElementById('editMinPacks').value = item.minPacks || 0;
            
            document.getElementById('editModal').style.display = 'block';
        };

        window.deleteProduct = async function(productName) {
            if (!confirm(`×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”××•×¦×¨ "${productName}"?\n×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª ×›×œ ×”×•×•×¨×™×× ×˜×™× ×©×œ ×”××•×¦×¨ ×•×œ× × ×™×ª×Ÿ ×œ×‘×˜×œ×”.`)) {
                return;
            }
            
            try {
                showLoading(true);
                
                // ××—×§ ×-Firebase
                await deleteInventoryItem(productName);
                
                // ××—×§ ××”××¢×¨×š ×”××§×•××™
                inventory = inventory.filter(i => i.name !== productName);
                
                // ×¢×“×›×Ÿ ×ª×¦×•×’×”
                updateStats();
                displayInventory();
                
                showToast(`×”××•×¦×¨ "${productName}" × ××—×§ ×‘×”×¦×œ×—×”`, 'success');
            } catch (error) {
                console.error('Error deleting product:', error);
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”××•×¦×¨: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        };

		window.deleteVariantByIdentifier = async function(productName, location, expiry) {
			if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×•×•×¨×™×× ×˜?')) return;
			
			try {
				const item = inventory.find(i => i.name === productName);
				if (item && item.variants) {
					// ××¦× ××ª ×”××™× ×“×§×¡ ×”× ×›×•×Ÿ ×©×œ ×”×•×•×¨×™×× ×˜
					const variantIndex = item.variants.findIndex(v => 
						v.location === location && 
						(v.expiry || '') === expiry
					);
					
					if (variantIndex === -1) {
						showToast('×”×•×•×¨×™×× ×˜ ×œ× × ××¦×', 'error');
						return;
					}
					
					item.variants.splice(variantIndex, 1);
					await saveInventoryItem(item);
					await loadAllData();
					updateStats();
					displayInventory();
					showToast('×”×•×•×¨×™×× ×˜ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
				}
			} catch (error) {
				showToast('×©×’×™××” ×‘××—×™×§×ª ×”×•×•×¨×™×× ×˜', 'error');
			}
		};
		
		// ×¤×•× ×§×¦×™×” ×¢×–×¨ ×—×“×©×” ×œ×¤×¨×¡×•×¨ ×ª××¨×™×š ×¢×‘×¨×™
		function parseHebrewDate(dateStr) {
			if (!dateStr) return null;
			
			try {
				// × ×¡×” ×›××” ×¤×•×¨××˜×™× × ×¤×•×¦×™×
				let parts;
				let day, month, year;
				
				if (dateStr.includes('/')) {
					// ×¤×•×¨××˜: DD/MM/YYYY ××• D/M/YYYY
					parts = dateStr.split('/');
					if (parts.length === 3) {
						day = parseInt(parts[0], 10);
						month = parseInt(parts[1], 10);
						year = parseInt(parts[2], 10);
						
						// ×ª×™×§×•×Ÿ ×©× ×” ×“×•-×¡×¤×¨×ª×™×ª
						if (year < 100) {
							year += 2000;
						}
					}
				} else if (dateStr.includes('.')) {
					// ×¤×•×¨××˜: DD.MM.YYYY
					parts = dateStr.split('.');
					if (parts.length === 3) {
						day = parseInt(parts[0], 10);
						month = parseInt(parts[1], 10);
						year = parseInt(parts[2], 10);
						
						if (year < 100) {
							year += 2000;
						}
					}
				} else if (dateStr.includes('-')) {
					// ×¤×•×¨××˜ ISO: YYYY-MM-DD
					const date = new Date(dateStr);
					if (!isNaN(date.getTime())) {
						return date;
					}
				}
				
				// ×‘×“×•×§ ×ª×§×™× ×•×ª
				if (day && month && year && day >= 1 && day <= 31 && month >= 1 && month <= 12 && year >= 2020) {
					// ×—×©×•×‘: ×—×•×“×©×™× ×‘-JavaScript ××ª×—×™×œ×™× ×-0
					return new Date(year, month - 1, day);
				}
				
				return null;
			} catch (error) {
				console.error('Error parsing date:', dateStr, error);
				return null;
			}
		}

		// ×”×—×œ×£ ××ª ×”×—×œ×§ ×”×¨×œ×•×•× ×˜×™ ×‘×¤×•× ×§×¦×™×” generateReport:
		

		window.editVariantByIdentifier = function(productName, location, expiry, rowIndex) {
			const item = inventory.find(i => i.name === productName);
			if (!item || !item.variants) return;
			
			// ×¡×¤×•×¨ ×›××” ×•×¨×™×× ×˜×™× ×ª×•×××™× ×™×© ×œ×¤× ×™ ×”× ×•×›×—×™
			let matchCount = 0;
			let targetIndex = -1;
			
			for (let i = 0; i < item.variants.length; i++) {
				const v = item.variants[i];
				if (v.location === location && (v.expiry || '') === expiry) {
					if (matchCount === rowIndex) {
						targetIndex = i;
						break;
					}
					matchCount++;
				}
			}
			
			if (targetIndex === -1) {
				showToast('×”×•×•×¨×™×× ×˜ ×œ× × ××¦×', 'error');
				return;
			}
			
			const variant = item.variants[targetIndex];
			
			document.getElementById('editVariantProductName').value = productName;
			document.getElementById('editVariantIndex').value = targetIndex;
			document.getElementById('editVariantQuantityPacks').value = variant.quantityPacks || 0;
			document.getElementById('editVariantQuantityUnits').value = variant.quantityUnits || 0;
			document.getElementById('editVariantLocation').value = variant.location || '';
			document.getElementById('editVariantExpiry').value = variant.expiry || '';
			document.getElementById('editVariantModal').style.display = 'block';
		};

		window.deleteVariantByIdentifier = async function(productName, location, expiry, rowIndex) {
			if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×•×•×¨×™×× ×˜?')) return;
			
			try {
				const item = inventory.find(i => i.name === productName);
				if (item && item.variants) {
					// ×¡×¤×•×¨ ×›××” ×•×¨×™×× ×˜×™× ×ª×•×××™× ×™×© ×œ×¤× ×™ ×”× ×•×›×—×™
					let matchCount = 0;
					let targetIndex = -1;
					
					for (let i = 0; i < item.variants.length; i++) {
						const v = item.variants[i];
						if (v.location === location && (v.expiry || '') === expiry) {
							if (matchCount === rowIndex) {
								targetIndex = i;
								break;
							}
							matchCount++;
						}
					}
					
					if (targetIndex === -1) {
						showToast('×”×•×•×¨×™×× ×˜ ×œ× × ××¦×', 'error');
						return;
					}
					
					item.variants.splice(targetIndex, 1);
					await saveInventoryItem(item);
					await loadAllData();
					updateStats();
					displayInventory();
					showToast('×”×•×•×¨×™×× ×˜ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
				}
			} catch (error) {
				showToast('×©×’×™××” ×‘××—×™×§×ª ×”×•×•×¨×™×× ×˜', 'error');
			}
		};

        window.deleteVariant = async function(productName, variantIndex) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×•×•×¨×™×× ×˜?')) return;
            
            try {
                const item = inventory.find(i => i.name === productName);
                if (item && item.variants) {
                    item.variants.splice(variantIndex, 1);
                    await saveInventoryItem(item);
                    await loadAllData();
                    updateStats();
                    displayInventory();
                    showToast('×”×•×•×¨×™×× ×˜ × ××—×§ ×‘×”×¦×œ×—×”', 'success');
                }
            } catch (error) {
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”×•×•×¨×™×× ×˜', 'error');
            }
        };

        window.editVariant = function(productName, variantIndex) {
            const item = inventory.find(i => i.name === productName);
            if (!item || !item.variants || !item.variants[variantIndex]) return;
            
            const variant = item.variants[variantIndex];
            
            document.getElementById('editVariantProductName').value = productName;
            document.getElementById('editVariantIndex').value = variantIndex;
            document.getElementById('editVariantQuantityPacks').value = variant.quantityPacks || 0;
            document.getElementById('editVariantQuantityUnits').value = variant.quantityUnits || 0;
            document.getElementById('editVariantLocation').value = variant.location || '';
            document.getElementById('editVariantExpiry').value = variant.expiry || '';
            document.getElementById('editVariantModal').style.display = 'block';
        };

        window.openAddVariantModal = function(productName) {
            document.getElementById('addVariantProductName').value = productName;
            document.getElementById('addVariantQuantityPacks').value = 0;
            document.getElementById('addVariantQuantityUnits').value = 0;
            document.getElementById('addVariantLocation').value = '';
            document.getElementById('addVariantExpiry').value = '';
            document.getElementById('addVariantModal').style.display = 'block';
        };

        window.closeAddVariantModal = function() {
            document.getElementById('addVariantModal').style.display = 'none';
            document.getElementById('addVariantForm').reset();
        };

        window.closeEditVariantModal = function() {
            document.getElementById('editVariantModal').style.display = 'none';
            document.getElementById('editVariantForm').reset();
        };

        window.closeEditModal = function() {
            document.getElementById('editModal').style.display = 'none';
            document.getElementById('editItemForm').reset();
        };

        // --- ×¢×¨×™×›×ª ×ª× ×•×¢×•×ª ---
        window.editMovement = function(id) {
			const movement = movements.find(m => m.id === id);
			if (!movement) return;
			
			// ××œ ×ª××¤×©×¨ ×¢×¨×™×›×ª ×ª× ×•×¢×•×ª ×‘×™×˜×•×œ
			if (movement.type && movement.type.includes('×‘×™×˜×•×œ')) {
				showToast('×œ× × ×™×ª×Ÿ ×œ×¢×¨×•×š ×ª× ×•×¢×•×ª ×‘×™×˜×•×œ', 'error');
				return;
			}
			
			document.getElementById('editMovementId').value = movement.id;
			document.getElementById('editMovementProduct').value = movement.product;
			document.getElementById('editMovementType').value = movement.type;
			document.getElementById('editMovementLocation').value = movement.location || '';
			document.getElementById('editMovementExpiry').value = movement.expiry || '';
			document.getElementById('editMovementQuantityPacks').value = movement.quantityPacks || 0;
			document.getElementById('editMovementQuantityUnits').value = movement.quantityUnits || 0;
			document.getElementById('editMovementNotes').value = movement.notes || '';
			
			// ×©××•×¨ ××ª ×”×¢×¨×›×™× ×”××§×•×¨×™×™×
			document.getElementById('editMovementOriginalQuantityPacks').value = movement.quantityPacks || 0;
			document.getElementById('editMovementOriginalQuantityUnits').value = movement.quantityUnits || 0;
			document.getElementById('editMovementOriginalType').value = movement.type;
			
			document.getElementById('editMovementModal').style.display = 'block';
		};

		// ×¢×“×›×Ÿ ××ª ×”-event listener ×©×œ editMovementForm
		document.getElementById('editMovementForm').addEventListener('submit', async function(e) {
			e.preventDefault();
			
			try {
				const id = document.getElementById('editMovementId').value;
				const productName = document.getElementById('editMovementProduct').value;
				const newType = document.getElementById('editMovementType').value;
				const newLocation = document.getElementById('editMovementLocation').value;
				const newExpiry = document.getElementById('editMovementExpiry').value;
				const newQuantityPacks = parseInt(document.getElementById('editMovementQuantityPacks').value) || 0;
				const newQuantityUnits = parseInt(document.getElementById('editMovementQuantityUnits').value) || 0;
				const notes = document.getElementById('editMovementNotes').value;
				
				// ×§×— ××ª ×”×¢×¨×›×™× ×”××§×•×¨×™×™×
				const originalQuantityPacks = parseInt(document.getElementById('editMovementOriginalQuantityPacks').value) || 0;
				const originalQuantityUnits = parseInt(document.getElementById('editMovementOriginalQuantityUnits').value) || 0;
				const originalType = document.getElementById('editMovementOriginalType').value;
				
				// ××¦× ××ª ×”××•×¦×¨ ×‘××œ××™
				const item = inventory.find(i => i.name === productName);
				if (!item) {
					showToast('×”××•×¦×¨ ×œ× × ××¦× ×‘××œ××™', 'error');
					return;
				}
				
				// ×‘×˜×œ ××ª ×”×”×©×¤×¢×” ×©×œ ×”×ª× ×•×¢×” ×”××§×•×¨×™×ª ×¢×œ ×”××œ××™
				let targetVariant = null;
				if (item.variants && newLocation) {
					targetVariant = item.variants.find(v => 
						v.location === newLocation && 
						((!v.expiry && !newExpiry) || (v.expiry === newExpiry))
					);
					
					// ×× ×œ× × ××¦× ×•×¨×™×× ×˜ ××ª××™×, ×¦×•×¨ ×—×“×©
					if (!targetVariant) {
						targetVariant = {
							quantityPacks: 0,
							quantityUnits: 0,
							location: newLocation,
							expiry: newExpiry || ''
						};
						item.variants.push(targetVariant);
					}
				} else {
					// ×× ××™×Ÿ ××™×§×•×, ×”×©×ª××© ×‘×•×•×¨×™×× ×˜ ×”×¨××©×•×Ÿ
					if (!item.variants || item.variants.length === 0) {
						item.variants = [{
							quantityPacks: 0,
							quantityUnits: 0,
							location: '××—×¡×Ÿ ×¨××©×™',
							expiry: ''
						}];
					}
					targetVariant = item.variants[0];
				}
				
				// ×©×œ×‘ 1: ×‘×˜×œ ××ª ×”×”×©×¤×¢×” ×”××§×•×¨×™×ª
				if (originalType === '×”×•×¦××”') {
					// ×× ×”×™×™×ª×” ×”×•×¦××”, ×”×—×–×¨ ×œ××œ××™
					targetVariant.quantityPacks += originalQuantityPacks;
					targetVariant.quantityUnits += originalQuantityUnits;
				} else if (originalType === '×”×›× ×¡×”') {
					// ×× ×”×™×™×ª×” ×”×›× ×¡×”, ×”×•×¨×“ ××”××œ××™
					targetVariant.quantityPacks = Math.max(0, targetVariant.quantityPacks - originalQuantityPacks);
					targetVariant.quantityUnits = Math.max(0, targetVariant.quantityUnits - originalQuantityUnits);
				}
				
				// ×©×œ×‘ 2: ×”×—×œ ××ª ×”×”×©×¤×¢×” ×”×—×“×©×”
				if (newType === '×”×•×¦××”') {
					// ×”×•×¨×“ ××”××œ××™
					targetVariant.quantityPacks = Math.max(0, targetVariant.quantityPacks - newQuantityPacks);
					targetVariant.quantityUnits = Math.max(0, targetVariant.quantityUnits - newQuantityUnits);
				} else if (newType === '×”×›× ×¡×”') {
					// ×”×•×¡×£ ×œ××œ××™
					targetVariant.quantityPacks += newQuantityPacks;
					targetVariant.quantityUnits += newQuantityUnits;
				}
				
				// × ×¨××œ ××ª ×”×™×—×™×“×•×ª
				if (targetVariant.quantityUnits >= item.unitsPerPack && item.unitsPerPack > 0) {
					const extraPacks = Math.floor(targetVariant.quantityUnits / item.unitsPerPack);
					targetVariant.quantityPacks += extraPacks;
					targetVariant.quantityUnits = targetVariant.quantityUnits % item.unitsPerPack;
				}
				
				// ×˜×¤×œ ×‘×™×—×™×“×•×ª ×©×œ×™×œ×™×•×ª
				while (targetVariant.quantityUnits < 0 && targetVariant.quantityPacks > 0) {
					targetVariant.quantityPacks--;
					targetVariant.quantityUnits += item.unitsPerPack;
				}
				
				// ×•×•×“× ×©××™×Ÿ ×¢×¨×›×™× ×©×œ×™×œ×™×™×
				targetVariant.quantityPacks = Math.max(0, targetVariant.quantityPacks);
				targetVariant.quantityUnits = Math.max(0, targetVariant.quantityUnits);
				
				// ×¢×“×›×Ÿ ××ª ×”×ª× ×•×¢×” ×‘-Firebase
				await db.collection('movements').doc(id).update({
					product: productName,
					type: newType,
					location: newLocation,
					expiry: newExpiry,
					quantityPacks: newQuantityPacks,
					quantityUnits: newQuantityUnits,
					notes: notes,
					lastEdited: new Date().toISOString(),
					editedBy: currentUser.fullName
				});
				
				// ×©××•×¨ ××ª ×”××•×¦×¨ ×”××¢×•×“×›×Ÿ
				await saveInventoryItem(item);
				
				// ×˜×¢×Ÿ ××—×“×© ××ª ×”× ×ª×•× ×™×
				await loadAllData();
				updateStats();
				displayInventory();
				displayMovements();
				
				showToast('×”×ª× ×•×¢×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!', 'success');
				closeEditMovementModal();
				
			} catch (error) {
				console.error('Error updating movement:', error);
				showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª× ×•×¢×”: ' + error.message, 'error');
			}
		});

        window.closeEditMovementModal = function() {
            document.getElementById('editMovementModal').style.display = 'none';
            document.getElementById('editMovementForm').reset();
        };

        window.deleteMovement = async function(id) {
			if (!confirm('×”×× ×œ××—×•×§ ×ª× ×•×¢×” ×–×•? ×©×™× ×œ×‘: ×”××œ××™ ×™×¢×•×“×›×Ÿ ×‘×”×ª××.')) return;
			
			try {
				// ×§×— ××ª ×¤×¨×˜×™ ×”×ª× ×•×¢×” ×œ×¤× ×™ ×”××—×™×§×”
				const movementDoc = await db.collection('movements').doc(id).get();
				if (!movementDoc.exists) {
					showToast('×”×ª× ×•×¢×” ×œ× × ××¦××”', 'error');
					return;
				}
				
				const movement = movementDoc.data();
				
				// ×‘×“×•×§ ×× ×™×© ××¡×¤×™×§ ××™×“×¢ ×œ×¢×“×›×•×Ÿ ×”××œ××™
				if (!movement.product || !movement.type) {
					if (!confirm('×—×¡×¨×™× ×¤×¨×˜×™× ×‘×ª× ×•×¢×” ×–×•. ×œ××—×•×§ ×‘×›×œ ×–××ª ×œ×œ× ×¢×“×›×•×Ÿ ×”××œ××™?')) {
						return;
					}
					// ××—×§ ×¨×§ ××ª ×”×ª× ×•×¢×”
					await db.collection('movements').doc(id).delete();
					await loadMovementsOnly();
					displayMovements();
					showToast('×”×ª× ×•×¢×” × ××—×§×” (×œ×œ× ×¢×“×›×•×Ÿ ××œ××™)', 'warning');
					return;
				}
				
				// ××¦× ××ª ×”××•×¦×¨ ×‘××œ××™
				const item = inventory.find(i => i.name === movement.product);
				if (!item) {
					if (!confirm(`×”××•×¦×¨ "${movement.product}" ×œ× × ××¦× ×‘××œ××™. ×œ××—×•×§ ××ª ×”×ª× ×•×¢×” ×‘×œ×‘×“?`)) {
						return;
					}
					// ××—×§ ×¨×§ ××ª ×”×ª× ×•×¢×”
					await db.collection('movements').doc(id).delete();
					await loadMovementsOnly();
					displayMovements();
					showToast('×”×ª× ×•×¢×” × ××—×§×” (×”××•×¦×¨ ×œ× × ××¦× ×‘××œ××™)', 'warning');
					return;
				}
				
				// ×—×©×‘ ××ª ×”×›××•×™×•×ª ×œ×”×—×–×¨×”
				const quantityPacks = movement.quantityPacks || 0;
				const quantityUnits = movement.quantityUnits || 0;
				
				// ××¦× ××ª ×”×•×•×¨×™×× ×˜ ×”××ª××™× ××• ×”×©×ª××© ×‘×¨××©×•×Ÿ
				let targetVariant = null;
				
				if (movement.location && item.variants) {
					// × ×¡×” ×œ××¦×•× ×•×¨×™×× ×˜ ××ª××™×
					targetVariant = item.variants.find(v => 
						v.location === movement.location && 
						((!v.expiry && !movement.expiry) || (v.expiry === movement.expiry))
					);
				}
				
				// ×× ×œ× × ××¦× ×•×¨×™×× ×˜ ××ª××™×, ×”×©×ª××© ×‘×¨××©×•×Ÿ ××• ×¦×•×¨ ×—×“×©
				if (!targetVariant) {
					if (item.variants && item.variants.length > 0) {
						targetVariant = item.variants[0];
						showToast('×”×•×•×¨×™×× ×˜ ×”××§×•×¨×™ ×œ× × ××¦×, ×”××œ××™ ×™×¢×•×“×›×Ÿ ×‘×•×•×¨×™×× ×˜ ×”×¨××©×•×Ÿ', 'warning');
					} else {
						// ×¦×•×¨ ×•×¨×™×× ×˜ ×—×“×©
						item.variants = [{
							quantityPacks: 0,
							quantityUnits: 0,
							location: movement.location || '××—×¡×Ÿ ×¨××©×™',
							expiry: movement.expiry || ''
						}];
						targetVariant = item.variants[0];
					}
				}
				
				// ×¢×“×›×Ÿ ××ª ×”××œ××™ ×‘×”×ª×× ×œ×¡×•×’ ×”×ª× ×•×¢×”
				if (movement.type === '×”×•×¦××”') {
					// ×× ×”×™×™×ª×” ×”×•×¦××”, ×”×—×–×¨ ×œ××œ××™
					targetVariant.quantityPacks = (targetVariant.quantityPacks || 0) + quantityPacks;
					targetVariant.quantityUnits = (targetVariant.quantityUnits || 0) + quantityUnits;
				} else if (movement.type === '×”×›× ×¡×”') {
					// ×× ×”×™×™×ª×” ×”×›× ×¡×”, ×”×•×¨×“ ××”××œ××™
					targetVariant.quantityPacks = Math.max(0, (targetVariant.quantityPacks || 0) - quantityPacks);
					targetVariant.quantityUnits = Math.max(0, (targetVariant.quantityUnits || 0) - quantityUnits);
				}
				
				// × ×¨××œ ××ª ×”×™×—×™×“×•×ª (×”××¨ ×™×—×™×“×•×ª ×¢×•×“×¤×•×ª ×œ×—×‘×™×œ×•×ª)
				if (targetVariant.quantityUnits >= item.unitsPerPack && item.unitsPerPack > 0) {
					const extraPacks = Math.floor(targetVariant.quantityUnits / item.unitsPerPack);
					targetVariant.quantityPacks += extraPacks;
					targetVariant.quantityUnits = targetVariant.quantityUnits % item.unitsPerPack;
				}
				
				// ×©××•×¨ ××ª ×”××•×¦×¨ ×”××¢×•×“×›×Ÿ
				await saveInventoryItem(item);
				
				// ××—×§ ××ª ×”×ª× ×•×¢×”
				await db.collection('movements').doc(id).delete();
				
				// ×¦×•×¨ ×ª× ×•×¢×ª ×‘×™×˜×•×œ ×œ×ª×™×¢×•×“
				await saveMovement({
					date: getFormattedDate(),
					time: getFormattedTime(),
					product: movement.product,
					location: targetVariant.location,
					expiry: targetVariant.expiry,
					type: movement.type === '×”×•×¦××”' ? '×‘×™×˜×•×œ ×”×•×¦××”' : '×‘×™×˜×•×œ ×”×›× ×¡×”',
					quantityPacks: quantityPacks,
					quantityUnits: quantityUnits,
					user: currentUser.fullName,
					notes: `×‘×™×˜×•×œ ×ª× ×•×¢×” ××ª××¨×™×š ${movement.date || '×œ× ×™×“×•×¢'} (${movement.user || '××©×ª××© ×œ× ×™×“×•×¢'})`
				});
				
				// ×˜×¢×Ÿ ××—×“×© ××ª ×›×œ ×”× ×ª×•× ×™×
				await loadAllData();
				updateStats();
				displayInventory();
				displayMovements();
				
				showToast('×”×ª× ×•×¢×” × ××—×§×” ×•×”××œ××™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
				
			} catch (error) {
				console.error('Error deleting movement:', error);
				showToast('×©×’×™××” ×‘××—×™×§×ª ×”×ª× ×•×¢×”: ' + error.message, 'error');
			}
		};

        // --- ×¢×¨×™×›×ª ××©×ª××©×™× ---
        window.editUser = function(username) {
            if (!currentUser.permissions.includes('manage_users')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ××©×ª××©×™×', 'error');
                return;
            }
            
            const user = users.find(u => u.username === username);
            if (!user) {
                showToast('××©×ª××© ×œ× × ××¦×', 'error');
                return;
            }
            
            document.getElementById('editUserOriginalUsername').value = user.username;
            document.getElementById('editUsername').value = user.username;
            document.getElementById('editPassword').value = '';
            document.getElementById('editFullName').value = user.fullName;
            document.getElementById('editUserRole').value = user.role || '';
            
            // ××™×¤×•×¡ ×›×œ ×”-checkboxes
            document.querySelectorAll('#editUserForm input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            
            // ×¡×™××•×Ÿ ×”×”×¨×©××•×ª ×”×§×™×™××•×ª
            (user.permissions || []).forEach(perm => {
                const checkbox = document.getElementById('edit_perm_' + perm);
                if (checkbox) checkbox.checked = true;
            });
            
            document.getElementById('editUserModal').style.display = 'block';
        };

        window.closeEditUserModal = function() {
            document.getElementById('editUserModal').style.display = 'none';
            document.getElementById('editUserForm').reset();
        };

        window.deleteUser = async function(username) {
            if (!confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××©×ª××© ×–×”?')) return;
            
            try {
                await deleteUserFromDB(username);
                users = users.filter(u => u.username !== username);
                displayUsers();
                showToast('×”××©×ª××© × ××—×§ ×‘×”×¦×œ×—×”', 'success');
            } catch (error) {
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”××©×ª××©', 'error');
            }
        };

        // --- ×¢×¨×™×›×ª ×œ×™×§×•×˜×™× ---
        window.openEditPicking = async function(pickId) {
            try {
                const pickSnap = await db.collection('pickingLists').doc(pickId).get();
                if (!pickSnap.exists) {
                    showToast('×¨×©×™××ª ×”×œ×™×§×•×˜ ×œ× ×§×™×™××ª', 'error');
                    return;
                }
                
                const pick = pickSnap.data();
                window.currentEditPickId = pickId;

                let html = `<table class="picking-table"><tr>
                    <th>××•×¦×¨</th>
                    <th>×›××•×ª</th>
                    <th>××™×§×•×</th>
                    <th>×ª×•×§×£</th>
                    <th>×”×¢×¨×”</th>
                    <th>× ×œ×§×—</th>
                </tr>`;
                
                (pick.plan || []).forEach((row, i) => {
                    html += `<tr>
                        <td>${row.productName}</td>
                        <td>${row.takePacks} ×—×‘'${row.takeUnits ? ' + ' + row.takeUnits + ' ×™×—×™×“×•×ª' : ''}</td>
                        <td>${row.location || ''}</td>
                        <td>${row.expiry ? formatDate(row.expiry) : ''}</td>
                        <td>
                            <input type="text" id="edit_note_${i}" value="${row.note || ''}" style="width:95%;padding:4px 7px;">
                        </td>
                        <td style="text-align:center">
                            <input type="checkbox" class="edit-pick-checkbox" data-index="${i}" id="edit_pick_checkbox_${i}" checked>
                        </td>
                    </tr>`;
                });

                html += `</table>
                <div style="text-align:center; margin-top:14px;">
                    <button class="btn-main" onclick="selectAllPicking(true)">×‘×—×¨ ×”×›×œ</button>
                    <button class="btn-main" onclick="selectAllPicking(false)">× ×§×” ×”×›×œ</button>
                    <button class="btn-main" onclick="saveEditPicking()">××©×¨ ×•×¡×’×•×¨</button>
                </div>`;
                
                document.getElementById('editPickingListArea').innerHTML = html;
                document.getElementById('editPickingModal').style.display = "block";
                selectAllPicking(true);
            } catch (error) {
                showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××ª ×”×œ×™×§×•×˜', 'error');
            }
        }

        window.closeEditPicking = function() {
            document.getElementById('editPickingModal').style.display = "none";
            window.lastEditPickingResults = null;
        }
		
		window.saveEditPicking = async function() {
			console.log('saveEditPicking called');
			try {
				const pickId = window.currentEditPickId;
				console.log('pickId:', pickId);
				
				if (!pickId) {
					showToast('×œ× × ××¦× ××–×”×” ×œ×™×§×•×˜', 'error');
					return;
				}
				
				const pickSnap = await db.collection('pickingLists').doc(pickId).get();
				if (!pickSnap.exists) {
					showToast('×¨×©×™××ª ×”×œ×™×§×•×˜ ×œ× ×§×™×™××ª', 'error');
					return;
				}
				
				const pick = pickSnap.data();
				console.log('pick data:', pick);
				
				// ×‘×“×•×§ ×× ×”×œ×™×§×•×˜ ×›×‘×¨ ×‘×•×¦×¢
				if (pick.status === 'done') {
					if (!confirm('×œ×™×§×•×˜ ×–×” ×›×‘×¨ ×‘×•×¦×¢. ×”×× ×œ×¢×“×›×Ÿ ×‘×›×œ ×–××ª?')) {
						return;
					}
				}
				
				const results = [];
				const updatedPlan = [...(pick.plan || [])];
				
				// ××¡×•×£ ××ª ×”×ª×•×¦××•×ª ×•×”×”×¢×¨×•×ª
				for (let i = 0; i < updatedPlan.length; i++) {
					const cb = document.getElementById('edit_pick_checkbox_' + i);
					const noteInput = document.getElementById('edit_note_' + i);
					
					if (!cb) {
						console.error(`Checkbox not found for index ${i}`);
						continue;
					}
					
					const result = {
						status: cb.checked ? "× ×œ×§×—" : "×œ× × ×œ×§×—",
						note: noteInput ? noteInput.value.trim() : ''
					};
					
					results.push(result);
					
					// ×¢×“×›×•×Ÿ ×”×”×¢×¨×” ×‘-plan
					if (noteInput && noteInput.value.trim()) {
						updatedPlan[i].note = noteInput.value.trim();
					}
				}
				
				console.log('results:', results);
				
				// ×•×“× ×©×™×© ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“ ××¡×•××Ÿ
				const hasCheckedItems = results.some(r => r.status === "× ×œ×§×—");
				if (!hasCheckedItems) {
					if (!confirm('×œ× ×¡×•×× ×• ×¤×¨×™×˜×™× ×œ×œ×™×§×•×˜. ×”×× ×œ×”××©×™×š ×‘×›×œ ×–××ª?')) {
						return;
					}
				}
				
				// ×¢×“×›×Ÿ ××ª ×¨×©×™××ª ×”×œ×™×§×•×˜
				await db.collection('pickingLists').doc(pickId).update({
					status: 'done',
					results: results,
					plan: updatedPlan,
					pickedBy: currentUser.fullName,
					pickedAt: new Date().toISOString()
				});
				
				// ×¢×“×›×Ÿ ××ª ×”××œ××™ ×¨×§ ×¢×‘×•×¨ ×”×¤×¨×™×˜×™× ×©× ×œ×§×—×•
				for (let i = 0; i < updatedPlan.length; i++) {
					if (results[i].status !== '× ×œ×§×—') continue;
					
					const row = updatedPlan[i];
					
					// ××¦× ××ª ×”××•×¦×¨ ×‘××œ××™
					const item = inventory.find(it => it.name === row.productName);
					if (!item) {
						console.error(`Product not found: ${row.productName}`);
						continue;
					}
					
					// ××¦× ××ª ×”×•×•×¨×™×× ×˜ ×”××ª××™×
					let variantFound = false;
					for (let j = 0; j < (item.variants || []).length; j++) {
						const variant = item.variants[j];
						if (variant.location === row.location && 
							((!variant.expiry && !row.expiry) || (variant.expiry === row.expiry))) {
							
							// ×—×©×‘ ××ª ×”×›××•×™×•×ª ×”×—×“×©×•×ª
							let newPacks = (variant.quantityPacks || 0) - (row.takePacks || 0);
							let newUnits = (variant.quantityUnits || 0) - (row.takeUnits || 0);
							
							// ×˜×¤×œ ×‘××§×¨×” ×©×œ ×™×—×™×“×•×ª ×©×œ×™×œ×™×•×ª
							while (newUnits < 0 && newPacks > 0) {
								newPacks--;
								newUnits += item.unitsPerPack;
							}
							
							// ×•×•×“× ×©××™×Ÿ ×¢×¨×›×™× ×©×œ×™×œ×™×™×
							variant.quantityPacks = Math.max(0, newPacks);
							variant.quantityUnits = Math.max(0, newUnits);
							
							variantFound = true;
							break;
						}
					}
					
					if (!variantFound) {
						console.error(`Variant not found for ${row.productName} at ${row.location}`);
						continue;
					}
					
					// ×©××•×¨ ××ª ×”××•×¦×¨ ×”××¢×•×“×›×Ÿ
					await saveInventoryItem(item);
					
					// ×¦×•×¨ ×ª× ×•×¢×ª ××œ××™
					await saveMovement({
						date: getFormattedDate(),
						time: getFormattedTime(),
						product: row.productName,
						location: row.location,
						expiry: row.expiry,
						type: "×”×•×¦××”",
						quantityPacks: row.takePacks || 0,
						quantityUnits: row.takeUnits || 0,
						user: currentUser.fullName,
						notes: `×œ×™×§×•×˜ - ${results[i].note || '×œ×œ× ×”×¢×¨×•×ª'}`
					});
				}
				
				// ×˜×¢×Ÿ ××—×“×© ××ª ×”× ×ª×•× ×™×
				await loadAllData();
				updateStats();
				displayInventory();
				
				showToast('×”×œ×™×§×•×˜ × ×©××¨ ×•×”××œ××™ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”', 'success');
				closeEditPicking();
				displayPickings();
				
			} catch (error) {
				console.error('Error in saveEditPicking:', error);
				showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×œ×™×§×•×˜: ' + error.message, 'error');
			}
		};

        window.selectAllPicking = function(val = true) {
            const checkboxes = document.querySelectorAll('.edit-pick-checkbox');
            checkboxes.forEach(cb => cb.checked = val);
        }

        window.approvePicking = async function(pickId, results = null) {
			try {
				const pickSnap = await db.collection('pickingLists').doc(pickId).get();
				if (!pickSnap.exists) {
					showToast('×¨×©×™××ª ×”×œ×™×§×•×˜ ×œ× ×§×™×™××ª', 'error');
					return;
				}
				
				const pick = pickSnap.data();
				
				// ×× ×œ× ×¡×•×¤×§×• ×ª×•×¦××•×ª, ×”× ×— ×©×”×›×œ × ×œ×§×—
				if (!results) {
					results = (pick.plan || []).map(() => ({ status: "× ×œ×§×—" }));
				}
				
				// ×‘×“×•×§ ×× ×”×œ×™×§×•×˜ ×›×‘×¨ ×‘×•×¦×¢
				if (pick.status === 'done') {
					showToast('×œ×™×§×•×˜ ×–×” ×›×‘×¨ ×‘×•×¦×¢', 'error');
					return;
				}

				// ×¢×“×›×Ÿ ××ª ×¨×©×™××ª ×”×œ×™×§×•×˜
				await db.collection('pickingLists').doc(pickId).update({
					status: 'done',
					results: results,
					pickedBy: currentUser.fullName,
					pickedAt: new Date().toISOString()
				});

				// ×¢×“×›×•×Ÿ ×”××œ××™ ×•×™×¦×™×¨×ª ×ª× ×•×¢×•×ª
				let successCount = 0;
				let errorCount = 0;
				
				for (let i = 0; i < (pick.plan || []).length; i++) {
					if (results[i].status !== '× ×œ×§×—') continue;
					
					const row = pick.plan[i];
					
					try {
						// ××¦× ××ª ×”××•×¦×¨ ×‘××œ××™
						const item = inventory.find(it => it.name === row.productName);
						if (!item) {
							console.error(`Product not found: ${row.productName}`);
							errorCount++;
							continue;
						}
						
						// ××¦× ××ª ×”×•×•×¨×™×× ×˜ ×”××ª××™×
						let variantFound = false;
						for (const variant of (item.variants || [])) {
							if (variant.location === row.location && 
								((!variant.expiry && !row.expiry) || (variant.expiry === row.expiry))) {
								
								// ×”×•×¨×“ ××ª ×”×›××•×™×•×ª
								let newPacks = (variant.quantityPacks || 0) - (row.takePacks || 0);
								let newUnits = (variant.quantityUnits || 0) - (row.takeUnits || 0);
								
								// ×˜×¤×œ ×‘×™×—×™×“×•×ª ×©×œ×™×œ×™×•×ª
								while (newUnits < 0 && newPacks > 0) {
									newPacks--;
									newUnits += item.unitsPerPack;
								}
								
								variant.quantityPacks = Math.max(0, newPacks);
								variant.quantityUnits = Math.max(0, newUnits);
								
								variantFound = true;
								successCount++;
								break;
							}
						}
						
						if (!variantFound) {
							console.error(`Variant not found for ${row.productName} at ${row.location}`);
							errorCount++;
							continue;
						}
						
						// ×©××•×¨ ××ª ×”××•×¦×¨ ×”××¢×•×“×›×Ÿ
						await saveInventoryItem(item);
						
						// ×¦×•×¨ ×ª× ×•×¢×ª ××œ××™
						await saveMovement({
							date: getFormattedDate(),
							time: getFormattedTime(),
							product: row.productName,
							location: row.location,
							expiry: row.expiry,
							type: "×”×•×¦××”",
							quantityPacks: row.takePacks || 0,
							quantityUnits: row.takeUnits || 0,
							user: currentUser.fullName,
							notes: '×œ×™×§×•×˜ ×××•×©×¨'
						});
						
					} catch (itemError) {
						console.error(`Error processing item ${row.productName}:`, itemError);
						errorCount++;
					}
				}

				// ×˜×¢×Ÿ ××—×“×© ××ª ×”× ×ª×•× ×™×
				await loadAllData();
				updateStats();
				displayInventory();
				
				// ×”×•×“×¢×” ××¡×›××ª
				let message = `×”×œ×™×§×•×˜ ××•×©×¨ ×‘×”×¦×œ×—×”!`;
				if (successCount > 0) {
					message += ` ${successCount} ×¤×¨×™×˜×™× ×¢×•×“×›× ×• ×‘××œ××™.`;
				}
				if (errorCount > 0) {
					message += ` ${errorCount} ×¤×¨×™×˜×™× ×œ× ×¢×•×“×›× ×• ×‘×’×œ×œ ×©×’×™××•×ª.`;
				}
				
				showToast(message, errorCount > 0 ? 'warning' : 'success');
				displayPickings();
				
			} catch (error) {
				console.error('Error in approvePicking:', error);
				showToast('×©×’×™××” ×‘××™×©×•×¨ ×”×œ×™×§×•×˜: ' + error.message, 'error');
			}
		};


        window.deletePicking = async function(pickId) {
            if (!confirm("×”×× ×œ××—×•×§ ××ª ×”×œ×™×§×•×˜?")) return;
            
            try {
                await db.collection('pickingLists').doc(pickId).delete();
                displayPickings();
                showToast('×”×œ×™×§×•×˜ × ××—×§', 'success');
            } catch (error) {
                showToast('×©×’×™××” ×‘××—×™×§×ª ×”×œ×™×§×•×˜', 'error');
            }
        }

        // --- ×“×•×—×•×ª ---
        window.generateReport = function(type) {
			const reportContent = document.getElementById('reportContent');
			if (!reportContent) return;
			
			let html = '';
			
			switch(type) {
				case 'inventory':
					html = '<h3>×“×•×— ××œ××™ ××œ×</h3>';
					html += '<div style="margin: 10px 0;">';
					html += '<label><input type="checkbox" id="showVariantsCheckbox" checked onchange="regenerateReport(\'inventory\')"> ×”×¦×’ ×¤×™×¨×•×˜ ×œ×¤×™ ××™×§×•××™×</label>';
					html += '</div>';
					
					const showVariants = document.getElementById('showVariantsCheckbox')?.checked ?? true;
					
					html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
					
					if (showVariants) {
						// ×ª×¦×•×’×” ×¢× ×•×¨×™×× ×˜×™×
						html += '<thead><tr style="background: #34495e; color: white;">';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×©× ××•×¦×¨</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×§×˜×’×•×¨×™×”</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">××™×§×•×</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×›××•×ª</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×ª×¤×•×’×”</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×¡×˜×˜×•×¡</th>';
						html += '</tr></thead>';
						html += '<tbody>';
						
						inventory.forEach(item => {
							const [totalPacks, totalUnits] = totalPacksAndUnits(item);
							const hasVariants = item.variants && item.variants.length > 0;
							
							if (!hasVariants) {
								// ××•×¦×¨ ×œ×œ× ×•×¨×™×× ×˜×™×
								html += `<tr style="border: 1px solid #ddd;">
									<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
									<td style="padding: 8px; border: 1px solid #ddd;">${item.category}</td>
									<td style="padding: 8px; border: 1px solid #ddd;">-</td>
									<td style="padding: 8px; border: 1px solid #ddd;">0</td>
									<td style="padding: 8px; border: 1px solid #ddd;">-</td>
									<td style="padding: 8px; border: 1px solid #ddd;">×œ×œ× ××œ××™</td>
								</tr>`;
							} else {
								// ×©×•×¨×ª ×¡×™×›×•× ×œ××•×¦×¨
								html += `<tr style="background: #ecf0f1; font-weight: bold; border: 2px solid #34495e;">
									<td style="padding: 8px; border: 1px solid #ddd;" rowspan="${item.variants.length + 1}">${item.name}</td>
									<td style="padding: 8px; border: 1px solid #ddd;" rowspan="${item.variants.length + 1}">${item.category}</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">×¡×”"×›</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">
										${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
										${totalUnits > 0 ? ` + ${totalUnits} ${getUnitLabel(totalUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
									</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">-</td>
									<td style="padding: 8px; border: 1px solid #ddd; background: #3498db; color: white;">
										${totalPacks < (item.minPacks || 0) ? 'ğŸ”´ ××ª×—×ª ×œ××™× ×™××•×' : 'ğŸŸ¢ ×ª×§×™×Ÿ'}
									</td>
								</tr>`;
								
								// ×©×•×¨×•×ª ×•×¨×™×× ×˜×™×
								item.variants.forEach(variant => {
									let expiryStatus = '';
									let rowStyle = '';
									
									if (variant.expiry) {
										const daysToExpiry = Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24));
										if (daysToExpiry < 0) {
											expiryStatus = 'ğŸ”´ ×¤×’ ×ª×•×§×£';
											rowStyle = 'background: #ffebee;';
										} else if (daysToExpiry <= 7) {
											expiryStatus = 'ğŸŸ  ×ª×¤×•×’×” ×§×¨×•×‘×”';
											rowStyle = 'background: #fff3e0;';
										} else if (daysToExpiry <= 30) {
											expiryStatus = 'ğŸŸ¡ ×ª×¤×•×’×” ×‘×—×•×“×© ×”×§×¨×•×‘';
											rowStyle = 'background: #fffde7;';
										} else {
											expiryStatus = 'ğŸŸ¢ ×ª×§×™×Ÿ';
										}
									}
									
									html += `<tr style="${rowStyle} border: 1px solid #ddd;">
										<td style="padding: 8px; padding-right: 20px; border: 1px solid #ddd;">â†³ ${variant.location}</td>
										<td style="padding: 8px; border: 1px solid #ddd;">
											${variant.quantityPacks || 0} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
											${variant.quantityUnits > 0 ? ` + ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
										</td>
										<td style="padding: 8px; border: 1px solid #ddd;">${variant.expiry ? formatDate(variant.expiry) : '-'}</td>
										<td style="padding: 8px; border: 1px solid #ddd;">${expiryStatus}</td>
									</tr>`;
								});
							}
						});
						
					} else {
						// ×ª×¦×•×’×” ××¡×›××ª ×‘×œ×‘×“
						html += '<thead><tr style="background: #34495e; color: white;">';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×©× ××•×¦×¨</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×§×˜×’×•×¨×™×”</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×›××•×ª ×›×•×œ×œ×ª</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">××™× ×™××•×</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×ª×¤×•×’×” ×§×¨×•×‘×”</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×¡×˜×˜×•×¡</th>';
						html += '</tr></thead>';
						html += '<tbody>';
						
						inventory.forEach(item => {
							const [totalPacks, looseUnits] = totalPacksAndUnits(item);
							const earliestExpiry = getEarliestExpiry(item);
							const status = getGlobalStatus(totalPacks, item.minPacks || 0, earliestExpiry);
							
							let rowStyle = '';
							if (totalPacks < (item.minPacks || 0)) {
								rowStyle = 'background: #ffebee;';
							}
							
							html += `<tr style="${rowStyle} border: 1px solid #ddd;">
								<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${item.category}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">
									${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
									${looseUnits > 0 ? ` + ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
								</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${item.minPacks || 0} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${earliestExpiry ? formatDate(earliestExpiry) : '-'}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
							</tr>`;
						});
					}
					
					html += '</tbody></table>';
					break;

				case 'lowStock':
					html = '<h3>×“×•×— ×—×•×¡×¨×™× ×‘××œ××™</h3>';
					html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
					html += '<thead><tr style="background: #34495e; color: white;">';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×©× ××•×¦×¨</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×›××•×ª × ×•×›×—×™×ª</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×›××•×ª ××™× ×™××•×</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×—×•×¡×¨</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">××—×•×– ××”××™× ×™××•×</th>';
					html += '</tr></thead>';
					html += '<tbody>';
					
					const lowStockItems = [];
					inventory.forEach(item => {
						const [totalPacks, looseUnits] = totalPacksAndUnits(item);
						if (totalPacks < (item.minPacks || 0)) {
							const shortage = (item.minPacks || 0) - totalPacks;
							const percentage = item.minPacks > 0 ? Math.round((totalPacks / item.minPacks) * 100) : 0;
							lowStockItems.push({ item, totalPacks, looseUnits, shortage, percentage });
						}
					});
					
					// ××™×•×Ÿ ×œ×¤×™ ××—×•×– - ×”×›×™ × ××•×š ×§×•×“×
					lowStockItems.sort((a, b) => a.percentage - b.percentage);
					
					lowStockItems.forEach(({ item, totalPacks, looseUnits, shortage, percentage }) => {
						let rowStyle = '';
						if (percentage === 0) {
							rowStyle = 'background: #ffcdd2; font-weight: bold;'; // ××™×Ÿ ××œ××™ ×›×œ×œ
						} else if (percentage < 25) {
							rowStyle = 'background: #ffebee;'; // ×¤×—×•×ª ×-25%
						} else if (percentage < 50) {
							rowStyle = 'background: #fff3e0;'; // ×¤×—×•×ª ×-50%
						}
						
						html += `<tr style="${rowStyle} border: 1px solid #ddd;">
							<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
							<td style="padding: 8px; border: 1px solid #ddd;">
								${totalPacks} ${getUnitLabel(totalPacks, item.packUnitSingular, item.packUnitPlural)}
								${looseUnits > 0 ? ` + ${looseUnits} ${getUnitLabel(looseUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${item.minPacks || 0} ${getUnitLabel(item.minPacks, item.packUnitSingular, item.packUnitPlural)}</td>
							<td style="padding: 8px; border: 1px solid #ddd; color: #c62828; font-weight: bold;">
								${shortage} ${getUnitLabel(shortage, item.packUnitSingular, item.packUnitPlural)}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">
								<div style="display: flex; align-items: center;">
									<div style="width: 100px; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin-left: 10px;">
										<div style="width: ${percentage}%; height: 100%; background: ${percentage < 25 ? '#f44336' : percentage < 50 ? '#ff9800' : '#ffc107'};"></div>
									</div>
									<span>${percentage}%</span>
								</div>
							</td>
						</tr>`;
					});
					
					if (lowStockItems.length === 0) {
						html += '<tr><td colspan="5" style="text-align: center; padding: 20px;">××™×Ÿ ××•×¦×¨×™× ××ª×—×ª ×œ××™× ×™××•× ğŸ‰</td></tr>';
					}
					
					html += '</tbody></table>';
					break;

				case 'expiring':
					html = '<h3>×“×•×— ×ª×¤×•×’×•×ª ×§×¨×•×‘×•×ª</h3>';
					html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
					html += '<thead><tr style="background: #34495e; color: white;">';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×©× ××•×¦×¨</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">××™×§×•×</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×›××•×ª</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×ª××¨×™×š ×ª×¤×•×’×”</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×™××™× ×œ×ª×¤×•×’×”</th>';
					html += '<th style="padding: 10px; border: 1px solid #ddd;">×¡×˜×˜×•×¡</th>';
					html += '</tr></thead>';
					html += '<tbody>';
					
					const expiringItems = [];
					inventory.forEach(item => {
						(item.variants || []).forEach(variant => {
							if (!variant.expiry) return;
							if ((variant.quantityPacks || 0) === 0 && (variant.quantityUnits || 0) === 0) return;
							
							const daysToExpiry = Math.floor((new Date(variant.expiry) - new Date()) / (1000 * 60 * 60 * 24));
							if (daysToExpiry <= 30) {
								expiringItems.push({ item, variant, daysToExpiry });
							}
						});
					});
					
					// ××™×•×Ÿ ×œ×¤×™ ×™××™× ×œ×ª×¤×•×’×”
					expiringItems.sort((a, b) => a.daysToExpiry - b.daysToExpiry);
					
					expiringItems.forEach(({ item, variant, daysToExpiry }) => {
						let status, rowStyle;
						
						if (daysToExpiry < 0) {
							status = 'ğŸ”´ ×¤×’ ×ª×•×§×£!';
							rowStyle = 'background: #ffcdd2; font-weight: bold;';
						} else if (daysToExpiry === 0) {
							status = 'ğŸ”´ ×¤×’ ×”×™×•×!';
							rowStyle = 'background: #ffcdd2;';
						} else if (daysToExpiry <= 7) {
							status = 'ğŸŸ  ×ª×¤×•×’×” ×”×©×‘×•×¢';
							rowStyle = 'background: #ffebee;';
						} else if (daysToExpiry <= 14) {
							status = 'ğŸŸ¡ ×ª×¤×•×’×” ×‘×©×‘×•×¢×™×™×';
							rowStyle = 'background: #fff3e0;';
						} else {
							status = 'ğŸŸ¢ ×ª×¤×•×’×” ×‘×—×•×“×© ×”×§×¨×•×‘';
							rowStyle = 'background: #fffde7;';
						}
						
						html += `<tr style="${rowStyle} border: 1px solid #ddd;">
							<td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${variant.location}</td>
							<td style="padding: 8px; border: 1px solid #ddd;">
								${variant.quantityPacks || 0} ${getUnitLabel(variant.quantityPacks, item.packUnitSingular, item.packUnitPlural)}
								${variant.quantityUnits > 0 ? ` + ${variant.quantityUnits} ${getUnitLabel(variant.quantityUnits, item.baseUnitSingular, item.baseUnitPlural)}` : ''}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${formatDate(variant.expiry)}</td>
							<td style="padding: 8px; border: 1px solid #ddd; font-weight: bold; color: ${daysToExpiry < 0 ? '#d32f2f' : daysToExpiry <= 7 ? '#f57c00' : '#f9a825'};">
								${daysToExpiry < 0 ? `${Math.abs(daysToExpiry)} ×™××™× ××—×¨×™` : `${daysToExpiry} ×™××™×`}
							</td>
							<td style="padding: 8px; border: 1px solid #ddd;">${status}</td>
						</tr>`;
					});
					
					if (expiringItems.length === 0) {
						html += '<tr><td colspan="6" style="text-align: center; padding: 20px;">××™×Ÿ ××•×¦×¨×™× ×¢× ×ª×¤×•×’×” ×§×¨×•×‘×” ğŸ‰</td></tr>';
					}
					
					html += '</tbody></table>';
					break;

				case 'movements':
					html = '<h3>×“×•×— ×ª× ×•×¢×•×ª ××—×¨×•× ×•×ª</h3>';
					html += '<div style="margin: 10px 0;">';
					html += '<label>×ª×§×•×¤×”: ';
					html += '<select id="movementsPeriod" onchange="regenerateReport(\'movements\')" style="padding: 5px;">';
					html += '<option value="7">7 ×™××™× ××—×¨×•× ×™×</option>';
					html += '<option value="30" selected>30 ×™××™× ××—×¨×•× ×™×</option>';
					html += '<option value="90">90 ×™××™× ××—×¨×•× ×™×</option>';
					html += '<option value="all">×”×›×œ</option>';
					html += '</select></label>';
					html += '</div>';
					
					const periodDays = parseInt(document.getElementById('movementsPeriod')?.value || '30');
					const cutoffDate = new Date();
					if (periodDays !== 'all') {
						cutoffDate.setDate(cutoffDate.getDate() - periodDays);
					}

					const recentMovements = movements.filter(m => {
						if (!m.date) return false;
						if (periodDays === 'all') return true;
						
						const moveDate = parseHebrewDate(m.date);
						if (!moveDate) return false;
						
						return moveDate >= cutoffDate;
					});

					// ××™×•×Ÿ ×œ×¤×™ ×ª××¨×™×š ×™×•×¨×“
					recentMovements.sort((a, b) => {
						const dateA = parseHebrewDate(a.date);
						const dateB = parseHebrewDate(b.date);
						if (!dateA || !dateB) return 0;
						return dateB - dateA;
					});

					if (recentMovements.length === 0) {
						html += '<p style="text-align: center; padding: 20px;">××™×Ÿ ×ª× ×•×¢×•×ª ×‘×ª×§×•×¤×” ×©× ×‘×—×¨×”</p>';
					} else {
						html += '<table style="width:100%; margin-top:20px; border-collapse: collapse;">';
						html += '<thead><tr style="background: #34495e; color: white;">';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×ª××¨×™×š</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×©×¢×”</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">××•×¦×¨</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×¤×¢×•×œ×”</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×›××•×ª</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">××™×§×•×</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">××©×ª××©</th>';
						html += '<th style="padding: 10px; border: 1px solid #ddd;">×”×¢×¨×•×ª</th>';
						html += '</tr></thead>';
						html += '<tbody>';
						
						recentMovements.forEach(movement => {
							let rowStyle = '';
							if (movement.type === '×”×•×¦××”') {
								rowStyle = 'background: #ffebee;';
							} else if (movement.type === '×”×›× ×¡×”') {
								rowStyle = 'background: #e8f5e9;';
							} else if (movement.type && movement.type.includes('×‘×™×˜×•×œ')) {
								rowStyle = 'background: #fff3cd; font-style: italic;';
							}
							
							html += `<tr style="${rowStyle} border: 1px solid #ddd;">
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.date}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.time || ''}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.product}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.type}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.quantityPacks || 0} ×—×‘'${movement.quantityUnits > 0 ? ' + ' + movement.quantityUnits + ' ×™×—×™×“×•×ª' : ''}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.location || '-'}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.user || ''}</td>
								<td style="padding: 8px; border: 1px solid #ddd;">${movement.notes || ''}</td>
							</tr>`;
						});
						
						html += '</tbody></table>';
						
						// ×¡×™×›×•× ×¡×˜×˜×™×¡×˜×™
						const inMovements = recentMovements.filter(m => m.type === '×”×›× ×¡×”').length;
						const outMovements = recentMovements.filter(m => m.type === '×”×•×¦××”').length;
						const cancelMovements = recentMovements.filter(m => m.type && m.type.includes('×‘×™×˜×•×œ')).length;
						
						html += '<div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">';
						html += '<h4>×¡×™×›×•×:</h4>';
						html += `<p>×¡×”"×› ×ª× ×•×¢×•×ª: ${recentMovements.length}</p>`;
						html += `<p>×”×›× ×¡×•×ª: ${inMovements} | ×”×•×¦××•×ª: ${outMovements} | ×‘×™×˜×•×œ×™×: ${cancelMovements}</p>`;
						html += '</div>';
					}
					break;
			}
			
			html += '<div style="margin-top:30px; text-align: center;">';
			html += `<button onclick="exportReport('${type}')" class="btn-small" style="margin-right:10px;">×™×™×¦×•× ×œ-CSV</button>`;
			html += `<button onclick="printReport('${type}')" class="btn-small">×”×“×¤×¡×”</button>`;
			html += '</div>';
			
			reportContent.innerHTML = html;
		};
		
		function updateGenerateReportForMobile() {
			const originalGenerateReport = window.generateReport;
			
			window.generateReport = function(type) {
				// ×§×¨× ×œ×¤×•× ×§×¦×™×” ×”××§×•×¨×™×ª
				originalGenerateReport(type);
				
				// ×”×•×¡×£ ×ª×•×•×™×•×ª data-label ×œ×˜×‘×œ××•×ª ×‘××•×‘×™×™×œ
				if (window.innerWidth <= 768) {
					setTimeout(() => {
						const tables = document.querySelectorAll('#reportContent table');
						tables.forEach(table => {
							const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent);
							
							table.querySelectorAll('tbody tr').forEach(row => {
								const cells = row.querySelectorAll('td');
								cells.forEach((cell, index) => {
									if (headers[index]) {
										cell.setAttribute('data-label', headers[index] + ':');
									}
								});
							});
						});
					}, 100);
				}
			};
		}

		// ×”×¤×¢×œ ××ª ×”×¢×“×›×•×Ÿ
		document.addEventListener('DOMContentLoaded', updateGenerateReportForMobile);

		// ×¤×•× ×§×¦×™×” ×œ×¨×¢× ×•×Ÿ ×“×•×—
		window.regenerateReport = function(type) {
			generateReport(type);
		};
        window.exportReport = function(type) {
            // ×¤×•× ×§×¦×™×•× ×œ×™×•×ª ×™×™×¦×•× CSV × ×©××¨×ª ×›×¤×™ ×©×”×™×™×ª×”
            showToast('×™×™×¦×•× CSV ×œ× ×–××™×Ÿ ×‘×“××• ×–×”', 'info');
        };

        window.printReport = function(type) {
            window.print();
        };

        // --- ×˜×¤×¡×™× ---
        document.getElementById('addItemForm').addEventListener('submit', async function(e) {
			e.preventDefault();

			// ×‘×“×•×§ ×©×œ× × ×‘×—×¨ "×”×•×¡×£ ×™×—×™×“×” ×—×“×©×”"
			const unitFields = ['baseUnitSingular', 'baseUnitPlural', 'packUnitSingular', 'packUnitPlural'];
			for (const fieldId of unitFields) {
				const field = document.getElementById(fieldId);
				if (field && field.value === '__add_new__') {
					showToast('×™×© ×œ×‘×—×•×¨ ×™×—×™×“×ª ××™×“×” ××• ×œ×”×•×¡×™×£ ×—×“×©×”', 'error');
					field.focus();
					return;
				}
				if (field && !field.value) {
					showToast('×™×© ×œ××œ× ××ª ×›×œ ×©×“×•×ª ×™×—×™×“×•×ª ×”××™×“×”', 'error');
					field.focus();
					return;
				}
			}

			try {
				// × ×¨××œ ××ª ×©× ×”××•×¦×¨
				const rawName = document.getElementById('itemName').value;
				const normalizedName = rawName.trim().replace(/\s+/g, ' ');
				
				if (normalizedName.length < 2) {
					showToast('×©× ×”××•×¦×¨ ×—×™×™×‘ ×œ×”×›×™×œ ×œ×¤×—×•×ª 2 ×ª×•×•×™×', 'error');
					document.getElementById('itemName').focus();
					return;
				}
				
				// ×‘×“×•×§ ×× ×”××•×¦×¨ ×›×‘×¨ ×§×™×™× (×‘×“×™×§×” ××“×•×™×§×ª)
				const exactMatch = inventory.find(item => 
					normalizeProductName(item.name) === normalizeProductName(normalizedName)
				);
				
				if (exactMatch) {
					showToast(`××•×¦×¨ ×‘×©× "${exactMatch.name}" ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª`, 'error');
					document.getElementById('itemName').focus();
					return;
				}
				
				// ×—×¤×© ××•×¦×¨×™× ×“×•××™×
				const similarProducts = findSimilarProducts(normalizedName, 0.7);
				
				if (similarProducts.length > 0) {
					const similarNames = similarProducts.slice(0, 3).map(p => p.name).join(', ');
					const message = `× ××¦××• ××•×¦×¨×™× ×“×•××™×: ${similarNames}.\n×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×•×¡×™×£ ××•×¦×¨ ×—×“×©?`;
					
					if (!confirm(message)) {
						document.getElementById('itemName').focus();
						return;
					}
				}
				
				const variants = [];
				const variantRows = document.querySelectorAll('#variantsContainer .form-row');
				
				if (variantRows.length === 0) {
					showToast('×™×© ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×¤×¨×™×˜ ××—×“', 'error');
					return;
				}
				
				// ×‘×“×•×§ ×ª×§×™× ×•×ª ×©×œ ×›×œ ×•×¨×™×× ×˜
				const variantKeys = new Set();
				
				for (const variantRow of variantRows) {
					const location = variantRow.querySelector('.variant-location').value;
					if (!location) {
						showToast('×™×© ×œ×‘×—×•×¨ ××™×§×•× ×œ×›×œ ×”×¤×¨×™×˜×™×', 'error');
						variantRow.querySelector('.variant-location').focus();
						return;
					}
					
					const quantityPacks = parseInt(variantRow.querySelector('.variant-quantityPacks').value) || 0;
					const quantityUnits = parseInt(variantRow.querySelector('.variant-quantityUnits').value) || 0;
					const expiry = variantRow.querySelector('.variant-expiry').value;
					
					if (quantityPacks === 0 && quantityUnits === 0) {
						showToast('×™×© ×œ×”×–×™×Ÿ ×›××•×ª ×œ×›×œ ×¤×¨×™×˜ (×—×‘×™×œ×•×ª ××• ×™×—×™×“×•×ª)', 'error');
						variantRow.querySelector('.variant-quantityPacks').focus();
						return;
					}
					
					// ×‘×“×•×§ ×›×¤×™×œ×•×ª ×•×¨×™×× ×˜×™×
					const variantKey = `${location}|${expiry}`;
					if (variantKeys.has(variantKey)) {
						showToast(`×›×‘×¨ ×§×™×™× ×¤×¨×™×˜ ×¢× ××•×ª×• ××™×§×•× ×•×ª××¨×™×š ×ª×¤×•×’×” (${location})`, 'error');
						variantRow.querySelector('.variant-location').focus();
						return;
					}
					variantKeys.add(variantKey);
					
					variants.push({
						quantityPacks: quantityPacks,
						quantityUnits: quantityUnits,
						location: location,
						expiry: expiry
					});
				}

				const newItem = {
					name: normalizedName, // ×”×©×ª××© ×‘×©× ×”×× ×•×¨××œ
					category: document.getElementById('itemCategory').value,
					minPacks: parseInt(document.getElementById('minPacks').value) || 0,
					baseUnitSingular: document.getElementById('baseUnitSingular').value,
					baseUnitPlural: document.getElementById('baseUnitPlural').value,
					packUnitSingular: document.getElementById('packUnitSingular').value,
					packUnitPlural: document.getElementById('packUnitPlural').value,
					unitsPerPack: parseInt(document.getElementById('unitsPerPack').value) || 1,
					variants: variants
				};

				await saveInventoryItem(newItem);
				inventory.push(newItem);
				updateStats();
				showToast('×”×¤×¨×™×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
				this.reset();
				document.getElementById('variantsContainer').innerHTML = '';
				addVariant(); // ×”×•×¡×£ ×•×¨×™×× ×˜ ×¨×™×§ ×—×“×©
				showTab('inventory');
				
			} catch (error) {
				console.error('Error adding item:', error);
				showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×¤×¨×™×˜: ' + error.message, 'error');
			}
		});

        document.getElementById('transactionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const now = new Date();
            const date = getFormattedDate();
            const time = getFormattedTime();
            const user = currentUser.fullName;

            const rows = document.querySelectorAll('#multiTransactionRows .form-row');
            let anySuccess = false;
            const errorMessages = [];

            for (const row of rows) {
                const productSelect = row.querySelector('.transProductSelect');
                const typeSelect = row.querySelector('.transTypeSelect');
                const quantityPacksInput = row.querySelector('.transQuantityPacksInput');
                const quantityUnitsInput = row.querySelector('.transQuantityUnitsInput');
                const notesInput = row.querySelector('.transNotesInput');

                if (!productSelect.value || !typeSelect.value) {
                    errorMessages.push('×œ× × ×‘×—×¨ ××•×¦×¨ ××• ×¡×•×’ ×¤×¢×•×œ×” ×‘××—×ª ×”×©×•×¨×•×ª');
                    continue;
                }

                const productName = productSelect.value;
                const transType = typeSelect.value;
                const quantityPacks = parseInt(quantityPacksInput.value) || 0;
                const quantityUnits = parseInt(quantityUnitsInput.value) || 0;
                const notes = notesInput.value;

                if (quantityPacks === 0 && quantityUnits === 0) {
                    errorMessages.push(`×™×© ×œ×”×–×™×Ÿ ×›××•×ª ×—×•×§×™×ª ×‘-${productName}`);
                    continue;
                }

                const item = inventory.find(i => i.name === productName);
                if (!item) {
                    errorMessages.push(`×”××•×¦×¨ "${productName}" ×œ× × ××¦×`);
                    continue;
                }

                try {
                    if (transType === '×”×•×¦××”') {
						// ×œ×•×’×™×§×” ×œ×”×•×¦××” ××”××œ××™
						const { plan, leftPacks, leftUnits } = pickVariantsForQuantity(item, quantityPacks, quantityUnits);
						
						if (leftPacks > 0 || leftUnits > 0) {
							errorMessages.push(`××™×Ÿ ××¡×¤×™×§ ××œ××™ ×œ-${item.name} (×—×¡×¨×•×ª ${leftPacks} ×—×‘×™×œ×•×ª ×•-${leftUnits} ×™×—×™×“×•×ª)`);
							continue;
						}

						for (const pick of plan) {
							const variant = item.variants[pick.variantIndex];
							
							// ×”×•×¨×“ ××ª ×”×—×‘×™×œ×•×ª
							variant.quantityPacks -= pick.takePacks;
							
							// ×”×•×¨×“ ××ª ×”×™×—×™×“×•×ª
							variant.quantityUnits -= pick.takeUnits;
							
							// ×× ×¤×¨×˜× ×• ×—×‘×™×œ×•×ª, ×”×•×¡×£ ×‘×—×–×¨×” ××ª ×”×™×—×™×“×•×ª ×”×¢×•×“×¤×•×ª
							if (pick.returnUnits > 0) {
								variant.quantityUnits += pick.returnUnits;
							}
							
							// ×—×©×‘ ××ª ×”×›××•×ª × ×˜×• ×©× ×œ×§×—×”
							const netUnits = (pick.takePacks * item.unitsPerPack) + pick.takeUnits - (pick.returnUnits || 0);
							const netPacks = Math.floor(netUnits / item.unitsPerPack);
							const netLooseUnits = netUnits % item.unitsPerPack;
							
							await saveMovement({
								date, time,
								product: item.name,
								location: variant.location,
								expiry: variant.expiry,
								type: transType,
								quantityPacks: netPacks,
								quantityUnits: netLooseUnits,
								user,
								notes: notes + (pick.returnUnits > 0 ? ` (×¤×•×¨×˜×” ×—×‘×™×œ×”)` : '')
							});
						}
						
						anySuccess = true;
					} else {
                        // ×”×›× ×¡×” ×œ××œ××™ - ×”×•×¡×¤×” ×œ×•×•×¨×™×× ×˜ ×”×¨××©×•×Ÿ
                        if (!item.variants || item.variants.length === 0) {
                            errorMessages.push(`××™×Ÿ ×•×¨×™×× ×˜×™× ×¤×¢×™×œ×™× ×œ-${item.name}`);
                            continue;
                        }
                        
                        item.variants[0].quantityPacks += quantityPacks;
                        item.variants[0].quantityUnits += quantityUnits;
                        
                        await saveMovement({
                            date, time,
                            product: item.name,
                            location: item.variants[0].location,
                            expiry: item.variants[0].expiry,
                            type: transType,
                            quantityPacks,
                            quantityUnits,
                            user,
                            notes
                        });
                        
                        anySuccess = true;
                    }
                    
                    await saveInventoryItem(item);
                    
                } catch (error) {
                    console.error('Error processing transaction:', error);
                    errorMessages.push(`×©×’×™××” ×‘×¢×™×‘×•×“ ${productName}: ${error.message}`);
                }
            }

            if (anySuccess) {
                await loadAllData();
                updateStats();
                showToast('×”×ª× ×•×¢×•×ª × ×¨×©××• ×‘×”×¦×œ×—×”!', 'success');
                this.reset();
                document.getElementById('multiTransactionRows').innerHTML = '';
                addTransactionRow();
                displayMovements();
            }
            
            if (errorMessages.length) {
                showToast(errorMessages.join('\n'), 'error');
            }
        });

        // ×¤×•× ×§×¦×™×” ×¢×–×¨ ×œ×—×œ×•×§×ª ×•×¨×™×× ×˜×™×
        function pickVariantsForQuantity(item, packsNeeded, unitsNeeded) {
			const plan = [];
			let toTakePacks = packsNeeded;
			let toTakeUnits = unitsNeeded;
			
			// ××™×•×Ÿ ×•×¨×™×× ×˜×™× ×œ×¤×™ ×ª×•×§×£ ×¢×•×œ×” (FEFO)
			const sortedVariants = (item.variants || []).map((v, idx) => ({...v, idx}))
				.sort((a, b) => {
					if (!a.expiry) return 1;
					if (!b.expiry) return -1;
					return new Date(a.expiry) - new Date(b.expiry);
				});

			// ×©×œ×‘ 1: × ×¡×” ×œ×§×—×ª ×—×‘×™×œ×•×ª ×©×œ××•×ª
			for (const variant of sortedVariants) {
				if (toTakePacks <= 0) break;
				
				const availablePacks = variant.quantityPacks || 0;
				if (availablePacks > 0) {
					const takePacks = Math.min(toTakePacks, availablePacks);
					plan.push({
						variantIndex: variant.idx,
						takePacks: takePacks,
						takeUnits: 0,
						location: variant.location,
						expiry: variant.expiry
					});
					toTakePacks -= takePacks;
				}
			}

			// ×©×œ×‘ 2: × ×¡×” ×œ×§×—×ª ×™×—×™×“×•×ª ×‘×•×“×“×•×ª
			for (const variant of sortedVariants) {
				if (toTakeUnits <= 0) break;
				
				const availableUnits = variant.quantityUnits || 0;
				if (availableUnits > 0) {
					const takeUnits = Math.min(toTakeUnits, availableUnits);
					// ×‘×“×•×§ ×× ×›×‘×¨ ×™×© ×ª×•×›× ×™×ª ×œ×•×•×¨×™×× ×˜ ×”×–×”
					const existingPlan = plan.find(p => p.variantIndex === variant.idx);
					if (existingPlan) {
						existingPlan.takeUnits += takeUnits;
					} else {
						plan.push({
							variantIndex: variant.idx,
							takePacks: 0,
							takeUnits: takeUnits,
							location: variant.location,
							expiry: variant.expiry
						});
					}
					toTakeUnits -= takeUnits;
				}
			}

			// ×©×œ×‘ 3: ×× ×¢×“×™×™×Ÿ ×—×¡×¨×•×ª ×™×—×™×“×•×ª, × ×¡×” ×œ×¤×¨×•×˜ ×—×‘×™×œ×•×ª
			if (toTakeUnits > 0 && item.unitsPerPack > 0) {
				for (const variant of sortedVariants) {
					if (toTakeUnits <= 0) break;
					
					const availablePacks = variant.quantityPacks || 0;
					// ×‘×“×•×§ ×›××” ×—×‘×™×œ×•×ª ×›×‘×¨ ××ª×•×›× × ×•×ª ×œ×§×—×ª ××•×•×¨×™×× ×˜ ×–×”
					const plannedPacks = plan.find(p => p.variantIndex === variant.idx)?.takePacks || 0;
					const remainingPacks = availablePacks - plannedPacks;
					
					if (remainingPacks > 0) {
						// ×—×©×‘ ×›××” ×—×‘×™×œ×•×ª × ×¦×˜×¨×š ×œ×¤×¨×•×˜
						const packsToBreak = Math.ceil(toTakeUnits / item.unitsPerPack);
						const actualPacksToBreak = Math.min(packsToBreak, remainingPacks);
						
						if (actualPacksToBreak > 0) {
							// ××¦× ××• ×¦×•×¨ ×ª×•×›× ×™×ª ×œ×•×•×¨×™×× ×˜ ×”×–×”
							const existingPlan = plan.find(p => p.variantIndex === variant.idx);
							if (existingPlan) {
								existingPlan.takePacks += actualPacksToBreak;
								// × ×•×ª×Ÿ ××ª ×›×œ ×”×™×—×™×“×•×ª ××”×—×‘×™×œ×•×ª ×©× ×¤×¨×˜×•, ×¤×—×•×ª ××” ×©×× ×—× ×• ×¦×¨×™×›×™×
								const totalUnitsFromPacks = actualPacksToBreak * item.unitsPerPack;
								const unitsToReturn = Math.max(0, totalUnitsFromPacks - toTakeUnits);
								existingPlan.returnUnits = (existingPlan.returnUnits || 0) + unitsToReturn;
							} else {
								const totalUnitsFromPacks = actualPacksToBreak * item.unitsPerPack;
								const unitsToReturn = Math.max(0, totalUnitsFromPacks - toTakeUnits);
								plan.push({
									variantIndex: variant.idx,
									takePacks: actualPacksToBreak,
									takeUnits: 0,
									returnUnits: unitsToReturn,
									location: variant.location,
									expiry: variant.expiry
								});
							}
							toTakeUnits -= Math.min(toTakeUnits, actualPacksToBreak * item.unitsPerPack);
						}
					}
				}
			}
			
			return {plan, leftPacks: toTakePacks, leftUnits: toTakeUnits};
		}
        document.getElementById('addUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!currentUser.permissions.includes('manage_users')) {
                showToast('××™×Ÿ ×œ×š ×”×¨×©××” ×œ× ×”×œ ××©×ª××©×™×', 'error');
                return;
            }
            
            try {
                const permissions = [];
                document.querySelectorAll('#addUserForm input[type="checkbox"]:checked').forEach(cb => {
                    permissions.push(cb.id.replace('perm_', ''));
                });
                
                const newUser = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value,
                    fullName: document.getElementById('newFullName').value,
                    role: document.getElementById('newRole').value,
                    permissions: permissions
                };
                
                if (users.find(u => u.username === newUser.username)) {
                    showToast('×©× ××©×ª××© ×–×” ×›×‘×¨ ×§×™×™× ×‘××¢×¨×›×ª', 'error');
                    return;
                }
                
                await saveUser(newUser);
                users.push(newUser);
                showToast('×”××©×ª××© × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                this.reset();
                displayUsers();
            } catch (error) {
                showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ×”××©×ª××©', 'error');
            }
        });

        document.getElementById('editUserForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const originalUsername = document.getElementById('editUserOriginalUsername').value;
                const newUsername = document.getElementById('editUsername').value;

                const user = users.find(u => u.username === originalUsername);
                if (!user) {
                    showToast('××©×ª××© ×œ× × ××¦×', 'error');
                    return;
                }

                // ×¢×“×›×•×Ÿ ×¤×¨×˜×™ ×”××©×ª××©
                user.fullName = document.getElementById('editFullName').value;
                user.role = document.getElementById('editUserRole').value;

                // ×¢×“×›×•×Ÿ ×©× ××©×ª××© (×× ×©×•× ×”)
                if (originalUsername !== newUsername) {
                    await deleteUserFromDB(originalUsername);
                    user.username = newUsername;
                }

                // ×¢×“×›×•×Ÿ ×¡×™×¡××” ×¨×§ ×× ×”×•×–× ×” ×¡×™×¡××” ×—×“×©×”
                const newPassword = document.getElementById('editPassword').value;
                if (newPassword) {
                    user.password = newPassword;
                }

                // ×¢×“×›×•×Ÿ ×”×¨×©××•×ª
                const permissions = [];
                document.querySelectorAll('#editUserForm input[type="checkbox"]:checked').forEach(cb => {
                    permissions.push(cb.id.replace('edit_perm_', ''));
                });
                user.permissions = permissions;

                await saveUser(user);
                showToast('×”××©×ª××© ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
                closeEditUserModal();
                displayUsers();
            } catch (error) {
                showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××©×ª××©', 'error');
            }
        });

        document.getElementById('editItemForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const originalName = document.getElementById('editItemOriginalName').value;
                const item = inventory.find(i => i.name === originalName);
                if (!item) return;

                const newName = document.getElementById('editItemName').value;

                item.name = newName;
                item.category = document.getElementById('editItemCategory').value;
                item.baseUnitSingular = document.getElementById('editBaseUnitSingular').value;
                item.baseUnitPlural = document.getElementById('editBaseUnitPlural').value;
                item.packUnitSingular = document.getElementById('editPackUnitSingular').value;
                item.packUnitPlural = document.getElementById('editPackUnitPlural').value;
                item.unitsPerPack = parseInt(document.getElementById('editUnitsPerPack').value) || 1;
                item.minPacks = parseInt(document.getElementById('editMinPacks').value) || 0;

                // ×× ×”×©× ×”×©×ª× ×”, ××—×§ ××ª ×”××•×¦×¨ ×”×§×•×“× ×‘Ö¾Firebase
                if (originalName !== newName) {
                    await deleteInventoryItem(originalName);
                }

                await saveInventoryItem(item);
                await loadAllData();
                updateStats();
                showToast('×”××•×¦×¨ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
                closeEditModal();
                displayInventory();
            } catch (error) {
                showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××•×¦×¨', 'error');
            }
        });

        document.getElementById('editVariantForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            try {
                const productName = document.getElementById('editVariantProductName').value;
                const variantIndex = parseInt(document.getElementById('editVariantIndex').value);
                const item = inventory.find(i => i.name === productName);

                if (!item || !item.variants || !item.variants[variantIndex]) return;

                item.variants[variantIndex] = {
                    quantityPacks: parseInt(document.getElementById('editVariantQuantityPacks').value) || 0,
                    quantityUnits: parseInt(document.getElementById('editVariantQuantityUnits').value) || 0,
                    location: document.getElementById('editVariantLocation').value,
                    expiry: document.getElementById('editVariantExpiry').value
                };

                await saveInventoryItem(item);
                await loadAllData();
                updateStats();
                showToast('×”×•×•×¨×™×× ×˜ ×¢×•×“×›×Ÿ ×‘×”×¦×œ×—×”!', 'success');
                closeEditVariantModal();
                displayInventory();
            } catch (error) {
                showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×•×•×¨×™×× ×˜', 'error');
            }
        });

        document.getElementById('addVariantForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const productName = document.getElementById('addVariantProductName').value;
                const item = inventory.find(i => i.name === productName);
                if (!item) {
                    showToast('××•×¦×¨ ×œ× × ××¦×', 'error');
                    return;
                }
                
                const newVariant = {
                    quantityPacks: parseInt(document.getElementById('addVariantQuantityPacks').value) || 0,
                    quantityUnits: parseInt(document.getElementById('addVariantQuantityUnits').value) || 0,
                    location: document.getElementById('addVariantLocation').value,
                    expiry: document.getElementById('addVariantExpiry').value
                };
                
                if (!item.variants) item.variants = [];
                item.variants.push(newVariant);
                
                await saveInventoryItem(item);
                await loadAllData();
                updateStats();
                showToast('×”×•×•×¨×™×× ×˜ × ×•×¡×£ ×‘×”×¦×œ×—×”!', 'success');
                closeAddVariantModal();
                displayInventory();
            } catch (error) {
                showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×•×•×¨×™×× ×˜', 'error');
            }
        });

        document.getElementById('editMovementForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const id = document.getElementById('editMovementId').value;
                await db.collection('movements').doc(id).update({
                    product: document.getElementById('editMovementProduct').value,
                    type: document.getElementById('editMovementType').value,
                    quantityPacks: parseInt(document.getElementById('editMovementQuantityPacks').value) || 0,
                    quantityUnits: parseInt(document.getElementById('editMovementQuantityUnits').value) || 0,
                    notes: document.getElementById('editMovementNotes').value
                });
                
                await loadMovementsOnly();
                displayMovements();
                showToast('×”×ª× ×•×¢×” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”!', 'success');
                closeEditMovementModal();
            } catch (error) {
                showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª× ×•×¢×”', 'error');
            }
        });

        // --- ×˜×™×¤×•×œ ×‘×‘×—×™×¨×” "×”×•×¡×£ ×™×—×™×“×” ×—×“×©×”" ---
        document.addEventListener('change', function(e) {
			if (!e.target || !e.target.tagName || e.target.tagName !== 'SELECT') return;
			
			const handleUnitChange = (targetId, list, storageKey, promptText) => {
				if (e.target.id === targetId && e.target.value === '__add_new__') {
					e.preventDefault();
					
					const newUnit = prompt(promptText);
					if (newUnit && newUnit.trim()) {
						const trimmedUnit = newUnit.trim();
						
						// ×‘×“×•×§ ×× ×”×™×—×™×“×” ×›×‘×¨ ×§×™×™××ª
						if (list.includes(trimmedUnit)) {
							alert('×™×—×™×“×” ×–×• ×›×‘×¨ ×§×™×™××ª ×‘×¨×©×™××”');
							populateUnitsSelect(e.target, list);
							return;
						}
						
						// ×”×•×¡×£ ×œ×¨×©×™××”
						list.push(trimmedUnit);
						list.sort(); // ××™×•×Ÿ ××œ×¤×‘×™×ª×™
						
						// ×©××•×¨ ×‘-localStorage
						localStorage.setItem(storageKey, JSON.stringify(list));
						
						// ×¢×“×›×Ÿ ××ª ×”×¨×©×™××” ×”× ×¤×ª×—×ª ×¢× ×”×¢×¨×š ×”×—×“×© ×›×‘×¨×™×¨×ª ××—×“×œ
						populateUnitsSelect(e.target, list, trimmedUnit);
						
						// ×›×¤×” ××ª ×”×¢×¨×š ×”×—×“×© ×¢×œ ×”-select
						setTimeout(() => {
							e.target.value = trimmedUnit;
						}, 0);
					} else {
						// ×× ×‘×™×˜×œ×• ××• ×œ× ×”×–×™× ×• ×›×œ×•×, ××¤×¡ ××ª ×”×‘×—×™×¨×”
						e.target.value = "";
					}
				}
			};

			handleUnitChange('baseUnitSingular', baseUnitsSingularList, 'baseUnitsSingularList', '×”×–×Ÿ ×©× ×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×™×—×™×“) ×—×“×©×”:');
			handleUnitChange('baseUnitPlural', baseUnitsPluralList, 'baseUnitsPluralList', '×”×–×Ÿ ×©× ×™×—×™×“×ª ××™×“×” ×‘×¡×™×¡×™×ª (×¨×‘×™×) ×—×“×©×”:');
			handleUnitChange('packUnitSingular', packUnitsSingularList, 'packUnitsSingularList', '×”×–×Ÿ ×©× ×™×—×™×“×ª ××¨×™×–×” (×™×—×™×“) ×—×“×©×”:');
			handleUnitChange('packUnitPlural', packUnitsPluralList, 'packUnitsPluralList', '×”×–×Ÿ ×©× ×™×—×™×“×ª ××¨×™×–×” (×¨×‘×™×) ×—×“×©×”:');
		});

		// ×¢×“×›×Ÿ ×’× ××ª ×”×¤×•× ×§×¦×™×” populateUnitsSelect:
		function populateUnitsSelect(selectElement, list, selectedValue = "") {
			if (!selectElement) return;
			
			// ×©××•×¨ ××ª ×”×¢×¨×š ×”× ×•×›×—×™ ×× ×œ× ×¡×•×¤×§ ×¢×¨×š ×—×“×©
			const currentValue = selectedValue || selectElement.value;
			
			selectElement.innerHTML = "";
			
			// ××•×¤×¦×™×™×ª ×‘×¨×™×¨×ª ××—×“×œ
			const defaultOpt = document.createElement("option");
			defaultOpt.value = "";
			defaultOpt.textContent = "×‘×—×¨ ×™×—×™×“×”";
			defaultOpt.disabled = true;
			defaultOpt.selected = !currentValue;
			selectElement.appendChild(defaultOpt);

			// ×”×•×¡×£ ××ª ×›×œ ×”××•×¤×¦×™×•×ª
			list.forEach(unit => {
				const option = document.createElement("option");
				option.value = unit;
				option.textContent = unit;
				option.selected = (currentValue === unit);
				selectElement.appendChild(option);
			});
			
			// ××•×¤×¦×™×” ×œ×”×•×¡×¤×ª ×™×—×™×“×” ×—×“×©×”
			const addNew = document.createElement("option");
			addNew.value = "__add_new__";
			addNew.textContent = "â• ×”×•×¡×£ ×™×—×™×“×” ×—×“×©×”...";
			addNew.style.fontWeight = "bold";
			addNew.style.borderTop = "1px solid #ddd";
			selectElement.appendChild(addNew);
			
			// ×•×•×“× ×©×”×¢×¨×š × ×‘×—×¨
			if (currentValue && currentValue !== "__add_new__") {
				selectElement.value = currentValue;
			}
		}

		// ×¢×“×›×Ÿ ×’× ××ª ×”×¤×•× ×§×¦×™×” populateUnitsSelect:
		function populateUnitsSelect(selectElement, list, selectedValue = "") {
			if (!selectElement) return;
			
			// ×©××•×¨ ××ª ×”×¢×¨×š ×”× ×•×›×—×™ ×× ×œ× ×¡×•×¤×§ ×¢×¨×š ×—×“×©
			const currentValue = selectedValue || selectElement.value;
			
			selectElement.innerHTML = "";
			
			// ××•×¤×¦×™×™×ª ×‘×¨×™×¨×ª ××—×“×œ
			const defaultOpt = document.createElement("option");
			defaultOpt.value = "";
			defaultOpt.textContent = "×‘×—×¨ ×™×—×™×“×”";
			defaultOpt.disabled = true;
			defaultOpt.selected = !currentValue;
			selectElement.appendChild(defaultOpt);

			// ×”×•×¡×£ ××ª ×›×œ ×”××•×¤×¦×™×•×ª
			list.forEach(unit => {
				const option = document.createElement("option");
				option.value = unit;
				option.textContent = unit;
				option.selected = (currentValue === unit);
				selectElement.appendChild(option);
			});
			
			// ××•×¤×¦×™×” ×œ×”×•×¡×¤×ª ×™×—×™×“×” ×—×“×©×”
			const addNew = document.createElement("option");
			addNew.value = "__add_new__";
			addNew.textContent = "â• ×”×•×¡×£ ×™×—×™×“×” ×—×“×©×”...";
			addNew.style.fontWeight = "bold";
			addNew.style.borderTop = "1px solid #ddd";
			selectElement.appendChild(addNew);
			
			// ×•×•×“× ×©×”×¢×¨×š × ×‘×—×¨
			if (currentValue && currentValue !== "__add_new__") {
				selectElement.value = currentValue;
			}
		}

        // --- ×¡×’×™×¨×ª ××•×“×œ×™× ×‘×œ×—×™×¦×” ××—×•×¥ ×œ×ª×•×›×Ÿ ---
        window.onclick = function(event) {
            const modals = ['editModal', 'editVariantModal', 'editUserModal', 'addVariantModal', 'editMovementModal', 'editPickingModal'];
            modals.forEach(modalId => {
                const modal = document.getElementById(modalId);
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        };

        // --- ××ª×—×•×œ ---
        document.addEventListener('DOMContentLoaded', function() {
            // ×”×•×¡×¤×ª ×©×•×¨×ª ×ª× ×•×¢×” ×¨××©×•× ×”
            const transactionContainer = document.getElementById('multiTransactionRows');
            if (transactionContainer) {
                addTransactionRow();
            }

            // ×”×•×¡×¤×ª ×•×¨×™×× ×˜ ×¨××©×•×Ÿ ×‘×”×•×¡×¤×ª ××•×¦×¨
            const variantsContainer = document.getElementById('variantsContainer');
            if (variantsContainer) {
                addVariant();
            }
        });
		
		// ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™ ×©×œ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×›×œ ×“×§×”
		let statsInterval = null;

		function startStatsRefresh() {
			// ×¢×¦×•×¨ ×¨×¢× ×•×Ÿ ×§×•×“× ×× ×§×™×™×
			if (statsInterval) {
				clearInterval(statsInterval);
			}
			
			// ×¢×“×›×Ÿ ××™×™×“×™×ª
			updateStats();
			
			// ×”×’×“×¨ ×¨×¢× ×•×Ÿ ×›×œ 60 ×©× ×™×•×ª
			statsInterval = setInterval(() => {
				updateStats();
				
				// ×‘×“×•×§ ×× ×¢×‘×¨× ×• ×œ×ª××¨×™×š ×—×“×© (××—×¨×™ ×—×¦×•×ª)
				const currentDate = getFormattedDate();
				if (window.lastCheckedDate && window.lastCheckedDate !== currentDate) {
					// ×˜×¢×Ÿ ××—×“×© ××ª ×”×ª× ×•×¢×•×ª ×× ×¢×‘×¨ ×™×•×
					loadMovementsOnly().then(() => {
						updateStats();
					});
				}
				window.lastCheckedDate = currentDate;
				
			}, 60000); // ×›×œ 60 ×©× ×™×•×ª
		}
		
		// === FAB Menu Functions ===
		function toggleFabMenu() {
			const fabMenu = document.getElementById('fabMenu');
			const fabButton = document.getElementById('fabButton');
			
			if (fabMenu.classList.contains('show')) {
				closeFabMenu();
			} else {
				openFabMenu();
			}
		}

		function openFabMenu() {
			const fabMenu = document.getElementById('fabMenu');
			const fabButton = document.getElementById('fabButton');
			const fabMenuItems = document.getElementById('fabMenuItems');
			
			// ×©× ×” ××ª ×”×ª×•×›×Ÿ ×œ-X
			fabButton.innerHTML = 'âœ•';
			
			// ×‘× ×” ××ª ×”×ª×¤×¨×™×˜ ×œ×¤×™ ×”×¨×©××•×ª
			fabMenuItems.innerHTML = '';
			
			// ×¨×™×©×•× ×ª× ×•×¢×”
			if (currentUser.permissions.includes('add_transaction')) {
				const item = createFabMenuItem('ğŸ“', '×¨×™×©×•× ×ª× ×•×¢×”', 'transaction', () => {
					closeFabMenu();
					showTab('transaction');
				});
				fabMenuItems.appendChild(item);
			}
			
			// ×”×•×¡×¤×ª ××•×¦×¨
			if (currentUser.permissions.includes('add_item')) {
				const item = createFabMenuItem('ğŸ“¦', '××•×¦×¨ ×—×“×©', 'product', () => {
					closeFabMenu();
					showTab('addItem');
				});
				fabMenuItems.appendChild(item);
			}
			
			// ×”×•×¡×¤×ª ××©×ª××©
			if (currentUser.permissions.includes('manage_users')) {
				const item = createFabMenuItem('ğŸ‘¤', '××©×ª××© ×—×“×©', 'user', () => {
					closeFabMenu();
					showTab('users');
					setTimeout(() => {
						document.getElementById('addUserForm').scrollIntoView({ behavior: 'smooth' });
					}, 300);
				});
				fabMenuItems.appendChild(item);
			}
			
			// ×”×¦×’ ××ª ×”×ª×¤×¨×™×˜
			fabMenu.style.display = 'block';
			fabMenu.style.visibility = 'visible';
			
			// ×”×•×¡×£ ×× ×™××¦×™×” ×¢× delay ×§×˜×Ÿ
			requestAnimationFrame(() => {
				fabButton.classList.add('menu-open');
				fabMenu.classList.add('show');
			});
		}

		function closeFabMenu() {
			const fabMenu = document.getElementById('fabMenu');
			const fabButton = document.getElementById('fabButton');
			
			// ×”×—×–×¨ ××ª ×”×ª×•×›×Ÿ ×œ-+
			fabButton.innerHTML = 'â•';
			
			// ×”×¡×¨ ××ª ×”××—×œ×§×•×ª ×œ×× ×™××¦×™×™×ª ×¡×’×™×¨×”
			fabButton.classList.remove('menu-open');
			fabMenu.classList.remove('show');
			
			// ×”×¡×ª×¨ ×œ×’××¨×™ ××—×¨×™ ×”×× ×™××¦×™×”
			setTimeout(() => {
				fabMenu.style.visibility = 'hidden';
				fabMenu.style.display = 'none';
			}, 300);
		}

		// ×¢×“×›×Ÿ ××ª createFabMenuItem ×œ×”×•×¡×™×£ ××¤×§×˜ hover
		function createFabMenuItem(icon, label, className, onClick) {
			const item = document.createElement('div');
			item.className = 'fab-menu-item';
			item.style.cursor = 'pointer';
			
			const labelEl = document.createElement('span');
			labelEl.className = 'fab-menu-label';
			labelEl.textContent = label;
			
			const button = document.createElement('button');
			button.className = `fab-menu-button ${className}`;
			button.innerHTML = icon;
			button.type = 'button';
			
			// ××¤×§×˜ ripple ×¢×œ ×œ×—×™×¦×”
			button.addEventListener('click', function(e) {
				const ripple = document.createElement('span');
				ripple.className = 'ripple';
				this.appendChild(ripple);
				
				const rect = this.getBoundingClientRect();
				const x = e.clientX - rect.left;
				const y = e.clientY - rect.top;
				
				ripple.style.left = x + 'px';
				ripple.style.top = y + 'px';
				
				setTimeout(() => ripple.remove(), 600);
			});
			
			// ×¤×•× ×§×¦×™×™×ª ×”×œ×—×™×¦×”
			const handleClick = function(e) {
				e.preventDefault();
				e.stopPropagation();
				onClick();
			};
			
			item.addEventListener('click', handleClick);
			button.addEventListener('click', handleClick);
			
			item.appendChild(labelEl);
			item.appendChild(button);
			
			return item;
		}

		function stopStatsRefresh() {
			if (statsInterval) {
				clearInterval(statsInterval);
				statsInterval = null;
			}
		}
		
		function toggleTheme() {
			const html = document.documentElement;
			const currentTheme = html.getAttribute('data-theme');
			
			// ×”×•×¡×£ class ×œ×× ×™×¢×ª transitions
			html.classList.add('theme-transition');
			
			if (currentTheme === 'dark') {
				html.setAttribute('data-theme', 'light');
				localStorage.setItem('theme', 'light');
				document.getElementById('themeIcon').textContent = 'ğŸŒ™';
			} else {
				html.setAttribute('data-theme', 'dark');
				localStorage.setItem('theme', 'dark');
				document.getElementById('themeIcon').textContent = 'â˜€ï¸';
			}
			
			// ×”×¡×¨ ××ª ×”-class ××—×¨×™ ×§×¦×ª ×–××Ÿ
			setTimeout(() => {
				html.classList.remove('theme-transition');
			}, 100);
		}

		function applyTheme(theme) {
			const root = document.documentElement;
			const icon = document.getElementById('themeIcon');
			
			if (theme === 'dark') {
				root.setAttribute('data-theme', 'dark');
				icon.textContent = 'â˜€ï¸';
			} else if (theme === 'light') {
				root.setAttribute('data-theme', 'light');
				icon.textContent = 'ğŸŒ™';
			} else {
				root.removeAttribute('data-theme');
				icon.textContent = 'ğŸŒ“';
			}
		}

		// Apply saved theme on load
		window.addEventListener('DOMContentLoaded', () => {
			const savedTheme = localStorage.getItem('theme');
			
			// ×”×•×¡×£ class ×œ×× ×™×¢×ª transitions ×‘×˜×¢×™× ×” ×¨××©×•× ×™×ª
			document.documentElement.classList.add('theme-transition');
			
			if (savedTheme === 'dark') {
				document.documentElement.setAttribute('data-theme', 'dark');
				document.getElementById('themeIcon').textContent = 'â˜€ï¸';
			} else {
				document.documentElement.setAttribute('data-theme', 'light');
				document.getElementById('themeIcon').textContent = 'ğŸŒ™';
			}
			
			// ×”×¡×¨ ××ª ×”-class ××—×¨×™ ×”×˜×¢×™× ×”
			setTimeout(() => {
				document.documentElement.classList.remove('theme-transition');
			}, 100);
		});

		// ×¢×“×›×Ÿ ××ª showMainScreen ×œ×”×¤×¢×™×œ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
		const originalShowMainScreen = showMainScreen;
		showMainScreen = function() {
			originalShowMainScreen();
			startStatsRefresh();
		};

		// ×¢×“×›×Ÿ ××ª logout ×œ×¢×¦×•×¨ ×¨×¢× ×•×Ÿ ××•×˜×•××˜×™
		const originalLogout = logout;
		logout = function() {
			stopStatsRefresh();
			originalLogout();
		};

		// ×¢×“×›×Ÿ ××ª window.addEventListener ×›×“×™ ×œ× ×§×•×ª ×‘×¢×ª ×¡×’×™×¨×ª ×”×“×£
		window.addEventListener('beforeunload', () => {
			stopStatsRefresh();
		});
		
		// ×‘×“×•×§ ×”×¨×©××•×ª ×›×œ 5 ×“×§×•×ª
		setInterval(() => {
			if (currentUser) {
				checkRealtimePermissions();
			}
		}, 300000); // 300000ms = 5 ×“×§×•×ª
		
		// PWA Support
		if ('serviceWorker' in navigator) {
			navigator.serviceWorker.register('/sw.js').catch(() => {
				// Service worker registration failed
			});
		}

		// Add to home screen prompt
		let deferredPrompt;
		window.addEventListener('beforeinstallprompt', (e) => {
			e.preventDefault();
			deferredPrompt = e;
		});
		
		// === Create Service Worker File ===
		function createServiceWorker() {
			const swContent = `
		// Service Worker for offline support
		const CACHE_NAME = 'cinema-inventory-v1';
		const urlsToCache = [
		  '/',
		  '/index.html',
		  '/pick.html'
		];

		self.addEventListener('install', event => {
		  event.waitUntil(
			caches.open(CACHE_NAME)
			  .then(cache => cache.addAll(urlsToCache))
		  );
		});

		self.addEventListener('fetch', event => {
		  event.respondWith(
			caches.match(event.request)
			  .then(response => response || fetch(event.request))
		  );
		});`;
			
			console.log('Service Worker code:', swContent);
			console.log('×¦×•×¨ ×§×•×‘×¥ ×‘×©× sw.js ×•×”×¢×ª×§ ××ª ×”×§×•×“ ××”-console');
		}
		// === ×©×œ×‘ 1: ×¤×•× ×§×¦×™×•×ª ×‘×¡×™×¡ ×œ× ×™×ª×•×— ×¦×¨×™×›×” ===

		/**
		 * ×× ×ª×— ××ª ×”×™×¡×˜×•×¨×™×™×ª ×”×¦×¨×™×›×” ×©×œ ××•×¦×¨ ×¡×¤×¦×™×¤×™
		 * @param {string} productName - ×©× ×”××•×¦×¨
		 * @param {number} daysBack - ×›××” ×™××™× ××—×•×¨×” ×œ× ×ª×— (×‘×¨×™×¨×ª ××—×“×œ: 90)
		 * @returns {Object} ××•×‘×™×™×§×˜ ×¢× × ×ª×•× ×™ × ×™×ª×•×— ××¤×•×¨×˜×™×
		 */
		function analyzeProductConsumption(productName, daysBack = 90) {
			const endDate = new Date();
			const startDate = new Date();
			startDate.setDate(startDate.getDate() - daysBack);
			
			// ×¡× ×Ÿ ×¨×§ ×ª× ×•×¢×•×ª ×”×•×¦××” ×©×œ ×”××•×¦×¨ ×‘×˜×•×•×— ×”×–××Ÿ
			const productMovements = movements.filter(m => 
				m.product === productName && 
				m.type === '×”×•×¦××”' &&
				m.date && 
				parseHebrewDate(m.date) >= startDate
			);
			
			if (productMovements.length === 0) {
				return {
					productName,
					hasData: false,
					message: '××™×Ÿ × ×ª×•× ×™ ×¦×¨×™×›×” ×‘×ª×§×•×¤×” ×”××‘×•×§×©×ª'
				};
			}
			
			// ×—×©×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×‘×¡×™×¡×™×•×ª
			const stats = calculateConsumptionStats(productMovements, startDate, endDate);
			
			// ×–×”×” ×“×¤×•×¡×™ ×¦×¨×™×›×”
			const patterns = identifyConsumptionPatterns(productMovements);
			
			// ×—×©×‘ ××’××•×ª
			const trends = calculateTrends(productMovements, startDate);
			
			return {
				productName,
				hasData: true,
				period: {
					start: startDate,
					end: endDate,
					days: daysBack
				},
				stats,
				patterns,
				trends,
				movements: productMovements
			};
		}

		/**
		 * ×—×™×©×•×‘ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×¦×¨×™×›×” ×‘×¡×™×¡×™×•×ª
		 */
		function calculateConsumptionStats(movements, startDate, endDate) {
			// ×—×©×‘ ×¡×š ×¦×¨×™×›×”
			const totalPacks = movements.reduce((sum, m) => sum + (m.quantityPacks || 0), 0);
			const totalUnits = movements.reduce((sum, m) => sum + (m.quantityUnits || 0), 0);
			
			// ×—×©×‘ ××¡×¤×¨ ×™××™× ×‘×¤×•×¢×œ (×œ× ×›×•×œ×œ ×™××™× ×œ×œ× ×¤×¢×™×œ×•×ª)
			const activeDays = new Set(movements.map(m => m.date)).size;
			const totalDays = Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24));
			
			// ×—×©×‘ ×××•×¦×¢×™×
			const avgPacksPerDay = totalPacks / totalDays;
			const avgPacksPerActiveDay = totalPacks / activeDays;
			
			// ××¦× ××™× ×™××•× ×•××§×¡×™××•× ×™×•××™
			const dailyConsumption = groupMovementsByDay(movements);
			const dailyAmounts = Object.values(dailyConsumption).map(d => d.packs);
			
			return {
				total: {
					packs: totalPacks,
					units: totalUnits
				},
				average: {
					packsPerDay: parseFloat(avgPacksPerDay.toFixed(2)),
					packsPerActiveDay: parseFloat(avgPacksPerActiveDay.toFixed(2))
				},
				days: {
					total: totalDays,
					active: activeDays,
					activePercentage: parseFloat(((activeDays / totalDays) * 100).toFixed(1))
				},
				range: {
					min: Math.min(...dailyAmounts, 0),
					max: Math.max(...dailyAmounts, 0),
					variance: calculateVariance(dailyAmounts)
				}
			};
		}

		/**
		 * ×–×™×”×•×™ ×“×¤×•×¡×™ ×¦×¨×™×›×” (×™××™ ×©×‘×•×¢, ×¡×•×¤×™ ×©×‘×•×¢, ×—×’×™×)
		 */
		function identifyConsumptionPatterns(movements) {
			const patterns = {
				byDayOfWeek: {
					0: { name: '×¨××©×•×Ÿ', total: 0, count: 0 },
					1: { name: '×©× ×™', total: 0, count: 0 },
					2: { name: '×©×œ×™×©×™', total: 0, count: 0 },
					3: { name: '×¨×‘×™×¢×™', total: 0, count: 0 },
					4: { name: '×—××™×©×™', total: 0, count: 0 },
					5: { name: '×©×™×©×™', total: 0, count: 0 },
					6: { name: '×©×‘×ª', total: 0, count: 0 }
				},
				byTimeOfDay: {
					morning: { range: '06:00-12:00', total: 0, count: 0 },
					afternoon: { range: '12:00-18:00', total: 0, count: 0 },
					evening: { range: '18:00-23:00', total: 0, count: 0 },
					night: { range: '23:00-06:00', total: 0, count: 0 }
				},
				weekendVsWeekday: {
					weekend: { total: 0, days: 0 },
					weekday: { total: 0, days: 0 }
				}
			};
			
			// ×§×‘×¥ ×ª× ×•×¢×•×ª ×œ×¤×™ ×™×•×
			const dailyData = groupMovementsByDay(movements);
			
			// × ×ª×— ×›×œ ×™×•×
			Object.entries(dailyData).forEach(([dateStr, dayData]) => {
				const date = parseHebrewDate(dateStr);
				if (!date) return;
				
				const dayOfWeek = date.getDay();
				const isWeekend = dayOfWeek === 5 || dayOfWeek === 6;
				
				// ×¢×“×›×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª ×™×•× ×‘×©×‘×•×¢
				patterns.byDayOfWeek[dayOfWeek].total += dayData.packs;
				patterns.byDayOfWeek[dayOfWeek].count += 1;
				
				// ×¢×“×›×Ÿ ×¡×•×£ ×©×‘×•×¢ ××•×œ ×××¦×¢ ×©×‘×•×¢
				if (isWeekend) {
					patterns.weekendVsWeekday.weekend.total += dayData.packs;
					patterns.weekendVsWeekday.weekend.days += 1;
				} else {
					patterns.weekendVsWeekday.weekday.total += dayData.packs;
					patterns.weekendVsWeekday.weekday.days += 1;
				}
			});
			
			// ×—×©×‘ ×××•×¦×¢×™× ×œ×›×œ ×“×¤×•×¡
			Object.values(patterns.byDayOfWeek).forEach(day => {
				day.average = day.count > 0 ? parseFloat((day.total / day.count).toFixed(2)) : 0;
			});
			
			patterns.weekendVsWeekday.weekend.average = 
				patterns.weekendVsWeekday.weekend.days > 0 
				? parseFloat((patterns.weekendVsWeekday.weekend.total / patterns.weekendVsWeekday.weekend.days).toFixed(2))
				: 0;
				
			patterns.weekendVsWeekday.weekday.average = 
				patterns.weekendVsWeekday.weekday.days > 0
				? parseFloat((patterns.weekendVsWeekday.weekday.total / patterns.weekendVsWeekday.weekday.days).toFixed(2))
				: 0;
			
			return patterns;
		}

		/**
		 * ×—×™×©×•×‘ ××’××•×ª (×¢×œ×™×™×”/×™×¨×™×“×” ×‘×¦×¨×™×›×”)
		 */
		function calculateTrends(movements, startDate) {
			const weeklyData = groupMovementsByWeek(movements, startDate);
			
			if (weeklyData.length < 2) {
				return {
					hasEnoughData: false,
					message: '××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×œ×—×™×©×•×‘ ××’××”'
				};
			}
			
			// ×—×©×‘ ×××•×¦×¢ × ×¢
			const movingAverage = calculateMovingAverage(weeklyData.map(w => w.total), 3);
			
			// ×—×©×‘ ×©×™×¤×•×¢ ×”××’××”
			const trendSlope = calculateTrendSlope(weeklyData.map(w => w.total));
			
			// ×–×”×” ××’××”
			let trendDirection;
			if (Math.abs(trendSlope) < 0.1) {
				trendDirection = 'stable';
			} else if (trendSlope > 0) {
				trendDirection = 'increasing';
			} else {
				trendDirection = 'decreasing';
			}
			
			// ×—×©×‘ ××—×•×– ×©×™× ×•×™ ×‘×™×Ÿ ×ª×—×™×œ×ª ×œ×¡×•×£ ×”×ª×§×•×¤×”
			const firstWeekAvg = weeklyData.slice(0, 2).reduce((sum, w) => sum + w.total, 0) / 2;
			const lastWeekAvg = weeklyData.slice(-2).reduce((sum, w) => sum + w.total, 0) / 2;
			const changePercentage = ((lastWeekAvg - firstWeekAvg) / firstWeekAvg) * 100;
			
			return {
				hasEnoughData: true,
				direction: trendDirection,
				slope: parseFloat(trendSlope.toFixed(3)),
				changePercentage: parseFloat(changePercentage.toFixed(1)),
				weeklyData,
				movingAverage
			};
		}

		// === ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ ===

		/**
		 * ×§×™×‘×•×¥ ×ª× ×•×¢×•×ª ×œ×¤×™ ×™×•×
		 */
		function groupMovementsByDay(movements) {
			const grouped = {};
			
			movements.forEach(m => {
				if (!m.date) return;
				
				if (!grouped[m.date]) {
					grouped[m.date] = {
						date: m.date,
						packs: 0,
						units: 0,
						count: 0
					};
				}
				
				grouped[m.date].packs += m.quantityPacks || 0;
				grouped[m.date].units += m.quantityUnits || 0;
				grouped[m.date].count += 1;
			});
			
			return grouped;
		}

		/**
		 * ×§×™×‘×•×¥ ×ª× ×•×¢×•×ª ×œ×¤×™ ×©×‘×•×¢
		 */
		function groupMovementsByWeek(movements, startDate) {
			const weeks = [];
			const weekMap = new Map();
			
			movements.forEach(m => {
				const date = parseHebrewDate(m.date);
				if (!date) return;
				
				const weekNumber = getWeekNumber(date, startDate);
				
				if (!weekMap.has(weekNumber)) {
					weekMap.set(weekNumber, {
						week: weekNumber,
						total: 0,
						count: 0,
						movements: []
					});
				}
				
				const week = weekMap.get(weekNumber);
				week.total += m.quantityPacks || 0;
				week.count += 1;
				week.movements.push(m);
			});
			
			// ×”××¨ ×œ××¢×¨×š ×•××™×™×Ÿ
			return Array.from(weekMap.values()).sort((a, b) => a.week - b.week);
		}

		/**
		 * ×—×™×©×•×‘ ××¡×¤×¨ ×©×‘×•×¢ ×™×—×¡×™
		 */
		function getWeekNumber(date, startDate) {
			const diffTime = Math.abs(date - startDate);
			const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
			return Math.floor(diffDays / 7);
		}

		/**
		 * ×—×™×©×•×‘ ×©×•× ×•×ª
		 */
		function calculateVariance(values) {
			if (values.length === 0) return 0;
			
			const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
			const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
			const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / values.length;
			
			return parseFloat(Math.sqrt(variance).toFixed(2));
		}

		/**
		 * ×—×™×©×•×‘ ×××•×¦×¢ × ×¢
		 */
		function calculateMovingAverage(values, period) {
			const result = [];
			
			for (let i = 0; i < values.length; i++) {
				const start = Math.max(0, i - period + 1);
				const subset = values.slice(start, i + 1);
				const avg = subset.reduce((sum, val) => sum + val, 0) / subset.length;
				result.push(parseFloat(avg.toFixed(2)));
			}
			
			return result;
		}

		/**
		 * ×—×™×©×•×‘ ×©×™×¤×•×¢ ××’××” (linear regression)
		 */
		function calculateTrendSlope(values) {
			const n = values.length;
			if (n < 2) return 0;
			
			let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
			
			for (let i = 0; i < n; i++) {
				sumX += i;
				sumY += values[i];
				sumXY += i * values[i];
				sumX2 += i * i;
			}
			
			const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
			return slope;
		}

		// === ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×” ===
		function testConsumptionAnalysis() {
			// ×‘×“×•×§ ×©×”× ×ª×•× ×™× ×˜×¢×•× ×™×
			if (typeof movements === 'undefined' || !Array.isArray(movements)) {
				console.error('××©×ª× ×” movements ×œ× × ××¦×. ×•×•×“× ×©××ª×” ××—×•×‘×¨ ×œ××¢×¨×›×ª ×•×©×”× ×ª×•× ×™× × ×˜×¢× ×•.');
				console.log('× ×¡×” ×œ×”×¨×™×¥ ×§×•×“×: await loadAllData()');
				return;
			}
			
			if (typeof inventory === 'undefined' || !Array.isArray(inventory)) {
				console.error('××©×ª× ×” inventory ×œ× × ××¦×. ×•×•×“× ×©××ª×” ××—×•×‘×¨ ×œ××¢×¨×›×ª.');
				return;
			}
			
			console.log(`× ××¦××• ${movements.length} ×ª× ×•×¢×•×ª ×•-${inventory.length} ××•×¦×¨×™×`);
			
			// ×‘×—×¨ ××•×¦×¨ ×¤×•×¤×•×œ×¨×™ ×œ×‘×“×™×§×”
			const popularProducts = inventory
				.filter(item => {
					const itemMovements = movements.filter(m => 
						m.product === item.name && m.type === '×”×•×¦××”'
					);
					return itemMovements.length > 5; // ×”×•×¨×“×ª×™ ×œ-5 ×ª× ×•×¢×•×ª ×œ×¤×—×•×ª
				})
				.map(item => ({
					name: item.name,
					movementCount: movements.filter(m => 
						m.product === item.name && m.type === '×”×•×¦××”'
					).length
				}))
				.sort((a, b) => b.movementCount - a.movementCount);
			
			if (popularProducts.length === 0) {
				console.log('××™×Ÿ ××•×¦×¨×™× ×¢× ××¡×¤×™×§ ×ª× ×•×¢×•×ª ×”×•×¦××”.');
				console.log('××•×¦×¨×™× ×¢× ×ª× ×•×¢×•×ª ×”×•×¦××”:');
				inventory.forEach(item => {
					const count = movements.filter(m => 
						m.product === item.name && m.type === '×”×•×¦××”'
					).length;
					if (count > 0) {
						console.log(`- ${item.name}: ${count} ×ª× ×•×¢×•×ª`);
					}
				});
				return;
			}
			
			console.log('××•×¦×¨×™× ×¤×•×¤×•×œ×¨×™×™×:');
			popularProducts.slice(0, 5).forEach(p => {
				console.log(`- ${p.name}: ${p.movementCount} ×ª× ×•×¢×•×ª`);
			});
			
			const testProduct = popularProducts[0].name;
			console.log(`\n×× ×ª×— ×¦×¨×™×›×” ×¢×‘×•×¨: ${testProduct}`);
			
			const analysis = analyzeProductConsumption(testProduct, 90);
			
			// ×”×¦×’ ×ª×•×¦××•×ª ×‘×¦×•×¨×” ×™×“×™×“×•×ª×™×ª
			if (analysis.hasData) {
				console.log('\nğŸ“Š ×¡×™×›×•× × ×™×ª×•×—:');
				console.log(`×ª×§×•×¤×”: ${analysis.period.days} ×™××™×`);
				console.log(`×¡×”"×› × ×¦×¨×š: ${analysis.stats.total.packs} ×—×‘×™×œ×•×ª`);
				console.log(`×××•×¦×¢ ×™×•××™: ${analysis.stats.average.packsPerDay} ×—×‘×™×œ×•×ª`);
				console.log(`×™××™× ×¤×¢×™×œ×™×: ${analysis.stats.days.active} ××ª×•×š ${analysis.stats.days.total} (${analysis.stats.days.activePercentage}%)`);
				
				if (analysis.patterns) {
					console.log('\nğŸ“… ×“×¤×•×¡×™ ×¦×¨×™×›×” ×œ×¤×™ ×™×•×:');
					Object.values(analysis.patterns.byDayOfWeek).forEach(day => {
						if (day.count > 0) {
							console.log(`${day.name}: ${day.average} ×—×‘×™×œ×•×ª ×‘×××•×¦×¢`);
						}
					});
					
					console.log('\nğŸ¯ ×”×©×•×•××ª ×¡×•×£ ×©×‘×•×¢:');
					console.log(`×××¦×¢ ×©×‘×•×¢: ${analysis.patterns.weekendVsWeekday.weekday.average} ×—×‘×™×œ×•×ª ×‘×××•×¦×¢`);
					console.log(`×¡×•×£ ×©×‘×•×¢: ${analysis.patterns.weekendVsWeekday.weekend.average} ×—×‘×™×œ×•×ª ×‘×××•×¦×¢`);
				}
				
				if (analysis.trends && analysis.trends.hasEnoughData) {
					console.log('\nğŸ“ˆ ××’××•×ª:');
					console.log(`×›×™×•×•×Ÿ: ${analysis.trends.direction === 'increasing' ? 'â¬†ï¸ ×¢×œ×™×™×”' : 
										analysis.trends.direction === 'decreasing' ? 'â¬‡ï¸ ×™×¨×™×“×”' : 'â¡ï¸ ×™×¦×™×‘'}`);
					console.log(`×©×™× ×•×™: ${analysis.trends.changePercentage}%`);
				}
			}
			
			return analysis;
		}

		// ×¤×•× ×§×¦×™×” × ×•×¡×¤×ª ×œ×‘×“×™×§×” ××”×™×¨×”
		function quickAnalyzeProduct(productName) {
			if (!productName) {
				console.log('×©×™××•×©: quickAnalyzeProduct("×©× ×”××•×¦×¨")');
				return;
			}
			
			const analysis = analyzeProductConsumption(productName, 30);
			if (!analysis.hasData) {
				console.log(`×œ× × ××¦××• × ×ª×•× ×™ ×¦×¨×™×›×” ×¢×‘×•×¨ "${productName}"`);
				return;
			}
			
			console.log(`× ×™×ª×•×— ××”×™×¨ ×œ-${productName}:`);
			console.log(`- ×¦×¨×™×›×” ×™×•××™×ª ×××•×¦×¢×ª: ${analysis.stats.average.packsPerDay} ×—×‘×™×œ×•×ª`);
			console.log(`- ×¡×”"×› ×‘-30 ×™××™×: ${analysis.stats.total.packs} ×—×‘×™×œ×•×ª`);
			
			return analysis;
		}
		// === ×©×œ×‘ 2: ××•×“×œ ×—×™×–×•×™ ×¦×¨×™×›×” ×—×›× ===

		/**
		 * ×× ×•×¢ ×”×—×™×–×•×™ ×”×¨××©×™
		 * @param {string} productName - ×©× ×”××•×¦×¨
		 * @param {number} daysToPredict - ×›××” ×™××™× ×§×“×™××” ×œ×—×–×•×ª (×‘×¨×™×¨×ª ××—×“×œ: 30)
		 * @param {Object} options - ××¤×©×¨×•×™×•×ª × ×•×¡×¤×•×ª ×œ×—×™×–×•×™
		 * @returns {Object} ×ª×—×–×™×ª ××¤×•×¨×˜×ª
		 */
		function predictConsumption(productName, daysToPredict = 30, options = {}) {
			// ×‘×¨×™×¨×•×ª ××—×“×œ ×œ××¤×©×¨×•×™×•×ª
			const settings = {
				analysisHistory: 90,        // ×›××” ×™××™× ××—×•×¨×” ×œ× ×ª×—
				confidenceLevel: 0.95,      // ×¨××ª ×”×‘×™×˜×—×•×Ÿ ×œ×—×™×–×•×™
				includeSeasonality: true,   // ×›×œ×•×œ ×¢×•× ×ª×™×•×ª
				includeEvents: true,        // ×›×œ×•×œ ××™×¨×•×¢×™× ××™×•×—×“×™×
				safetyFactor: 1.2,         // ××§×“× ×‘×™×˜×—×•×Ÿ (20% × ×•×¡×£)
				...options
			};
			
			// ×©×œ×‘ 1: × ×ª×— ×”×™×¡×˜×•×¨×™×”
			const analysis = analyzeProductConsumption(productName, settings.analysisHistory);
			
			if (!analysis.hasData) {
				return {
					success: false,
					message: '××™×Ÿ ××¡×¤×™×§ × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× ×œ×—×™×–×•×™',
					productName
				};
			}
			
			// ×©×œ×‘ 2: ×–×”×” ×’×•×¨××™× ××©×¤×™×¢×™×
			const factors = identifyInfluencingFactors(analysis, productName);
			
			// ×©×œ×‘ 3: ×‘× ×” ××•×“×œ ×—×™×–×•×™
			const model = buildPredictionModel(analysis, factors, settings);
			
			// ×©×œ×‘ 4: ×—×©×‘ ×ª×—×–×™×ª
			const forecast = calculateForecast(model, daysToPredict, settings);
			
			// ×©×œ×‘ 5: ×”×•×¡×£ ×”××œ×¦×•×ª
			const recommendations = generateRecommendations(forecast, analysis, productName);
			
			return {
				success: true,
				productName,
				analysis: {
					period: analysis.period,
					averageDaily: analysis.stats.average.packsPerDay,
					trend: analysis.trends
				},
				factors,
				forecast,
				recommendations,
				confidence: calculateConfidenceScore(analysis, model)
			};
		}

		/**
		 * ×–×™×”×•×™ ×’×•×¨××™× ××©×¤×™×¢×™× ×¢×œ ×”×¦×¨×™×›×”
		 */
		function identifyInfluencingFactors(analysis, productName) {
			const factors = {
				dayOfWeek: {},
				seasonality: {},
				events: [],
				correlation: {}
			};
			
			// 1. ×”×©×¤×¢×ª ×™×•× ×‘×©×‘×•×¢
			if (analysis.patterns && analysis.patterns.byDayOfWeek) {
				const avgDaily = analysis.stats.average.packsPerDay;
				
				Object.entries(analysis.patterns.byDayOfWeek).forEach(([day, data]) => {
					if (data.count > 0) {
						factors.dayOfWeek[day] = {
							name: data.name,
							multiplier: data.average / avgDaily,
							confidence: Math.min(data.count / 4, 1) // ×¦×¨×™×š ×œ×¤×—×•×ª 4 ×©×‘×•×¢×•×ª
						};
					}
				});
			}
			
			// 2. ×–×™×”×•×™ ×¢×•× ×ª×™×•×ª (×§×™×¥/×—×•×¨×£)
			factors.seasonality = detectSeasonality(analysis.movements);
			
			// 3. ×–×™×”×•×™ ××™×¨×•×¢×™× ××™×•×—×“×™× (×—×’×™×, ×—×•×¤×©×•×ª)
			factors.events = detectSpecialEvents(analysis.movements);
			
			// 4. ××ª×× ×¢× ××•×¦×¨×™× ××—×¨×™× (×œ××©×œ: ×¤×•×¤×§×•×¨×Ÿ ×¢× ××©×§××•×ª)
			factors.correlation = findProductCorrelations(productName, analysis.movements);
			
			return factors;
		}

		/**
		 * ×‘× ×™×™×ª ××•×“×œ ×”×—×™×–×•×™
		 */
		function buildPredictionModel(analysis, factors, settings) {
			const model = {
				baseline: analysis.stats.average.packsPerDay,
				trend: {
					slope: analysis.trends.slope || 0,
					confidence: analysis.trends.hasEnoughData ? 0.8 : 0.3
				},
				seasonality: factors.seasonality,
				dayOfWeekMultipliers: factors.dayOfWeek,
				variance: analysis.stats.range.variance,
				method: determinebestMethod(analysis)
			};
			
			// ×”×ª×× ××ª ×”××•×“×œ ×‘×”×ª×× ×œ×›××•×ª ×•××™×›×•×ª ×”× ×ª×•× ×™×
			if (analysis.stats.days.active < 30) {
				model.method = 'simple_average';
				model.confidence = 0.5;
			} else if (analysis.stats.days.active < 60) {
				model.method = 'weighted_average';
				model.confidence = 0.7;
			} else {
				model.method = 'advanced_prediction';
				model.confidence = 0.9;
			}
			
			return model;
		}

		/**
		 * ×—×™×©×•×‘ ×”×ª×—×–×™×ª
		 */
		function calculateForecast(model, daysToPredict, settings) {
			const forecast = {
				daily: [],
				weekly: [],
				total: 0,
				range: { min: 0, max: 0 }
			};
			
			const today = new Date();
			let runningTotal = 0;
			let weeklyTotal = 0;
			let currentWeek = [];
			
			for (let i = 0; i < daysToPredict; i++) {
				const forecastDate = new Date(today);
				forecastDate.setDate(today.getDate() + i);
				
				// ×—×™×©×•×‘ ×¦×¨×™×›×” ×¦×¤×•×™×” ×œ×™×•×
				let predictedAmount = model.baseline;
				
				// ×”×—×œ ××›×¤×™×œ ×™×•× ×‘×©×‘×•×¢
				const dayOfWeek = forecastDate.getDay();
				if (model.dayOfWeekMultipliers[dayOfWeek]) {
					predictedAmount *= model.dayOfWeekMultipliers[dayOfWeek].multiplier;
				}
				
				// ×”×—×œ ××’××”
				if (model.trend.slope !== 0) {
					predictedAmount += model.trend.slope * (i / 7); // ×©×™× ×•×™ ×©×‘×•×¢×™
				}
				
				// ×”×—×œ ×¢×•× ×ª×™×•×ª
				const month = forecastDate.getMonth();
				if (model.seasonality[month]) {
					predictedAmount *= model.seasonality[month].multiplier;
				}
				
				// ×”×•×¡×£ ×©×•× ×•×ª ××§×¨××™×ª (××‘×•×¡×¡×ª ×¢×œ ×”×©×•× ×•×ª ×”×”×™×¡×˜×•×¨×™×ª)
				if (model.variance > 0) {
					const randomFactor = 1 + (Math.random() - 0.5) * (model.variance / model.baseline);
					predictedAmount *= randomFactor;
				}
				
				// ×”×—×œ ××§×“× ×‘×™×˜×—×•×Ÿ
				predictedAmount *= settings.safetyFactor;
				
				// ×¢×™×’×•×œ ×œ××¡×¤×¨ ×©×œ×
				predictedAmount = Math.round(predictedAmount);
				
				const dailyForecast = {
					date: forecastDate.toISOString().split('T')[0],
					dayName: ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™', '×©×‘×ª'][dayOfWeek],
					predicted: predictedAmount,
					confidence: model.confidence
				};
				
				forecast.daily.push(dailyForecast);
				runningTotal += predictedAmount;
				weeklyTotal += predictedAmount;
				currentWeek.push(dailyForecast);
				
				// ×¡×™×›×•× ×©×‘×•×¢×™
				if ((i + 1) % 7 === 0 || i === daysToPredict - 1) {
					forecast.weekly.push({
						weekNumber: Math.floor(i / 7) + 1,
						total: weeklyTotal,
						average: weeklyTotal / currentWeek.length,
						days: [...currentWeek]
					});
					weeklyTotal = 0;
					currentWeek = [];
				}
			}
			
			forecast.total = runningTotal;
			forecast.range.min = Math.round(runningTotal * 0.8); // 20% ×¤×—×•×ª
			forecast.range.max = Math.round(runningTotal * 1.2); // 20% ×™×•×ª×¨
			
			return forecast;
		}

		/**
		 * ×™×¦×™×¨×ª ×”××œ×¦×•×ª ×—×›××•×ª
		 */
		function generateRecommendations(forecast, analysis, productName) {
			const recommendations = [];
			const product = inventory.find(p => p.name === productName);
			
			if (!product) return recommendations;
			
			// 1. ×”××œ×¦×ª ×›××•×ª ×œ×”×–×× ×”
			const currentStock = totalPacksAndUnits(product)[0];
			const daysOfStock = currentStock / analysis.stats.average.packsPerDay;
			
			if (daysOfStock < 7) {
				recommendations.push({
					type: 'urgent',
					title: '×“×¨×•×©×” ×”×–×× ×” ×“×—×•×¤×”!',
					description: `× ×•×ª×¨ ××œ××™ ×œ-${Math.floor(daysOfStock)} ×™××™× ×‘×œ×‘×“`,
					suggestedOrder: Math.ceil(forecast.weekly[0].total * 4) // ××œ××™ ×œ-4 ×©×‘×•×¢×•×ª
				});
			} else if (daysOfStock < 14) {
				recommendations.push({
					type: 'warning',
					title: '××•××œ×¥ ×œ×”×–××™×Ÿ ×‘×§×¨×•×‘',
					description: `×”××œ××™ ×™×¡×¤×™×§ ×œ×›-${Math.floor(daysOfStock)} ×™××™×`,
					suggestedOrder: Math.ceil(forecast.total)
				});
			}
			
			// 2. ×”×ª×¨××” ×¢×œ ××’××•×ª
			if (analysis.trends.direction === 'increasing' && analysis.trends.changePercentage > 20) {
				recommendations.push({
					type: 'trend',
					title: '××’××ª ×¢×œ×™×™×” ×‘×¦×¨×™×›×”',
					description: `×”×¦×¨×™×›×” ×¢×œ×ª×” ×‘-${analysis.trends.changePercentage}% - ×©×§×•×œ ×œ×”×’×“×™×œ ××œ××™ ××™× ×™××•×`
				});
			}
			
			// 3. ×”××œ×¦×•×ª ×œ×™××™× ×¡×¤×¦×™×¤×™×™×
			const highDemandDays = forecast.daily
				.filter(day => day.predicted > analysis.stats.average.packsPerDay * 1.5)
				.slice(0, 3);
			
			if (highDemandDays.length > 0) {
				recommendations.push({
					type: 'planning',
					title: '×™××™× ×¢× ×¦×¨×™×›×” ×’×‘×•×”×” ×¦×¤×•×™×”',
					description: highDemandDays.map(d => `${d.dayName} ${d.date}: ${d.predicted} ×—×‘×™×œ×•×ª`).join(', ')
				});
			}
			
			// 4. ×”××œ×¦×ª ××•×¤×˜×™××™×–×¦×™×”
			if (analysis.stats.range.variance > analysis.stats.average.packsPerDay * 0.5) {
				recommendations.push({
					type: 'optimization',
					title: '×©×•× ×•×ª ×’×‘×•×”×” ×‘×¦×¨×™×›×”',
					description: '×©×§×•×œ ×œ×‘×“×•×§ ×¡×™×‘×•×ª ×œ×ª× ×•×“×•×ª ×”×—×¨×™×’×•×ª ×•×œ×©×¤×¨ ××ª ×“×™×•×§ ×”×ª×—×–×™×ª'
				});
			}
			
			return recommendations;
		}

		// === ×¤×•× ×§×¦×™×•×ª ×¢×–×¨ × ×•×¡×¤×•×ª ===

		/**
		 * ×–×™×”×•×™ ×¢×•× ×ª×™×•×ª
		 */
		function detectSeasonality(movements) {
			const monthlyData = {};
			
			// ××ª×—×œ ×—×•×“×©×™×
			for (let i = 0; i < 12; i++) {
				monthlyData[i] = { total: 0, days: 0 };
			}
			
			// ××¡×•×£ × ×ª×•× ×™× ×œ×¤×™ ×—×•×“×©
			const dailyGroups = groupMovementsByDay(movements);
			
			Object.entries(dailyGroups).forEach(([dateStr, data]) => {
				const date = parseHebrewDate(dateStr);
				if (date) {
					const month = date.getMonth();
					monthlyData[month].total += data.packs;
					monthlyData[month].days += 1;
				}
			});
			
			// ×—×©×‘ ×××•×¦×¢×™× ×•××›×¤×™×œ×™×
			let totalAverage = 0;
			let monthsWithData = 0;
			
			Object.values(monthlyData).forEach(data => {
				if (data.days > 0) {
					data.average = data.total / data.days;
					totalAverage += data.average;
					monthsWithData++;
				}
			});
			
			if (monthsWithData > 0) {
				totalAverage /= monthsWithData;
			}
			
			// ×—×©×‘ ××›×¤×™×œ×™×
			const seasonality = {};
			Object.entries(monthlyData).forEach(([month, data]) => {
				if (data.days > 0) {
					seasonality[month] = {
						multiplier: totalAverage > 0 ? data.average / totalAverage : 1,
						confidence: Math.min(data.days / 10, 1)
					};
				}
			});
			
			return seasonality;
		}

		/**
		 * ×–×™×”×•×™ ××™×¨×•×¢×™× ××™×•×—×“×™×
		 */
		function detectSpecialEvents(movements) {
			// ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×–×™×”×•×™ ×—×’×™×, ×—×•×¤×©×•×ª, ××™×¨×•×¢×™× ××™×•×—×“×™×
			// ×œ×“×•×’××”: ×‘×“×™×§×” ×©×œ ×ª××¨×™×›×™× ×¢×‘×¨×™×™× ×œ×—×’×™×
			const events = [];
			
			// ×“×•×’××”: ×–×™×”×•×™ ×™××™× ×¢× ×¦×¨×™×›×” ×—×¨×™×’×”
			const dailyData = groupMovementsByDay(movements);
			const avgDaily = Object.values(dailyData).reduce((sum, d) => sum + d.packs, 0) / Object.keys(dailyData).length;
			
			Object.entries(dailyData).forEach(([date, data]) => {
				if (data.packs > avgDaily * 2) {
					events.push({
						date: date,
						type: 'high_demand',
						multiplier: data.packs / avgDaily
					});
				}
			});
			
			return events;
		}

		/**
		 * ××¦×™××ª ××ª×××™× ×‘×™×Ÿ ××•×¦×¨×™×
		 */
		function findProductCorrelations(productName, productMovements) {
			// ×¤×•× ×§×¦×™×” ×¤×©×•×˜×” ×œ××¦×™××ª ××•×¦×¨×™× ×©× ×¦×¨×›×™× ×™×—×“
			const correlations = {};
			
			// ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ××•×¨×›×‘×ª ×™×•×ª×¨
			// ×œ×“×•×’××”: ×× ×¤×•×¤×§×•×¨×Ÿ - ×‘×“×•×§ ××ª×× ×¢× ××©×§××•×ª
			
			return correlations;
		}

		/**
		 * ×§×‘×™×¢×ª ×©×™×˜×ª ×”×—×™×–×•×™ ×”×˜×•×‘×” ×‘×™×•×ª×¨
		 */
		function determinebestMethod(analysis) {
			if (analysis.stats.days.active < 30) {
				return 'simple_average';
			} else if (analysis.stats.range.variance > analysis.stats.average.packsPerDay) {
				return 'adaptive_smoothing';
			} else if (analysis.trends.hasEnoughData && Math.abs(analysis.trends.slope) > 0.1) {
				return 'trend_projection';
			} else {
				return 'weighted_moving_average';
			}
		}

		/**
		 * ×—×™×©×•×‘ ×¦×™×•×Ÿ ×××™× ×•×ª
		 */
		function calculateConfidenceScore(analysis, model) {
			let score = 0.5; // ×‘×¡×™×¡
			
			// ×™×•×ª×¨ × ×ª×•× ×™× = ×™×•×ª×¨ ×××™× ×•×ª
			if (analysis.stats.days.active > 60) score += 0.2;
			else if (analysis.stats.days.active > 30) score += 0.1;
			
			// ×©×•× ×•×ª × ××•×›×” = ×™×•×ª×¨ ×××™× ×•×ª
			if (analysis.stats.range.variance < analysis.stats.average.packsPerDay * 0.3) score += 0.1;
			
			// ××’××” ×‘×¨×•×¨×” = ×™×•×ª×¨ ×××™× ×•×ª
			if (analysis.trends.hasEnoughData && Math.abs(analysis.trends.slope) < 0.5) score += 0.1;
			
			// ×¢×’×œ ×œ-2 ×¡×¤×¨×•×ª
			return Math.min(parseFloat(score.toFixed(2)), 0.95);
		}

		// === ×¤×•× ×§×¦×™×” ×œ×‘×“×™×§×ª ×”×—×™×–×•×™ ===
		function testPrediction(productName = null) {
			// ×‘×“×™×§×ª ×–××™× ×•×ª × ×ª×•× ×™×
			if (typeof movements === 'undefined' || !Array.isArray(movements)) {
				console.error('× ×ª×•× ×™ movements ×œ× ×–××™× ×™×. ×•×•×“× ×©××ª×” ××—×•×‘×¨ ×œ××¢×¨×›×ª.');
				return;
			}
			
			if (typeof inventory === 'undefined' || !Array.isArray(inventory)) {
				console.error('× ×ª×•× ×™ inventory ×œ× ×–××™× ×™×. ×•×•×“× ×©××ª×” ××—×•×‘×¨ ×œ××¢×¨×›×ª.');
				return;
			}
			
			// ×× ×œ× × ×‘×—×¨ ××•×¦×¨, ×‘×—×¨ ××•×˜×•××˜×™×ª
			if (!productName) {
				const testProduct = inventory.find(item => {
					const count = movements.filter(m => 
						m.product === item.name && m.type === '×”×•×¦××”'
					).length;
					return count > 10; // ×”×•×¨×“×ª×™ ××ª ×”×¡×£ ×œ-10 ×ª× ×•×¢×•×ª
				});
				
				if (!testProduct) {
					console.log('×œ× × ××¦× ××•×¦×¨ ×¢× ××¡×¤×™×§ × ×ª×•× ×™× ×œ×—×™×–×•×™');
					console.log('××•×¦×¨×™× ×–××™× ×™× ×¢× ×ª× ×•×¢×•×ª:');
					inventory.forEach(item => {
						const count = movements.filter(m => 
							m.product === item.name && m.type === '×”×•×¦××”'
						).length;
						if (count > 0) {
							console.log(`- ${item.name}: ${count} ×ª× ×•×¢×•×ª ×”×•×¦××”`);
						}
					});
					return;
				}
				
				productName = testProduct.name;
			}
			
			console.log(`ğŸ”® ××—×©×‘ ×—×™×–×•×™ ×¢×‘×•×¨: ${productName}`);
			
			const prediction = predictConsumption(productName, 30);
			
			if (!prediction.success) {
				console.error(prediction.message);
				return;
			}
			
			// ×”×¦×’ ×ª×•×¦××•×ª
			console.log('\nğŸ“Š ×¡×™×›×•× ×—×™×–×•×™:');
			console.log(`×¦×¨×™×›×” ×™×•××™×ª ×××•×¦×¢×ª: ${prediction.analysis.averageDaily.toFixed(1)} ×—×‘×™×œ×•×ª`);
			console.log(`×¦×¤×™ ×œ-30 ×™××™×: ${prediction.forecast.total} ×—×‘×™×œ×•×ª`);
			console.log(`×˜×•×•×—: ${prediction.forecast.range.min}-${prediction.forecast.range.max} ×—×‘×™×œ×•×ª`);
			console.log(`×¨××ª ×‘×™×˜×—×•×Ÿ: ${(prediction.confidence * 100).toFixed(0)}%`);
			
			console.log('\nğŸ“… ×—×™×–×•×™ ×©×‘×•×¢×™:');
			prediction.forecast.weekly.forEach(week => {
				console.log(`×©×‘×•×¢ ${week.weekNumber}: ${week.total} ×—×‘×™×œ×•×ª (×××•×¦×¢ ×™×•××™: ${week.average.toFixed(1)})`);
			});
			
			if (prediction.recommendations.length > 0) {
				console.log('\nğŸ’¡ ×”××œ×¦×•×ª:');
				prediction.recommendations.forEach(rec => {
					console.log(`[${rec.type}] ${rec.title}`);
					console.log(`   ${rec.description}`);
					if (rec.suggestedOrder) {
						console.log(`   ×›××•×ª ××•××œ×¦×ª ×œ×”×–×× ×”: ${rec.suggestedOrder} ×—×‘×™×œ×•×ª`);
					}
				});
			}
			
			return prediction;
		}
		// === ×©×œ×‘ 3: ××™× ×˜×’×¨×¦×™×” ×‘×××©×§ ×”××¢×¨×›×ª ===

		/**
		 * ×”×•×¡×¤×ª ×˜××‘ ×—×™×–×•×™ ×¦×¨×™×›×” ×œ××¢×¨×›×ª
		 */
		function addPredictionTab() {
			// ×”×•×¡×£ ×˜××‘ ×—×“×© ×œ×ª×¤×¨×™×˜
			const tabsContainer = document.querySelector('.tabs');
			if (!tabsContainer) return;
			
			// ×‘×“×•×§ ×× ×”×˜××‘ ×›×‘×¨ ×§×™×™×
			if (document.querySelector('[data-tab="predictions"]')) return;
			
			// ×¦×•×¨ ×˜××‘ ×—×“×©
			const predictionTab = document.createElement('div');
			predictionTab.className = 'tab';
			predictionTab.setAttribute('data-tab', 'predictions');
			predictionTab.setAttribute('data-permission', 'view_reports'); // ××©×ª××© ×‘××•×ª×” ×”×¨×©××” ×›××• ×“×•×—×•×ª
			predictionTab.textContent = '×—×™×–×•×™ ×¦×¨×™×›×”';
			predictionTab.onclick = function(e) { showTab(e, 'predictions'); };
			
			// ×”×•×¡×£ ××ª ×”×˜××‘ ×œ×¤× ×™ "×“×•×—×•×ª"
			const reportsTab = document.querySelector('[data-tab="reports"]');
			if (reportsTab) {
				tabsContainer.insertBefore(predictionTab, reportsTab);
			} else {
				tabsContainer.appendChild(predictionTab);
			}
			
			// ×¦×•×¨ ××ª ×ª×•×›×Ÿ ×”×˜××‘
			const tabContent = document.createElement('div');
			tabContent.id = 'predictions';
			tabContent.className = 'tab-content';
			tabContent.innerHTML = `
				<h2>×—×™×–×•×™ ×¦×¨×™×›×” ×•× ×™×”×•×œ ××œ××™ ×—×›×</h2>
				
				<div class="prediction-controls" style="margin-bottom: 20px;">
					<div class="form-row">
						<div class="form-group">
							<label for="predictionProduct">×‘×—×¨ ××•×¦×¨ ×œ×—×™×–×•×™</label>
							<select id="predictionProduct" onchange="updatePrediction()">
								<option value="">×‘×—×¨ ××•×¦×¨...</option>
							</select>
						</div>
						<div class="form-group">
							<label for="predictionDays">×ª×§×•×¤×ª ×—×™×–×•×™ (×™××™×)</label>
							<select id="predictionDays" onchange="updatePrediction()">
								<option value="7">×©×‘×•×¢</option>
								<option value="14">×©×‘×•×¢×™×™×</option>
								<option value="30" selected>×—×•×“×©</option>
								<option value="60">×—×•×“×©×™×™×</option>
								<option value="90">3 ×—×•×“×©×™×</option>
							</select>
						</div>
						<div class="form-group">
							<label for="safetyFactor">××§×“× ×‘×™×˜×—×•×Ÿ</label>
							<select id="safetyFactor" onchange="updatePrediction()">
								<option value="1">×œ×œ× (100%)</option>
								<option value="1.1">× ××•×š (110%)</option>
								<option value="1.2" selected>×¨×’×™×œ (120%)</option>
								<option value="1.3">×’×‘×•×” (130%)</option>
							</select>
						</div>
					</div>
				</div>
				
				<div id="predictionAlerts" style="margin-bottom: 20px;"></div>
				
				<div id="predictionResults" style="display: none;">
					<!-- ×¡×™×›×•× ×¨××©×™ -->
					<div class="stats" style="margin-bottom: 30px;">
						<div class="stat-card">
							<h3>×¦×¨×™×›×” ×™×•××™×ª ×××•×¦×¢×ª</h3>
							<div class="value" id="avgDailyConsumption">-</div>
						</div>
						<div class="stat-card">
							<h3>×¦×¤×™ ×¦×¨×™×›×” ×›×•×œ×œ</h3>
							<div class="value" id="totalPredicted">-</div>
						</div>
						<div class="stat-card">
							<h3>××œ××™ × ×•×›×—×™</h3>
							<div class="value" id="currentStock">-</div>
						</div>
						<div class="stat-card">
							<h3>×™××™× ×¢×“ ×’××¨ ×”××œ××™</h3>
							<div class="value" id="daysUntilEmpty">-</div>
						</div>
					</div>
					
					<!-- ×’×¨×£ ×—×™×–×•×™ -->
					<div style="background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
						<h3>×’×¨×£ ×—×™×–×•×™ ×¦×¨×™×›×”</h3>
						<canvas id="predictionChart" height="100"></canvas>
					</div>
					
					<!-- ×”××œ×¦×•×ª -->
					<div id="predictionRecommendations" style="margin-bottom: 20px;"></div>
					
					<!-- ×˜×‘×œ×ª ×—×™×–×•×™ ××¤×•×¨×˜ -->
					<div style="background: white; padding: 20px; border-radius: 8px;">
						<h3>×¤×™×¨×•×˜ ×—×™×–×•×™ ×œ×¤×™ ×©×‘×•×¢×•×ª</h3>
						<div id="weeklyPredictionTable"></div>
					</div>
				</div>
				
				<!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” -->
				<div style="margin-top: 30px; text-align: center;">
					<button onclick="exportPrediction()" class="btn-small" style="margin-right: 10px;">ğŸ“¥ ×™×™×¦×•× ×œ××§×¡×œ</button>
					<button onclick="createOrderFromPrediction()" class="btn-small btn-edit">ğŸ›’ ×¦×•×¨ ×¨×©×™××ª ×”×–×× ×”</button>
					<button onclick="showAllProductsPredictions()" class="btn-small">ğŸ“Š ×—×™×–×•×™ ×œ×›×œ ×”××•×¦×¨×™×</button>
				</div>
			`;
			
			// ×”×•×¡×£ ××ª ×”×ª×•×›×Ÿ ×œ××™×›×œ ×”×¨××©×™
			const mainContainer = document.querySelector('.container');
			const existingPredictions = document.getElementById('predictions');
			if (existingPredictions) {
				existingPredictions.remove();
			}
			mainContainer.appendChild(tabContent);
			
			console.log('âœ… ×˜××‘ ×—×™×–×•×™ ×¦×¨×™×›×” × ×•×¡×£ ×‘×”×¦×œ×—×”!');
		}

		/**
		 * ××ª×—×•×œ ×¨×©×™××ª ×”××•×¦×¨×™× ×‘×˜××‘ ×”×—×™×–×•×™
		 */
		function initializePredictionProducts() {
			const select = document.getElementById('predictionProduct');
			if (!select || !inventory) return;
			
			// × ×§×” ××ª ×”×¨×©×™××”
			select.innerHTML = '<option value="">×‘×—×¨ ××•×¦×¨...</option>';
			
			// ×”×•×¡×£ ××•×¦×¨×™× ×¢× ×ª× ×•×¢×•×ª
			const productsWithMovements = inventory
				.map(item => ({
					name: item.name,
					category: item.category,
					movements: movements.filter(m => m.product === item.name && m.type === '×”×•×¦××”').length
				}))
				.filter(p => p.movements > 0)
				.sort((a, b) => b.movements - a.movements);
			
			productsWithMovements.forEach(product => {
				const option = document.createElement('option');
				option.value = product.name;
				option.textContent = `${product.name} (${product.category}) - ${product.movements} ×ª× ×•×¢×•×ª`;
				select.appendChild(option);
			});
		}

		/**
		 * ×¢×“×›×•×Ÿ ×”×—×™×–×•×™ ×‘×”×ª×× ×œ×‘×—×™×¨×ª ×”××©×ª××©
		 */
		window.updatePrediction = function() {
			const productName = document.getElementById('predictionProduct').value;
			if (!productName) {
				document.getElementById('predictionResults').style.display = 'none';
				return;
			}
			
			const days = parseInt(document.getElementById('predictionDays').value);
			const safetyFactor = parseFloat(document.getElementById('safetyFactor').value);
			
			// ×”×¦×’ ××™× ×“×™×§×˜×•×¨ ×˜×¢×™× ×”
			document.getElementById('predictionResults').style.display = 'block';
			document.getElementById('predictionResults').style.opacity = '0.5';
			
			try {
				// ×—×©×‘ ×—×™×–×•×™
				const prediction = predictConsumption(productName, days, { safetyFactor });
				
				if (!prediction.success) {
					showPredictionError(prediction.message);
					return;
				}
				
				// ×¢×“×›×Ÿ ××ª ×”×ª×¦×•×’×”
				displayPredictionResults(prediction);
				
				// ×¦×•×¨ ×’×¨×£
				createPredictionChart(prediction);
				
				// ×”×¦×’ ×”××œ×¦×•×ª
				displayRecommendations(prediction.recommendations);
				
				// ×”×¦×’ ××ª ×”×ª×•×¦××•×ª
				document.getElementById('predictionResults').style.opacity = '1';
				
			} catch (error) {
				console.error('Error in prediction:', error);
				showPredictionError('×©×’×™××” ×‘×—×™×©×•×‘ ×”×—×™×–×•×™');
			}
		};

		/**
		 * ×”×¦×’×ª ×ª×•×¦××•×ª ×”×—×™×–×•×™
		 */
		function displayPredictionResults(prediction) {
			const product = inventory.find(p => p.name === prediction.productName);
			const [currentPacks, currentUnits] = product ? totalPacksAndUnits(product) : [0, 0];
			
			// ×¢×“×›×Ÿ ×›×¨×˜×™×¡×™ ×¡×˜×˜×™×¡×˜×™×§×”
			document.getElementById('avgDailyConsumption').textContent = 
				`${prediction.analysis.averageDaily.toFixed(1)} ×—×‘×™×œ×•×ª`;
			
			document.getElementById('totalPredicted').textContent = 
				`${prediction.forecast.total} ×—×‘×™×œ×•×ª`;
			
			document.getElementById('currentStock').textContent = 
				`${currentPacks} ×—×‘×™×œ×•×ª`;
			
			const daysUntilEmpty = currentPacks > 0 ? 
				Math.floor(currentPacks / prediction.analysis.averageDaily) : 0;
			
			const daysElement = document.getElementById('daysUntilEmpty');
			daysElement.textContent = daysUntilEmpty + ' ×™××™×';
			
			// ×¦×‘×¢ ×œ×¤×™ ××¦×‘
			if (daysUntilEmpty < 7) {
				daysElement.style.color = '#e74c3c';
			} else if (daysUntilEmpty < 14) {
				daysElement.style.color = '#f39c12';
			} else {
				daysElement.style.color = '#27ae60';
			}
			
			// ×˜×‘×œ×ª ×—×™×–×•×™ ×©×‘×•×¢×™
			displayWeeklyPrediction(prediction.forecast.weekly);
		}

		/**
		 * ×™×¦×™×¨×ª ×’×¨×£ ×—×™×–×•×™
		 */
		function createPredictionChart(prediction) {
			const canvas = document.getElementById('predictionChart');
			const ctx = canvas.getContext('2d');
			
			// × ×§×” ×’×¨×£ ×§×•×“× ×× ×§×™×™×
			if (window.predictionChartInstance) {
				window.predictionChartInstance.destroy();
			}
			
			// ×”×›×Ÿ × ×ª×•× ×™× ×œ×’×¨×£
			const labels = prediction.forecast.daily.slice(0, 30).map(d => {
				const date = new Date(d.date);
				return `${date.getDate()}/${date.getMonth() + 1}`;
			});
			
			const data = prediction.forecast.daily.slice(0, 30).map(d => d.predicted);
			
			// ×¦×•×¨ ×’×¨×£
			window.predictionChartInstance = new Chart(ctx, {
				type: 'line',
				data: {
					labels: labels,
					datasets: [{
						label: '×¦×¨×™×›×” ×¦×¤×•×™×” (×—×‘×™×œ×•×ª)',
						data: data,
						borderColor: '#3498db',
						backgroundColor: 'rgba(52, 152, 219, 0.1)',
						tension: 0.4,
						fill: true,
						pointRadius: 3,
						pointHoverRadius: 5
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: true,
					plugins: {
						title: {
							display: false
						},
						legend: {
							display: false
						},
						tooltip: {
							callbacks: {
								label: function(context) {
									const dayIndex = context.dataIndex;
									const dayData = prediction.forecast.daily[dayIndex];
									return [
										`${dayData.dayName}`,
										`×¦×¤×™: ${context.parsed.y} ×—×‘×™×œ×•×ª`
									];
								}
							}
						}
					},
					scales: {
						y: {
							beginAtZero: true,
							title: {
								display: true,
								text: '×—×‘×™×œ×•×ª'
							}
						},
						x: {
							title: {
								display: true,
								text: '×ª××¨×™×š'
							}
						}
					}
				}
			});
		}

		/**
		 * ×”×¦×’×ª ×”××œ×¦×•×ª
		 */
		function displayRecommendations(recommendations) {
			const container = document.getElementById('predictionRecommendations');
			if (!recommendations || recommendations.length === 0) {
				container.innerHTML = '';
				return;
			}
			
			let html = '<div class="recommendations-container">';
			
			recommendations.forEach(rec => {
				let alertClass = 'alert-info';
				if (rec.type === 'urgent') alertClass = 'alert-danger';
				else if (rec.type === 'warning') alertClass = 'alert-warning';
				else if (rec.type === 'trend') alertClass = 'alert-info';
				
				html += `
					<div class="alert ${alertClass}" style="margin-bottom: 10px;">
						<strong>${rec.title}</strong><br>
						${rec.description}
						${rec.suggestedOrder ? `<br><strong>×›××•×ª ××•××œ×¦×ª ×œ×”×–×× ×”: ${rec.suggestedOrder} ×—×‘×™×œ×•×ª</strong>` : ''}
					</div>
				`;
			});
			
			html += '</div>';
			container.innerHTML = html;
		}

		/**
		 * ×”×¦×’×ª ×˜×‘×œ×ª ×—×™×–×•×™ ×©×‘×•×¢×™
		 */
		function displayWeeklyPrediction(weeklyData) {
			const container = document.getElementById('weeklyPredictionTable');
			
			let html = `
				<table style="width: 100%; margin-top: 10px;">
					<thead>
						<tr>
							<th>×©×‘×•×¢</th>
							<th>×ª××¨×™×›×™×</th>
							<th>×¡×”"×› ×¦×¤×•×™</th>
							<th>×××•×¦×¢ ×™×•××™</th>
							<th>×™×•× ×©×™×</th>
						</tr>
					</thead>
					<tbody>
			`;
			
			weeklyData.forEach(week => {
				const startDate = new Date(week.days[0].date);
				const endDate = new Date(week.days[week.days.length - 1].date);
				const dateRange = `${startDate.getDate()}/${startDate.getMonth() + 1} - ${endDate.getDate()}/${endDate.getMonth() + 1}`;
				
				const peakDay = week.days.reduce((max, day) => 
					day.predicted > max.predicted ? day : max
				);
				
				html += `
					<tr>
						<td>×©×‘×•×¢ ${week.weekNumber}</td>
						<td>${dateRange}</td>
						<td><strong>${week.total} ×—×‘×™×œ×•×ª</strong></td>
						<td>${week.average.toFixed(1)} ×—×‘×™×œ×•×ª</td>
						<td>${peakDay.dayName} (${peakDay.predicted} ×—×‘×™×œ×•×ª)</td>
					</tr>
				`;
			});
			
			html += '</tbody></table>';
			container.innerHTML = html;
		}

		/**
		 * ×”×¦×’×ª ×©×’×™××”
		 */
		function showPredictionError(message) {
			const alertsContainer = document.getElementById('predictionAlerts');
			alertsContainer.innerHTML = `
				<div class="alert alert-danger">
					<strong>×©×’×™××”:</strong> ${message}
				</div>
			`;
			document.getElementById('predictionResults').style.display = 'none';
		}

		/**
		 * ×™×¦×™×¨×ª ×¨×©×™××ª ×”×–×× ×” ××”×—×™×–×•×™
		 */
		window.createOrderFromPrediction = function() {
			const productName = document.getElementById('predictionProduct').value;
			if (!productName) {
				alert('×™×© ×œ×‘×—×•×¨ ××•×¦×¨ ×ª×—×™×œ×”');
				return;
			}
			
			const days = parseInt(document.getElementById('predictionDays').value);
			const prediction = predictConsumption(productName, days);
			
			if (!prediction.success) return;
			
			const product = inventory.find(p => p.name === productName);
			const [currentStock] = totalPacksAndUnits(product);
			
			const suggestedOrder = Math.max(0, prediction.forecast.total - currentStock);
			
			if (confirm(`×œ×”×•×¡×™×£ ${suggestedOrder} ×—×‘×™×œ×•×ª ×©×œ ${productName} ×œ×¨×©×™××ª ×”×–×× ×”?`)) {
				// ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×©××™×¨×ª ×”×”×–×× ×”
				showToast(`× ×•×¡×¤×• ${suggestedOrder} ×—×‘×™×œ×•×ª ×©×œ ${productName} ×œ×¨×©×™××ª ×”×”×–×× ×”`, 'success');
			}
		};

		/**
		 * ×—×™×–×•×™ ×œ×›×œ ×”××•×¦×¨×™×
		 */
		window.showAllProductsPredictions = function() {
			// ×¤×•× ×§×¦×™×” ×–×• ×ª×™×¦×•×¨ ×“×•×— ×—×™×–×•×™ ××§×™×£ ×œ×›×œ ×”××•×¦×¨×™×
			alert('×¤×•× ×§×¦×™×” ×–×• ×ª×”×™×” ×–××™× ×” ×‘×§×¨×•×‘');
		};

		/**
		 * ×™×™×¦×•× ×—×™×–×•×™ ×œ××§×¡×œ
		 */
		window.exportPrediction = function() {
			const productName = document.getElementById('predictionProduct').value;
			if (!productName) {
				alert('×™×© ×œ×‘×—×•×¨ ××•×¦×¨ ×ª×—×™×œ×”');
				return;
			}
			
			// ×›××Ÿ ××¤×©×¨ ×œ×”×•×¡×™×£ ×œ×•×’×™×§×” ×œ×™×™×¦×•×
			alert('×™×™×¦×•× ×œ××§×¡×œ ×™×”×™×” ×–××™×Ÿ ×‘×§×¨×•×‘');
		};

		// === ×”×•×¡×¤×” ××•×˜×•××˜×™×ª ×‘×¢×ª ×˜×¢×™× ×ª ×”××¢×¨×›×ª ===
		// ×”×•×¡×£ ××ª ×”×©×•×¨×•×ª ×”×‘××•×ª ×œ×¤×•× ×§×¦×™×” showMainScreen ××• ×œ××—×¨ ×”×˜×¢×™× ×” ×”×¨××©×•× ×™×ª:
		if (document.querySelector('.tabs')) {
			addPredictionTab();
		}

		// ×”×•×¡×£ ×˜×™×¤×•×œ ×‘×˜××‘ ×”×—×“×© ×‘×¤×•× ×§×¦×™×” showTab
		const originalShowTab = window.showTab;
		window.showTab = async function(e, tabName) {
			// ×§×¨× ×œ×¤×•× ×§×¦×™×” ×”××§×•×¨×™×ª
			if (originalShowTab) {
				await originalShowTab(e, tabName);
			}
			
			// ×× ×–×” ×”×˜××‘ ×©×œ× ×•, ××ª×—×œ ××•×ª×•
			if (tabName === 'predictions') {
				initializePredictionProducts();
			}
		};

    </script>

    <footer style="text-align:center; padding:20px 0; color:#666; background:transparent; font-size:14px;">
        Â© 2025 ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª ×œ×—×™×œ×™×§ ×‘×™×˜××Ÿ
    </footer>
</body>
</html>